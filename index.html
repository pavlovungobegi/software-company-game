<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Software Company Simulator</title>
  <style>
    /* ============================================ */
    /* SOFTWARE COMPANY SIMULATOR - STYLES */
    /* Version 2.0 | Phase 1-2: Core + Products */
    /* ============================================ */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f9fafb;
      color: #111827;
      line-height: 1.6;
      padding-top: 130px;
    }
    
    /* Header Wrapper - Fixed Container */
    .header-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* Header */
    .header {
      background: #2563eb;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-controls {
      background: #1e40af;
      color: white;
      padding: 0.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    
    .company-name {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .day-counter {
      font-size: 1.2rem;
      font-family: 'Courier New', monospace;
    }
    
    .day-counter small {
      font-size: 0.8rem;
      opacity: 0.9;
    }
    
    .cash-display {
      font-size: 1.5rem;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      background: rgba(255,255,255,0.2);
    }
    
    .cash-display.green { background: #10b981; }
    .cash-display.yellow { background: #f59e0b; }
    .cash-display.red { background: #ef4444; }
    .cash-display.flashing-red { 
      background: #ef4444;
      animation: flash 0.5s infinite;
    }
    
    .next-billing-info {
      font-size: 0.75rem;
      text-align: center;
      margin-top: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      color: white;
      font-weight: 600;
    }
    
    .next-billing-info .cash-flow-positive {
      color: #14d192;
      font-weight: 700;
    }
    
    .next-billing-info .cash-flow-negative {
      color: #df7575;
      font-weight: 700;
    }
    
    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    /* Notification System */
    .notification-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    
    .notification {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-size: 0.95rem;
      font-weight: 600;
      min-width: 300px;
      max-width: 500px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideDown 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
      pointer-events: auto;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .notification.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .notification.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .notification-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .notification-text {
      flex: 1;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-100px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }
    
    @media (max-width: 1024px) {
      .notification {
        min-width: 250px;
        max-width: 90vw;
        font-size: 0.85rem;
        padding: 0.75rem 1rem;
      }
      
      .notification-icon {
        font-size: 1.25rem;
      }
      
      .notification-container {
        top: 10px;
      }
    }
    
    .founder-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      font-size: 0.9rem;
      cursor: help;
    }
    
    .speed-controls {
      display: flex;
      gap: 0.5rem;
    }
    
    .speed-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    
    .speed-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .speed-btn.active {
      background: rgba(255,255,255,0.4);
      font-weight: bold;
    }
    
    /* Yellowish highlight for pause button when game is paused */
    #pauseBtn.active {
      background: #fef3c7;
      color: #78350f;
      font-weight: bold;
    }
    
    #pauseBtn.active:hover {
      background: #fde68a;
      border-color: #fbbf24;
    }
    
    .game-controls {
      display: flex;
      gap: 0.5rem;
    }
    
    .game-ctrl-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .game-ctrl-btn:hover {
      background: rgba(255,255,255,0.35);
      transform: translateY(-1px);
    }
    
    .game-ctrl-btn:active {
      transform: translateY(0);
    }
    
    .reset-btn {
      background: rgba(239, 68, 68, 0.3);
    }
    
    .reset-btn:hover {
      background: rgba(239, 68, 68, 0.5);
    }
    
    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      padding: 1rem;
      max-width: 1800px;
      margin: 0 auto;
    }
    
    /* Mobile Navigation */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      z-index: 999;
      padding: 0.5rem;
    }
    
    .mobile-nav-buttons {
      display: flex;
      justify-content: space-around;
      gap: 0.5rem;
    }
    
    .mobile-nav-btn {
      flex: 1;
      padding: 0.6rem 0.5rem;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      min-width: 0;
    }
    
    .mobile-nav-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    
    /* Mobile Styles */
    @media (max-width: 1024px) {
      body {
        padding-top: 70px;
        padding-bottom: 70px;
      }
      
      /* Much smaller header on mobile */
      .header {
        padding: 0.35rem 0.75rem;
      }
      
      .header-left {
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      
      .company-name {
        font-size: 0.85rem;
      }
      
      .day-counter {
        font-size: 0.75rem;
      }
      
      .day-counter small {
        font-size: 0.6rem;
        display: block;
      }
      
      .founder-badge {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
      }
      
      .cash-display {
        font-size: 0.9rem;
        padding: 0.3rem 0.6rem;
      }
      
      .next-billing-info {
        font-size: 0.7rem;
        padding: 0;
        margin-top: 0;
      }
      
      .header-controls {
        padding: 0.3rem 0.75rem;
      }
      
      .speed-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
      }
      
      .game-ctrl-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
      }
      
      /* Swipeable panels */
      .main-container {
        display: flex;
        overflow-x: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        gap: 0;
        padding: 0;
        margin: 0;
        width: 100vw;
        scrollbar-width: none;
      }
      
      .main-container::-webkit-scrollbar {
        display: none;
      }
      
      .panel {
        min-width: 100vw;
        scroll-snap-align: start;
        border-radius: 0;
        margin-top: 5vh;
        height: calc(100vh - 70px - 70px);
        overflow-y: auto;
        padding: 1.5rem 1rem 1rem 1rem;
      }
      
      /* Hide desktop event log on mobile (it becomes its own panel) */
      #desktopEventLogWrapper {
        display: none !important;
      }
      
      /* Show event log panel on mobile */
      #eventLogPanel {
        display: flex;
      }
      
      /* Show mobile navigation */
      .mobile-nav {
        display: block;
      }
      
      /* Hide some controls on very small screens */
      @media (max-width: 640px) {
        .header-left {
          font-size: 0.85rem;
        }
        
        .speed-btn span {
          display: none;
        }
      }
    }
    
    /* Hide mobile event log panel on desktop */
    @media (min-width: 1025px) {
      #eventLogPanel {
        display: none;
      }
    }
    
    /* Panels */
    .panel {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .panel-header {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.75rem;
      padding-bottom: 0.4rem;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Buttons */
    .btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.5rem 0.85rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.2s;
    }
    
    .btn:hover {
      background: #1d4ed8;
    }
    
    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .btn-success {
      background: #10b981;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-danger {
      background: #ef4444;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-sm {
      padding: 0.35rem 0.75rem;
      font-size: 0.85rem;
    }
    
    /* Pause Banner */
    /* Pause banner removed - pause state now shown by pause button color */
    .pause-banner {
      display: none !important;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* Event Log */
    .event-log {
      background: white;
      border-radius: 8px;
      padding: 0.75rem;
      margin-top: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      height: 120px;
      overflow-y: auto;
    }
    
    .event-log h3 {
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
      color: #6b7280;
    }
    
    .event {
      padding: 0.2rem 0;
      font-size: 0.8rem;
      color: #374151;
      line-height: 1.3;
    }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      padding: 0.8rem;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      text-align: center;
      color: #2563eb;
      border-radius: 8px;
    }
    
    .modal-body {
      margin-bottom: 0.8rem;
    }
    
    .modal-footer {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    
    .form-group {
      margin-bottom: 0.8rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.35rem;
      font-weight: 600;
      font-size: 0.9rem;
      color: #374151;
    }
    
    .form-group input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #2563eb;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .radio-option:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }
    
    .radio-option input[type="radio"] {
      margin-right: 0.75rem;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .radio-option-content {
      flex: 1;
    }
    
    .radio-option-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .radio-option-desc {
      font-size: 0.85rem;
      color: #6b7280;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 1rem;
      color: #9ca3af;
      font-size: 0.85rem;
    }
    
    /* Loading state */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }
    
    /* ============================================ */
    /* PHASE 2: PRODUCT SYSTEM STYLES */
    /* ============================================ */
    
    /* Product Cards */
    .product-card {
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .product-card.in-development {
      border-color: #9ca3af;
      background: #fffbeb;
    }
    
    .product-card.published {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .product-card.deprecated {
      border-color: #ef4444;
      background: #fef2f2;
      opacity: 0.7;
    }
    
    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.3rem;
    }
    
    .product-name {
      font-weight: bold;
      font-size: 0.9rem;
      color: #111827;
    }
    
    .product-status {
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-dev {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-published {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-deprecated {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .product-info {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.3rem;
      line-height: 1.3;
    }
    
    .product-info strong {
      color: #374151;
    }
    
    .progress-bar {
      width: 100%;
      height: 18px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin: 0.3rem 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .lifetime-indicator {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      line-height: 1.3;
    }
    
    .lifetime-green {
      background: #d1fae5;
      color: #065f46;
    }
    
    .lifetime-yellow {
      background: #fef3c7;
      color: #92400e;
    }
    
    .lifetime-orange {
      background: #fed7aa;
      color: #9a3412;
    }
    
    .lifetime-red {
      background: #fee2e2;
      color: #991b1b;
    }
    
    /* Product Template Selection */
    .product-template {
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
    }
    
    .product-template:hover {
      border-color: #93c5fd;
      background: #f0f9ff;
      box-shadow: 0 1px 4px rgba(37, 99, 235, 0.15);
    }
    
    .product-template input[type="radio"] {
      margin-top: 0.15rem;
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #2563eb;
      flex-shrink: 0;
    }
    
    .product-template:has(input[type="radio"]:checked) {
      border-color: #2563eb;
      background: #eff6ff;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .product-template:has(input[type="radio"]:checked) .template-name {
      color: #2563eb;
    }
    
    .product-template.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .product-template.disabled:hover {
      border-color: #d1d5db;
      background: #f3f4f6;
      box-shadow: none;
    }
    
    .product-template.disabled input[type="radio"] {
      cursor: not-allowed;
    }
    
    .template-content {
      flex: 1;
    }
    
    .template-name {
      font-weight: bold;
      font-size: 0.95rem;
      color: #111827;
      margin-bottom: 0.3rem;
    }
    
    .template-details {
      font-size: 0.75rem;
      color: #6b7280;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.3rem;
      margin-bottom: 0.3rem;
    }
    
    .template-detail {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .template-description {
      font-size: 0.75rem;
      color: #9ca3af;
      font-style: italic;
      margin-top: 0.1rem;
      line-height: 1.2;
    }
    
    .scrollable-list {
      max-height: 58vh;
      overflow-y: auto;
      padding-right: 0.5rem;
    }
    
    .scrollable-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .scrollable-list::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    .scrollable-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    .scrollable-list::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .modal-intro {
      color: #6b7280;
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 3px solid #2563eb;
    }
    
    /* ============================================ */
    /* EMPLOYEE SYSTEM - Phase 3 */
    /* ============================================ */
    
    /* Employee Cards */
    .employee-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
    }
    
    .employee-card:hover {
      border-color: #2563eb;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }
    
    /* Assigned Person Cards (in product assignment sections) */
    .assigned-person-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      padding: 0.25rem 0.5rem;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.7rem;
      min-width: 75%;
    }
    
    .assigned-person-name {
      color: #374151;
      font-weight: 500;
    }
    
    .person-role {
      color: #6b7280;
      font-weight: 400;
      font-size: 0.75rem;
    }
    
    .unassign-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.2rem 0.4rem;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: bold;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .unassign-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }
    
    .add-person-btn {
      background: white;
      color: #2563eb;
      border: 2px dashed #93c5fd;
      border-radius: 6px;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .add-person-btn:hover {
      background: #eff6ff;
      border-color: #2563eb;
      transform: translateY(-1px);
    }
    
    .team-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      padding: 0.3rem 0.4rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .team-section-header:hover {
      background: rgba(0,0,0,0.05);
    }
    
    .team-section-title {
      font-weight: bold;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .team-count {
      background: rgba(0,0,0,0.1);
      padding: 0.1rem 0.4rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .team-count.warning {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .team-toggle {
      font-size: 0.75rem;
      color: #6b7280;
      transition: transform 0.2s;
    }
    
    .team-toggle.expanded {
      transform: rotate(180deg);
    }
    
    .team-section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.15s ease-out;
    }
    
    .team-section-content.expanded {
      max-height: 1000px;
      transition: max-height 0.3s ease-in;
    }
    
    .employee-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    
    .employee-name {
      font-weight: bold;
      font-size: 0.9rem;
      color: #111827;
      margin-right: 0.5rem;
    }
    
    .employee-role {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .role-developer {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .role-marketer {
      background: #fce7f3;
      color: #be185d;
    }
    
    .employee-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.3rem;
      font-size: 0.75rem;
      color: #6b7280;
    }
    
    .employee-stat {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .skill-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .skill-junior { background: #fef3c7; color: #92400e; }
    .skill-intermediate { background: #dbeafe; color: #1e40af; }
    .skill-senior { background: #d1fae5; color: #065f46; }
    .skill-lead { background: #e9d5ff; color: #6b21a8; }
    .skill-expert { background: #fecaca; color: #991b1b; }
    
    .employee-assignment {
      font-size: 0.7rem;
      color: #9ca3af;
      padding: 0.25rem 0.35rem;
      background: #f9fafb;
      border-radius: 4px;
    }
    
    .assignment-active {
      color: #2563eb;
      background: #eff6ff;
      font-weight: 500;
    }
    
    .hire-section {
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .hire-section h3 {
      margin: 0 0 0.75rem 0;
      color: #374151;
      font-size: 1rem;
    }
    
    .hire-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .hire-btn {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.4rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .hire-btn:hover:not(:disabled) {
      border-color: #2563eb;
      background: #eff6ff;
      transform: translateY(-1px);
    }
    
    .hire-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .hire-btn-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .hire-btn-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #111827;
    }
    
    .hire-btn-stats {
      font-size: 0.8rem;
      color: #6b7280;
    }
    
    .hire-btn-cost {
      font-weight: bold;
      font-size: 0.95rem;
      color: #059669;
    }
    
    /* Office Info */
    .office-info {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .office-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    
    .office-info-left {
      flex: 1;
    }
    
    .office-actions {
      display: flex;
      gap: 0.35rem;
      margin-left: 0.5rem;
    }
    
    .office-name {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 0.35rem;
      color: #111827;
    }
    
    .office-stats {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.75rem;
      color: #6b7280;
    }
    
    .office-stat-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    
    .office-upgrade-section {
      border-top: 1px solid #e5e7eb;
    }
    
    .office-upgrade-btn {
      padding: 0.35rem 0.6rem;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      color: #4b5563;
      font-weight: 600;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    
    .office-upgrade-btn.upgrade {
      background: #d1fae5;
      border-color: #a7f3d0;
      color: #065f46;
    }
    
    .office-upgrade-btn.upgrade:hover:not(:disabled) {
      background: #a7f3d0;
      border-color: #6ee7b7;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }
    
    .office-upgrade-btn.downgrade {
      background: #fee2e2;
      border-color: #fecaca;
      color: #991b1b;
    }
    
    .office-upgrade-btn.downgrade:hover:not(:disabled) {
      background: #fecaca;
      border-color: #fca5a5;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
    }
    
    .office-upgrade-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
      color: #9ca3af;
      border-color: #e5e7eb;
    }
    
    .office-upgrade-details {
      background: #f9fafb;
      border-radius: 6px;
      padding: 0.5rem;
      font-size: 0.75rem;
      min-height: 5rem;
    }
    
    .upgrade-detail {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.15rem 0;
      color: #6b7280;
      font-size: 0.7rem;
      line-height: 1.4;
    }
    
    .upgrade-detail span:last-child {
      text-align: right;
    }
    
    .upgrade-detail strong {
      color: #111827;
      font-weight: 600;
    }
    
    /* ============================================ */
    /* FINANCES PANEL */
    /* ============================================ */
    
    .finance-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.75rem;
      transition: all 0.2s;
    }
    
    .finance-header {
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
      padding-bottom: 0.35rem;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .finance-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3rem 0;
      font-size: 0.85rem;
    }
    
    .finance-row-sub {
      font-size: 0.75rem;
      color: #6b7280;
      padding-left: 0.5rem;
      margin-top: -0.15rem;
      line-height: 1.3;
    }
    
    .finance-value {
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .finance-value.positive {
      color: #10b981;
    }
    
    .finance-value.negative {
      color: #ef4444;
    }
    
    .finance-value.neutral {
      color: #6b7280;
    }
    
    .finance-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 0.5rem 0;
    }
    
    /* Server Capacity */
    .server-capacity {
      margin-top: 0.5rem;
    }
    
    .capacity-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.35rem;
    }
    
    .capacity-bar {
      height: 16px;
      background: #f3f4f6;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .capacity-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      transition: all 0.3s;
      border-radius: 8px;
    }
    
    .capacity-fill.capacity-warning {
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    }
    
    .capacity-fill.capacity-critical {
      background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
    }
    
    .capacity-percent {
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.2rem;
      font-weight: 600;
    }
    
    /* Founder XP Tooltip */
    .founder-badge {
      position: relative;
    }
    
    .founder-xp-tooltip {
      position: absolute;
      top: 100%;
      left: 100%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      white-space: nowrap;
      margin-top: 0.5rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    
    .founder-badge:hover .founder-xp-tooltip {
      opacity: 1;
    }
    
    .xp-progress-bar {
      width: 150px;
      height: 6px;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 0.25rem;
    }
    
    .xp-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      transition: width 0.3s;
    }
    
    /* Candidate Cards */
    .candidate-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      background: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      animation: fadeInSlide 0.4s ease-out;
    }
    
    @keyframes fadeInSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .candidate-card:nth-child(1) { animation-delay: 0.05s; }
    .candidate-card:nth-child(2) { animation-delay: 0.1s; }
    .candidate-card:nth-child(3) { animation-delay: 0.15s; }
    .candidate-card:nth-child(4) { animation-delay: 0.2s; }
    
    .candidate-card:hover:not(.hired) {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      transform: translateY(-2px) scale(1.01);
    }
    
    .candidate-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      animation: pulse 0.5s ease-out;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
      }
      70% {
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }
    
    .candidate-card.hired {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }
    
    .candidate-card.hired::after {
      content: 'HIRED';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      font-size: 2rem;
      font-weight: bold;
      color: #10b981;
      opacity: 0.3;
      pointer-events: none;
    }
    
    .candidate-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.75rem;
    }
    
    .candidate-name {
      font-weight: 600;
      font-size: 1rem;
      color: #111827;
    }
    
    .candidate-tier-badge {
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .candidate-card:hover .candidate-tier-badge {
      transform: scale(1.05);
    }
    
    .candidate-description {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 0.75rem;
      line-height: 1.4;
    }
    
    .candidate-stats {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .candidate-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }
    
    .candidate-stat-label {
      color: #6b7280;
    }
    
    .candidate-stat-value {
      font-weight: 600;
      color: #111827;
    }
    
    .candidates-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    /* Milestone Achievement Notification */
    .milestone-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 2.5rem;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      animation: milestoneAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      text-align: center;
      max-width: 400px;
    }
    
    @keyframes milestoneAppear {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    .milestone-notification h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .milestone-notification p {
      margin: 0;
      font-size: 1rem;
      opacity: 0.95;
    }
    
    /* Tooltip Styles */
    .tooltip-container {
      position: relative;
      display: inline-block;
    }
    
    .tooltip-container .tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: none;
    }
    
    .tooltip-container .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #1f2937;
    }
    
    .tooltip-container:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    /* Pool Refresh Animation */
    @keyframes poolRefresh {
      0% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.3;
        transform: scale(0.95);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .candidates-refreshing .candidate-card {
      animation: poolRefresh 0.6s ease-in-out;
    }
    
    /* Milestone Progress Bar in Finance Panel */
    .milestone-progress-container {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e5e7eb;
    }
    
    .milestone-progress-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    
    .milestone-progress-current {
      font-weight: 600;
      color: #7c3aed;
    }
    
    .milestone-progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .milestone-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #7c3aed, #a78bfa);
      transition: width 0.3s ease-out;
      border-radius: 10px;
    }
    
    /* Pool Quality Badge in Hiring Modal */
    .pool-quality-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .pool-quality-icon {
      font-size: 1.2rem;
    }
    
    /* Pool Refresh Info */
    .pool-refresh-info {
      background: #fffbeb;
      border: 1px solid #fbbf24;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      color: #92400e;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .pool-refresh-icon {
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- Header Wrapper - Contains both header bars -->
  <div class="header-wrapper">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="company-name" id="companyNameDisplay">My Startup</div>
        <div class="day-counter">
          Day <span id="dayCounter">0</span>
          <small>(<span id="yearMonth">Year 0, Month 0</span>)</small>
        </div>
        <div class="founder-badge">
          <span>üë®‚Äçüíº Lvl <span id="founderLevel">1</span> (<span id="founderXP">0</span> XP)</span>
          <div class="founder-xp-tooltip">
            <div><strong id="founderName">Founder</strong></div>
            <div>Level <span id="tooltipLevel">1</span> - <span id="tooltipEfficiency">100</span>% Efficiency</div>
            <div>XP: <span id="tooltipCurrentXP">0</span> / <span id="tooltipNextLevelXP">100</span></div>
            <div class="xp-progress-bar">
              <div class="xp-progress-fill" id="xpProgressBar" style="width: 0%"></div>
            </div>
            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: #d1d5db;">
              <span id="tooltipXPNeeded">100</span> XP to next level
            </div>
            <div style="font-size: 0.8rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #374151;">
              <span id="tooltipCurrentAssignment">Not assigned</span>
            </div>
          </div>
        </div>
      </div>
      <div class="header-right">
        <div class="cash-display green" id="cashDisplay">$0</div>
        <div class="next-billing-info" id="nextBillingInfo"></div>
      </div>
    </div>

    <!-- Speed Controls -->
    <div class="header-controls">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
      <div class="speed-controls">
        <button class="speed-btn" id="pauseBtn" title="Pause game">‚è∏ Pause<span style="font-size: 0.7rem; opacity: 0.7;">(Space)</span></button>
        <button class="speed-btn active" id="playBtn" title="Play game">‚ñ∂ Play (1x)<span style="font-size: 0.7rem; opacity: 0.7;">(Space)</span></button>
        <button class="speed-btn" id="speed2xBtn" title="Play at 2x speed">2x</button>
        <button class="speed-btn" id="speed5xBtn" title="Play at 5x speed">5x</button>
      </div>
      <div class="game-controls">
        <button class="game-ctrl-btn" id="saveBtn" title="Save game to browser storage">Save</button>
        <button class="game-ctrl-btn reset-btn" id="resetBtn" title="Reset and start a new game">Reset</button>
      </div>
    </div>
  </div>
  </div><!-- End Header Wrapper -->

  <!-- Pause Banner removed - pause state now shown by yellowish pause button -->

  <!-- Main Container -->
  <div class="main-container">
    <!-- Products Panel -->
    <div class="panel">
      <div class="panel-header">
        <span>Products</span>
        <button class="btn btn-success" id="newProductBtn">+ New Product</button>
      </div>
      <div id="productsContainer">
        <div class="empty-state">No products yet. Start building!</div>
      </div>
    </div>

    <!-- R&D Panel -->
    <div class="panel">
      <div class="panel-header">
        <span>üî¨ R&D</span>
        <button class="btn btn-primary" id="newRndBtn">+ New R&D Project</button>
      </div>
      <div id="rndContainer">
        <div class="empty-state">No R&D projects yet. Start researching!</div>
      </div>
    </div>

    <!-- Employees Panel -->
    <div class="panel">
      <div class="panel-header">
        <span>üë• Team</span>
      </div>
      <div id="employeesContainer">
        <!-- Office Info -->
        <div class="office-info" id="officeInfo"></div>
        
        <!-- Hire Buttons -->
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <button class="btn" onclick="showHireDeveloperModal()" style="flex: 1;">
            üë®‚Äçüíª Hire Developer
          </button>
          <button class="btn" onclick="showHireMarketerModal()" style="flex: 1;">
            üì¢ Hire Marketer
          </button>
        </div>
        
        <!-- Employee List -->
        <div id="employeeList"></div>
      </div>
    </div>

    <!-- Finances Panel -->
    <div class="panel">
      <div class="panel-header">
        <span>Finances</span>
      </div>
      <div class="panel-content" id="financesContent">
        <div class="loading">Loading financial data...</div>
      </div>
    </div>

    <!-- Event Log Panel (Mobile Only) -->
    <div class="panel" id="eventLogPanel">
      <div id="eventLogMobile" style="font-size: 0.9rem;"></div>
    </div>
  </div>

  <!-- Mobile Navigation (Bottom Tab Bar) -->
  <div class="mobile-nav">
    <div class="mobile-nav-buttons">
      <button class="mobile-nav-btn active" onclick="scrollToPanel(0)">
        üì¶
      </button>
      <button class="mobile-nav-btn" onclick="scrollToPanel(1)">
        üî¨
      </button>
      <button class="mobile-nav-btn" onclick="scrollToPanel(2)">
        üë•
      </button>
      <button class="mobile-nav-btn" onclick="scrollToPanel(3)">
        üí∞
      </button>
      <button class="mobile-nav-btn" onclick="scrollToPanel(4)">
        üìã
      </button>
    </div>
  </div>

  <!-- Event Log -->
  <div id="desktopEventLogWrapper" style="max-width: 1800px; margin: 0 auto; padding: 0 1.5rem 1.5rem;">
    <div class="event-log">
      <div id="eventLog"></div>
    </div>
  </div>

  <!-- New Product Modal -->
  <div class="modal-overlay" id="newProductModal">
    <div class="modal">
      <div class="modal-header">üî® Create New Product</div>
      <div class="modal-body">
        <div class="modal-intro">Products have different development time, lifetime, pricing, and server costs.</div>
        <div class="scrollable-list" id="productTemplatesList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancelProductBtn">Cancel</button>
        <button class="btn btn-success" id="createProductBtn">Start Building üî®</button>
      </div>
    </div>
  </div>

  <!-- New R&D Project Modal -->
  <div class="modal-overlay" id="newRndModal">
    <div class="modal">
      <div class="modal-header">üî¨ Start R&D Project</div>
      <div class="modal-body">
        <div class="modal-intro">R&D projects provide permanent upgrades and unlock new products.</div>
        <div class="scrollable-list" id="rndProjectsList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideNewRndModal()">Cancel</button>
        <button class="btn btn-primary" onclick="handleCreateRndProject()">Start Research üî¨</button>
      </div>
    </div>
  </div>

  <!-- Assign to R&D Modal -->
  <div class="modal-overlay" id="assignToRndModal">
    <div class="modal">
      <div class="modal-header">üë®‚Äçüíª Assign Developer to R&D</div>
      <div class="modal-body">
        <div class="modal-intro">Select a developer to assign to this R&D project.</div>
        <div class="scrollable-list" id="availableDevelopersForRnd"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideAssignToRndModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Hire Developer Modal -->
  <div class="modal-overlay" id="hireDeveloperModal">
    <div class="modal">
      <div class="modal-header">üë®‚Äçüíª Hire Developer</div>
      <div class="modal-body">
        <div class="scrollable-list" id="hireDeveloperList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideHireDeveloperModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Hire Marketer Modal -->
  <div class="modal-overlay" id="hireMarketerModal">
    <div class="modal">
      <div class="modal-header">üì¢ Hire Marketer</div>
      <div class="modal-body">
        <div class="scrollable-list" id="hireMarketerList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideHireMarketerModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Assign Developer to Product Modal -->
  <div class="modal-overlay" id="assignDeveloperModal">
    <div class="modal">
      <div class="modal-header">üë®‚Äçüíª Assign Developer</div>
      <div class="modal-body">
        <div class="modal-intro" id="assignDeveloperProductName"></div>
        <div class="scrollable-list" id="assignDeveloperList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideAssignDeveloperModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Assign Marketer to Product Modal -->
  <div class="modal-overlay" id="assignMarketerModal">
    <div class="modal">
      <div class="modal-header">üì¢ Assign Marketer</div>
      <div class="modal-body">
        <div class="modal-intro" id="assignMarketerProductName"></div>
        <div class="scrollable-list" id="assignMarketerList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideAssignMarketerModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div class="modal-overlay" id="gameOverModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white;">
        üíÄ GAME OVER
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.2rem; font-weight: bold; color: #dc2626; margin-bottom: 1rem;">
          Your company went bankrupt! üí∏
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1.5rem; margin: 1rem 0;">
          <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;">Final Stats</div>
          <div style="display: grid; gap: 0.75rem; text-align: left;">
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
              <span style="color: #6b7280;">üìÖ Survived:</span>
              <span style="font-weight: 600; color: #111827;" id="gameOverDays">0 days</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
              <span style="color: #6b7280;">üì¶ Products Created:</span>
              <span style="font-weight: 600; color: #111827;" id="gameOverProducts">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
              <span style="color: #6b7280;">üë• Team Size:</span>
              <span style="font-weight: 600; color: #111827;" id="gameOverTeam">1</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
              <span style="color: #6b7280;">üí∞ Final Cash:</span>
              <span style="font-weight: 600; color: #dc2626;" id="gameOverCash">$0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 1rem;">
        <button class="btn btn-primary" onclick="restartGame()" style="flex: 1; padding: 1rem; font-size: 1.1rem;">
          üîÑ Restart Game
        </button>
      </div>
    </div>
  </div>

  <!-- Fire Employee Confirmation Modal -->
  <div class="modal-overlay" id="fireEmployeeModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
        üî• Fire Employee
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="fireEmployeeName">
          Fire Employee Name?
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">Role:</span>
              <span style="font-weight: 600;" id="fireEmployeeRole">Senior Developer</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">Current Salary:</span>
              <span style="font-weight: 600;" id="fireEmployeeSalary">$7,000/month</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #dc2626; font-weight: 600;">Severance Pay:</span>
              <span style="font-weight: 700; color: #dc2626;" id="fireEmployeeSeverance">$7,000</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Monthly Savings:</span>
              <span style="font-weight: 700; color: #10b981;" id="fireEmployeeSavings">$7,000/mo</span>
            </div>
          </div>
        </div>
        <div style="color: #dc2626; font-size: 0.9rem; margin-top: 1rem;">
          ‚ö†Ô∏è This will cost <span id="fireEmployeeCost" style="font-weight: 700;">$7,000</span> immediately.
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideFireEmployeeModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmFireEmployee()" style="flex: 1; background: #ef4444; border-color: #dc2626; color: white;">
          üî• Confirm Fire
        </button>
      </div>
    </div>
  </div>

  <!-- Hire Confirmation Modal -->
  <div class="modal-overlay" id="hireConfirmModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        ‚úÖ Hire Employee
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="hireConfirmName">
          Candidate Name
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">Role:</span>
              <span style="font-weight: 600;" id="hireConfirmRole">Senior Developer</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">Efficiency:</span>
              <span style="font-weight: 600;" id="hireConfirmEfficiency">2.2x</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #dc2626; font-weight: 600;">Monthly Salary:</span>
              <span style="font-weight: 700; color: #dc2626;" id="hireConfirmSalary">$7,000/month</span>
            </div>
          </div>
        </div>
        <div style="color: #6b7280; font-size: 0.9rem; margin-top: 1rem;">
          üí° This candidate will be removed from the pool once hired.
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideHireConfirmModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmHireCandidate()" style="flex: 1; background: #10b981; border-color: #059669; color: white;">
          ‚úÖ Confirm Hire
        </button>
      </div>
    </div>
  </div>

  <!-- Promotion Negotiation Modal -->
  <div class="modal-overlay" id="promotionModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 0.75rem 1rem;">
        üéì Promotion Negotiation
      </div>
      <div class="modal-body" style="text-align: center; padding: 0.75rem 1rem;">
        <div style="font-size: 0.95rem; font-weight: 600; color: #111827; margin-bottom: 0.25rem;" id="promotionEmployeeName">
          Employee Name
        </div>
        <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;" id="promotionEmployeeRole">
          Junior Developer ‚Üí Intermediate Developer
        </div>
        
        <!-- Salary Info Side-by-Side -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
          <div style="background: #f9fafb; border-radius: 6px; padding: 0.5rem;">
            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem;">üíº Expectation</div>
            <div style="font-size: 1rem; font-weight: 700; color: #111827;" id="promotionExpectation">$5,000/mo</div>
          </div>
          <div style="background: white; border: 2px solid #7c3aed; border-radius: 6px; padding: 0.5rem;">
            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem;">üíµ Your Offer</div>
            <div style="font-size: 1rem; font-weight: 700; color: #7c3aed;" id="promotionOfferDisplay">$5,000/mo</div>
          </div>
        </div>
        
        <!-- Slider -->
        <div style="margin-bottom: 0.5rem;">
          <input 
            type="range" 
            id="promotionSalarySlider" 
            min="0" 
            max="100" 
            value="100" 
            step="1"
            style="width: 100%; margin-bottom: 0.25rem;"
          >
          <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #9ca3af;">
            <span id="promotionMinSalary">$4,000</span>
            <span id="promotionMaxSalary">$6,000</span>
          </div>
        </div>
        
        <!-- Acceptance Chance -->
        <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; padding: 0.4rem 0.5rem; margin-bottom: 0.5rem;" id="promotionAcceptanceChance">
          <span style="font-size: 0.8rem; color: #92400e;">
            üìä <strong>Acceptance:</strong> <span id="promotionProbability">100%</span>
          </span>
        </div>
        
        <!-- Rejection History (hidden by default) -->
        <div id="promotionRejectionInfo" style="display: none; background: #fee2e2; border: 1px solid #ef4444; border-radius: 4px; padding: 0.4rem 0.5rem; margin-bottom: 0.5rem;">
          <div style="font-size: 0.75rem; color: #991b1b; text-align: center; font-weight: 600;">
            ‚ö†Ô∏è <span id="promotionRejectionText">Rejected 1/3</span> - After 3 rejections, they quit!
          </div>
        </div>
        
        <!-- Compact Tip -->
        <div style="color: #6b7280; font-size: 0.7rem; text-align: center;">
          üí° Higher offers = better acceptance. <strong>3 rejections = employee quits</strong>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem; padding: 0.5rem 1rem;">
        <button class="btn" onclick="hidePromotionModal()" style="flex: 1; padding: 0.4rem;">Cancel</button>
        <button class="btn" onclick="makePromotionOffer()" style="flex: 1; padding: 0.4rem; background: #8b5cf6; border-color: #7c3aed; color: white;">
          üí∞ Make Offer
        </button>
      </div>
    </div>
  </div>

  <!-- Upgrade Office Confirmation Modal -->
  <div class="modal-overlay" id="upgradeOfficeModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        ‚¨ÜÔ∏è Upgrade Office
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="upgradeOfficeName">
          Home Office ‚Üí Startup Space
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">üë• Capacity:</span>
              <span style="font-weight: 600;" id="upgradeOfficeCapacity">3 ‚Üí 10 people</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">üí∞ Monthly Rent:</span>
              <span style="font-weight: 600;" id="upgradeOfficeRent">$0 ‚Üí $2,000/month</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #dc2626; font-weight: 600;">üî® Setup Cost:</span>
              <span style="font-weight: 700; color: #dc2626;" id="upgradeOfficeSetupCost">$4,000</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #dc2626; font-weight: 600;">Monthly Cost Increase:</span>
              <span style="font-weight: 700; color: #dc2626;" id="upgradeOfficeCostIncrease">+$2,000/mo</span>
            </div>
          </div>
        </div>
        <div style="color: #6b7280; font-size: 0.9rem; margin-top: 1rem;">
          üí° The setup cost is paid immediately and covers moving expenses.
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideUpgradeOfficeModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmUpgradeOffice()" style="flex: 1; background: #10b981; border-color: #059669; color: white;">
          ‚¨ÜÔ∏è Confirm Upgrade
        </button>
      </div>
    </div>
  </div>

  <!-- Downgrade Office Confirmation Modal -->
  <div class="modal-overlay" id="downgradeOfficeModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">
        ‚¨áÔ∏è Downgrade Office
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="downgradeOfficeName">
          Startup Space ‚Üí Home Office
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">üë• Capacity:</span>
              <span style="font-weight: 600;" id="downgradeOfficeCapacity">10 ‚Üí 3 people</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">üí∞ Monthly Rent:</span>
              <span style="font-weight: 600;" id="downgradeOfficeRent">$2,000 ‚Üí $0/month</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Monthly Savings:</span>
              <span style="font-weight: 700; color: #10b981;" id="downgradeOfficeSavings">$2,000/mo</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Upfront Cost:</span>
              <span style="font-weight: 700; color: #10b981;">$0 (Free!)</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideDowngradeOfficeModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmDowngradeOffice()" style="flex: 1; background: #6b7280; border-color: #4b5563; color: white;">
          ‚¨áÔ∏è Confirm Downgrade
        </button>
      </div>
    </div>
  </div>

  <!-- Downgrade Server Confirmation Modal -->
  <div class="modal-overlay" id="downgradeServerModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">
        ‚¨áÔ∏è Downgrade Server
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="downgradeServerName">
          Standard Cloud ‚Üí Basic VPS
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">üìä Capacity:</span>
              <span style="font-weight: 600;" id="downgradeServerCapacity">5,000 ‚Üí 1,000 subs</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">üí∞ Monthly Fee:</span>
              <span style="font-weight: 600;" id="downgradeServerFee">$150 ‚Üí $50/month</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Monthly Savings:</span>
              <span style="font-weight: 700; color: #10b981;" id="downgradeServerSavings">$100/mo</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Upfront Cost:</span>
              <span style="font-weight: 700; color: #10b981;">$0 (Free!)</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideDowngradeServerModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmDowngradeServer()" style="flex: 1; background: #6b7280; border-color: #4b5563; color: white;">
          ‚¨áÔ∏è Confirm Downgrade
        </button>
      </div>
    </div>
  </div>

  <!-- New Game Setup Modal -->
  <div class="modal-overlay active" id="newGameModal">
    <div class="modal">
      <div class="modal-header">üöÄ Start Your Software Company</div>
      <div class="modal-body">
        <form id="newGameForm">
          <div class="form-group">
            <label style="margin-bottom: 0;">Company Name:</label>
            <div style="display: flex; gap: 0.4rem;">
              <input type="text" id="companyNameInput" value="TechVentures" required style="flex: 1;">
              <button type="button" class="btn btn-sm" onclick="document.getElementById('companyNameInput').value = generateRandomCompanyName();" style="padding: 0.5rem 0.8rem; font-size: 0.9rem;">üé≤</button>
            </div>
          </div>

          <div class="form-group">
            <label style="margin-bottom: 0;">Founder Name:</label>
            <div style="display: flex; gap: 0.4rem;">
              <input type="text" id="founderNameInput" value="Alex Chen" required style="flex: 1;">
              <button type="button" class="btn btn-sm" onclick="document.getElementById('founderNameInput').value = generateRandomFounderName();" style="padding: 0.5rem 0.8rem; font-size: 0.9rem;">üé≤</button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
            <!-- Currency Selection -->
            <div class="form-group" style="margin-bottom: 0;">
              <label>Currency:</label>
              <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.5rem; border: 2px solid #2563eb; background: #eff6ff; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="currency" value="USD" checked style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => {l.style.borderColor='#e5e7eb'; l.style.background='white';}); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <span style="font-weight: 500; font-size: 0.85rem;">USD ($)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="currency" value="EUR" style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => {l.style.borderColor='#e5e7eb'; l.style.background='white';}); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <span style="font-weight: 500; font-size: 0.85rem;">EUR (‚Ç¨)</span>
                </label>
              </div>
            </div>

            <!-- Starting Capital -->
            <div class="form-group" style="margin-bottom: 0;">
              <label>Starting Capital:</label>
              <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="capital" value="100000" style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => l.style.borderColor='#e5e7eb'); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.8rem;">$100k / ‚Ç¨100k</div>
                    <div style="font-size: 0.7rem; color: #6b7280;">Very Easy</div>
                  </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="capital" value="50000" style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => l.style.borderColor='#e5e7eb'); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.8rem;">$50k / ‚Ç¨50k</div>
                    <div style="font-size: 0.7rem; color: #6b7280;">Easy</div>
                  </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.5rem; border: 2px solid #2563eb; background: #eff6ff; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="capital" value="25000" checked style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => {l.style.borderColor='#e5e7eb'; l.style.background='white';}); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.8rem;">$25k / ‚Ç¨25k</div>
                    <div style="font-size: 0.7rem; color: #2563eb;">Normal ‚≠ê</div>
                  </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="capital" value="10000" style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => {l.style.borderColor='#e5e7eb'; l.style.background='white';}); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.8rem;">$10k / ‚Ç¨10k</div>
                    <div style="font-size: 0.7rem; color: #6b7280;">Hard</div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="startGameBtn" style="font-size: 1rem; padding: 0.6rem 1.5rem;">
          üöÄ Start My Company!
        </button>
      </div>
    </div>
  </div>

  <script>
    /* ============================================ */
    /* SOFTWARE COMPANY SIMULATOR - JAVASCRIPT */
    /* Version 2.0 | Phase 1-2: Core + Products */
    /* ============================================ */

    // ============================================
    // GAME STATE (Global Variables)
    // ============================================
    let currency = "USD";
    let currentDay = 0;
    let cash = 25000;
    let lifetimeEarnings = 0; // Track total earnings for unlock milestones
    let companyName = "My Startup";
    let isPlaying = false;
    let gameSpeed = 1;
    let tickTimer = null;

    let founder = {
      name: "Founder",
      efficiency: 1.0,
      skillLevel: 1,
      experiencePoints: 0,
      assignedProduct: null
    };

    let products = [];
    let developers = [];
    let marketers = [];
    let eventLog = [];
    
    // R&D System
    let rndProjects = []; // Active R&D projects (similar to products)
    let completedRndProjects = []; // IDs of completed R&D projects
    let unlockedProducts = ['Task Manager']; // Initially only Task Manager is unlocked
    let nextRndProjectId = 1;

    let currentServerTier = 0; // Shared Hosting (free)
    let currentOfficeTier = 0; // Home Office (no rent)
    
    let nextProductId = 1;
    
    // NEW: Candidate pool system - refreshed monthly based on milestones
    let candidatePool = {
      developers: [],     // Array of 4 developer candidates
      marketers: [],      // Array of 4 marketer candidates
      lastRefreshDay: 0   // Day when pool was last refreshed
    };
    
    // OLD: Legacy candidate system (will be replaced)
    let developerCandidates = {}; // { tierIndex: [candidate1, candidate2, candidate3, candidate4] }
    let marketerCandidates = {}; // { tierIndex: [candidate1, candidate2, candidate3, candidate4] }
    let lastCandidateRefresh = 0; // Track which month we last refreshed
    let candidateToHire = null; // Temporary storage for confirmation modal

    // ============================================
    // PRODUCT TEMPLATES (15 products)
    // ============================================
    const PRODUCT_TEMPLATES = [
      {
        name: "Task Manager",
        developmentEffort: 3,
        lifetimeMonths: 36,
        monthlyPriceUSD: 13,
        monthlyPriceEUR: 12,
        serverCostPerUser: 0.075,
        description: "Simple to-do list app"
      },
      {
        name: "Time Tracking App",
        developmentEffort: 4,
        lifetimeMonths: 48,
        monthlyPriceUSD: 20,
        monthlyPriceEUR: 19,
        serverCostPerUser: 0.09,
        description: "Employee time logging"
      },
      {
        name: "CRM Lite",
        developmentEffort: 6,
        lifetimeMonths: 72,
        monthlyPriceUSD: 34,
        monthlyPriceEUR: 32,
        serverCostPerUser: 0.15,
        description: "Basic CRM"
      },
      {
        name: "Email Marketing Tool",
        developmentEffort: 8,
        lifetimeMonths: 72,
        monthlyPriceUSD: 41,
        monthlyPriceEUR: 39,
        serverCostPerUser: 0.18,
        description: "Campaign management"
      },
      {
        name: "Analytics Dashboard",
        developmentEffort: 9,
        lifetimeMonths: 60,
        monthlyPriceUSD: 55,
        monthlyPriceEUR: 51,
        serverCostPerUser: 0.225,
        description: "Data viz tool"
      },
      {
        name: "Invoicing Software",
        developmentEffort: 5,
        lifetimeMonths: 84,
        monthlyPriceUSD: 27,
        monthlyPriceEUR: 25,
        serverCostPerUser: 0.12,
        description: "Billing & invoices"
      },
      {
        name: "Project Management Suite",
        developmentEffort: 18,
        lifetimeMonths: 84,
        monthlyPriceUSD: 69,
        monthlyPriceEUR: 64,
        serverCostPerUser: 0.3,
        description: "Full PM tool"
      },
      {
        name: "HR Management System",
        developmentEffort: 24,
        lifetimeMonths: 96,
        monthlyPriceUSD: 83,
        monthlyPriceEUR: 77,
        serverCostPerUser: 0.27,
        description: "Employee management"
      },
      {
        name: "E-commerce Platform",
        developmentEffort: 30,
        lifetimeMonths: 108,
        monthlyPriceUSD: 104,
        monthlyPriceEUR: 97,
        serverCostPerUser: 0.45,
        description: "Online store builder"
      },
      {
        name: "Video Conferencing Tool",
        developmentEffort: 36,
        lifetimeMonths: 72,
        monthlyPriceUSD: 125,
        monthlyPriceEUR: 116,
        serverCostPerUser: 0.525,
        description: "Remote meetings"
      },
      {
        name: "AI Chatbot",
        developmentEffort: 48,
        lifetimeMonths: 48,
        monthlyPriceUSD: 139,
        monthlyPriceEUR: 130,
        serverCostPerUser: 0.6,
        description: "Customer service bot"
      },
      {
        name: "ERP System",
        developmentEffort: 60,
        lifetimeMonths: 132,
        monthlyPriceUSD: 209,
        monthlyPriceEUR: 194,
        serverCostPerUser: 0.75,
        description: "Enterprise resource planning"
      },
      {
        name: "Social Media Manager",
        developmentEffort: 12,
        lifetimeMonths: 60,
        monthlyPriceUSD: 62,
        monthlyPriceEUR: 58,
        serverCostPerUser: 0.24,
        description: "Post scheduling & analytics"
      },
      {
        name: "Password Manager",
        developmentEffort: 7,
        lifetimeMonths: 72,
        monthlyPriceUSD: 34,
        monthlyPriceEUR: 32,
        serverCostPerUser: 0.135,
        description: "Secure credential vault"
      },
      {
        name: "Form Builder",
        developmentEffort: 5,
        lifetimeMonths: 48,
        monthlyPriceUSD: 25,
        monthlyPriceEUR: 22,
        serverCostPerUser: 0.105,
        description: "Drag-and-drop forms"
      }
    ];

    // ============================================
    // R&D PROJECT TEMPLATES
    // ============================================
    const RND_CATEGORIES = {
      GROWTH: 'growth',
      RETENTION: 'retention',
      EFFICIENCY: 'efficiency',
      UNLOCK: 'unlock'
    };

    const RND_PROJECTS = [
      // ORGANIC GROWTH STREET (Sequential)
      {
        id: 'growth_1',
        name: "SEO & Content Marketing",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 6, // 3 months * 2
        effect: { type: 'organic_growth', value: 0.05 },
        description: "Optimize for search engines and create valuable content",
        prerequisites: []
      },
      {
        id: 'growth_2',
        name: "Viral Referral System",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 12, // 6 months * 2
        effect: { type: 'organic_growth', value: 0.10 },
        description: "Implement gamified referrals and social sharing",
        prerequisites: ['growth_1']
      },
      {
        id: 'growth_3',
        name: "AI Growth Engine",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 24, // 12 months * 2
        effect: { type: 'organic_growth', value: 0.15 },
        description: "Predictive algorithms and automated personalization",
        prerequisites: ['growth_2']
      },
      
      // CHURN REDUCTION STREET (Sequential)
      {
        id: 'retention_1',
        name: "Customer Success Portal",
        category: RND_CATEGORIES.RETENTION,
        developmentEffort: 8, // 4 months * 2
        effect: { type: 'churn_reduction', value: 0.10 },
        description: "Self-service help center and onboarding guides",
        prerequisites: []
      },
      {
        id: 'retention_2',
        name: "Predictive Retention Analytics",
        category: RND_CATEGORIES.RETENTION,
        developmentEffort: 16, // 8 months * 2
        effect: { type: 'churn_reduction', value: 0.15 },
        description: "Identify at-risk customers before they leave",
        prerequisites: ['retention_1']
      },
      {
        id: 'retention_3',
        name: "Hyper-Personalization Engine",
        category: RND_CATEGORIES.RETENTION,
        developmentEffort: 24, // 12 months * 2
        effect: { type: 'churn_reduction', value: 0.20 },
        description: "AI-driven personalized experiences and proactive support",
        prerequisites: ['retention_2']
      },
      
      // EMPLOYEE EFFECTIVENESS STREET (Sequential)
      {
        id: 'efficiency_1',
        name: "Modern Dev Tools & CI/CD",
        category: RND_CATEGORIES.EFFICIENCY,
        developmentEffort: 6, // 3 months * 2
        effect: { type: 'employee_efficiency', value: 0.10 },
        description: "Automated testing, deployment pipelines, and modern IDEs",
        prerequisites: []
      },
      {
        id: 'efficiency_2',
        name: "Knowledge Management Platform",
        category: RND_CATEGORIES.EFFICIENCY,
        developmentEffort: 12, // 6 months * 2
        effect: { type: 'employee_efficiency', value: 0.15 },
        description: "Internal wiki, training resources, and best practices library",
        prerequisites: ['efficiency_1']
      },
      {
        id: 'efficiency_3',
        name: "AI Coding Assistant",
        category: RND_CATEGORIES.EFFICIENCY,
        developmentEffort: 20, // 10 months * 2
        effect: { type: 'employee_efficiency', value: 0.20 },
        description: "AI-powered code completion, debugging, and refactoring",
        prerequisites: ['efficiency_2']
      },
      
      // PRODUCT UNLOCK STREET (Sequential chain)
      {
        id: 'unlock_time_tracking',
        name: "Advanced Task Scheduling Research",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 4, // 2 months * 2
        effect: { type: 'unlock_product', value: 'Time Tracking App' },
        description: "Research advanced time tracking algorithms",
        prerequisites: []
      },
      {
        id: 'unlock_form_builder',
        name: "Dynamic Form Generation",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 4, // 2 months * 2
        effect: { type: 'unlock_product', value: 'Form Builder' },
        description: "Develop dynamic form rendering technology",
        prerequisites: ['unlock_time_tracking']
      },
      {
        id: 'unlock_invoicing',
        name: "Automated Billing Systems",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 6, // 3 months * 2
        effect: { type: 'unlock_product', value: 'Invoicing Software' },
        description: "Create automated billing and invoice generation",
        prerequisites: ['unlock_form_builder']
      },
      {
        id: 'unlock_crm',
        name: "Customer Relationship Modeling",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 8, // 4 months * 2
        effect: { type: 'unlock_product', value: 'CRM Lite' },
        description: "Design customer relationship database architecture",
        prerequisites: ['unlock_invoicing']
      },
      {
        id: 'unlock_password',
        name: "Encryption & Secure Storage",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 6, // 3 months * 2
        effect: { type: 'unlock_product', value: 'Password Manager' },
        description: "Research encryption and secure credential storage",
        prerequisites: ['unlock_crm']
      },
      {
        id: 'unlock_email_marketing',
        name: "Campaign Automation Engine",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 10, // 5 months * 2
        effect: { type: 'unlock_product', value: 'Email Marketing Tool' },
        description: "Build campaign automation and email delivery systems",
        prerequisites: ['unlock_password']
      },
      {
        id: 'unlock_analytics',
        name: "Data Visualization Framework",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 12, // 6 months * 2
        effect: { type: 'unlock_product', value: 'Analytics Dashboard' },
        description: "Create advanced data visualization libraries",
        prerequisites: ['unlock_email_marketing']
      },
      {
        id: 'unlock_social_media',
        name: "Social Media API Integration",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 12, // 6 months * 2
        effect: { type: 'unlock_product', value: 'Social Media Manager' },
        description: "Integrate with major social media platforms",
        prerequisites: ['unlock_analytics']
      },
      {
        id: 'unlock_project_mgmt',
        name: "Agile Workflow Architecture",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 16, // 8 months * 2
        effect: { type: 'unlock_product', value: 'Project Management Suite' },
        description: "Design agile project management workflows",
        prerequisites: ['unlock_social_media']
      },
      {
        id: 'unlock_hr',
        name: "Enterprise HR Systems",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 20, // 10 months * 2
        effect: { type: 'unlock_product', value: 'HR Management System' },
        description: "Build enterprise-grade HR management infrastructure",
        prerequisites: ['unlock_project_mgmt']
      },
      {
        id: 'unlock_ecommerce',
        name: "Payment Gateway & Shopping Cart",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 24, // 12 months * 2
        effect: { type: 'unlock_product', value: 'E-commerce Platform' },
        description: "Integrate payment processing and shopping cart",
        prerequisites: ['unlock_hr']
      },
      {
        id: 'unlock_video',
        name: "Real-time Video Streaming",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 30, // 15 months * 2
        effect: { type: 'unlock_product', value: 'Video Conferencing Tool' },
        description: "Develop real-time video and audio streaming technology",
        prerequisites: ['unlock_ecommerce']
      },
      {
        id: 'unlock_ai_chatbot',
        name: "Natural Language Processing",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 40, // 20 months * 2
        effect: { type: 'unlock_product', value: 'AI Chatbot' },
        description: "Research NLP and conversational AI",
        prerequisites: ['unlock_video']
      },
      {
        id: 'unlock_erp',
        name: "Enterprise Integration Framework",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 48, // 24 months * 2
        effect: { type: 'unlock_product', value: 'ERP System' },
        description: "Build enterprise resource planning integration framework",
        prerequisites: ['unlock_ai_chatbot']
      }
    ];

    // ============================================
    // HIRING MILESTONE SYSTEM
    // ============================================
    // Milestones based on lifetime earnings determine hiring pool quality
    const HIRING_MILESTONES = [
      { threshold: 0, name: "Startup", badge: "üå±", description: "Entry-Level Talent" },
      { threshold: 100000, name: "Small Business", badge: "üìà", description: "Growing Talent Pool" },
      { threshold: 500000, name: "Growing Company", badge: "üöÄ", description: "Quality Candidates" },
      { threshold: 2000000, name: "Established Company", badge: "üè¢", description: "Senior Talent Available" },
      { threshold: 10000000, name: "Major Player", badge: "‚≠ê", description: "Elite Talent Pool" }
    ];

    // Probability tables: [Junior%, Intermediate%, Senior%, Lead%, Expert%]
    const DEVELOPER_TIER_PROBABILITIES = {
      0:        [100, 0,  0,  0,  0],  // Startup: 100% Junior
      100000:   [70,  25, 5,  0,  0],  // Small Business: Mostly Junior, some Intermediate
      500000:   [40,  40, 15, 5,  0],  // Growing Company: Balanced mix
      2000000:  [20,  30, 30, 15, 5],  // Established: More Senior talent
      10000000: [5,   20, 35, 25, 15]  // Major Player: Mostly Senior/Lead/Expert
    };

    const MARKETER_TIER_PROBABILITIES = {
      0:        [100, 0,  0,  0,  0],  // Startup: 100% Junior
      100000:   [70,  25, 5,  0,  0],  // Small Business: Mostly Junior, some Intermediate
      500000:   [40,  40, 15, 5,  0],  // Growing Company: Balanced mix
      2000000:  [20,  30, 30, 15, 5],  // Established: More Senior talent
      10000000: [5,   20, 35, 25, 15]  // Major Player: Mostly Senior/Lead/Expert
    };

    // ============================================
    // EMPLOYEE & OFFICE TIERS (Phase 3)
    // ============================================
    // Employee progression: 100 months of work = 1.0x efficiency gain
    const EXPERIENCE_RATE = 0.01; // Efficiency gain per month of work
    
    const DEVELOPER_TIERS = [
      {
        name: "Junior Developer",
        skill: "junior",
        efficiency: 0.5,
        efficiencyCap: 1.0, // Promotes to Intermediate at 1.0x
        monthlySalaryUSD: 3000,
        monthlySalaryEUR: 2700
      },
      {
        name: "Intermediate Developer",
        skill: "intermediate",
        efficiency: 1.0,
        efficiencyCap: 1.5, // Promotes to Senior at 1.5x
        monthlySalaryUSD: 5000,
        monthlySalaryEUR: 4500
      },
      {
        name: "Senior Developer",
        skill: "senior",
        efficiency: 1.5,
        efficiencyCap: 2.0, // Promotes to Lead at 2.0x
        monthlySalaryUSD: 7000,
        monthlySalaryEUR: 6300
      },
      {
        name: "Lead Developer",
        skill: "lead",
        efficiency: 2.0,
        efficiencyCap: 3.0, // Promotes to Expert at 3.0x
        monthlySalaryUSD: 9000,
        monthlySalaryEUR: 8100
      },
      {
        name: "Expert Developer",
        skill: "expert",
        efficiency: 3.0,
        efficiencyCap: 5.0, // Max efficiency, no further promotion
        monthlySalaryUSD: 12000,
        monthlySalaryEUR: 10800
      }
    ];

    const MARKETER_TIERS = [
      {
        name: "Junior Marketer",
        skill: "junior",
        efficiency: 0.5,
        efficiencyCap: 1.0, // Promotes to Intermediate at 1.0x
        monthlySalaryUSD: 2500,
        monthlySalaryEUR: 2250
      },
      {
        name: "Intermediate Marketer",
        skill: "intermediate",
        efficiency: 1.0,
        efficiencyCap: 1.5, // Promotes to Senior at 1.5x
        monthlySalaryUSD: 4000,
        monthlySalaryEUR: 3600
      },
      {
        name: "Senior Marketer",
        skill: "senior",
        efficiency: 1.5,
        efficiencyCap: 2.0, // Promotes to Lead at 2.0x
        monthlySalaryUSD: 5500,
        monthlySalaryEUR: 4950
      },
      {
        name: "Lead Marketer",
        skill: "lead",
        efficiency: 2.0,
        efficiencyCap: 3.0, // Promotes to Expert at 3.0x
        monthlySalaryUSD: 7000,
        monthlySalaryEUR: 6300
      },
      {
        name: "Expert Marketer",
        skill: "expert",
        efficiency: 3.0,
        efficiencyCap: 5.0, // Max efficiency, no further promotion
        monthlySalaryUSD: 10000,
        monthlySalaryEUR: 9000
      }
    ];

    const OFFICE_TIERS = [
      {
        name: "Home Office",
        capacity: 3,
        monthlyRentUSD: 0,
        monthlyRentEUR: 0,
        utilitiesBaseUSD: 200,
        utilitiesBaseEUR: 180,
        utilitiesPerPersonUSD: 80,
        utilitiesPerPersonEUR: 72
      },
      {
        name: "Small Office",
        capacity: 8,
        monthlyRentUSD: 1500,
        monthlyRentEUR: 1350,
        utilitiesBaseUSD: 500,
        utilitiesBaseEUR: 450,
        utilitiesPerPersonUSD: 60,
        utilitiesPerPersonEUR: 54
      },
      {
        name: "Medium Office",
        capacity: 15,
        monthlyRentUSD: 4500,
        monthlyRentEUR: 4050,
        utilitiesBaseUSD: 1200,
        utilitiesBaseEUR: 1080,
        utilitiesPerPersonUSD: 50,
        utilitiesPerPersonEUR: 45
      },
      {
        name: "Large Office",
        capacity: 30,
        monthlyRentUSD: 15000,
        monthlyRentEUR: 13500,
        utilitiesBaseUSD: 2500,
        utilitiesBaseEUR: 2250,
        utilitiesPerPersonUSD: 40,
        utilitiesPerPersonEUR: 36
      },
      {
        name: "Enterprise HQ",
        capacity: 100,
        monthlyRentUSD: 60000,
        monthlyRentEUR: 54000,
        utilitiesBaseUSD: 10000,
        utilitiesBaseEUR: 9000,
        utilitiesPerPersonUSD: 30,
        utilitiesPerPersonEUR: 27
      }
    ];

    const SERVER_TIERS = [
      {
        name: "Shared Hosting",
        maxSubscribers: 100,
        monthlyFeeUSD: 10,      // Free tier
        monthlyFeeEUR: 9,
        upgradeCostUSD: 0,
        upgradeCostEUR: 0
      },
      {
        name: "VPS Basic",
        maxSubscribers: 500,
        monthlyFeeUSD: 100,
        monthlyFeeEUR: 90,
        upgradeCostUSD: 200,
        upgradeCostEUR: 180
      },
      {
        name: "VPS Standard",
        maxSubscribers: 2000,
        monthlyFeeUSD: 500,
        monthlyFeeEUR: 450,
        upgradeCostUSD: 800,
        upgradeCostEUR: 720
      },
      {
        name: "VPS Premium",
        maxSubscribers: 5000,
        monthlyFeeUSD: 1500,
        monthlyFeeEUR: 1350,
        upgradeCostUSD: 2000,
        upgradeCostEUR: 1800
      },
      {
        name: "Dedicated Server",
        maxSubscribers: 15000,
        monthlyFeeUSD: 6000,
        monthlyFeeEUR: 5400,
        upgradeCostUSD: 5000,
        upgradeCostEUR: 4500
      },
      {
        name: "Cloud Infrastructure",
        maxSubscribers: 50000,
        monthlyFeeUSD: 25000,
        monthlyFeeEUR: 22500,
        upgradeCostUSD: 15000,
        upgradeCostEUR: 13500
      },
      {
        name: "Enterprise Cloud",
        maxSubscribers: 999999, // Unlimited
        monthlyFeeUSD: 300000,
        monthlyFeeEUR: 270000,
        upgradeCostUSD: 0,       // No more upgrades
        upgradeCostEUR: 0
      }
    ];

    // ============================================
    // EMPLOYEE UNLOCK THRESHOLDS
    // ============================================
    const EMPLOYEE_UNLOCK_THRESHOLDS = {
      junior: 0,           // Always unlocked
      intermediate: 100000,
      senior: 500000,
      lead: 1000000,
      expert: 5000000
    };

    const FIRST_NAMES = [
      // English/Western names
      "Alex", "Jamie", "Jordan", "Taylor", "Morgan", "Casey", "Riley", "Avery", "Quinn", "Sage",
      "Emma", "Liam", "Olivia", "Noah", "Ava", "Ethan", "Sophia", "Mason", "Isabella", "William",
      "Mia", "James", "Charlotte", "Benjamin", "Amelia", "Lucas", "Harper", "Henry", "Evelyn", "Alexander",
      "Abigail", "Michael", "Emily", "Daniel", "Elizabeth", "Matthew", "Sofia", "David", "Ella", "Joseph",
      "Madison", "Samuel", "Scarlett", "Jackson", "Victoria", "Sebastian", "Aria", "Jack", "Grace", "Aiden",
      // Asian names (Chinese, Japanese, Korean, Indian, Vietnamese, Indonesian, Filipino)
      "Wei", "Ming", "Lei", "Jing", "Yan", "Yuki", "Haruto", "Hana", "Kenji", "Akira",
      "Sora", "Ji-ho", "Min-jun", "Seo-yeon", "Hye-jin", "Arjun", "Priya", "Rohan", "Ananya", "Aditya",
      "Kavya", "Linh", "Minh", "Tuan", "Hoa", "Budi", "Siti", "Adi", "Dewi", "Jose",
      // Turkish names
      "Emre", "Elif", "Ahmet", "Ay≈üe", "Mehmet", "Zeynep", "Can", "Deniz",
      // Middle Eastern/Arabic names
      "Omar", "Fatima", "Hassan", "Layla", "Ali", "Noor", "Yusuf", "Zara", "Karim", "Amina",
      // African names
      "Kwame", "Amara", "Kofi", "Zuri", "Chidi", "Nia", "Jabari", "Aisha", "Kwesi", "Abeni"
    ];

    const LAST_NAMES = [
      // English/Western surnames
      "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez",
      "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson", "Thomas", "Taylor", "Moore", "Jackson", "Martin",
      "Perez", "Thompson", "White", "Harris", "Sanchez", "Clark", "Ramirez", "Lewis", "Robinson",
      "Walker", "Young", "Allen", "King", "Wright", "Scott", "Torres", "Hill", "Flores",
      "Green", "Adams", "Nelson", "Baker", "Hall", "Rivera", "Campbell", "Mitchell", "Carter", "Roberts",
      // Asian surnames (Chinese, Japanese, Korean, Indian, Vietnamese, Indonesian, Filipino)
      "Wang", "Zhang", "Li", "Chen", "Liu", "Yang", "Huang", "Zhao", "Wu", "Zhou",
      "Tanaka", "Suzuki", "Yamamoto", "Sato", "Takahashi", "Nakamura", "Kobayashi", "Kim", "Park", "Lee",
      "Choi", "Jung", "Kang", "Shin", "Patel", "Kumar", "Singh", "Shah", "Sharma", "Reddy",
      "Gupta", "Tran", "Le", "Pham", "Hoang", "Nguyen", "Santoso", "Putra", "Wibowo", "Kusuma",
      "Santos", "Cruz", "Reyes", "Dela Cruz", "Aquino",
      // Turkish surnames
      "Yilmaz", "Kaya", "Demir", "√áelik", "Aydƒ±n", "√ñzdemir", "Arslan", "Ko√ß", "Yildiz",
      // Middle Eastern/Arabic surnames
      "Al-Farsi", "Hassan", "Abbas", "Mansour", "Khalil", "Rahman", "Al-Rashid", "Bin Laden", "Al-Saud",
      // African surnames
      "Okafor", "Mensah", "Diallo", "Mwangi", "Nkosi", "Kamau", "Adeyemi", "Okoro", "Banda", "Mbatha"
    ];

    const COMPANY_PREFIXES = [
      // Tech/Modern
      "Quantum", "Cyber", "Tech", "Digital", "Cloud", "Smart", "Innovative", "Next", "Future", "Apex",
      "Peak", "Prime", "Elite", "Stellar", "Zenith", "Nexus", "Vertex", "Pivot", "Spark", "Swift",
      "Agile", "Bright", "Clear", "Dynamic", "Epic", "Flash", "Global", "Hyper", "Infinite", "Kinetic",
      // Creative/Modern
      "Nova", "Pulse", "Echo", "Vibe", "Flux", "Aura", "Prism", "Surge", "Lumina", "Catalyst",
      "Horizon", "Velocity", "Momentum", "Aurora", "Cascade", "Fusion", "Helix", "Radiant", "Synapse", "Titanium",
      // Abstract/Professional
      "Alpha", "Beta", "Sigma", "Omega", "Zeta", "Vertex", "Vector", "Matrix", "Cipher", "Pixel",
      "Byte", "Synth", "Forge", "Atlas", "Orbit", "Pulse", "Node", "Edge", "Core", "Axis"
    ];

    const COMPANY_SUFFIXES = [
      // Classic Tech
      "Solutions", "Systems", "Technologies", "Software", "Labs", "Works", "Studios", "Ventures", "Innovations", "Digital",
      "Tech", "Apps", "Cloud", "Data", "AI", "Logic", "Dynamics", "Platform", "Services", "Group",
      "Media", "Networks", "Interactive", "Designs", "Development", "Engineering", "Products", "Analytics", "Hub", "Core",
      // Modern/Startup
      "Labs", "Studio", "Forge", "Factory", "Agency", "Collective", "Nexus", "Hub", "Space", "Labs",
      "Inc", "Corp", "Ltd", "Worldwide", "Partners", "Associates", "Consulting", "Strategies", "Intelligence", "Insights",
      // Trendy/Creative
      "House", "Club", "Guild", "Academy", "Institute", "Foundation", "Alliance", "Federation", "League", "Syndicate",
      "Frameworks", "Architects", "Builders", "Creators", "Makers", "Innovators", "Pioneers", "Disruptors", "Visionaries", "Explorers"
    ];

    let nextEmployeeId = 1;

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function formatCurrency(amount) {
      const rounded = Math.round(amount);
      const formatted = rounded.toLocaleString();
      return currency === "USD" ? `$${formatted}` : `‚Ç¨${formatted}`;
    }

    function logEvent(message) {
      const event = {
        day: currentDay,
        message: message
      };
      eventLog.unshift(event); // Add to beginning
      if (eventLog.length > 50) eventLog.pop(); // Keep last 50
      updateEventLog();
    }
    
    // ============================================
    // NOTIFICATION SYSTEM
    // ============================================
    
    function showNotification(message, type = 'success') {
      const container = document.getElementById('notificationContainer');
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // Set icon based on type
      let icon = '‚úÖ';
      if (type === 'success') icon = '‚úÖ';
      if (type === 'warning') icon = '‚ö†Ô∏è';
      if (type === 'error') icon = '‚ùå';
      
      notification.innerHTML = `
        <span class="notification-icon">${icon}</span>
        <span class="notification-text">${message}</span>
      `;
      
      // Add to container
      container.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function updateEventLog() {
      const container = document.getElementById('eventLog');
      const mobileContainer = document.getElementById('eventLogMobile');
      
      const logHTML = eventLog.slice(0, 20).map(e => 
        `<div class="event">Day ${e.day}: ${e.message}</div>`
      ).join('');
      
      container.innerHTML = logHTML;
      if (mobileContainer) {
        mobileContainer.innerHTML = logHTML;
      }
    }

    function updateCashDisplay() {
      const display = document.getElementById('cashDisplay');
      display.textContent = formatCurrency(cash);
      
      // Color coding
      display.className = 'cash-display';
      if (cash < 0) {
        display.classList.add('flashing-red');
      } else if (cash < 5000) {
        display.classList.add('red');
      } else if (cash < 20000) {
        display.classList.add('yellow');
      } else {
        display.classList.add('green');
      }
      
      // Calculate and display next billing cash flow
      const nextBillingInfo = document.getElementById('nextBillingInfo');
      const cashFlow = calculateNetCashFlow();
      const daysUntilBilling = currentDay === 0 ? 30 : (30 - (currentDay % 30));
      
      const flowClass = cashFlow >= 0 ? 'cash-flow-positive' : 'cash-flow-negative';
      const flowSign = cashFlow >= 0 ? '+' : '';
      
      nextBillingInfo.innerHTML = `<span class="${flowClass}">${flowSign}${formatCurrency(cashFlow)}</span>`;
    }

    function updateDayDisplay() {
      document.getElementById('dayCounter').textContent = currentDay;
      const year = Math.floor(currentDay / 360);
      const month = Math.floor((currentDay % 360) / 30);
      document.getElementById('yearMonth').textContent = `Year ${year}, Month ${month}`;
    }

    function updateFounderDisplay() {
      const xp = Math.floor(founder.experiencePoints);
      document.getElementById('founderLevel').textContent = founder.skillLevel;
      document.getElementById('founderXP').textContent = xp;
      
      // Update tooltip
      document.getElementById('founderName').textContent = founder.name;
      document.getElementById('tooltipLevel').textContent = founder.skillLevel;
      document.getElementById('tooltipEfficiency').textContent = Math.round(founder.efficiency * 100);
      document.getElementById('tooltipCurrentXP').textContent = xp;
      
      // Calculate XP needed for next level
      let nextLevelXP = 100;
      if (founder.skillLevel === 1) nextLevelXP = 100;
      else if (founder.skillLevel === 2) nextLevelXP = 250;
      else if (founder.skillLevel === 3) nextLevelXP = 500;
      else if (founder.skillLevel === 4) nextLevelXP = 1000;
      else nextLevelXP = 1000; // Max level
      
      document.getElementById('tooltipNextLevelXP').textContent = nextLevelXP;
      
      // Update current assignment
      const assignmentEl = document.getElementById('tooltipCurrentAssignment');
      if (founder.assignedProduct) {
        const product = products.find(p => p.id === founder.assignedProduct);
        if (product) {
          const isDeveloper = product.assignedDevelopers.includes('founder');
          const isMarketer = product.assignedMarketers.includes('founder');
          
          if (isDeveloper) {
            assignmentEl.textContent = `üë®‚Äçüíª Developing: ${product.name}`;
          } else if (isMarketer) {
            assignmentEl.textContent = `üì¢ Marketing: ${product.name}`;
          } else {
            assignmentEl.textContent = 'Not assigned';
          }
        } else {
          assignmentEl.textContent = 'Not assigned';
        }
      } else {
        assignmentEl.textContent = 'Not assigned';
      }
      
      const xpNeeded = Math.max(0, nextLevelXP - xp);
      document.getElementById('tooltipXPNeeded').textContent = xpNeeded;
      
      // Update progress bar
      const progressPercent = founder.skillLevel >= 5 ? 100 : Math.min(100, (xp / nextLevelXP) * 100);
      document.getElementById('xpProgressBar').style.width = progressPercent + '%';
    }

    // ============================================
    // PHASE 2: PRODUCT FUNCTIONS
    // ============================================
    function createProduct(template) {
      // Check if product with same name already exists and is not deprecated
      const existingProduct = products.find(p => p.name === template.name && p.status !== "deprecated");
      
      if (existingProduct) {
        const statusText = existingProduct.status === "in_development" ? "still in development" : "still active";
        logEvent(`‚ùå Cannot create "${template.name}" - one is ${statusText}. Wait for it to be deprecated first.`);
        return;
      }
      
      const product = {
        id: nextProductId++,
        name: template.name,
        developmentEffort: template.developmentEffort,
        currentProgress: 0,
        status: "in_development",
        createdAt: Date.now(), // Timestamp for sorting
        publishDate: null,
        lifetimeMonths: template.lifetimeMonths,
        remainingLifetimeMonths: template.lifetimeMonths,
        deprecationDate: null,
        monthlyPrice: currency === "USD" ? template.monthlyPriceUSD : template.monthlyPriceEUR,
        subscribers: 0,
        churnRate: 0.05,
        marketingMultiplier: 1.0,
        serverCostPerUser: template.serverCostPerUser,
        assignedDevelopers: [], // No auto-assignment
        assignedMarketers: []
      };
      
      products.push(product);
      
      logEvent(`üìã Created "${product.name}" - assign developers to start building!`);
      updateProductsUI();
    }
    
    function assignFounderToProduct(productId) {
      // Unassign founder from all products first (both dev and marketing)
      products.forEach(p => {
        const devIndex = p.assignedDevelopers.indexOf('founder');
        if (devIndex > -1) {
          p.assignedDevelopers.splice(devIndex, 1);
        }
        const mktIndex = p.assignedMarketers.indexOf('founder');
        if (mktIndex > -1) {
          p.assignedMarketers.splice(mktIndex, 1);
        }
      });
      
      // Assign to new product as developer
      const product = products.find(p => p.id === productId);
      if (product) {
        product.assignedDevelopers.push('founder');
        founder.assignedProduct = productId;
        logEvent(`üë®‚Äçüíº ${founder.name} assigned to develop "${product.name}"`);
      }
      
      updateProductsUI();
    }
    
    function assignFounderToProductAsMarketer(productId) {
      // Unassign founder from all products first (both dev and marketing)
      products.forEach(p => {
        const devIndex = p.assignedDevelopers.indexOf('founder');
        if (devIndex > -1) {
          p.assignedDevelopers.splice(devIndex, 1);
        }
        const mktIndex = p.assignedMarketers.indexOf('founder');
        if (mktIndex > -1) {
          p.assignedMarketers.splice(mktIndex, 1);
        }
      });
      
      // Assign to new product as marketer
      const product = products.find(p => p.id === productId);
      if (product) {
        product.assignedMarketers.push('founder');
        founder.assignedProduct = productId;
        logEvent(`üì¢ ${founder.name} assigned to market "${product.name}"`);
      }
      
      updateProductsUI();
    }
    
    function unassignFounderFromProduct(productId) {
      const product = products.find(p => p.id === productId);
      if (product) {
        // Check both developer and marketer assignments
        const devIndex = product.assignedDevelopers.indexOf('founder');
        const mktIndex = product.assignedMarketers.indexOf('founder');
        
        if (devIndex > -1) {
          product.assignedDevelopers.splice(devIndex, 1);
          founder.assignedProduct = null;
          logEvent(`üë®‚Äçüíº ${founder.name} unassigned from developing "${product.name}"`);
        } else if (mktIndex > -1) {
          product.assignedMarketers.splice(mktIndex, 1);
          founder.assignedProduct = null;
          logEvent(`üì¢ ${founder.name} unassigned from marketing "${product.name}"`);
        }
      }
      
      updateProductsUI();
    }
    
    function assignEmployeeToProduct(employeeId, productId) {
      const employee = [...developers, ...marketers].find(e => e.id === employeeId);
      const product = products.find(p => p.id === productId);
      
      if (!employee || !product) return;
      
      // Unassign from previous product
      if (employee.assignedProduct) {
        const oldProduct = products.find(p => p.id === employee.assignedProduct);
        if (oldProduct) {
          if (employee.role === 'developer') {
            const index = oldProduct.assignedDevelopers.indexOf(employeeId);
            if (index > -1) oldProduct.assignedDevelopers.splice(index, 1);
          } else {
            const index = oldProduct.assignedMarketers.indexOf(employeeId);
            if (index > -1) oldProduct.assignedMarketers.splice(index, 1);
          }
        }
      }
      
      // Assign to new product
      employee.assignedProduct = productId;
      if (employee.role === 'developer' && product.status === 'in_development') {
        product.assignedDevelopers.push(employeeId);
        logEvent(`üë®‚Äçüíª ${employee.name} assigned to develop "${product.name}"`);
      } else if (employee.role === 'marketer' && product.status === 'published') {
        product.assignedMarketers.push(employeeId);
        logEvent(`üì¢ ${employee.name} assigned to market "${product.name}"`);
      }
      
      updateProductsUI();
      updateEmployeesUI();
    }
    
    function unassignEmployeeFromProduct(employeeId) {
      const employee = [...developers, ...marketers].find(e => e.id === employeeId);
      if (!employee || !employee.assignedProduct) return;
      
      const product = products.find(p => p.id === employee.assignedProduct);
      if (product) {
        if (employee.role === 'developer') {
          const index = product.assignedDevelopers.indexOf(employeeId);
          if (index > -1) product.assignedDevelopers.splice(index, 1);
        } else {
          const index = product.assignedMarketers.indexOf(employeeId);
          if (index > -1) product.assignedMarketers.splice(index, 1);
        }
        logEvent(`${employee.role === 'developer' ? 'üë®‚Äçüíª' : 'üì¢'} ${employee.name} unassigned from "${product.name}"`);
      }
      
      employee.assignedProduct = null;
      updateProductsUI();
      updateEmployeesUI();
    }
    
    function updateProductDevelopment() {
      const effects = getRndEffects();
      const efficiencyMultiplier = 1 + effects.employeeEfficiency;
      
      products.forEach(product => {
        if (product.status === 'in_development') {
          let dailyProgress = 0;
          
          // Founder contribution
          if (product.assignedDevelopers.includes('founder')) {
            const contribution = (founder.efficiency / 30) * efficiencyMultiplier; // 1 month = 30 days
            dailyProgress += contribution;
            founder.experiencePoints += contribution * 10; // 10 XP per man-month
          }
          
          // Employee developer contributions
          product.assignedDevelopers.forEach(devId => {
            if (devId !== 'founder') {
              const developer = developers.find(d => d.id === devId);
              if (developer) {
                const contribution = (developer.efficiency / 30) * efficiencyMultiplier;
                dailyProgress += contribution;
              }
            }
          });
          
          product.currentProgress += dailyProgress;
          
          // Check if completed
          if (product.currentProgress >= product.developmentEffort) {
            publishProduct(product);
          }
        }
      });
      
      // Check for founder level up
      checkFounderLevelUp();
    }
    
    // ============================================
    // R&D SYSTEM
    // ============================================
    
    function getRndEffects() {
      const effects = {
        organicGrowth: 0,
        churnReduction: 0,
        employeeEfficiency: 0
      };
      
      completedRndProjects.forEach(projectId => {
        const project = RND_PROJECTS.find(p => p.id === projectId);
        if (project) {
          if (project.effect.type === 'organic_growth') {
            effects.organicGrowth += project.effect.value;
          } else if (project.effect.type === 'churn_reduction') {
            effects.churnReduction += project.effect.value;
          } else if (project.effect.type === 'employee_efficiency') {
            effects.employeeEfficiency += project.effect.value;
          }
        }
      });
      
      return effects;
    }
    
    function isProductUnlocked(productName) {
      return unlockedProducts.includes(productName);
    }
    
    function canStartRndProject(projectId) {
      const project = RND_PROJECTS.find(p => p.id === projectId);
      if (!project) return false;
      
      // Check if already completed
      if (completedRndProjects.includes(projectId)) return false;
      
      // Check if already in progress
      if (rndProjects.find(p => p.templateId === projectId)) return false;
      
      // Check prerequisites
      for (const prereqId of project.prerequisites) {
        if (!completedRndProjects.includes(prereqId)) {
          return false;
        }
      }
      
      return true;
    }
    
    function startRndProject(templateId) {
      const template = RND_PROJECTS.find(p => p.id === templateId);
      if (!template) {
        logEvent("‚ùå R&D project template not found");
        return;
      }
      
      if (!canStartRndProject(templateId)) {
        logEvent("‚ùå Prerequisites not met for this R&D project");
        return;
      }
      
      const newProject = {
        id: nextRndProjectId++,
        templateId: template.id,
        name: template.name,
        category: template.category,
        developmentEffort: template.developmentEffort,
        currentProgress: 0,
        assignedDevelopers: [],
        effect: template.effect,
        description: template.description
      };
      
      rndProjects.push(newProject);
      logEvent(`üî¨ Started R&D: ${newProject.name}`);
      updateRndUI();
    }
    
    function updateRndDevelopment() {
      const effects = getRndEffects();
      const efficiencyMultiplier = 1 + effects.employeeEfficiency;
      
      rndProjects.forEach(project => {
        let dailyProgress = 0;
        
        // Founder contribution
        if (project.assignedDevelopers.includes('founder')) {
          const contribution = (founder.efficiency / 30) * efficiencyMultiplier;
          dailyProgress += contribution;
          founder.experiencePoints += contribution * 10; // 10 XP per man-month
        }
        
        // Employee developer contributions
        project.assignedDevelopers.forEach(devId => {
          if (devId !== 'founder') {
            const developer = developers.find(d => d.id === devId);
            if (developer) {
              const contribution = (developer.efficiency / 30) * efficiencyMultiplier;
              dailyProgress += contribution;
            }
          }
        });
        
        project.currentProgress += dailyProgress;
        
        // Check if completed
        if (project.currentProgress >= project.developmentEffort) {
          completeRndProject(project);
        }
      });
    }
    
    function completeRndProject(project) {
      // Mark as completed
      completedRndProjects.push(project.templateId);
      
      // Apply effect
      if (project.effect.type === 'unlock_product') {
        unlockedProducts.push(project.effect.value);
        logEvent(`üéâ R&D Complete! Unlocked product: ${project.effect.value}`);
        showNotification(`üî¨ R&D Complete: ${project.name} - Unlocked ${project.effect.value}!`, 'success');
      } else if (project.effect.type === 'organic_growth') {
        const percentage = (project.effect.value * 100).toFixed(0);
        logEvent(`üéâ R&D Complete! Organic growth +${percentage}%`);
        showNotification(`üî¨ R&D Complete: ${project.name} - Organic growth +${percentage}%!`, 'success');
      } else if (project.effect.type === 'churn_reduction') {
        const percentage = (project.effect.value * 100).toFixed(0);
        logEvent(`üéâ R&D Complete! Churn reduction -${percentage}%`);
        showNotification(`üî¨ R&D Complete: ${project.name} - Churn reduction -${percentage}%!`, 'success');
      } else if (project.effect.type === 'employee_efficiency') {
        const percentage = (project.effect.value * 100).toFixed(0);
        logEvent(`üéâ R&D Complete! Employee efficiency +${percentage}%`);
        showNotification(`üî¨ R&D Complete: ${project.name} - Employee efficiency +${percentage}%!`, 'success');
      }
      
      // Remove from active projects
      const index = rndProjects.findIndex(p => p.id === project.id);
      if (index !== -1) {
        rndProjects.splice(index, 1);
      }
      
      updateRndUI();
    }
    
    function updateRndUI() {
      const container = document.getElementById('rndContainer');
      const effects = getRndEffects();
      
      // Build bonus display section
      let bonusHTML = '';
      const hasAnyBonus = effects.organicGrowth > 0 || effects.churnReduction > 0 || effects.employeeEfficiency > 0;
      
      if (hasAnyBonus) {
        bonusHTML += '<div style="margin-bottom: 0.75rem; padding: 0.5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">';
        bonusHTML += '<div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-bottom: 0.35rem;">üéØ R&D Bonuses</div>';
        bonusHTML += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
        
        if (effects.organicGrowth > 0) {
          bonusHTML += '<div style="display: flex; align-items: center; gap: 0.1rem; padding: 0.15rem 0.3rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">';
          bonusHTML += '<span style="font-size: 0.7rem;">üìà</span>';
          bonusHTML += '<span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">+' + (effects.organicGrowth * 100).toFixed(0) + '%</span>';
          bonusHTML += '<span style="font-size: 0.7rem; color: #6b7280;">growth</span>';
          bonusHTML += '</div>';
        }
        
        if (effects.churnReduction > 0) {
          bonusHTML += '<div style="display: flex; align-items: center; gap: 0.1rem; padding: 0.15rem 0.3rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">';
          bonusHTML += '<span style="font-size: 0.7rem;">üõ°Ô∏è</span>';
          bonusHTML += '<span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">-' + (effects.churnReduction * 100).toFixed(0) + '%</span>';
          bonusHTML += '<span style="font-size: 0.7rem; color: #6b7280;">churn</span>';
          bonusHTML += '</div>';
        }
        
        if (effects.employeeEfficiency > 0) {
          bonusHTML += '<div style="display: flex; align-items: center; gap: 0.1rem; padding: 0.15rem 0.3rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">';
          bonusHTML += '<span style="font-size: 0.7rem;">‚ö°</span>';
          bonusHTML += '<span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">+' + (effects.employeeEfficiency * 100).toFixed(0) + '%</span>';
          bonusHTML += '<span style="font-size: 0.7rem; color: #6b7280;">efficiency</span>';
          bonusHTML += '</div>';
        }
        
        bonusHTML += '</div>';
        bonusHTML += '</div>';
      }
      
      if (rndProjects.length === 0) {
        container.innerHTML = bonusHTML + '<div class="empty-state">No active R&D projects. Start researching!</div>';
        // Clear expanded states when no R&D projects
        Object.keys(expandedTeamSections).forEach(sectionId => {
          if (sectionId.startsWith('rnd-')) {
            delete expandedTeamSections[sectionId];
          }
        });
        return;
      }
      
      // Clean up expanded states for R&D projects that no longer exist
      const currentRndProjectIds = rndProjects.map(p => p.id);
      Object.keys(expandedTeamSections).forEach(sectionId => {
        // Only clean up R&D sections (format: 'rnd-X')
        if (sectionId.startsWith('rnd-')) {
          const projectId = parseInt(sectionId.split('-')[1]);
          if (!currentRndProjectIds.includes(projectId)) {
            delete expandedTeamSections[sectionId];
          }
        }
      });
      
      const efficiencyMultiplier = 1 + effects.employeeEfficiency;
      
      const projectsHTML = rndProjects.map(project => {
        const progress = (project.currentProgress / project.developmentEffort) * 100;
        const progressClamped = Math.min(progress, 100);
        
        // Get assigned developers
        const devCount = project.assignedDevelopers.length;
        
        // Effect display
        let effectText = '';
        if (project.effect.type === 'unlock_product') {
          effectText = `üîì Unlocks: ${project.effect.value}`;
        } else if (project.effect.type === 'organic_growth') {
          effectText = `üìà Organic Growth +${(project.effect.value * 100).toFixed(0)}%`;
        } else if (project.effect.type === 'churn_reduction') {
          effectText = `üõ°Ô∏è Churn Reduction -${(project.effect.value * 100).toFixed(0)}%`;
        } else if (project.effect.type === 'employee_efficiency') {
          effectText = `‚ö° Employee Efficiency +${(project.effect.value * 100).toFixed(0)}%`;
        }
        
        // Calculate total efficiency
        let totalEfficiency = 0;
        if (project.assignedDevelopers.includes('founder')) {
          totalEfficiency += founder.efficiency * efficiencyMultiplier;
        }
        project.assignedDevelopers.forEach(devId => {
          if (devId !== 'founder') {
            const developer = developers.find(d => d.id === devId);
            if (developer) {
              totalEfficiency += developer.efficiency * efficiencyMultiplier;
            }
          }
        });
        
        const daysLeft = totalEfficiency > 0 ? 
          Math.ceil((project.developmentEffort - project.currentProgress) / (totalEfficiency / 30)) : 
          '‚àû';
        
        let html = '<div class="product-card">';
        html += '<div class="product-header">';
        html += '<div class="product-name">üî¨ ' + project.name + '</div>';
        html += '<div class="product-status status-development">In Progress</div>';
        html += '</div>';
        html += '<div class="product-info">' + project.description + '</div>';
        html += '<div class="product-info">';
        html += '<strong>' + effectText + '</strong>';
        html += '</div>';
        html += '<div class="progress-bar">';
        html += '<div class="progress-fill" style="width: ' + progressClamped + '%">' + Math.round(progressClamped) + '%</div>';
        html += '</div>';
        html += '<div class="product-info">';
        html += '<strong>Progress:</strong> ' + project.currentProgress.toFixed(2) + ' / ' + project.developmentEffort + ' man-months<br>';
        
        // Show estimated completion or warning
        if (project.assignedDevelopers.length > 0) {
          html += '<strong>Est. completion:</strong> ' + (daysLeft === '‚àû' ? 'Never (no developers assigned!)' : '~' + daysLeft + ' days');
        } else {
          html += '<strong>‚ö†Ô∏è No developers assigned!</strong> Assign developers to start research.';
        }
        html += '</div>';
        
        // Assignment section - collapsible development team
        const rndSectionId = 'rnd-' + project.id;
        const isRndExpanded = expandedTeamSections[rndSectionId] === true;
        
        html += '<div style="margin-top: 0.5rem; padding: 0.4rem; background: #e5e5e5; border-radius: 4px;">';
        html += '<div class="team-section-header" onclick="toggleTeamSection(\'' + rndSectionId + '\')">';
        html += '<div class="team-section-title" style="color: #2563eb;">';
        html += '<span>üë®‚Äçüíª Development Team</span>';
        html += '<span class="team-count' + (devCount === 0 ? ' warning' : '') + '">(' + devCount + ')' + (devCount === 0 ? ' ‚ö†Ô∏è' : '') + '</span>';
        html += '</div>';
        html += '<span class="team-toggle' + (isRndExpanded ? ' expanded' : '') + '" id="toggle-' + rndSectionId + '">‚ñº</span>';
        html += '</div>';
        
        html += '<div class="team-section-content' + (isRndExpanded ? ' expanded' : '') + '" id="' + rndSectionId + '">';
        html += '<div style="display: flex; flex-direction: column; gap: 0.3rem; padding-top: 0.4rem;">';
        
        // Show assigned developers
        project.assignedDevelopers.forEach(devId => {
          if (devId === 'founder') {
            html += '<div class="assigned-person-card">';
            html += '<span class="person-role">üë§ ' + founder.name + ' (Founder)</span>';
            html += '<button class="unassign-btn" onclick="unassignFromRnd(' + project.id + ', \'founder\')">‚úï</button>';
            html += '</div>';
          } else {
            const dev = developers.find(d => d.id === devId);
            if (dev) {
              const skillLabel = dev.skill.charAt(0).toUpperCase() + dev.skill.slice(1);
              html += '<div class="assigned-person-card">';
              html += '<span class="person-role">' + dev.name + ' (' + skillLabel + ')</span>';
              html += '<button class="unassign-btn" onclick="unassignFromRnd(' + project.id + ', ' + devId + ')">‚úï</button>';
              html += '</div>';
            }
          }
        });
        
        // Add developer button
        html += '<button class="add-person-btn" onclick="showAssignToRndModal(' + project.id + ')">‚ûï Assign Developer</button>';
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        return html;
      }).join('');
      
      // Set container HTML with bonus section + projects
      container.innerHTML = bonusHTML + projectsHTML;
    }
    
    function showNewRndModal() {
      pauseGame(); // Auto-pause when opening modal
      const modal = document.getElementById('newRndModal');
      const list = document.getElementById('rndProjectsList');
      
      // Group projects by category, excluding completed ones
      const grouped = {
        [RND_CATEGORIES.GROWTH]: [],
        [RND_CATEGORIES.RETENTION]: [],
        [RND_CATEGORIES.EFFICIENCY]: [],
        [RND_CATEGORIES.UNLOCK]: []
      };
      
      RND_PROJECTS.forEach(project => {
        // Skip completed projects
        const isCompleted = completedRndProjects.includes(project.id);
        if (!isCompleted) {
          grouped[project.category].push(project);
        }
      });
      
      // Find first available project for default selection
      let firstAvailableId = null;
      for (const project of RND_PROJECTS) {
        const isCompleted = completedRndProjects.includes(project.id);
        if (!isCompleted && canStartRndProject(project.id)) {
          firstAvailableId = project.id;
          break;
        }
      }
      
      const categoryNames = {
        [RND_CATEGORIES.GROWTH]: 'üìà Organic Growth',
        [RND_CATEGORIES.RETENTION]: 'üõ°Ô∏è Churn Reduction',
        [RND_CATEGORIES.EFFICIENCY]: '‚ö° Employee Efficiency',
        [RND_CATEGORIES.UNLOCK]: 'üîì Product Unlocks'
      };
      
      list.innerHTML = Object.entries(grouped)
        .filter(([category, projects]) => projects.length > 0) // Only show categories with remaining projects
        .map(([category, projects]) => {
          const projectsHtml = projects.map(project => {
            const canStart = canStartRndProject(project.id);
            const isInProgress = rndProjects.find(p => p.templateId === project.id);
            
            let statusNote = '';
            let disabledClass = '';
            let disabled = '';
            
            if (isInProgress) {
              statusNote = '<div style="color: #3b82f6; font-size: 0.75rem; margin-top: 0.1rem;">üîÑ In Progress</div>';
              disabledClass = 'disabled';
              disabled = 'disabled';
            } else if (!canStart) {
              const prereqs = project.prerequisites.map(id => {
                const prereq = RND_PROJECTS.find(p => p.id === id);
                return prereq ? prereq.name : id;
              }).join(', ');
              statusNote = `<div style="color: #f59e0b; font-size: 0.75rem; margin-top: 0.1rem;">üîí Requires: ${prereqs}</div>`;
              disabledClass = 'disabled';
              disabled = 'disabled';
            }
            
            let effectText = '';
            if (project.effect.type === 'unlock_product') {
              effectText = `üîì Unlocks: ${project.effect.value}`;
            } else if (project.effect.type === 'organic_growth') {
              effectText = `+${(project.effect.value * 100).toFixed(0)}% growth`;
            } else if (project.effect.type === 'churn_reduction') {
              effectText = `-${(project.effect.value * 100).toFixed(0)}% churn`;
            } else if (project.effect.type === 'employee_efficiency') {
              effectText = `+${(project.effect.value * 100).toFixed(0)}% efficiency`;
            }
            
            return `
              <label class="product-template ${disabledClass}">
                <input type="radio" name="rndTemplate" value="${project.id}" ${project.id === firstAvailableId ? 'checked' : ''} ${disabled}>
                <div class="template-content">
                  <div class="template-name">${project.name}</div>
                  <div class="template-details">
                    <div class="template-detail">üìÖ ${project.developmentEffort} months</div>
                    <div class="template-detail">${effectText}</div>
                  </div>
                  <div class="template-description">${project.description}</div>
                  ${statusNote}
                </div>
              </label>
            `;
          }).join('');
          
          return `
            <div style="margin-bottom: 1rem;">
              <h3 style="margin-bottom: 0.5rem; font-size: 0.95rem; color: #374151;">${categoryNames[category]}</h3>
              ${projectsHtml}
            </div>
          `;
        }).join('');
      
      modal.classList.add('active');
    }
    
    function hideNewRndModal() {
      document.getElementById('newRndModal').classList.remove('active');
    }
    
    function handleCreateRndProject() {
      const selected = document.querySelector('input[name="rndTemplate"]:checked');
      if (!selected) {
        logEvent("‚ùå Please select an R&D project");
        return;
      }
      
      const projectId = selected.value;
      startRndProject(projectId);
      hideNewRndModal();
    }
    
    function showAssignToRndModal(projectId) {
      pauseGame(); // Auto-pause when opening modal
      const project = rndProjects.find(p => p.id === projectId);
      if (!project) return;
      
      const modal = document.getElementById('assignToRndModal');
      const list = document.getElementById('availableDevelopersForRnd');
      
      // Store current project ID for assignment
      modal.dataset.projectId = projectId;
      
      // Get available developers (not assigned to ANY project - product or R&D)
      const availableDevelopers = [];
      
      // Check if founder is available (not assigned to any product or R&D project)
      const founderAssignment = getFounderAssignment();
      if (!founderAssignment) {
        availableDevelopers.push({
          id: 'founder',
          name: founder.name,
          role: 'Founder',
          efficiency: founder.efficiency,
          assignment: null
        });
      }
      
      // Add employee developers (only if not assigned to ANY product or R&D project)
      developers.forEach(dev => {
        const devAssignment = getDevAssignment(dev.id);
        if (!devAssignment) {
          const skillLabel = dev.skill.charAt(0).toUpperCase() + dev.skill.slice(1);
          availableDevelopers.push({
            id: dev.id,
            name: dev.name,
            role: skillLabel,
            efficiency: dev.efficiency,
            assignment: null
          });
        }
      });
      
      if (availableDevelopers.length === 0) {
        list.innerHTML = '<div class="empty-state">No available developers. All developers are currently assigned to products or R&D projects. Unassign them first to reassign.</div>';
      } else {
        list.innerHTML = availableDevelopers.map(dev => {
          return `
            <div class="employee-card" onclick="assignToRnd(${projectId}, ${typeof dev.id === 'string' ? `'${dev.id}'` : dev.id})" style="cursor: pointer;">
              <div class="employee-header" style="margin-bottom: 0.4rem;">
                <span class="employee-name">${dev.name}</span>
                <span class="employee-role">${dev.role}</span>
              </div>
              <div class="employee-stats">
                <span>‚ö° Efficiency: ${Math.round(dev.efficiency * 100)}%</span>
              </div>
            </div>
          `;
        }).join('');
      }
      
      modal.classList.add('active');
    }
    
    function hideAssignToRndModal() {
      document.getElementById('assignToRndModal').classList.remove('active');
    }
    
    function assignToRnd(projectId, developerId) {
      const project = rndProjects.find(p => p.id === projectId);
      if (!project) return;
      
      if (!project.assignedDevelopers.includes(developerId)) {
        project.assignedDevelopers.push(developerId);
        
        const devName = developerId === 'founder' ? founder.name : developers.find(d => d.id === developerId)?.name;
        logEvent(`üë®‚Äçüíª ${devName} assigned to R&D: ${project.name}`);
      }
      
      hideAssignToRndModal();
      updateRndUI();
    }
    
    function unassignFromRnd(projectId, developerId) {
      const project = rndProjects.find(p => p.id === projectId);
      if (!project) return;
      
      const index = project.assignedDevelopers.indexOf(developerId);
      if (index !== -1) {
        project.assignedDevelopers.splice(index, 1);
        
        const devName = developerId === 'founder' ? founder.name : developers.find(d => d.id === developerId)?.name;
        logEvent(`‚Ü©Ô∏è ${devName} unassigned from R&D: ${project.name}`);
      }
      
      updateRndUI();
    }
    
    function getFounderAssignment() {
      // Check products
      for (const product of products) {
        if (product.assignedDevelopers?.includes('founder')) {
          return `${product.name} (Product)`;
        }
        if (product.assignedMarketers?.includes('founder')) {
          return `${product.name} (Marketing)`;
        }
      }
      // Check R&D
      for (const project of rndProjects) {
        if (project.assignedDevelopers.includes('founder')) {
          return `${project.name} (R&D)`;
        }
      }
      return null;
    }
    
    function getDevAssignment(devId) {
      // Check products
      for (const product of products) {
        if (product.assignedDevelopers?.includes(devId)) {
          return `${product.name}`;
        }
      }
      // Check R&D
      for (const project of rndProjects) {
        if (project.assignedDevelopers.includes(devId)) {
          return `${project.name} (R&D)`;
        }
      }
      return null;
    }
    
    function publishProduct(product) {
      product.status = 'published';
      product.publishDate = currentDay;
      product.currentProgress = product.developmentEffort; // Cap at 100%
      
      // Auto-unassign all developers (including founder) since development is complete
      if (product.assignedDevelopers.includes('founder')) {
        founder.assignedProduct = null;
        logEvent(`üë®‚Äçüíº ${founder.name} unassigned from development (product published)`);
      }
      product.assignedDevelopers = [];
      
      logEvent(`üéâ "${product.name}" published and ready for customers!`);
      showNotification(`üéâ ${product.name} published and ready for customers!`, 'success');
      updateProductsUI();
    }
    
    function checkProductLifecycles() {
      products.forEach(product => {
        if (product.status === 'published') {
          const monthsSincePublish = (currentDay - product.publishDate) / 30;
          product.remainingLifetimeMonths = product.lifetimeMonths - monthsSincePublish;
          
          if (product.remainingLifetimeMonths <= 0) {
            product.status = 'deprecated';
            product.deprecationDate = currentDay;
            product.remainingLifetimeMonths = 0;
            
            // Auto-unassign all marketers (including founder) since product is end-of-life
            if (product.assignedMarketers.includes('founder')) {
              founder.assignedProduct = null;
              logEvent(`üì¢ ${founder.name} unassigned from marketing (product deprecated)`);
            }
            product.assignedMarketers = [];
            
            logEvent(`‚ò†Ô∏è "${product.name}" is now deprecated (end of life)`);
            showNotification(`‚ò†Ô∏è ${product.name} is now deprecated (end of life)`, 'warning');
            updateProductsUI();
          }
        }
      });
    }
    
    function updateCustomerAcquisition() {
      // Check server capacity first
      const server = SERVER_TIERS[currentServerTier];
      const totalSubs = getTotalSubscribers();
      const availableCapacity = server.maxSubscribers - totalSubs;
      
      // Get R&D effects
      const effects = getRndEffects();
      const organicGrowthMultiplier = 1 + effects.organicGrowth;
      const churnReductionMultiplier = 1 - effects.churnReduction;
      
      products.forEach(product => {
        if (product.status === 'published') {
          let dailyGrowth = 0;
          
          // Organic growth (word of mouth, search, etc.)
          // Base: 0.5-1 subscribers per day + small bonus based on existing user base
          const organicBase = 0.5 + (Math.random() * 0.5); // 0.5 to 1.0 per day
          const wordOfMouthBonus = Math.sqrt(product.subscribers) * 0.01; // Scales slowly with subscriber count
          dailyGrowth += (organicBase + wordOfMouthBonus) * organicGrowthMultiplier;
          
          // Marketer contributions (much higher than organic)
          product.assignedMarketers.forEach(mktId => {
            if (mktId === 'founder') {
              // Founder as marketer
              dailyGrowth += 5 * founder.efficiency;
            } else {
              const marketer = marketers.find(m => m.id === mktId);
              if (marketer) {
                // Base growth: 5 subscribers per day per 1x marketer
                dailyGrowth += 5 * marketer.efficiency;
              }
            }
          });
          
          // Calculate potential growth
          const randomFactor = 0.8 + (Math.random() * 0.4); // 80%-120%
          const potentialGrowth = Math.max(1, Math.round(dailyGrowth * randomFactor));
          
          // Check server capacity before adding subscribers
          const currentTotalSubs = getTotalSubscribers();
          const actualGrowth = Math.min(potentialGrowth, server.maxSubscribers - currentTotalSubs);
          
          if (actualGrowth > 0) {
            product.subscribers += actualGrowth;
          } else if (potentialGrowth > 0 && actualGrowth === 0) {
            // Server is full, log once per day (only for first product that hits limit)
            const lastWarningDay = product.lastCapacityWarning || -999;
            if (currentDay > lastWarningDay) {
              logEvent(`‚ö†Ô∏è Server full! "${product.name}" cannot gain subscribers. Upgrade server!`);
              showNotification(`‚ö†Ô∏è Server capacity full! Upgrade server to gain more subscribers.`, 'warning');
              product.lastCapacityWarning = currentDay;
            }
          }
          
          // Normal churn for published products (much lower than deprecated)
          // Churn rate: 1-2% of subscribers leave per day
          if (product.subscribers > 10) { // Only apply churn if there are enough subscribers
            const baseChurnRate = 0.01 + (Math.random() * 0.01); // 1-2% daily churn
            const adjustedChurnRate = baseChurnRate * churnReductionMultiplier; // Apply R&D reduction
            const subscribersLost = Math.ceil(product.subscribers * adjustedChurnRate);
            product.subscribers = Math.max(0, product.subscribers - subscribersLost);
          }
        }
        
        // Deprecated products lose subscribers over time
        if (product.status === 'deprecated' && product.subscribers > 0) {
          // Churn rate: 10-15% of subscribers leave per day
          const churnRate = 0.10 + (Math.random() * 0.05); // 10-15% daily churn
          const subscribersLost = Math.max(1, Math.ceil(product.subscribers * churnRate));
          const previousSubscribers = product.subscribers;
          product.subscribers = Math.max(0, product.subscribers - subscribersLost);
          
          // Log when product fully dies (last subscriber leaves)
          if (previousSubscribers > 0 && product.subscribers === 0) {
            logEvent(`üíÄ "${product.name}" has lost all subscribers and is now hidden. You can create it again!`);
          }
        }
      });
    }
    
    function checkFounderLevelUp() {
      const xp = founder.experiencePoints;
      let newLevel = founder.skillLevel;
      let newEfficiency = founder.efficiency;
      
      if (xp >= 1000 && founder.skillLevel < 5) {
        newLevel = 5;
        newEfficiency = 1.5;
      } else if (xp >= 500 && founder.skillLevel < 4) {
        newLevel = 4;
        newEfficiency = 1.3;
      } else if (xp >= 250 && founder.skillLevel < 3) {
        newLevel = 3;
        newEfficiency = 1.2;
      } else if (xp >= 100 && founder.skillLevel < 2) {
        newLevel = 2;
        newEfficiency = 1.1;
      }
      
      if (newLevel > founder.skillLevel) {
        founder.skillLevel = newLevel;
        founder.efficiency = newEfficiency;
        logEvent(`üåü ${founder.name} leveled up to Level ${newLevel}! Efficiency: ${Math.round(newEfficiency * 100)}%`);
        updateFounderDisplay();
      }
    }
    
    function updateProductsUI() {
      const container = document.getElementById('productsContainer');
      
      // Get R&D effects for efficiency calculations
      const effects = getRndEffects();
      const efficiencyMultiplier = 1 + effects.employeeEfficiency;
      
      // Filter out deprecated products with 0 subscribers (they're done, hide them)
      const visibleProducts = products.filter(p => {
        return !(p.status === 'deprecated' && p.subscribers === 0);
      });
      
      // Sort by creation date descending (newest first)
      visibleProducts.sort((a, b) => {
        const aCreated = a.createdAt || 0; // Fallback for old saves without createdAt
        const bCreated = b.createdAt || 0;
        return bCreated - aCreated; // Descending order
      });
      
      if (visibleProducts.length === 0) {
        container.innerHTML = '<div class="empty-state">No products yet. Start building!</div>';
        // Clear expanded states when no products
        expandedTeamSections = {};
        return;
      }
      
      // Clean up expanded states for products that no longer exist
      const currentProductIds = visibleProducts.map(p => p.id);
      Object.keys(expandedTeamSections).forEach(sectionId => {
        // Only clean up product sections (dev- and mkt-), not R&D sections (rnd-)
        if (sectionId.startsWith('dev-') || sectionId.startsWith('mkt-')) {
          // Extract product ID from section ID (format: 'dev-1' or 'mkt-1')
          const productId = parseInt(sectionId.split('-')[1]);
          if (!currentProductIds.includes(productId)) {
            delete expandedTeamSections[sectionId];
          }
        }
      });
      
      container.innerHTML = visibleProducts.map(product => {
        let html = '<div class="product-card ' + product.status + '">';
        
        // Header
        html += '<div class="product-header">';
        html += '<div class="product-name">' + product.name + '</div>';
        html += '<div class="product-status status-' + (product.status === 'in_development' ? 'dev' : product.status) + '">';
        html += product.status === 'in_development' ? 'In Development' : 
                product.status === 'published' ? 'Live' : 'Deprecated';
        html += '</div>';
        html += '</div>';
        
        // In Development
        if (product.status === 'in_development') {
          const progress = Math.min(100, (product.currentProgress / product.developmentEffort) * 100);
          html += '<div class="progress-bar">';
          html += '<div class="progress-fill" style="width: ' + progress + '%">' + Math.round(progress) + '%</div>';
          html += '</div>';
          html += '<div class="product-info">';
          html += '<strong>Progress:</strong> ' + product.currentProgress.toFixed(2) + ' / ' + product.developmentEffort + ' man-months<br>';
          
          // Show assigned developers
          if (product.assignedDevelopers.length > 0) {
            html += '<strong>Assigned:</strong> ';
            const devNames = product.assignedDevelopers.map(id => {
              if (id === 'founder') return founder.name + ' (Founder)';
              const developer = developers.find(d => d.id === id);
              if (developer) {
                const skillLabel = developer.skill ? developer.skill.charAt(0).toUpperCase() + developer.skill.slice(1) : developer.tierName;
                return developer.name + ' (' + skillLabel + ')';
              }
              return 'Developer #' + id;
            });
            html += devNames.join(', ') + '<br>';
            
            // Calculate estimated completion with current team (including R&D efficiency bonus)
            let totalEfficiency = 0;
            if (product.assignedDevelopers.includes('founder')) {
              totalEfficiency += founder.efficiency * efficiencyMultiplier;
            }
            // Add hired developers' efficiency
            product.assignedDevelopers.forEach(devId => {
              if (devId !== 'founder') {
                const developer = developers.find(d => d.id === devId);
                if (developer) {
                  totalEfficiency += developer.efficiency * efficiencyMultiplier;
                }
              }
            });
            const daysLeft = totalEfficiency > 0 ? 
              Math.ceil((product.developmentEffort - product.currentProgress) / (totalEfficiency / 30)) : 
              '‚àû';
            html += '<strong>Est. completion:</strong> ' + (daysLeft === '‚àû' ? 'Never (no developers assigned!)' : '~' + daysLeft + ' days');
          } else {
            html += '<strong>‚ö†Ô∏è No developers assigned!</strong> Assign developers to start building.';
          }
          html += '</div>';
          
          // Assignment section - collapsible development team
          const devCount = product.assignedDevelopers.length;
          const devSectionId = 'dev-' + product.id;
          const isDevExpanded = expandedTeamSections[devSectionId] === true;
          
          html += '<div style="margin-top: 0.4rem; padding: 0.25rem; background: #e5e5e5; border-radius: 6px;">';
          html += '<div class="team-section-header" onclick="toggleTeamSection(\'' + devSectionId + '\')">';
          html += '<div class="team-section-title">';
          html += '<span>üë• Development Team</span>';
          html += '<span class="team-count' + (devCount === 0 ? ' warning' : '') + '">(' + devCount + ')' + (devCount === 0 ? ' ‚ö†Ô∏è' : '') + '</span>';
          html += '</div>';
          html += '<span class="team-toggle' + (isDevExpanded ? ' expanded' : '') + '" id="toggle-' + devSectionId + '">‚ñº</span>';
          html += '</div>';
          
          html += '<div class="team-section-content' + (isDevExpanded ? ' expanded' : '') + '" id="' + devSectionId + '">';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 0.4rem; padding-top: 0.4rem;">';
          
          // Show assigned developers only
          const founderAssigned = product.assignedDevelopers.includes('founder');
          if (founderAssigned) {
            html += '<div class="assigned-person-card">';
            html += '<span class="assigned-person-name">' + founder.name + ' <span class="person-role">(Founder)</span></span>';
            html += '<button class="unassign-btn" onclick="unassignFounderFromProduct(' + product.id + ')">‚úñ</button>';
            html += '</div>';
          }
          
          // Assigned developers
          product.assignedDevelopers.forEach(devId => {
            if (devId !== 'founder') {
              const dev = developers.find(d => d.id === devId);
              if (dev) {
                const skillLabel = dev.skill.charAt(0).toUpperCase() + dev.skill.slice(1);
                html += '<div class="assigned-person-card">';
                html += '<span class="assigned-person-name">' + dev.name + ' <span class="person-role">(' + skillLabel + ')</span></span>';
                html += '<button class="unassign-btn" onclick="unassignEmployeeFromProduct(' + dev.id + ')">‚úñ</button>';
                html += '</div>';
              }
            }
          });
          
          // Add developer button
          html += '<button class="add-person-btn" onclick="showAssignDeveloperModal(' + product.id + ')">‚ûï Add Developer</button>';
          
          html += '</div>';
          html += '</div>';
          html += '</div>';
        }
        
        // Published
        if (product.status === 'published') {
          const monthlyRevenue = product.subscribers * product.monthlyPrice;
          const monthlyServerCost = product.subscribers * product.serverCostPerUser;
          const monthlyNetRevenue = monthlyRevenue - monthlyServerCost;
          
          // Lifetime indicator calculation
          const monthsLeft = Math.round(product.remainingLifetimeMonths);
          let lifetimeClass = 'lifetime-green';
          if (monthsLeft < 6) lifetimeClass = 'lifetime-red';
          else if (monthsLeft < 12) lifetimeClass = 'lifetime-orange';
          else if (monthsLeft < 36) lifetimeClass = 'lifetime-yellow';
          
          const yearsLeft = Math.floor(monthsLeft / 12);
          const remainingMonths = monthsLeft % 12;
          let lifetimeText = '';
          if (yearsLeft > 0) lifetimeText = yearsLeft + ' year' + (yearsLeft > 1 ? 's' : '');
          if (remainingMonths > 0) {
            if (lifetimeText) lifetimeText += ', ';
            lifetimeText += remainingMonths + ' month' + (remainingMonths > 1 ? 's' : '');
          }
          
          // Horizontal layout: info on left (75%), lifetime on right (25%)
          html += '<div style="display: flex; gap: 0.5rem; align-items: flex-start;">';
          
          // Left side: Product info (75%)
          html += '<div class="product-info" style="flex: 7; margin-bottom: 0;">';
          html += '<strong>Subscribers:</strong> ' + product.subscribers + '<br>';
          html += '<strong>Monthly Revenue:</strong> ' + formatCurrency(monthlyNetRevenue) + ' <span style="font-size: 0.85rem; color: #6b7280;">(net)</span><br>';
          html += '<span style="color: #6b7280;">Revenue: ' + formatCurrency(monthlyRevenue) + ' - Server: ' + formatCurrency(monthlyServerCost) + '</span><br>';
          html += '<strong>Price:</strong> ' + formatCurrency(product.monthlyPrice) + '/mo per customer';
          html += '</div>';
          
          // Right side: Lifetime indicator (25%)
          html += '<div style="flex: 3; display: flex; justify-content: flex-end;">';
          html += '<div class="lifetime-indicator ' + lifetimeClass + '" style="text-align: center; word-wrap: break-word;">';
          html += '‚è≥ ' + lifetimeText + ' remaining';
          html += '</div>';
          html += '</div>';
          
          html += '</div>';
          
          // Marketer assignment - collapsible marketing team
          const mktCount = product.assignedMarketers.length;
          const mktSectionId = 'mkt-' + product.id;
          const isMktExpanded = expandedTeamSections[mktSectionId] === true;
          
          html += '<div style="margin-top: 0.4rem; padding: 0.25rem; background: #e5e5e5; border-radius: 6px;">';
          html += '<div class="team-section-header" onclick="toggleTeamSection(\'' + mktSectionId + '\')">';
          html += '<div class="team-section-title">';
          html += '<span>üì¢ Marketing Team</span>';
          html += '<span class="team-count' + (mktCount === 0 ? ' warning' : '') + '">(' + mktCount + ')' + (mktCount === 0 ? ' ‚ö†Ô∏è' : '') + '</span>';
          html += '</div>';
          html += '<span class="team-toggle' + (isMktExpanded ? ' expanded' : '') + '" id="toggle-' + mktSectionId + '">‚ñº</span>';
          html += '</div>';
          
          html += '<div class="team-section-content' + (isMktExpanded ? ' expanded' : '') + '" id="' + mktSectionId + '">';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 0.4rem; padding-top: 0.4rem;">';
          
          // Show assigned marketers only
          const founderAssignedAsMarketer = product.assignedMarketers.includes('founder');
          if (founderAssignedAsMarketer) {
            html += '<div class="assigned-person-card">';
            html += '<span class="assigned-person-name">' + founder.name + ' <span class="person-role">(Founder)</span></span>';
            html += '<button class="unassign-btn" onclick="unassignFounderFromProduct(' + product.id + ')">‚úñ</button>';
            html += '</div>';
          }
          
          // Assigned marketers
          product.assignedMarketers.forEach(mktId => {
            if (mktId !== 'founder') {
              const mkt = marketers.find(m => m.id === mktId);
              if (mkt) {
                const skillLabel = mkt.skill.charAt(0).toUpperCase() + mkt.skill.slice(1);
                html += '<div class="assigned-person-card">';
                html += '<span class="assigned-person-name">' + mkt.name + ' <span class="person-role">(' + skillLabel + ')</span></span>';
                html += '<button class="unassign-btn" onclick="unassignEmployeeFromProduct(' + mkt.id + ')">‚úñ</button>';
                html += '</div>';
              }
            }
          });
          
          // Add marketer button
          html += '<button class="add-person-btn" onclick="showAssignMarketerModal(' + product.id + ')">‚ûï Add Marketer</button>';
          
          html += '</div>';
          html += '</div>';
          html += '</div>';
        }
        
        // Deprecated
        if (product.status === 'deprecated') {
          const deprecatedRevenue = product.subscribers * product.monthlyPrice;
          const deprecatedServerCost = product.subscribers * product.serverCostPerUser;
          const deprecatedNetRevenue = deprecatedRevenue - deprecatedServerCost;
          
          html += '<div class="product-info">';
          html += '<strong>‚ö†Ô∏è END OF LIFE</strong><br>';
          html += 'Remaining subscribers: ' + product.subscribers + ' (declining fast)<br>';
          html += 'Revenue: ' + formatCurrency(deprecatedNetRevenue) + '/mo <span style="font-size: 0.85rem; color: #6b7280;">(net)</span>';
          html += '</div>';
        }
        
        html += '</div>';
        return html;
      }).join('');
      
      // No need to restore states - they're applied directly in HTML generation above
    }
    
    function showNewProductModal() {
      pauseGame(); // Auto-pause when opening modal
      const modal = document.getElementById('newProductModal');
      const list = document.getElementById('productTemplatesList');
      
      // Create sorted array of templates by development effort (ascending)
      const sortedTemplates = PRODUCT_TEMPLATES.map((template, originalIndex) => ({
        template,
        originalIndex
      })).sort((a, b) => a.template.developmentEffort - b.template.developmentEffort);
      
      // Find first available template index for default selection
      let firstAvailableIndex = -1;
      for (let i = 0; i < sortedTemplates.length; i++) {
        const template = sortedTemplates[i].template;
        const existing = products.find(p => p.name === template.name && p.status !== "deprecated");
        const unlocked = isProductUnlocked(template.name);
        if (!existing && unlocked) {
          firstAvailableIndex = sortedTemplates[i].originalIndex;
          break;
        }
      }
      
      // Render product templates (sorted by development effort)
      list.innerHTML = sortedTemplates.map(({template, originalIndex}) => {
        const price = currency === "USD" ? 
          `$${template.monthlyPriceUSD}/mo` : 
          `‚Ç¨${template.monthlyPriceEUR}/mo`;
        
        const years = Math.floor(template.lifetimeMonths / 12);
        const remainingMonths = template.lifetimeMonths % 12;
        const lifeDisplay = remainingMonths > 0 ? 
          `${years}y ${remainingMonths}m` : 
          `${years} years`;
        
        // Check if this product already exists and is not deprecated
        const existingProduct = products.find(p => p.name === template.name && p.status !== "deprecated");
        const unlocked = isProductUnlocked(template.name);
        const isDisabled = existingProduct !== undefined || !unlocked;
        const disabledClass = isDisabled ? 'disabled' : '';
        
        let statusNote = '';
        if (existingProduct) {
          statusNote = `<div style="color: #ef4444; font-size: 0.8rem; margin-top: 0.1rem;">‚ö†Ô∏è Already exists (${existingProduct.status === "in_development" ? "in development" : "active"})</div>`;
        } else if (!unlocked) {
          statusNote = `<div style="color: #f59e0b; font-size: 0.8rem; margin-top: 0.1rem;">üîí Locked - Complete R&D project to unlock</div>`;
        }
        
        return `
          <label class="product-template ${disabledClass}">
            <input type="radio" name="productTemplate" value="${originalIndex}" ${originalIndex === firstAvailableIndex ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
            <div class="template-content">
              <div class="template-name">${template.name}</div>
              <div class="template-details">
                <div class="template-detail">üìÖ ${template.developmentEffort} months dev</div>
                <div class="template-detail">‚è≥ ${lifeDisplay} life</div>
                <div class="template-detail">üí∞ ${price}</div>
                <div class="template-detail">üñ•Ô∏è ${template.serverCostPerUser}/user</div>
              </div>
              <div class="template-description">${template.description}</div>
              ${statusNote}
            </div>
          </label>
        `;
      }).join('');
      
      modal.classList.add('active');
    }
    
    function hideNewProductModal() {
      document.getElementById('newProductModal').classList.remove('active');
    }
    
    function handleCreateProduct() {
      const selectedIndex = parseInt(document.querySelector('input[name="productTemplate"]:checked').value);
      const template = PRODUCT_TEMPLATES[selectedIndex];
      
      createProduct(template);
      hideNewProductModal();
    }

    // ============================================
    // GAME LOOP
    // ============================================
    function startGame() {
      if (isPlaying) return;
      isPlaying = true;
      updateSpeedButtons();
      gameTick();
    }

    function pauseGame() {
      isPlaying = false;
      if (tickTimer) clearTimeout(tickTimer);
      updateSpeedButtons();
    }

    function setGameSpeed(speed) {
      gameSpeed = speed;
      updateSpeedButtons();
      if (isPlaying) {
        // Restart with new speed
        pauseGame();
        startGame();
      }
    }

    function updateSpeedButtons() {
      document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
      if (!isPlaying) {
        document.getElementById('pauseBtn').classList.add('active');
      } else {
        if (gameSpeed === 1) document.getElementById('playBtn').classList.add('active');
        else if (gameSpeed === 2) document.getElementById('speed2xBtn').classList.add('active');
        else if (gameSpeed === 5) document.getElementById('speed5xBtn').classList.add('active');
      }
    }

    function gameTick() {
      currentDay++;
      updateDayDisplay();
      updateCashDisplay();

      // R&D Development
      updateRndDevelopment();

      // Phase 2: Product development
      updateProductDevelopment();
      
      // Check product lifecycles daily
      checkProductLifecycles();
      
      // Phase 3: Customer acquisition (daily)
      updateCustomerAcquisition();
      
      // Update employee experience and check for promotions
      updateEmployeeExperience();
      
      // Check if candidate pool needs refresh (every 30 days)
      refreshCandidatePoolIfNeeded();
      
      // Phase 3: Monthly billing (every 30 days)
      if (currentDay % 30 === 0) {
        handleMonthlyBilling();
      }
      
      // Update UI
      updateFounderDisplay();
      updateProductsUI();
      updateRndUI();
      updateEmployeesUI();
      updateFinancesUI();
      
      // Update hiring modals if they're open
      refreshOpenHiringModals();
      
      // Auto-save every 10 days
      if (currentDay % 10 === 0 && currentDay > 0) {
        saveGame();
      }
      
      // Check game over
      if (cash < 0) {
        pauseGame();
        logEvent("üíÄ GAME OVER! Company bankrupt!");
        showGameOver();
      }

      // Schedule next tick
      if (isPlaying) {
        tickTimer = setTimeout(gameTick, 1000 / gameSpeed);
      }
    }

    // ============================================
    // EMPLOYEE MANAGEMENT (Phase 3)
    // ============================================
    
    function generateEmployeeName() {
      const firstName = FIRST_NAMES[Math.floor(Math.random() * FIRST_NAMES.length)];
      const lastName = LAST_NAMES[Math.floor(Math.random() * LAST_NAMES.length)];
      return `${firstName} ${lastName}`;
    }
    
    function getCurrentTeamSize() {
      return 1 + developers.length + marketers.length; // 1 for founder
    }
    
    function getOfficeCapacity() {
      return OFFICE_TIERS[currentOfficeTier].capacity;
    }
    
    function canHireMoreEmployees() {
      return getCurrentTeamSize() < getOfficeCapacity();
    }
    
    // ============================================
    // HIRING MILESTONE & CANDIDATE POOL SYSTEM
    // ============================================
    
    function getCurrentMilestone() {
      // Find the highest milestone threshold reached based on lifetime earnings
      let currentMilestone = HIRING_MILESTONES[0];
      for (const milestone of HIRING_MILESTONES) {
        if (lifetimeEarnings >= milestone.threshold) {
          currentMilestone = milestone;
        } else {
          break;
        }
      }
      return currentMilestone;
    }
    
    function getNextMilestone() {
      const current = getCurrentMilestone();
      const currentIndex = HIRING_MILESTONES.findIndex(m => m.threshold === current.threshold);
      if (currentIndex < HIRING_MILESTONES.length - 1) {
        return HIRING_MILESTONES[currentIndex + 1];
      }
      return null; // Already at max milestone
    }
    
    function selectTierByProbability(probabilities) {
      // probabilities = [70, 25, 5, 0, 0] for example
      // Returns tier index (0-4 for Junior to Expert)
      const random = Math.random() * 100;
      let cumulative = 0;
      
      for (let i = 0; i < probabilities.length; i++) {
        cumulative += probabilities[i];
        if (random <= cumulative) {
          return i; // Returns 0-4 (tier index in DEVELOPER_TIERS/MARKETER_TIERS)
        }
      }
      
      return 0; // Default to Junior (index 0) if something goes wrong
    }
    
    function generateCandidate(type) {
      // type: "developer" or "marketer"
      
      // Get current milestone
      const milestone = getCurrentMilestone();
      
      // Get probability distribution for this milestone
      const probabilities = type === "developer" 
        ? DEVELOPER_TIER_PROBABILITIES[milestone.threshold]
        : MARKETER_TIER_PROBABILITIES[milestone.threshold];
      
      // Randomly select tier based on probabilities
      const tierIndex = selectTierByProbability(probabilities);
      const tier = type === "developer" ? DEVELOPER_TIERS[tierIndex] : MARKETER_TIERS[tierIndex];
      
      // Apply ¬±20% fluctuation to efficiency
      const baseEfficiency = tier.efficiency;
      const efficiency = generateRandomEfficiency(baseEfficiency);
      
      // Apply ¬±20% fluctuation to salary
      const baseSalary = currency === "USD" ? tier.monthlySalaryUSD : tier.monthlySalaryEUR;
      const salaryVariation = 0.8 + (Math.random() * 0.4); // 0.8 to 1.2 (¬±20%)
      const monthlySalary = Math.round(baseSalary * salaryVariation);
      
      // Generate candidate
      return {
        id: nextEmployeeId++,
        name: generateEmployeeName(),
        role: type,
        tier: tierIndex,
        tierName: tier.name,
        skill: tier.skill,
        efficiency: efficiency,
        monthlySalary: monthlySalary,
        assignedProduct: null
      };
    }
    
    function generateCandidatePool() {
      // Generate 4 developers
      candidatePool.developers = [];
      for (let i = 0; i < 4; i++) {
        candidatePool.developers.push(generateCandidate("developer"));
      }
      
      // Generate 4 marketers
      candidatePool.marketers = [];
      for (let i = 0; i < 4; i++) {
        candidatePool.marketers.push(generateCandidate("marketer"));
      }
      
      candidatePool.lastRefreshDay = currentDay;
      
      const milestone = getCurrentMilestone();
      logEvent(`üîÑ Hiring pool refreshed! ${milestone.badge} ${milestone.description}`);
    }
    
    function refreshCandidatePoolIfNeeded() {
      // Refresh every 30 days (monthly)
      if (currentDay % 30 === 0 && currentDay > 0) {
        generateCandidatePool();
        
        // If hiring modals are open, refresh them with new candidates
        refreshOpenHiringModals();
      }
    }
    
    function refreshOpenHiringModals() {
      // Check if developer hiring modal is open and refresh it
      const devModal = document.getElementById('hireDeveloperModal');
      if (devModal && devModal.classList.contains('active')) {
        updateHireDeveloperModalContent();
      }
      
      // Check if marketer hiring modal is open and refresh it
      const mktModal = document.getElementById('hireMarketerModal');
      if (mktModal && mktModal.classList.contains('active')) {
        updateHireMarketerModalContent();
      }
    }
    
    function checkMilestoneAchievement(previousEarnings, newEarnings) {
      const previousMilestone = HIRING_MILESTONES.find(m => previousEarnings >= m.threshold && (HIRING_MILESTONES[HIRING_MILESTONES.indexOf(m) + 1]?.threshold > previousEarnings || HIRING_MILESTONES.indexOf(m) === HIRING_MILESTONES.length - 1));
      const newMilestone = getCurrentMilestone();
      
      if (previousMilestone && newMilestone.threshold > previousMilestone.threshold) {
        logEvent(`üéâ Milestone achieved: ${newMilestone.name}!`);
        logEvent(`‚ú® Your company's reputation has improved - better talent will apply!`);
        
        // Show visual notification
        showMilestoneNotification(newMilestone);
        
        // Immediately refresh candidate pool with new probabilities
        generateCandidatePool();
      }
    }
    
    // Show milestone achievement notification
    function showMilestoneNotification(milestone) {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = 'milestone-notification';
      notification.innerHTML = `
        <h3>üéâ Milestone Achieved!</h3>
        <p><strong>${milestone.name}</strong></p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">Your company's reputation has improved!<br>Better talent will now apply for positions.</p>
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 4 seconds
      setTimeout(() => {
        notification.style.animation = 'milestoneAppear 0.3s ease-out reverse';
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 4000);
    }
    
    // ============================================
    // FINANCES CALCULATIONS
    // ============================================
    
    function calculateMonthlyIncome() {
      let totalRevenue = 0;
      let totalServerCost = 0;
      
      products.forEach(product => {
        if (product.status === 'published' || product.status === 'deprecated') {
          totalRevenue += product.subscribers * product.monthlyPrice;
          totalServerCost += product.subscribers * product.serverCostPerUser;
        }
      });
      
      return {
        grossRevenue: totalRevenue,
        serverCost: totalServerCost,
        netIncome: totalRevenue - totalServerCost
      };
    }
    
    function calculateMonthlyCosts() {
      const office = OFFICE_TIERS[currentOfficeTier];
      const teamSize = getCurrentTeamSize();
      
      const rent = currency === "USD" ? office.monthlyRentUSD : office.monthlyRentEUR;
      const utilitiesBase = currency === "USD" ? office.utilitiesBaseUSD : office.utilitiesBaseEUR;
      const utilitiesPerPerson = currency === "USD" ? office.utilitiesPerPersonUSD : office.utilitiesPerPersonEUR;
      const utilities = utilitiesBase + (utilitiesPerPerson * teamSize);
      
      // Insurance: 2% of gross revenue + base per employee
      const income = calculateMonthlyIncome();
      const insuranceBase = currency === "USD" ? 100 : 90;
      const insurance = (income.grossRevenue * 0.02) + (insuranceBase * (developers.length + marketers.length));
      
      // Salaries
      const salaries = [...developers, ...marketers].reduce((sum, emp) => sum + emp.monthlySalary, 0);
      
      // Server hosting fee (fixed monthly cost for tier)
      const server = SERVER_TIERS[currentServerTier];
      const serverFee = currency === "USD" ? server.monthlyFeeUSD : server.monthlyFeeEUR;
      
      return {
        rent: rent,
        utilities: utilities,
        insurance: insurance,
        salaries: salaries,
        serverFee: serverFee,
        total: rent + utilities + insurance + salaries + serverFee
      };
    }
    
    function calculateNetCashFlow() {
      const income = calculateMonthlyIncome();
      const costs = calculateMonthlyCosts();
      return income.netIncome - costs.total;
    }
    
    function calculateBurnRate() {
      const cashFlow = calculateNetCashFlow();
      if (cashFlow >= 0) return Infinity; // Profitable, no burn
      
      const monthlyBurn = Math.abs(cashFlow);
      if (monthlyBurn === 0) return Infinity;
      
      return Math.floor(cash / monthlyBurn);
    }
    
    function getTotalSubscribers() {
      return products.reduce((sum, p) => {
        if (p.status === 'published' || p.status === 'deprecated') {
          return sum + p.subscribers;
        }
        return sum;
      }, 0);
    }
    
    function getServerCapacityPercentage() {
      const server = SERVER_TIERS[currentServerTier];
      const totalSubs = getTotalSubscribers();
      return Math.min(100, Math.round((totalSubs / server.maxSubscribers) * 100));
    }
    
    function canUpgradeServer() {
      if (currentServerTier >= SERVER_TIERS.length - 1) return false;
      const nextTier = SERVER_TIERS[currentServerTier + 1];
      const cost = currency === "USD" ? nextTier.upgradeCostUSD : nextTier.upgradeCostEUR;
      return cash >= cost;
    }
    
    function upgradeServer() {
      if (!canUpgradeServer()) return;
      
      const nextTier = SERVER_TIERS[currentServerTier + 1];
      const cost = currency === "USD" ? nextTier.upgradeCostUSD : nextTier.upgradeCostEUR;
      
      cash -= cost;
      currentServerTier++;
      
      logEvent(`üñ•Ô∏è Server upgraded to ${nextTier.name}!`);
      logEvent(`  üìä Capacity: ${SERVER_TIERS[currentServerTier - 1].maxSubscribers} ‚Üí ${nextTier.maxSubscribers} subscribers`);
      logEvent(`  üí∞ Monthly Fee: ${formatCurrency(currency === "USD" ? SERVER_TIERS[currentServerTier - 1].monthlyFeeUSD : SERVER_TIERS[currentServerTier - 1].monthlyFeeEUR)} ‚Üí ${formatCurrency(currency === "USD" ? nextTier.monthlyFeeUSD : nextTier.monthlyFeeEUR)}/month`);
      logEvent(`  üî® Upgrade Cost Paid: ${formatCurrency(cost)}`);
      
      updateCashDisplay();
      updateFinancesUI();
    }
    
    function canDowngradeServer() {
      if (currentServerTier <= 0) return false;
      const prevTier = SERVER_TIERS[currentServerTier - 1];
      const totalSubs = getTotalSubscribers();
      return totalSubs <= prevTier.maxSubscribers;
    }
    
    function downgradeServer() {
      pauseGame(); // Auto-pause when opening modal
      if (!canDowngradeServer()) {
        const prevTier = SERVER_TIERS[currentServerTier - 1];
        const totalSubs = getTotalSubscribers();
        alert(`‚ùå Cannot downgrade!\n\nYou have ${totalSubs.toLocaleString()} subscribers but ${prevTier.name} only supports ${prevTier.maxSubscribers.toLocaleString()}.\n\nReduce subscriber count first (wait for churn or deprecate products).`);
        startGame(); // Auto-resume after alert
        return;
      }
      
      const currentTier = SERVER_TIERS[currentServerTier];
      const prevTier = SERVER_TIERS[currentServerTier - 1];
      const oldFee = currency === "USD" ? currentTier.monthlyFeeUSD : currentTier.monthlyFeeEUR;
      const newFee = currency === "USD" ? prevTier.monthlyFeeUSD : prevTier.monthlyFeeEUR;
      const savings = oldFee - newFee;
      
      // Show modal instead of confirm
      document.getElementById('downgradeServerName').textContent = `${currentTier.name} ‚Üí ${prevTier.name}`;
      document.getElementById('downgradeServerCapacity').textContent = `${currentTier.maxSubscribers.toLocaleString()} ‚Üí ${prevTier.maxSubscribers.toLocaleString()} subscribers`;
      document.getElementById('downgradeServerFee').textContent = `${formatCurrency(oldFee)} ‚Üí ${formatCurrency(newFee)}/month`;
      document.getElementById('downgradeServerSavings').textContent = `${formatCurrency(savings)}/mo`;
      document.getElementById('downgradeServerModal').classList.add('active');
    }
    
    function hideDowngradeServerModal() {
      document.getElementById('downgradeServerModal').classList.remove('active');
      startGame(); // Auto-resume when closing modal
    }
    
    function confirmDowngradeServer() {
      const currentTier = SERVER_TIERS[currentServerTier];
      const prevTier = SERVER_TIERS[currentServerTier - 1];
      const oldFee = currency === "USD" ? currentTier.monthlyFeeUSD : currentTier.monthlyFeeEUR;
      const newFee = currency === "USD" ? prevTier.monthlyFeeUSD : prevTier.monthlyFeeEUR;
      const savings = oldFee - newFee;
      
      currentServerTier--;
      
      logEvent(`üìâ Server downgraded to ${prevTier.name}`);
      logEvent(`  üìä Capacity: ${currentTier.maxSubscribers.toLocaleString()} ‚Üí ${prevTier.maxSubscribers.toLocaleString()} subscribers`);
      logEvent(`  üí∞ Monthly Fee Reduced: ${formatCurrency(oldFee)} ‚Üí ${formatCurrency(newFee)}/month (saves ${formatCurrency(savings)}/mo)`);
      
      hideDowngradeServerModal();
      updateFinancesUI();
    }
    
    // ============================================
    // CANDIDATE POOL SYSTEM
    // ============================================
    
    function generateRandomEfficiency(baseEfficiency) {
      // ¬±20% deviation (40% total range)
      const minEfficiency = baseEfficiency * 0.8;
      const maxEfficiency = baseEfficiency * 1.2;
      const randomEfficiency = minEfficiency + Math.random() * (maxEfficiency - minEfficiency);
      return Math.round(randomEfficiency * 100) / 100; // Round to 2 decimals
    }
    
    function generateCandidateForTier(tierIndex, role) {
      const tier = role === 'developer' ? DEVELOPER_TIERS[tierIndex] : MARKETER_TIERS[tierIndex];
      const efficiency = generateRandomEfficiency(tier.efficiency);
      
      // Calculate salary based on absolute efficiency value
      // Use the 1.0x efficiency tier as the base reference ($5,000 for devs, $4,000 for marketers)
      const tiers = role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
      const baseReferenceSalary = currency === "USD" ? tiers[1].monthlySalaryUSD : tiers[1].monthlySalaryEUR; // Intermediate tier (1.0x)
      
      // Salary = Base Reference Salary √ó Actual Efficiency √ó ¬±10% random variation
      const baseSalary = baseReferenceSalary * efficiency;
      
      // Add ¬±10% random variation to salary (total 20% range)
      const salaryVariation = 0.90 + (Math.random() * 0.20); // 0.90 to 1.10
      const finalSalary = Math.round(baseSalary * salaryVariation);
      
      return {
        id: Math.random().toString(36).substr(2, 9), // Unique ID for this candidate
        name: generateEmployeeName(),
        role: role,
        tier: tierIndex,
        tierName: tier.name,
        skill: tier.skill,
        efficiency: efficiency,
        monthlySalary: finalSalary
      };
    }
    
    function refreshCandidatePools() {
      // Generate 4 candidates for each developer tier
      developerCandidates = {};
      for (let i = 0; i < DEVELOPER_TIERS.length; i++) {
        developerCandidates[i] = [];
        for (let j = 0; j < 4; j++) {
          developerCandidates[i].push(generateCandidateForTier(i, 'developer'));
        }
      }
      
      // Generate 4 candidates for each marketer tier
      marketerCandidates = {};
      for (let i = 0; i < MARKETER_TIERS.length; i++) {
        marketerCandidates[i] = [];
        for (let j = 0; j < 4; j++) {
          marketerCandidates[i].push(generateCandidateForTier(i, 'marketer'));
        }
      }
      
      lastCandidateRefresh = getCurrentMonth();
      logEvent("üìã Candidate pools refreshed for this month");
    }
    
    function getCurrentMonth() {
      return Math.floor(currentDay / 30);
    }
    
    function checkAndRefreshCandidates() {
      const currentMonth = getCurrentMonth();
      if (currentMonth > lastCandidateRefresh) {
        refreshCandidatePools();
      }
    }
    
    function removeCandidateFromPool(candidateId, role, tierIndex) {
      if (role === 'developer') {
        developerCandidates[tierIndex] = developerCandidates[tierIndex].filter(c => c.id !== candidateId);
      } else {
        marketerCandidates[tierIndex] = marketerCandidates[tierIndex].filter(c => c.id !== candidateId);
      }
    }
    
    // ============================================
    // HIRING EMPLOYEES
    // ============================================
    
    function hireDeveloper(tierIndex) {
      if (!canHireMoreEmployees()) {
        logEvent("‚ùå Office at capacity! Upgrade your office to hire more people.");
        return;
      }
      
      const tier = DEVELOPER_TIERS[tierIndex];
      const salary = currency === "USD" ? tier.monthlySalaryUSD : tier.monthlySalaryEUR;
      
      if (cash < salary) {
        logEvent(`‚ùå Not enough cash to hire ${tier.name}. Need ${formatCurrency(salary)}`);
        return;
      }
      
      const employee = {
        id: nextEmployeeId++,
        name: generateEmployeeName(),
        role: "developer",
        tier: tierIndex,
        tierName: tier.name,
        skill: tier.skill,
        efficiency: tier.efficiency,
        monthlySalary: salary,
        assignedProduct: null
      };
      
      developers.push(employee);
      cash -= salary; // Pay first month upfront
      
      logEvent(`‚úÖ Hired ${employee.name} as ${tier.name} for ${formatCurrency(salary)}/mo`);
      updateCashDisplay();
      updateEmployeesUI();
    }
    
    function hireMarketer(tierIndex) {
      if (!canHireMoreEmployees()) {
        logEvent("‚ùå Office at capacity! Upgrade your office to hire more people.");
        return;
      }
      
      const tier = MARKETER_TIERS[tierIndex];
      const salary = currency === "USD" ? tier.monthlySalaryUSD : tier.monthlySalaryEUR;
      
      if (cash < salary) {
        logEvent(`‚ùå Not enough cash to hire ${tier.name}. Need ${formatCurrency(salary)}`);
        return;
      }
      
      const employee = {
        id: nextEmployeeId++,
        name: generateEmployeeName(),
        role: "marketer",
        tier: tierIndex,
        tierName: tier.name,
        skill: tier.skill,
        efficiency: tier.efficiency,
        monthlySalary: salary,
        assignedProduct: null
      };
      
      marketers.push(employee);
      cash -= salary; // Pay first month upfront
      
      logEvent(`‚úÖ Hired ${employee.name} as ${tier.name} for ${formatCurrency(salary)}/mo`);
      updateCashDisplay();
      updateEmployeesUI();
    }
    
    function showUpgradeOfficeModal() {
      pauseGame(); // Auto-pause when opening modal
      
      if (currentOfficeTier >= OFFICE_TIERS.length - 1) {
        logEvent("‚ùå Already at maximum office tier!");
        startGame();
        return;
      }
      
      const currentTier = OFFICE_TIERS[currentOfficeTier];
      const nextTier = OFFICE_TIERS[currentOfficeTier + 1];
      const setupCost = currency === "USD" ? nextTier.monthlyRentUSD * 2 : nextTier.monthlyRentEUR * 2;
      const currentRent = currency === "USD" ? currentTier.monthlyRentUSD : currentTier.monthlyRentEUR;
      const nextRent = currency === "USD" ? nextTier.monthlyRentUSD : nextTier.monthlyRentEUR;
      const rentIncrease = nextRent - currentRent;
      
      // Show modal with details
      document.getElementById('upgradeOfficeName').textContent = `${currentTier.name} ‚Üí ${nextTier.name}`;
      document.getElementById('upgradeOfficeCapacity').textContent = `${currentTier.capacity} ‚Üí ${nextTier.capacity} people`;
      document.getElementById('upgradeOfficeRent').textContent = `${formatCurrency(currentRent)} ‚Üí ${formatCurrency(nextRent)}/month`;
      document.getElementById('upgradeOfficeSetupCost').textContent = formatCurrency(setupCost);
      document.getElementById('upgradeOfficeCostIncrease').textContent = `+${formatCurrency(rentIncrease)}/mo`;
      
      // Check if can afford
      const upgradeBtn = document.querySelector('#upgradeOfficeModal .modal-footer button:last-child');
      if (cash < setupCost) {
        upgradeBtn.disabled = true;
        upgradeBtn.style.opacity = '0.5';
        upgradeBtn.style.cursor = 'not-allowed';
      } else {
        upgradeBtn.disabled = false;
        upgradeBtn.style.opacity = '1';
        upgradeBtn.style.cursor = 'pointer';
      }
      
      document.getElementById('upgradeOfficeModal').classList.add('active');
    }
    
    function hideUpgradeOfficeModal() {
      document.getElementById('upgradeOfficeModal').classList.remove('active');
      startGame(); // Auto-resume when closing modal
    }
    
    function confirmUpgradeOffice() {
      const currentTier = OFFICE_TIERS[currentOfficeTier];
      const nextTier = OFFICE_TIERS[currentOfficeTier + 1];
      const setupCost = currency === "USD" ? nextTier.monthlyRentUSD * 2 : nextTier.monthlyRentEUR * 2;
      const currentRent = currency === "USD" ? currentTier.monthlyRentUSD : currentTier.monthlyRentEUR;
      const nextRent = currency === "USD" ? nextTier.monthlyRentUSD : nextTier.monthlyRentEUR;
      
      if (cash < setupCost) {
        logEvent(`‚ùå Not enough cash to upgrade office. Need ${formatCurrency(setupCost)}`);
        hideUpgradeOfficeModal();
        return;
      }
      
      cash -= setupCost;
      currentOfficeTier++;
      
      logEvent(`üè¢ Upgraded to ${nextTier.name}!`);
      logEvent(`  üë• Capacity: ${currentTier.capacity} ‚Üí ${nextTier.capacity} people`);
      logEvent(`  üí∞ Monthly Rent: ${formatCurrency(currentRent)} ‚Üí ${formatCurrency(nextRent)}/mo`);
      logEvent(`  üî® Setup Cost Paid: ${formatCurrency(setupCost)}`);
      
      hideUpgradeOfficeModal();
      updateCashDisplay();
      updateEmployeesUI();
    }
    
    function canDowngradeOffice() {
      if (currentOfficeTier <= 0) return false;
      const prevTier = OFFICE_TIERS[currentOfficeTier - 1];
      const teamSize = getCurrentTeamSize();
      return teamSize <= prevTier.capacity;
    }
    
    function showDowngradeOfficeModal() {
      pauseGame(); // Auto-pause when opening modal
      if (!canDowngradeOffice()) {
        const prevTier = OFFICE_TIERS[currentOfficeTier - 1];
        const teamSize = getCurrentTeamSize();
        alert(`‚ùå Cannot downgrade!\n\nYou have ${teamSize} people but ${prevTier.name} only fits ${prevTier.capacity}.\n\nFire employees first to reduce team size.`);
        startGame(); // Auto-resume after alert
        return;
      }
      
      const currentTier = OFFICE_TIERS[currentOfficeTier];
      const prevTier = OFFICE_TIERS[currentOfficeTier - 1];
      const oldRent = currency === "USD" ? currentTier.monthlyRentUSD : currentTier.monthlyRentEUR;
      const newRent = currency === "USD" ? prevTier.monthlyRentUSD : prevTier.monthlyRentEUR;
      const savings = oldRent - newRent;
      
      // Show modal with details
      document.getElementById('downgradeOfficeName').textContent = `${currentTier.name} ‚Üí ${prevTier.name}`;
      document.getElementById('downgradeOfficeCapacity').textContent = `${currentTier.capacity} ‚Üí ${prevTier.capacity} people`;
      document.getElementById('downgradeOfficeRent').textContent = `${formatCurrency(oldRent)} ‚Üí ${formatCurrency(newRent)}/month`;
      document.getElementById('downgradeOfficeSavings').textContent = `${formatCurrency(savings)}/mo`;
      document.getElementById('downgradeOfficeModal').classList.add('active');
    }
    
    function hideDowngradeOfficeModal() {
      document.getElementById('downgradeOfficeModal').classList.remove('active');
      startGame(); // Auto-resume when closing modal
    }
    
    function confirmDowngradeOffice() {
      const currentTier = OFFICE_TIERS[currentOfficeTier];
      const prevTier = OFFICE_TIERS[currentOfficeTier - 1];
      const oldRent = currency === "USD" ? currentTier.monthlyRentUSD : currentTier.monthlyRentEUR;
      const newRent = currency === "USD" ? prevTier.monthlyRentUSD : prevTier.monthlyRentEUR;
      const savings = oldRent - newRent;
      
      currentOfficeTier--;
      
      logEvent(`üìâ Office downgraded to ${prevTier.name}`);
      logEvent(`  üë• Capacity: ${currentTier.capacity} ‚Üí ${prevTier.capacity} people`);
      logEvent(`  üí∞ Monthly Rent Reduced: ${formatCurrency(oldRent)} ‚Üí ${formatCurrency(newRent)}/month (saves ${formatCurrency(savings)}/mo)`);
      
      hideDowngradeOfficeModal();
      updateEmployeesUI();
    }
    
    let employeeToFire = null;
    
    function fireEmployee(employeeId) {
      pauseGame(); // Auto-pause when opening modal
      const employee = [...developers, ...marketers].find(e => e.id === employeeId);
      if (!employee) return;
      
      const severancePay = employee.monthlySalary;
      
      if (cash < severancePay) {
        alert(`‚ùå Cannot afford severance pay!\n\nFiring ${employee.name} requires ${formatCurrency(severancePay)} in severance.\n\nCurrent cash: ${formatCurrency(cash)}`);
        startGame(); // Auto-resume after alert
        return;
      }
      
      // Store employee ID for confirmation
      employeeToFire = employeeId;
      
      // Show modal instead of confirm
      document.getElementById('fireEmployeeName').textContent = `Fire ${employee.name}?`;
      document.getElementById('fireEmployeeRole').textContent = employee.tierName;
      document.getElementById('fireEmployeeSalary').textContent = `${formatCurrency(employee.monthlySalary)}/month`;
      document.getElementById('fireEmployeeSeverance').textContent = formatCurrency(severancePay);
      document.getElementById('fireEmployeeSavings').textContent = `${formatCurrency(employee.monthlySalary)}/mo`;
      document.getElementById('fireEmployeeCost').textContent = formatCurrency(severancePay);
      document.getElementById('fireEmployeeModal').classList.add('active');
    }
    
    function hideFireEmployeeModal() {
      document.getElementById('fireEmployeeModal').classList.remove('active');
      employeeToFire = null;
      startGame(); // Auto-resume when closing modal
    }
    
    function confirmFireEmployee() {
      if (employeeToFire === null) return;
      
      const employee = [...developers, ...marketers].find(e => e.id === employeeToFire);
      if (!employee) {
        hideFireEmployeeModal();
        return;
      }
      
      const severancePay = employee.monthlySalary;
      
      // Pay severance
      cash -= severancePay;
      
      // Unassign from all products
      products.forEach(product => {
        if (employee.role === 'developer') {
          product.assignedDevelopers = product.assignedDevelopers.filter(id => id !== employeeToFire);
        } else {
          product.assignedMarketers = product.assignedMarketers.filter(id => id !== employeeToFire);
        }
      });
      
      // Remove from team
      if (employee.role === 'developer') {
        developers = developers.filter(d => d.id !== employeeToFire);
      } else {
        marketers = marketers.filter(m => m.id !== employeeToFire);
      }
      
      logEvent(`üî• Fired ${employee.name} (${employee.tierName})`);
      logEvent(`  üí∏ Severance Paid: ${formatCurrency(severancePay)}`);
      logEvent(`  üí∞ Monthly Savings: ${formatCurrency(employee.monthlySalary)}/month`);
      
      hideFireEmployeeModal();
      updateCashDisplay();
      updateEmployeesUI();
      updateProductsUI();
    }
    
    // Promotion modal variables
    let employeeToPromote = null;
    let promotionRole = null;
    let promotionExpectation = 0;
    let promotionMinSalary = 0;
    let promotionMaxSalary = 0;
    
    function showPromotionModal(employeeId, role) {
      pauseGame(); // Auto-pause when opening modal
      
      const employee = role === 'developer' 
        ? developers.find(d => d.id === employeeId)
        : marketers.find(m => m.id === employeeId);
        
      if (!employee || !employee.readyForPromotion) return;
      
      employeeToPromote = employeeId;
      promotionRole = role;
      promotionExpectation = employee.salaryExpectationForNextRank;
      
      // Set salary range: 50% below expectation to 20% above expectation
      promotionMinSalary = Math.round(promotionExpectation * 0.5);
      promotionMaxSalary = Math.round(promotionExpectation * 1.2);
      
      const tiers = role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
      const currentTierName = employee.tierName;
      const nextTierName = tiers[employee.tier + 1].name;
      
      // Update modal content
      document.getElementById('promotionEmployeeName').textContent = employee.name;
      document.getElementById('promotionEmployeeRole').textContent = `${currentTierName} ‚Üí ${nextTierName}`;
      document.getElementById('promotionExpectation').textContent = `${formatCurrency(promotionExpectation)}/mo`;
      document.getElementById('promotionMinSalary').textContent = formatCurrency(promotionMinSalary);
      document.getElementById('promotionMaxSalary').textContent = formatCurrency(promotionMaxSalary);
      
      // Set up slider
      const slider = document.getElementById('promotionSalarySlider');
      slider.min = promotionMinSalary;
      slider.max = promotionMaxSalary;
      slider.value = promotionExpectation; // Start at expectation
      
      // Update display
      updatePromotionOffer();
      
      // Add slider event listener
      slider.oninput = updatePromotionOffer;
      
      // Handle rejection display
      const rejectionCount = employee.promotionRejectionCount || 0;
      if (rejectionCount > 0) {
        updatePromotionRejectionDisplay(rejectionCount);
      } else {
        // Hide rejection info for fresh promotion attempt
        document.getElementById('promotionRejectionInfo').style.display = 'none';
      }
      
      // Show modal
      document.getElementById('promotionModal').classList.add('active');
    }
    
    function updatePromotionOffer() {
      const slider = document.getElementById('promotionSalarySlider');
      const offer = parseInt(slider.value);
      
      // Update offer display
      document.getElementById('promotionOfferDisplay').textContent = `${formatCurrency(offer)}/mo`;
      
      // Calculate and display acceptance probability
      const probability = calculatePromotionAcceptanceProbability(offer, promotionExpectation);
      const percentDisplay = Math.round(probability * 100);
      document.getElementById('promotionProbability').textContent = `${percentDisplay}%`;
      
      // Update acceptance chance box color based on probability
      const chanceBox = document.getElementById('promotionAcceptanceChance');
      if (probability >= 0.9) {
        chanceBox.style.background = '#d1fae5';
        chanceBox.style.borderColor = '#10b981';
      } else if (probability >= 0.7) {
        chanceBox.style.background = '#fef3c7';
        chanceBox.style.borderColor = '#fbbf24';
      } else if (probability >= 0.4) {
        chanceBox.style.background = '#fed7aa';
        chanceBox.style.borderColor = '#f97316';
      } else {
        chanceBox.style.background = '#fecaca';
        chanceBox.style.borderColor = '#ef4444';
      }
    }
    
    function hidePromotionModal() {
      document.getElementById('promotionModal').classList.remove('active');
      employeeToPromote = null;
      promotionRole = null;
      // Keep game paused after closing modal
    }
    
    function makePromotionOffer() {
      if (employeeToPromote === null) return;
      
      const slider = document.getElementById('promotionSalarySlider');
      const offer = parseInt(slider.value);
      
      const employee = promotionRole === 'developer' 
        ? developers.find(d => d.id === employeeToPromote)
        : marketers.find(m => m.id === employeeToPromote);
        
      if (!employee) {
        hidePromotionModal();
        return;
      }
      
      // Calculate acceptance probability
      const probability = calculatePromotionAcceptanceProbability(offer, promotionExpectation);
      const accepted = Math.random() < probability;
      
      if (accepted) {
        // Employee accepts!
        promoteEmployee(employee, offer, promotionRole);
        logEvent(`‚úÖ ${employee.name} accepted the promotion offer of ${formatCurrency(offer)}/month!`);
        showNotification(`‚úÖ ${employee.name} accepted promotion!`, 'success');
        hidePromotionModal();
        updateEmployeesUI();
      } else {
        // Employee rejects - increment rejection count
        employee.promotionRejectionCount = (employee.promotionRejectionCount || 0) + 1;
        
        const percentDiff = Math.round(((offer - promotionExpectation) / promotionExpectation) * 100);
        logEvent(`‚ùå ${employee.name} rejected the offer of ${formatCurrency(offer)}/month (${percentDiff}% ${percentDiff >= 0 ? 'above' : 'below'} expectation) - Rejection ${employee.promotionRejectionCount}/3`);
        showNotification(`‚ùå ${employee.name} rejected the offer (${employee.promotionRejectionCount}/3)`, 'error');
        
        // Check if this is the 3rd rejection
        if (employee.promotionRejectionCount >= 3) {
          // Employee quits!
          logEvent(`üíî ${employee.name} has quit after 3 rejected promotion offers!`);
          showNotification(`üíî ${employee.name} quit!`, 'error');
          
          // Unassign from all products
          products.forEach(product => {
            if (employee.role === 'developer') {
              product.assignedDevelopers = product.assignedDevelopers.filter(id => id !== employee.id);
            } else {
              product.assignedMarketers = product.assignedMarketers.filter(id => id !== employee.id);
            }
          });
          
          // Unassign from R&D projects
          if (employee.role === 'developer') {
            rndProjects.forEach(project => {
              project.assignedDevelopers = project.assignedDevelopers.filter(id => id !== employee.id);
            });
          }
          
          // Remove from team (no severance pay - they quit)
          if (employee.role === 'developer') {
            developers = developers.filter(d => d.id !== employee.id);
          } else {
            marketers = marketers.filter(m => m.id !== employee.id);
          }
          
          hidePromotionModal();
          updateEmployeesUI();
          updateProductsUI();
          updateRndUI();
        } else {
          // Show rejection count and keep modal open
          updatePromotionRejectionDisplay(employee.promotionRejectionCount);
        }
      }
    }
    
    function updatePromotionRejectionDisplay(rejectionCount) {
      const rejectionInfo = document.getElementById('promotionRejectionInfo');
      const rejectionText = document.getElementById('promotionRejectionText');
      
      rejectionInfo.style.display = 'block';
      
      // Compact format: "Rejected X/3"
      rejectionText.textContent = `Rejected ${rejectionCount}/3`;
      
      // Update warning color based on rejection count
      if (rejectionCount === 2) {
        rejectionInfo.style.background = '#fca5a5';
        rejectionInfo.style.borderColor = '#dc2626';
      }
    }
    
    // ============================================
    // EMPLOYEE EXPERIENCE & PROGRESSION
    // ============================================
    
    function updateEmployeeExperience() {
      // Update experience for developers
      developers.forEach(dev => {
        // Check if developer is assigned to any work
        const isWorking = products.some(p => 
          (p.status === 'in_development' || p.status === 'published') && 
          p.assignedDevelopers.includes(dev.id)
        ) || rndProjects.some(p => p.assignedDevelopers.includes(dev.id));
        
        if (isWorking) {
          dev.experienceMonths = (dev.experienceMonths || 0) + (1/30); // 1 day = 1/30 month
          
          // Check for promotion
          checkEmployeePromotion(dev, 'developer');
        }
      });
      
      // Update experience for marketers
      marketers.forEach(mkt => {
        // Check if marketer is assigned to any work
        const isWorking = products.some(p => 
          p.status === 'published' && 
          p.assignedMarketers.includes(mkt.id)
        );
        
        if (isWorking) {
          mkt.experienceMonths = (mkt.experienceMonths || 0) + (1/30); // 1 day = 1/30 month
          
          // Check for promotion
          checkEmployeePromotion(mkt, 'marketer');
        }
      });
    }
    
    function checkEmployeePromotion(employee, role) {
      const tiers = role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
      const currentTier = tiers[employee.tier];
      
      // Calculate efficiency based on experience
      // Use employee's base efficiency (what they were hired at) as the starting point
      const baseEfficiency = employee.baseEfficiency || currentTier.efficiency;
      const gainedEfficiency = employee.experienceMonths * EXPERIENCE_RATE;
      
      // If employee is ready for promotion but not promoted, cap at current efficiency cap
      let newEfficiency;
      if (employee.readyForPromotion) {
        // Employee is stuck at cap until promoted
        newEfficiency = currentTier.efficiencyCap;
      } else {
        // Employee can still gain efficiency
        newEfficiency = Math.min(baseEfficiency + gainedEfficiency, currentTier.efficiencyCap);
      }
      
      // Update efficiency
      employee.efficiency = newEfficiency;
      
      // Check if reached cap and ready for promotion
      if (newEfficiency >= currentTier.efficiencyCap && employee.tier < tiers.length - 1 && !employee.readyForPromotion) {
        // Mark as ready for promotion (not auto-promote)
        employee.readyForPromotion = true;
        employee.promotionRejectionCount = 0; // Reset rejection count for this promotion
        
        // Generate salary expectation for next rank with ¬±20% fluctuation (normal distribution)
        const nextTier = tiers[employee.tier + 1];
        const baseSalary = currency === 'USD' ? nextTier.monthlySalaryUSD : nextTier.monthlySalaryEUR;
        employee.salaryExpectationForNextRank = generateSalaryExpectation(baseSalary);
        
        logEvent(`üéØ ${employee.name} (${employee.tierName}) is ready for promotion!`);
        showNotification(`üéØ ${employee.name} ready for promotion!`, 'info');
      }
    }
    
    function generateSalaryExpectation(baseSalary) {
      // Generate salary expectation with ¬±20% fluctuation using normal distribution
      // Using Box-Muller transform to generate normally distributed random value
      const u1 = Math.random();
      const u2 = Math.random();
      const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
      
      // z0 is now a standard normal (mean=0, stddev=1)
      // We want mean=1.0 (base salary), stddev=0.1 (so ~95% within ¬±20%)
      const multiplier = 1.0 + (z0 * 0.1);
      
      // Clamp to ¬±20% range
      const clampedMultiplier = Math.max(0.8, Math.min(1.2, multiplier));
      
      return Math.round(baseSalary * clampedMultiplier);
    }
    
    function calculatePromotionAcceptanceProbability(offer, expectation) {
      // If offer >= expectation, 100% acceptance
      if (offer >= expectation) {
        return 1.0;
      }
      
      // Calculate percentage difference (negative value)
      const percentDiff = ((offer - expectation) / expectation) * 100;
      
      // Create acceptance probability curve:
      // -5% or better: ~90% chance
      // -10%: ~80% chance
      // -15%: ~60% chance
      // -20%: ~40% chance
      // -25%: ~20% chance
      // -30%: ~10% chance
      // -35%: ~5% chance
      // -40% or worse: ~1% chance
      
      // Using exponential decay formula: probability = e^(k * percentDiff)
      // Where k controls the steepness of the curve
      const k = 0.08; // Tuned for desired curve
      const probability = Math.exp(k * percentDiff);
      
      // Ensure minimum 1% chance
      return Math.max(0.01, Math.min(1.0, probability));
    }
    
    function promoteEmployee(employee, offeredSalary, role) {
      const tiers = role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
      const oldTierName = employee.tierName;
      const oldSalary = employee.monthlySalary;
      
      employee.tier += 1;
      const newTier = tiers[employee.tier];
      
      employee.tierName = newTier.name;
      employee.skill = newTier.skill;
      employee.monthlySalary = offeredSalary;
      employee.efficiency = newTier.efficiency; // Reset to new tier base
      employee.baseEfficiency = newTier.efficiency; // Reset base efficiency for new tier
      employee.experienceMonths = 0; // Reset experience for new tier
      employee.readyForPromotion = false; // Clear promotion flag
      employee.salaryExpectationForNextRank = null; // Clear expectation
      employee.promotionRejectionCount = 0; // Reset rejection count
      
      // Log promotion with salary change
      const salaryIncrease = employee.monthlySalary - oldSalary;
      logEvent(`üéì ${employee.name} promoted from ${oldTierName} to ${employee.tierName}! Salary: ${formatCurrency(oldSalary)} ‚Üí ${formatCurrency(employee.monthlySalary)} (+${formatCurrency(salaryIncrease)})`);
      showNotification(`üéì ${employee.name} promoted to ${employee.tierName}!`, 'success');
    }
    
    function updateEmployeesUI() {
      // Update office info
      const office = OFFICE_TIERS[currentOfficeTier];
      const teamSize = getCurrentTeamSize();
      const officeInfo = document.getElementById('officeInfo');
      
      const rent = currency === "USD" ? office.monthlyRentUSD : office.monthlyRentEUR;
      
      // Action buttons for top-right (text with colored backgrounds)
      let actionButtons = '';
      const canUpgradeOffice = currentOfficeTier < OFFICE_TIERS.length - 1;
      const canDowngrade = canDowngradeOffice();
      
      if (canUpgradeOffice || canDowngrade) {
        actionButtons = '<div class="office-actions">';
        
        // Downgrade button (left)
        if (canDowngrade) {
          actionButtons += `
            <button 
              class="office-upgrade-btn downgrade" 
              onclick="showDowngradeOfficeModal()"
              title="Downgrade office"
            >
              Downgrade
            </button>
          `;
        }
        
        // Upgrade button (right)
        if (canUpgradeOffice) {
          actionButtons += `
            <button 
              class="office-upgrade-btn upgrade" 
              onclick="showUpgradeOfficeModal()"
              title="Upgrade office"
            >
              Upgrade
            </button>
          `;
        }
        
        actionButtons += '</div>';
      }
      
      // Max tier badge
      const maxTierBadge = currentOfficeTier >= OFFICE_TIERS.length - 1 
        ? '<span style="font-size: 0.7rem; color: #10b981; font-weight: 600;">üèÜ Max Tier</span>' 
        : '';
      
      officeInfo.innerHTML = `
        <div class="office-header">
          <div class="office-info-left">
            <div class="office-name">üè¢ ${office.name} ${maxTierBadge}</div>
            <div class="office-stats">
              <div class="office-stat-item">
                <span>üë•</span>
                <span>${teamSize} / ${office.capacity} people</span>
              </div>
              <div class="office-stat-item">
                ${rent > 0 ? `<span>üí∞</span><span>${formatCurrency(rent)}/mo</span>` : '<span>üè†</span><span>No rent</span>'}
              </div>
            </div>
          </div>
          ${actionButtons}
        </div>
      `;
      
      // Update employee list
      const employeeList = document.getElementById('employeeList');
      
      if (developers.length === 0 && marketers.length === 0) {
        employeeList.innerHTML = '<div class="empty-state">No employees yet. Hire your first team member!</div>';
        return;
      }
      
      employeeList.innerHTML = [...developers, ...marketers].map(emp => {
        // Find which product this employee is assigned to
        let assignment = null;
        let assignmentType = '';
        
        // Check products
        const productAssignment = products.find(p => {
          if (emp.role === 'developer') {
            return p.assignedDevelopers.includes(emp.id);
          } else {
            return p.assignedMarketers.includes(emp.id);
          }
        });
        
        if (productAssignment) {
          assignment = productAssignment;
          assignmentType = 'Product';
        } else if (emp.role === 'developer') {
          // Check R&D projects (only developers can work on R&D)
          const rndAssignment = rndProjects.find(p => p.assignedDevelopers.includes(emp.id));
          if (rndAssignment) {
            assignment = rndAssignment;
            assignmentType = 'R&D';
          }
        }
        
        // Calculate experience progress
        const tiers = emp.role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
        const currentTier = tiers[emp.tier];
        const experienceMonths = emp.experienceMonths || 0;
        const gainedEfficiency = experienceMonths * EXPERIENCE_RATE;
        const baseEfficiency = emp.baseEfficiency || currentTier.efficiency;
        const currentEfficiency = Math.min(baseEfficiency + gainedEfficiency, currentTier.efficiencyCap);
        const progressToNextTier = (currentEfficiency - baseEfficiency) / (currentTier.efficiencyCap - baseEfficiency) * 100;
        const isMaxTier = emp.tier >= tiers.length - 1 && currentEfficiency >= currentTier.efficiencyCap;
        
        let experienceBar = '';
        if (emp.readyForPromotion) {
          // Show "Ready for Promotion" badge
          experienceBar = `
            <div>
              <div style="color: #10b981; padding: 0.2rem; border-radius: 6px; text-align: center; font-size: 0.7rem;">
                üéì Ready for Promotion
              </div>
            </div>
          `;
        } else if (!isMaxTier) {
          const nextTierName = emp.tier < tiers.length - 1 ? tiers[emp.tier + 1].name : 'Max Level';
          experienceBar = `
            <div>
              <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #6b7280; margin-bottom: 0.2rem;">
                <span>üìà Progress to ${nextTierName}</span>
                <span>${Math.round(progressToNextTier)}%</span>
              </div>
              <div style="background: #e5e7eb; border-radius: 4px; height: 6px; overflow: hidden;">
                <div style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: ${progressToNextTier}%; transition: width 0.3s ease;"></div>
              </div>
            </div>
          `;
        } else {
          experienceBar = `
            <div style="margin-top: 0.5rem; font-size: 0.7rem; color: #10b981; text-align: center; font-weight: 600;">
              ‚≠ê Maximum Level Reached
            </div>
          `;
        }
        
        return `
          <div class="employee-card">
            <div class="employee-header">
              <div style="display: flex; align-items: center; flex-wrap: wrap;">
                <span class="employee-name">${emp.name}</span>
                <span class="employee-role role-${emp.role}">
                  ${emp.role === 'developer' ? 'üë®‚Äçüíª' : 'üì¢'} ${emp.tierName}
                </span>
              </div>
              <div style="display: flex; gap: 0.3rem;">
                ${emp.readyForPromotion ? `
                  <button 
                    class="btn" 
                    onclick="showPromotionModal(${emp.id}, '${emp.role}')"
                    style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #10b981; border-color: #059669; color: white;"
                    title="Promote employee"
                  >
                    üéì Promote
                  </button>
                ` : ''}
                <button 
                  class="btn" 
                  onclick="fireEmployee(${emp.id})"
                  style="padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #ef4444; border-color: #dc2626;"
                  title="Fire employee (1 month severance)"
                >
                  üî• Fire
                </button>
              </div>
            </div>
            <div class="employee-stats">
              <div class="employee-stat">‚ö° Efficiency: ${currentEfficiency.toFixed(2)}x</div>
              <div class="employee-stat">üí∞ Salary: ${formatCurrency(emp.monthlySalary)}/mo</div>
            </div>
            ${experienceBar}
            <div class="employee-assignment ${assignment ? 'assignment-active' : ''}">
              ${assignment ? 
                `${assignmentType === 'R&D' ? 'üî¨' : 'üìå'} Working on: ${assignment.name}${assignmentType === 'R&D' ? ' (R&D)' : ''}` : 
                'üí§ Unassigned (assign to a product or R&D)'
              }
            </div>
          </div>
        `;
      }).join('');
    }
    
    function updateFinancesUI() {
      const financesContent = document.getElementById('financesContent');
      
      const income = calculateMonthlyIncome();
      const costs = calculateMonthlyCosts();
      const cashFlow = calculateNetCashFlow();
      const burnRate = calculateBurnRate();
      
      const totalSubs = getTotalSubscribers();
      const server = SERVER_TIERS[currentServerTier];
      const capacityPercent = getServerCapacityPercentage();
      
      // Calculate days until next billing
      const daysUntilBilling = currentDay === 0 ? 30 : (30 - (currentDay % 30));
      
      // Server upgrade/downgrade section
      let serverUpgradeSection = '';
      const canUpgrade = currentServerTier < SERVER_TIERS.length - 1;
      const canDowngrade = canDowngradeServer();
      
      if (canUpgrade || canDowngrade) {
        serverUpgradeSection = '<div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">';
        
        // Upgrade column
        if (canUpgrade) {
          const nextTier = SERVER_TIERS[currentServerTier + 1];
          const upgradeCost = currency === "USD" ? nextTier.upgradeCostUSD : nextTier.upgradeCostEUR;
          const nextFee = currency === "USD" ? nextTier.monthlyFeeUSD : nextTier.monthlyFeeEUR;
          const canAfford = canUpgradeServer();
          
          serverUpgradeSection += `
            <div style="flex: 1; display: flex; flex-direction: column;">
              <button 
                class="office-upgrade-btn" 
                onclick="upgradeServer()"
                ${!canAfford ? 'disabled' : ''}
                style="margin-bottom: 0.35rem;"
              >
                ‚¨ÜÔ∏è ${nextTier.name}
              </button>
              <div class="office-upgrade-details" style="padding: 0.5rem; font-size: 0.75rem;">
                <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.75rem;">‚¨ÜÔ∏è Upgrade:</div>
                <div class="upgrade-detail" style="font-size: 0.7rem; padding: 0.15rem 0;">
                  <span>üìä ${server.maxSubscribers.toLocaleString()} ‚Üí</span>
                  <span><strong>${nextTier.maxSubscribers.toLocaleString()}</strong> subs</span>
                </div>
                <div class="upgrade-detail" style="font-size: 0.7rem; padding: 0.15rem 0;">
                  <span>üí∞ ${formatCurrency(costs.serverFee)} ‚Üí</span>
                  <span><strong>${formatCurrency(nextFee)}</strong>/mo</span>
                </div>
                <div class="upgrade-detail" style="font-size: 0.7rem; padding: 0.15rem 0;">
                  <span>üî® Setup:</span>
                  <span><strong>${formatCurrency(upgradeCost)}</strong></span>
                </div>
              </div>
            </div>
          `;
        }
        
        // Downgrade column
        if (canDowngrade) {
          const prevTier = SERVER_TIERS[currentServerTier - 1];
          const prevFee = currency === "USD" ? prevTier.monthlyFeeUSD : prevTier.monthlyFeeEUR;
          const savings = costs.serverFee - prevFee;
          
          serverUpgradeSection += `
            <div style="flex: 1; display: flex; flex-direction: column;">
              <button 
                class="office-upgrade-btn" 
                onclick="downgradeServer()"
                style="background: #6b7280; margin-bottom: 0.35rem;"
              >
                ‚¨áÔ∏è ${prevTier.name}
              </button>
              <div class="office-upgrade-details" style="padding: 0.5rem; font-size: 0.75rem; background: #f3f4f6;">
                <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.75rem;">‚¨áÔ∏è Downgrade:</div>
                <div class="upgrade-detail" style="font-size: 0.7rem; padding: 0.15rem 0;">
                  <span>üìä ${server.maxSubscribers.toLocaleString()} ‚Üí</span>
                  <span><strong>${prevTier.maxSubscribers.toLocaleString()}</strong> subs</span>
                </div>
                <div class="upgrade-detail" style="font-size: 0.7rem; padding: 0.15rem 0;">
                  <span>üí∞ Save:</span>
                  <span><strong>${formatCurrency(savings)}</strong>/mo</span>
                </div>
                <div class="upgrade-detail" style="color: #10b981; font-size: 0.7rem; padding: 0.15rem 0;">
                  <span>‚úÖ No cost</span>
                  <span></span>
                </div>
              </div>
            </div>
          `;
        }
        
        serverUpgradeSection += '</div>';
      } else if (currentServerTier >= SERVER_TIERS.length - 1) {
        serverUpgradeSection = '<div style="text-align: center; color: #6b7280; font-size: 0.75rem; margin-top: 0.35rem;">üèÜ Maximum server tier!</div>';
      }
      
      // Capacity warning
      let capacityWarning = '';
      if (capacityPercent >= 90) {
        capacityWarning = '<div style="color: #ef4444; font-size: 0.75rem; margin-top: 0.35rem;">‚ö†Ô∏è Server capacity critical! Upgrade soon!</div>';
      } else if (capacityPercent >= 75) {
        capacityWarning = '<div style="color: #f59e0b; font-size: 0.75rem; margin-top: 0.35rem;">‚ö†Ô∏è Server capacity high. Consider upgrading.</div>';
      }
      
      financesContent.innerHTML = `
        <!-- Financial Summary -->
        <div class="finance-card">
          <div class="finance-header">üí∞ Monthly Finances</div>
          <div style="text-align: center; padding: 0.35rem; background: #f9fafb; border-radius: 4px; margin-bottom: 0.5rem;">
            <div style="font-size: 0.75rem; color: #6b7280;">üìÖ Next Billing Cycle</div>
            <div style="font-size: 0.85rem; font-weight: 600; color: #111827; margin-top: 0.15rem;">In ${daysUntilBilling} ${daysUntilBilling === 1 ? 'day' : 'days'}</div>
          </div>
          <div class="finance-row">
            <span>üìà Income:</span>
            <span class="finance-value positive">${formatCurrency(income.netIncome)}</span>
          </div>
          <div class="finance-row-sub">
            Revenue: ${formatCurrency(income.grossRevenue)} - Server Cost: ${formatCurrency(income.serverCost)}
          </div>
          <div class="finance-row" style="margin-top: 0.5rem;">
            <span>üìâ Expenses:</span>
            <span class="finance-value negative">${formatCurrency(costs.total)}</span>
          </div>
          <div class="finance-row-sub">
            ${costs.rent > 0 ? `Rent: ${formatCurrency(costs.rent)}, ` : ''}Utilities: ${formatCurrency(costs.utilities)}, Insurance: ${formatCurrency(costs.insurance)}${costs.salaries > 0 ? `, Salaries: ${formatCurrency(costs.salaries)}` : ''}${costs.serverFee > 0 ? `, Server: ${formatCurrency(costs.serverFee)}` : ''}
          </div>
          <div class="finance-divider"></div>
          <div class="finance-row">
            <span>üíµ Net Cash Flow:</span>
            <span class="finance-value ${cashFlow >= 0 ? 'positive' : 'negative'}">${formatCurrency(cashFlow)}</span>
          </div>
          <div class="finance-row" style="margin-top: 0.5rem;">
            <span>‚è±Ô∏è Burn Rate:</span>
            <span class="finance-value ${burnRate === Infinity ? 'positive' : (burnRate <= 3 ? 'negative' : 'neutral')}">
              ${burnRate === Infinity ? '‚àû (Profitable!)' : `${burnRate} ${burnRate === 1 ? 'month' : 'months'}`}
            </span>
          </div>
        </div>
        
        <!-- Lifetime Earnings & Hiring Reputation -->
        <div class="finance-card" style="margin-top: 0.75rem;">
          <div class="finance-header">üìä Lifetime Earnings & Reputation</div>
          <div class="finance-row">
            <span>Total Earned:</span>
            <span class="finance-value positive">${formatCurrency(lifetimeEarnings)}</span>
          </div>
          ${(() => {
            const milestone = getCurrentMilestone();
            const nextMilestone = getNextMilestone();
            
            if (nextMilestone) {
              const progress = ((lifetimeEarnings - milestone.threshold) / (nextMilestone.threshold - milestone.threshold)) * 100;
              const progressClamped = Math.min(100, Math.max(0, progress));
              
              return `
                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <span style="font-size: 0.8rem; font-weight: 600;">
                      ${milestone.badge} ${milestone.name}
                    </span>
                    <span style="font-size: 0.75rem; color: #6b7280;">
                      ${Math.round(progressClamped)}%
                    </span>
                  </div>
                  <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: ${progressClamped}%; transition: width 0.3s;"></div>
                  </div>
                  <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                    Next: ${nextMilestone.badge} ${nextMilestone.name} at ${formatCurrency(nextMilestone.threshold)}
                  </div>
                  <div style="font-size: 0.75rem; color: #059669; margin-top: 0.15rem;">
                    üíº ${milestone.description}
                  </div>
                </div>
              `;
            } else {
              return `
                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 0.9rem;">${milestone.badge}</span>
                    <span style="font-size: 0.85rem; font-weight: 600; color: #f59e0b;">
                      ${milestone.name}
                    </span>
                  </div>
                  <div style="font-size: 0.75rem; color: #f59e0b; margin-top: 0.25rem;">
                    ‚≠ê Maximum reputation! You attract the best talent!
                  </div>
                </div>
              `;
            }
          })()}
        </div>
        
        <!-- Server Tier -->
        <div class="finance-card" style="margin-top: 0.75rem;">
          <div class="finance-header">üñ•Ô∏è ${server.name}</div>
          <div class="server-capacity">
            <div class="capacity-label">
              <span>üìä Capacity:</span>
              <span>${totalSubs.toLocaleString()} / ${server.maxSubscribers.toLocaleString()} subscribers</span>
            </div>
            <div class="capacity-bar">
              <div class="capacity-fill ${capacityPercent >= 90 ? 'capacity-critical' : (capacityPercent >= 75 ? 'capacity-warning' : '')}" style="width: ${capacityPercent}%"></div>
            </div>
            <div class="capacity-percent">${capacityPercent}%</div>
          </div>
          ${capacityWarning}
          ${serverUpgradeSection}
        </div>
      `;
    }
    
    function updateHireDeveloperModalContent() {
      const list = document.getElementById('hireDeveloperList');
      const hasCapacity = canHireMoreEmployees();
      const milestone = getCurrentMilestone();
      const daysUntilRefresh = 30 - (currentDay % 30);
      
      // Header with simple company status
      let headerHTML = `
        <div style="background: white; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem;">
          <div style="font-size: 0.75rem; color: #6b7280;">
            <strong style="color: #111827;">Company Status:</strong> ${milestone.badge} ${milestone.name}
          </div>
        </div>
        
        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.25rem;">
          <span>üîÑ</span>
          <span>Pool refreshes in <strong>${daysUntilRefresh} day${daysUntilRefresh > 1 ? 's' : ''}</strong></span>
        </div>
      `;
      
      // Candidate cards in 2x2 grid
      const candidatesHTML = candidatePool.developers.map((candidate, index) => {
        const canAfford = cash >= candidate.monthlySalary;
        const tier = DEVELOPER_TIERS[candidate.tier];
        
        return `
          <button 
            class="hire-btn" 
            onclick="showHireConfirmation('${candidate.id}', 'developer', ${index});"
            ${!canAfford || !hasCapacity ? 'disabled' : ''}
            style="padding: 0.6rem; min-height: auto;"
          >
            <div style="text-align: left;">
              <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.4rem;">${candidate.name}</div>
              <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.8rem;">
                <div><span class="skill-badge skill-${tier.skill}" style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">${tier.name}</span></div>
                <div>‚ö° ${Math.round(candidate.efficiency * 100)}% efficiency</div>
                <div style="color: ${!canAfford ? '#dc2626' : '#059669'}; font-weight: 600;">üíº ${formatCurrency(candidate.monthlySalary)}/mo</div>
                ${!canAfford ? '<div style="color: #ef4444; font-size: 0.75rem;">‚ö†Ô∏è Cannot afford</div>' : ''}
                ${!hasCapacity ? '<div style="color: #ef4444; font-size: 0.75rem;">‚ö†Ô∏è No office capacity</div>' : ''}
              </div>
            </div>
          </button>
        `;
      }).join('');
      
      list.innerHTML = headerHTML + '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">' + candidatesHTML + '</div>';
    }
    
    function showHireDeveloperModal() {
      pauseGame(); // Auto-pause when opening modal
      
      // Ensure candidate pool is initialized
      if (candidatePool.developers.length === 0) {
        generateCandidatePool();
      }
      
      const modal = document.getElementById('hireDeveloperModal');
      updateHireDeveloperModalContent();
      modal.classList.add('active');
    }
    
    function hideHireDeveloperModal() {
      document.getElementById('hireDeveloperModal').classList.remove('active');
      // Keep game paused after closing modal
    }
    
    function hireFromPool(candidateIndex, type) {
      // type: "developer" or "marketer"
      
      if (!canHireMoreEmployees()) {
        logEvent("‚ùå Office at capacity! Upgrade your office to hire more people.");
        return;
      }
      
      // Get candidate from pool
      const candidate = type === "developer" 
        ? candidatePool.developers[candidateIndex]
        : candidatePool.marketers[candidateIndex];
      
      if (!candidate) {
        logEvent("‚ùå Candidate not found!");
        return;
      }
      
      // Check if can afford
      if (cash < candidate.monthlySalary) {
        logEvent(`‚ùå Not enough cash to hire ${candidate.name}. Need ${formatCurrency(candidate.monthlySalary)}`);
        return;
      }
      
      // Deduct first month's salary
      cash -= candidate.monthlySalary;
      
      // Add experience tracking to candidate
      candidate.experienceMonths = 0;
      candidate.baseEfficiency = candidate.efficiency;
      
      // Add to team
      if (type === "developer") {
        developers.push(candidate);
        logEvent(`‚úÖ Hired ${candidate.name} as ${candidate.tierName} for ${formatCurrency(candidate.monthlySalary)}/mo`);
      } else {
        marketers.push(candidate);
        logEvent(`‚úÖ Hired ${candidate.name} as ${candidate.tierName} for ${formatCurrency(candidate.monthlySalary)}/mo`);
      }
      
      // Remove from pool (regenerate on next month)
      // We don't remove from array, just mark as hired - pool will regenerate monthly anyway
      
      // Close modal and update UI
      if (type === "developer") {
        hideHireDeveloperModal();
      } else {
        hideHireMarketerModal();
      }
      
      updateCashDisplay();
      updateEmployeesUI();
      updateFinancesUI();
    }
    
    function showDeveloperCandidates(tierIndex) {
      const modal = document.getElementById('hireDeveloperModal');
      const list = document.getElementById('hireDeveloperList');
      const tier = DEVELOPER_TIERS[tierIndex];
      const candidates = developerCandidates[tierIndex] || [];
      
      list.innerHTML = `
        <div style="margin-bottom: 0.3rem;">
          <button 
            onclick="showHireDeveloperModal()" 
            class="btn"
            style="padding: 0.4rem 0.8rem; font-size: 0.9rem; margin-bottom: 0.5rem;"
          >
            ‚Üê Back to Tiers
          </button>
          <h3 style="color: #1f2937;">Available ${tier.name}s</h3>
          <p style="color: #6b7280; font-size: 0.9rem;">
            Select a candidate to review their details. Pool refreshes monthly.
          </p>
        </div>
        ${candidates.map(candidate => {
          const canAfford = cash >= candidate.monthlySalary;
          const hasCapacity = canHireMoreEmployees();
          
          return `
            <button 
              class="hire-btn" 
              onclick="showHireConfirmation('${candidate.id}', 'developer', ${tierIndex});"
              ${!canAfford || !hasCapacity ? 'disabled' : ''}
              style="width: 100%; margin-bottom: 0.5rem;"
            >
              <div class="hire-btn-info">
                <div class="hire-btn-title">
                  <strong>${candidate.name}</strong>
                </div>
                <div class="hire-btn-stats">
                  ‚ö° ${Math.round(candidate.efficiency * 100)}% efficiency ‚Ä¢ üíº ${formatCurrency(candidate.monthlySalary)}/mo
                  ${!canAfford ? '<br><span style="color: #ef4444;">‚ö†Ô∏è Cannot afford</span>' : ''}
                  ${!hasCapacity ? '<br><span style="color: #ef4444;">‚ö†Ô∏è No office capacity</span>' : ''}
                </div>
              </div>
              <div class="hire-btn-cost">${formatCurrency(candidate.monthlySalary)}</div>
            </button>
          `;
        }).join('')}
        ${candidates.length === 0 ? '<div class="empty-state">No candidates available this month. Wait for next month\'s pool refresh.</div>' : ''}
      `;
    }
    
    function updateHireMarketerModalContent() {
      const list = document.getElementById('hireMarketerList');
      const hasCapacity = canHireMoreEmployees();
      const milestone = getCurrentMilestone();
      const daysUntilRefresh = 30 - (currentDay % 30);
      
      // Header with simple company status
      let headerHTML = `
        <div style="background: white; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem;">
          <div style="font-size: 0.75rem; color: #6b7280;">
            <strong style="color: #111827;">Company Status:</strong> ${milestone.badge} ${milestone.name}
          </div>
        </div>
        
        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.25rem;">
          <span>üîÑ</span>
          <span>Pool refreshes in <strong>${daysUntilRefresh} day${daysUntilRefresh > 1 ? 's' : ''}</strong></span>
        </div>
      `;
      
      // Candidate cards in 2x2 grid
      const candidatesHTML = candidatePool.marketers.map((candidate, index) => {
        const canAfford = cash >= candidate.monthlySalary;
        const tier = MARKETER_TIERS[candidate.tier];
        
        return `
          <button 
            class="hire-btn" 
            onclick="showHireConfirmation('${candidate.id}', 'marketer', ${index});"
            ${!canAfford || !hasCapacity ? 'disabled' : ''}
            style="padding: 0.6rem; min-height: auto;"
          >
            <div style="text-align: left;">
              <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.4rem;">${candidate.name}</div>
              <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.8rem;">
                <div><span class="skill-badge skill-${tier.skill}" style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">${tier.name}</span></div>
                <div>‚ö° ${Math.round(candidate.efficiency * 100)}% efficiency</div>
                <div style="color: ${!canAfford ? '#dc2626' : '#059669'}; font-weight: 600;">üíº ${formatCurrency(candidate.monthlySalary)}/mo</div>
                ${!canAfford ? '<div style="color: #ef4444; font-size: 0.75rem;">‚ö†Ô∏è Cannot afford</div>' : ''}
                ${!hasCapacity ? '<div style="color: #ef4444; font-size: 0.75rem;">‚ö†Ô∏è No office capacity</div>' : ''}
              </div>
            </div>
          </button>
        `;
      }).join('');
      
      list.innerHTML = headerHTML + '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">' + candidatesHTML + '</div>';
    }
    
    function showHireMarketerModal() {
      pauseGame(); // Auto-pause when opening modal
      
      // Ensure candidate pool is initialized
      if (candidatePool.marketers.length === 0) {
        generateCandidatePool();
      }
      
      const modal = document.getElementById('hireMarketerModal');
      updateHireMarketerModalContent();
      modal.classList.add('active');
    }
    
    function hideHireMarketerModal() {
      document.getElementById('hireMarketerModal').classList.remove('active');
      // Keep game paused after closing modal
    }
    
    function showMarketerCandidates(tierIndex) {
      const modal = document.getElementById('hireMarketerModal');
      const list = document.getElementById('hireMarketerList');
      const tier = MARKETER_TIERS[tierIndex];
      const candidates = marketerCandidates[tierIndex] || [];
      
      list.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <button 
            onclick="showHireMarketerModal()" 
            class="btn"
            style="padding: 0.4rem 0.8rem; font-size: 0.9rem; margin-bottom: 0.5rem;"
          >
            ‚Üê Back to Tiers
          </button>
          <h3 style="margin: 0.5rem 0; color: #1f2937;">Available ${tier.name}s</h3>
          <p style="margin: 0.5rem 0; color: #6b7280; font-size: 0.9rem;">
            Select a candidate to review their details. Pool refreshes monthly.
          </p>
        </div>
        ${candidates.map(candidate => {
          const canAfford = cash >= candidate.monthlySalary;
          const hasCapacity = canHireMoreEmployees();
          
          return `
            <button 
              class="hire-btn" 
              onclick="showHireConfirmation('${candidate.id}', 'marketer', ${tierIndex});"
              ${!canAfford || !hasCapacity ? 'disabled' : ''}
              style="width: 100%; margin-bottom: 0.5rem;"
            >
              <div class="hire-btn-info">
                <div class="hire-btn-title">
                  <strong>${candidate.name}</strong>
                </div>
                <div class="hire-btn-stats">
                  ‚ö° ${Math.round(candidate.efficiency * 100)}% efficiency ‚Ä¢ üíº ${formatCurrency(candidate.monthlySalary)}/mo
                  ${!canAfford ? '<br><span style="color: #ef4444;">‚ö†Ô∏è Cannot afford</span>' : ''}
                  ${!hasCapacity ? '<br><span style="color: #ef4444;">‚ö†Ô∏è No office capacity</span>' : ''}
                </div>
              </div>
              <div class="hire-btn-cost">${formatCurrency(candidate.monthlySalary)}</div>
            </button>
          `;
        }).join('')}
        ${candidates.length === 0 ? '<div class="empty-state">No candidates available this month. Wait for next month\'s pool refresh.</div>' : ''}
      `;
    }
    
    // ============================================
    // HIRE CONFIRMATION MODAL
    // ============================================
    
    function showHireConfirmation(candidateId, role, candidateIndex) {
      // Use new candidate pool structure - directly access by index
      const candidates = role === 'developer' ? candidatePool.developers : candidatePool.marketers;
      const candidate = candidates[candidateIndex];
      
      if (!candidate) {
        console.error('Candidate not found at index:', candidateIndex, 'role:', role);
        return;
      }
      
      candidateToHire = { ...candidate, candidateIndex, role };
      
      const modal = document.getElementById('hireConfirmModal');
      
      document.getElementById('hireConfirmName').textContent = candidate.name;
      document.getElementById('hireConfirmRole').textContent = candidate.tierName;
      document.getElementById('hireConfirmEfficiency').textContent = `${Math.round(candidate.efficiency * 100)}%`;
      document.getElementById('hireConfirmSalary').textContent = `${formatCurrency(candidate.monthlySalary)}/month`;
      
      modal.classList.add('active');
    }
    
    function hideHireConfirmModal() {
      document.getElementById('hireConfirmModal').classList.remove('active');
      candidateToHire = null;
    }
    
    function confirmHireCandidate() {
      if (!candidateToHire) return;
      
      const candidate = candidateToHire;
      
      // Hide confirmation modal
      hideHireConfirmModal();
      
      // Call hireFromPool with the stored candidateIndex and role
      hireFromPool(candidate.candidateIndex, candidate.role);
    }
    
    // ============================================
    // TOGGLE TEAM SECTION
    // ============================================
    
    // Track expanded team sections to preserve state across UI updates
    let expandedTeamSections = {};
    
    function toggleTeamSection(sectionId) {
      const content = document.getElementById(sectionId);
      const toggle = document.getElementById('toggle-' + sectionId);
      
      if (content && toggle) {
        const isExpanded = content.classList.toggle('expanded');
        toggle.classList.toggle('expanded');
        
        // Save state
        expandedTeamSections[sectionId] = isExpanded;
      }
    }
    
    // ASSIGN DEVELOPER/MARKETER TO PRODUCT MODALS
    // ============================================
    
    let currentAssignProductId = null;
    
    function showAssignDeveloperModal(productId) {
      pauseGame(); // Auto-pause when opening modal
      currentAssignProductId = productId;
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      const modal = document.getElementById('assignDeveloperModal');
      const list = document.getElementById('assignDeveloperList');
      const productNameEl = document.getElementById('assignDeveloperProductName');
      
      productNameEl.textContent = `Select a developer to assign to "${product.name}"`;
      
      // Get available developers (not assigned to ANY product or R&D project)
      const availableDevelopers = [];
      
      // Founder (only show if not assigned to any product or R&D)
      const founderAssignment = getFounderAssignment();
      if (!founderAssignment) {
        availableDevelopers.push({
          id: 'founder',
          name: founder.name,
          role: 'Founder',
          efficiency: founder.efficiency,
          isFounder: true
        });
      }
      
      // Hired developers (only show if not assigned to ANY product or R&D)
      developers.forEach(dev => {
        const devAssignment = getDevAssignment(dev.id);
        if (!devAssignment) {
          availableDevelopers.push({
            id: dev.id,
            name: dev.name,
            role: dev.tierName,
            efficiency: dev.efficiency,
            isFounder: false
          });
        }
      });
      
      if (availableDevelopers.length === 0) {
        list.innerHTML = '<div class="empty-state">No available developers. All developers are currently assigned to other products or R&D projects. Unassign them first to reassign.</div>';
      } else {
        list.innerHTML = availableDevelopers.map(dev => `
          <button 
            class="hire-btn" 
            onclick="${dev.isFounder ? 'assignFounderToProduct' : 'assignEmployeeToProduct'}(${dev.isFounder ? productId : dev.id + ',' + productId}); hideAssignDeveloperModal();"
          >
            <div class="hire-btn-header">
              <span class="hire-btn-title">üë®‚Äçüíª ${dev.name}</span>
              <span class="hire-btn-role">${dev.role}</span>
            </div>
            <div class="hire-btn-details">
              <span>‚ö° Efficiency: ${Math.round(dev.efficiency * 100)}%</span>
            </div>
          </button>
        `).join('');
      }
      
      modal.classList.add('active');
    }
    
    function hideAssignDeveloperModal() {
      document.getElementById('assignDeveloperModal').classList.remove('active');
      currentAssignProductId = null;
    }
    
    function showAssignMarketerModal(productId) {
      pauseGame(); // Auto-pause when opening modal
      currentAssignProductId = productId;
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      const modal = document.getElementById('assignMarketerModal');
      const list = document.getElementById('assignMarketerList');
      const productNameEl = document.getElementById('assignMarketerProductName');
      
      productNameEl.textContent = `Select a marketer to assign to "${product.name}"`;
      
      // Get available marketers (not assigned to ANY product)
      const availableMarketers = [];
      
      // Founder (only show if not assigned to any product)
      if (founder.assignedProduct === null) {
        availableMarketers.push({
          id: 'founder',
          name: founder.name,
          role: 'Founder',
          efficiency: founder.efficiency,
          isFounder: true
        });
      }
      
      // Hired marketers (only show if not assigned to ANY product)
      marketers.forEach(mkt => {
        const isAssignedAnywhere = products.some(p => p.assignedMarketers.includes(mkt.id));
        if (!isAssignedAnywhere) {
          availableMarketers.push({
            id: mkt.id,
            name: mkt.name,
            role: mkt.tierName,
            efficiency: mkt.efficiency,
            isFounder: false
          });
        }
      });
      
      if (availableMarketers.length === 0) {
        list.innerHTML = '<div class="empty-state">No available marketers. All marketers are currently assigned to other products. Unassign them first to reassign.</div>';
      } else {
        list.innerHTML = availableMarketers.map(mkt => `
          <button 
            class="hire-btn" 
            onclick="${mkt.isFounder ? 'assignFounderToProductAsMarketer' : 'assignEmployeeToProduct'}(${mkt.isFounder ? productId : mkt.id + ',' + productId}); hideAssignMarketerModal();"
          >
            <div class="hire-btn-header">
              <span class="hire-btn-title">üì¢ ${mkt.name}</span>
              <span class="hire-btn-role">${mkt.role}</span>
            </div>
            <div class="hire-btn-details">
              <span>‚ö° Efficiency: ${Math.round(mkt.efficiency * 100)}%</span>
            </div>
          </button>
        `).join('');
      }
      
      modal.classList.add('active');
    }
    
    function hideAssignMarketerModal() {
      document.getElementById('assignMarketerModal').classList.remove('active');
      currentAssignProductId = null;
    }
    
    function canAffordOfficeUpgrade() {
      if (currentOfficeTier >= OFFICE_TIERS.length - 1) return false;
      const nextTier = OFFICE_TIERS[currentOfficeTier + 1];
      const cost = currency === "USD" ? nextTier.monthlyRentUSD * 2 : nextTier.monthlyRentEUR * 2;
      return cash >= cost;
    }
    
    function handleMonthlyBilling() {
      const month = Math.floor(currentDay / 30);
      logEvent(`üìÖ Month ${month} completed - Processing monthly billing...`);
      
      // Refresh candidate pools for new month
      refreshCandidatePools();
      
      // ============================================
      // REVENUE COLLECTION
      // ============================================
      
      // Calculate monthly revenue from all products (published and deprecated)
      let totalRevenue = 0;
      let totalServerCost = 0;
      
      products.forEach(product => {
        if (product.status === 'published' || product.status === 'deprecated') {
          const productRevenue = product.subscribers * product.monthlyPrice;
          const productServerCost = product.subscribers * product.serverCostPerUser;
          totalRevenue += productRevenue;
          totalServerCost += productServerCost;
        }
      });
      
      const netRevenue = totalRevenue - totalServerCost;
      cash += netRevenue;
      
      // Track lifetime earnings and check for milestone achievements
      const previousLifetimeEarnings = lifetimeEarnings;
      if (totalRevenue > 0) {
        lifetimeEarnings += totalRevenue;
        
        // Check if we reached a new milestone
        checkMilestoneAchievement(previousLifetimeEarnings, lifetimeEarnings);
      }
      
      // ============================================
      // EXPENSE PAYMENTS
      // ============================================
      
      // Calculate office costs
      const office = OFFICE_TIERS[currentOfficeTier];
      const teamSize = getCurrentTeamSize();
      
      const rent = currency === "USD" ? office.monthlyRentUSD : office.monthlyRentEUR;
      const utilitiesBase = currency === "USD" ? office.utilitiesBaseUSD : office.utilitiesBaseEUR;
      const utilitiesPerPerson = currency === "USD" ? office.utilitiesPerPersonUSD : office.utilitiesPerPersonEUR;
      const utilities = utilitiesBase + (utilitiesPerPerson * teamSize);
      
      // Calculate insurance (2% of gross revenue + base per employee)
      const insuranceBase = currency === "USD" ? 100 : 90;
      const insurance = (totalRevenue * 0.02) + (insuranceBase * (developers.length + marketers.length));
      
      // Calculate total salaries
      const salaries = [...developers, ...marketers].reduce((sum, emp) => sum + emp.monthlySalary, 0);
      
      // Calculate server hosting fee
      const server = SERVER_TIERS[currentServerTier];
      const serverFee = currency === "USD" ? server.monthlyFeeUSD : server.monthlyFeeEUR;
      
      // Deduct costs
      const totalCosts = rent + utilities + insurance + salaries + serverFee;
      cash -= totalCosts;
      
      // ============================================
      // CONSOLIDATED LOGGING
      // ============================================
      
      // Log revenue (consolidated)
      if (totalRevenue > 0) {
        const revenueBreakdown = [];
        if (totalRevenue > 0) revenueBreakdown.push(`Revenue: ${formatCurrency(totalRevenue)}`);
        if (totalServerCost > 0) revenueBreakdown.push(`Server Cost: ${formatCurrency(totalServerCost)}`);
        
        logEvent(`üíµ Monthly Income: ${formatCurrency(netRevenue)} (${revenueBreakdown.join(', ')})`);
      }
      
      // Log expenses (consolidated)
      const expenseBreakdown = [];
      if (rent > 0) expenseBreakdown.push(`Rent: ${formatCurrency(rent)}`);
      expenseBreakdown.push(`Utilities: ${formatCurrency(utilities)}`);
      if (insurance > 0) expenseBreakdown.push(`Insurance: ${formatCurrency(insurance)}`);
      if (salaries > 0) expenseBreakdown.push(`Salaries: ${formatCurrency(salaries)}`);
      if (serverFee > 0) expenseBreakdown.push(`Server: ${formatCurrency(serverFee)}`);
      
      logEvent(`üí∞ Monthly Expenses: ${formatCurrency(totalCosts)} (${expenseBreakdown.join(', ')})`);
      
      // Log net result
      const netResult = netRevenue - totalCosts;
      if (netResult >= 0) {
        logEvent(`‚úÖ Net Profit: ${formatCurrency(netResult)}`);
      } else {
        logEvent(`‚ö†Ô∏è Net Loss: ${formatCurrency(Math.abs(netResult))}`);
      }
      
      updateCashDisplay();
    }

    // ============================================
    // NEW GAME SETUP
    // ============================================
    
    function generateRandomCompanyName() {
      const prefix = COMPANY_PREFIXES[Math.floor(Math.random() * COMPANY_PREFIXES.length)];
      const suffix = COMPANY_SUFFIXES[Math.floor(Math.random() * COMPANY_SUFFIXES.length)];
      return `${prefix} ${suffix}`;
    }
    
    function generateRandomFounderName() {
      const firstName = FIRST_NAMES[Math.floor(Math.random() * FIRST_NAMES.length)];
      const lastName = LAST_NAMES[Math.floor(Math.random() * LAST_NAMES.length)];
      return `${firstName} ${lastName}`;
    }
    
    function populateNewGameForm() {
      document.getElementById('companyNameInput').value = generateRandomCompanyName();
      document.getElementById('founderNameInput').value = generateRandomFounderName();
    }
    
    function showGameOver() {
      // Update game over modal with final stats
      document.getElementById('gameOverDays').textContent = currentDay + ' days';
      document.getElementById('gameOverProducts').textContent = products.length;
      document.getElementById('gameOverTeam').textContent = getCurrentTeamSize();
      document.getElementById('gameOverCash').textContent = formatCurrency(cash);
      
      // Show modal
      document.getElementById('gameOverModal').classList.add('active');
    }
    
    function restartGame() {
      // Hide game over modal
      document.getElementById('gameOverModal').classList.remove('active');
      
      // Show new game setup modal
      document.getElementById('newGameModal').classList.add('active');
      
      // Populate form with random names
      populateNewGameForm();
    }
    
    // ============================================
    // SAVE/LOAD SYSTEM
    // ============================================
    
    function saveGame() {
      const saveData = {
        version: "3.0", // Updated to 3.0 for new candidate pool system
        timestamp: Date.now(),
        gameState: {
          // Game config
          currency: currency,
          currentDay: currentDay,
          cash: cash,
          lifetimeEarnings: lifetimeEarnings,
          companyName: companyName,
          isPlaying: isPlaying,
          gameSpeed: gameSpeed,
          
          // Founder
          founder: {
            name: founder.name,
            efficiency: founder.efficiency,
            skillLevel: founder.skillLevel,
            experiencePoints: founder.experiencePoints,
            assignedProduct: founder.assignedProduct
          },
          
          // Infrastructure
          currentOfficeTier: currentOfficeTier,
          currentServerTier: currentServerTier,
          
          // Entities
          products: products,
          developers: developers,
          marketers: marketers,
          
          // R&D System
          rndProjects: rndProjects,
          completedRndProjects: completedRndProjects,
          unlockedProducts: unlockedProducts,
          
          // IDs
          nextProductId: nextProductId,
          nextEmployeeId: nextEmployeeId,
          nextRndProjectId: nextRndProjectId,
          
          // UI State
          expandedTeamSections: expandedTeamSections,
          
          // Candidate Pools (OLD SYSTEM)
          developerCandidates: developerCandidates,
          marketerCandidates: marketerCandidates,
          lastCandidateRefresh: lastCandidateRefresh,
          
          // NEW Candidate Pool System
          candidatePool: candidatePool,
          
          // Event log (keep last 50 events)
          eventLog: eventLog.slice(-50)
        }
      };
      
      try {
        localStorage.setItem('softwareCompanyGame', JSON.stringify(saveData));
        logEvent("üíæ Game saved!");
        
        return true;
      } catch (e) {
        logEvent("‚ùå Failed to save game: " + e.message);
        alert("Failed to save game. Your browser might have storage disabled.");
        return false;
      }
    }
    
    function loadGame() {
      try {
        const savedData = localStorage.getItem('softwareCompanyGame');
        if (!savedData) {
          return false; // No save found
        }
        
        const save = JSON.parse(savedData);
        
        // Validate save version
        if (!save.version || !save.gameState) {
          console.error("Invalid save format");
          return false;
        }
        
        // Restore game state
        currency = save.gameState.currency;
        currentDay = save.gameState.currentDay;
        cash = save.gameState.cash;
        lifetimeEarnings = save.gameState.lifetimeEarnings || 0;
        companyName = save.gameState.companyName;
        isPlaying = save.gameState.isPlaying || false;
        gameSpeed = save.gameState.gameSpeed || 1;
        
        // Restore founder
        founder.name = save.gameState.founder.name;
        founder.efficiency = save.gameState.founder.efficiency;
        founder.skillLevel = save.gameState.founder.skillLevel;
        founder.experiencePoints = save.gameState.founder.experiencePoints;
        founder.assignedProduct = save.gameState.founder.assignedProduct;
        
        // Restore infrastructure
        currentOfficeTier = save.gameState.currentOfficeTier || 0;
        currentServerTier = save.gameState.currentServerTier || 0;
        
        // Restore entities
        products = save.gameState.products || [];
        developers = save.gameState.developers || [];
        marketers = save.gameState.marketers || [];
        
        // Migration: Add skill property to old employees if missing
        developers.forEach(dev => {
          if (!dev.skill && dev.tier !== undefined) {
            dev.skill = DEVELOPER_TIERS[dev.tier].skill;
          }
          // Migration: Add experienceMonths to old employees
          if (dev.experienceMonths === undefined) {
            dev.experienceMonths = 0;
          }
          // Migration: Add baseEfficiency to old employees (use current efficiency as baseline)
          if (dev.baseEfficiency === undefined) {
            dev.baseEfficiency = dev.efficiency || DEVELOPER_TIERS[dev.tier].efficiency;
          }
        });
        marketers.forEach(mkt => {
          if (!mkt.skill && mkt.tier !== undefined) {
            mkt.skill = MARKETER_TIERS[mkt.tier].skill;
          }
          // Migration: Add experienceMonths to old employees
          if (mkt.experienceMonths === undefined) {
            mkt.experienceMonths = 0;
          }
          // Migration: Add baseEfficiency to old employees (use current efficiency as baseline)
          if (mkt.baseEfficiency === undefined) {
            mkt.baseEfficiency = mkt.efficiency || MARKETER_TIERS[mkt.tier].efficiency;
          }
        });
        
        // Restore R&D system
        rndProjects = save.gameState.rndProjects || [];
        completedRndProjects = save.gameState.completedRndProjects || [];
        unlockedProducts = save.gameState.unlockedProducts || ['Task Manager'];
        
        // Restore IDs
        nextProductId = save.gameState.nextProductId || 1;
        nextEmployeeId = save.gameState.nextEmployeeId || 1;
        nextRndProjectId = save.gameState.nextRndProjectId || 1;
        
        // Restore UI state
        expandedTeamSections = save.gameState.expandedTeamSections || {};
        
        // Restore candidate pools (OLD SYSTEM)
        developerCandidates = save.gameState.developerCandidates || {};
        marketerCandidates = save.gameState.marketerCandidates || {};
        lastCandidateRefresh = save.gameState.lastCandidateRefresh || 0;
        
        // If no candidate pools exist, generate them
        if (Object.keys(developerCandidates).length === 0) {
          refreshCandidatePools();
        }
        
        // Restore NEW candidate pool system
        if (save.gameState.candidatePool) {
          candidatePool = save.gameState.candidatePool;
        } else {
          // Old save without new system, initialize it
          candidatePool = {
            developers: [],
            marketers: [],
            lastRefreshDay: currentDay
          };
          generateCandidatePool();
        }
        
        // Restore event log
        eventLog = save.gameState.eventLog || [];
        
        // Update UI
        document.getElementById('companyNameDisplay').textContent = companyName;
        updateCashDisplay();
        updateDayDisplay();
        updateFounderDisplay();
        updateProductsUI();
        updateRndUI();
        updateEmployeesUI();
        updateFinancesUI();
        updateEventLog();
        updateSpeedButtons();
        
        // Pause state is shown by pause button color (yellowish)
        
        logEvent("üìÇ Game loaded successfully!");
        
        const saveDate = new Date(save.timestamp);
        logEvent(`üíæ Last saved: ${saveDate.toLocaleString()}`);
        
        return true;
      } catch (e) {
        console.error("Failed to load game:", e);
        logEvent("‚ùå Failed to load saved game");
        return false;
      }
    }
    
    function resetGameWithConfirmation() {
      // Pause game first
      pauseGame();
      
      // Confirm reset
      const message = "üîÑ Reset Game?\n\nThis will delete your current progress and start a new game.\n\nCurrent Progress:\n" +
                     "‚Ä¢ Day " + currentDay + "\n" +
                     "‚Ä¢ Cash: " + formatCurrency(cash) + "\n" +
                     "‚Ä¢ Products: " + products.length + "\n" +
                     "‚Ä¢ Team: " + getCurrentTeamSize() + " people\n\n" +
                     "Are you sure?";
      
      if (confirm(message)) {
        // Clear save
        try {
          localStorage.removeItem('softwareCompanyGame');
        } catch (e) {
          console.error("Failed to clear save:", e);
        }
        
        // Show new game modal
        document.getElementById('newGameModal').classList.add('active');
        populateNewGameForm();
        
        logEvent("üîÑ Game reset. Starting fresh...");
      } else {
        // User cancelled, resume if it was playing
        logEvent("‚ùå Reset cancelled");
      }
    }
    
    function initNewGame() {
      const form = document.getElementById('newGameForm');
      const companyNameInput = document.getElementById('companyNameInput');
      const founderNameInput = document.getElementById('founderNameInput');
      const selectedCurrency = document.querySelector('input[name="currency"]:checked').value;
      const selectedCapital = parseInt(document.querySelector('input[name="capital"]:checked').value);

      // Set game state
      companyName = companyNameInput.value || "My Startup";
      founder.name = founderNameInput.value || "Founder";
      founder.efficiency = 1.0;
      founder.skillLevel = 1;
      founder.experiencePoints = 0;
      founder.assignedProduct = null;
      currency = selectedCurrency;
      cash = selectedCapital;
      currentDay = 0;

      // Update UI
      document.getElementById('companyNameDisplay').textContent = companyName;
      updateCashDisplay();
      updateDayDisplay();
      updateFounderDisplay();

      // Reset game state
      products = [];
      developers = [];
      marketers = [];
      nextEmployeeId = 1;
      nextProductId = 1;
      currentOfficeTier = 0; // Start with Home Office
      currentServerTier = 0; // Start with Shared Hosting (free)
      eventLog = [];
      expandedTeamSections = {}; // Reset UI state
      lifetimeEarnings = 0; // Reset lifetime earnings
      
      // Reset R&D system
      rndProjects = [];
      completedRndProjects = [];
      unlockedProducts = ['Task Manager']; // Only Task Manager unlocked at start
      nextRndProjectId = 1;
      
      // Initialize candidate pools (OLD SYSTEM - keeping for compatibility)
      developerCandidates = {};
      marketerCandidates = {};
      lastCandidateRefresh = 0;
      refreshCandidatePools();
      
      // Initialize NEW candidate pool system
      candidatePool.developers = [];
      candidatePool.marketers = [];
      candidatePool.lastRefreshDay = 0;
      generateCandidatePool(); // Generate initial pool based on startup milestone
      
      // Log start
      logEvent(`üéâ ${companyName} founded by ${founder.name}!`);
      logEvent(`üí∞ Starting with ${formatCurrency(cash)}`);
      logEvent(`üè¢ Working from ${OFFICE_TIERS[0].name} (capacity: ${OFFICE_TIERS[0].capacity})`);
      logEvent(`üñ•Ô∏è Server: ${SERVER_TIERS[0].name} (free tier)`);
      
      // Initialize UI
      updateFounderDisplay();
      updateProductsUI();
      updateRndUI();
      updateEmployeesUI();
      updateFinancesUI();

      // Close modal
      document.getElementById('newGameModal').classList.remove('active');

      // Start game paused (pause state shown by yellowish pause button)
      isPlaying = false;
      updateSpeedButtons();
      logEvent(`‚è∏Ô∏è Game paused. Press Space or click Play to start!`);
      
      // Save initial game state
      saveGame();
    }

    // Make functions globally accessible for onclick handlers
    window.assignFounderToProduct = assignFounderToProduct;
    window.assignFounderToProductAsMarketer = assignFounderToProductAsMarketer;
    window.unassignFounderFromProduct = unassignFounderFromProduct;
    window.assignEmployeeToProduct = assignEmployeeToProduct;
    window.unassignEmployeeFromProduct = unassignEmployeeFromProduct;
    window.hireDeveloper = hireDeveloper;
    window.hireMarketer = hireMarketer;
    window.hireFromPool = hireFromPool; // NEW: Hire directly from candidate pool
    window.showHireConfirmation = showHireConfirmation;
    window.confirmHireCandidate = confirmHireCandidate;
    window.hideHireConfirmModal = hideHireConfirmModal;
    window.showUpgradeOfficeModal = showUpgradeOfficeModal;
    window.hideUpgradeOfficeModal = hideUpgradeOfficeModal;
    window.confirmUpgradeOffice = confirmUpgradeOffice;
    window.showDowngradeOfficeModal = showDowngradeOfficeModal;
    window.hideDowngradeOfficeModal = hideDowngradeOfficeModal;
    window.confirmDowngradeOffice = confirmDowngradeOffice;
    window.upgradeServer = upgradeServer;
    window.showHireDeveloperModal = showHireDeveloperModal;
    window.hideHireDeveloperModal = hideHireDeveloperModal;
    window.showHireMarketerModal = showHireMarketerModal;
    window.hideHireMarketerModal = hideHireMarketerModal;
    window.showAssignDeveloperModal = showAssignDeveloperModal;
    window.hideAssignDeveloperModal = hideAssignDeveloperModal;
    window.showPromotionModal = showPromotionModal;
    window.hidePromotionModal = hidePromotionModal;
    window.makePromotionOffer = makePromotionOffer;
    window.showAssignMarketerModal = showAssignMarketerModal;
    window.hideAssignMarketerModal = hideAssignMarketerModal;
    window.generateRandomCompanyName = generateRandomCompanyName;
    window.generateRandomFounderName = generateRandomFounderName;
    window.restartGame = restartGame;

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      // Try to load existing save
      const saveLoaded = loadGame();
      
      if (saveLoaded) {
        // Hide new game modal if save was loaded
        document.getElementById('newGameModal').classList.remove('active');
        logEvent("üéÆ Welcome back to " + companyName + "!");
      } else {
        // No save found, show new game modal with random names
        populateNewGameForm();
      }
      
      // Speed controls
      document.getElementById('pauseBtn').addEventListener('click', () => pauseGame());
      document.getElementById('playBtn').addEventListener('click', () => { setGameSpeed(1); startGame(); });
      document.getElementById('speed2xBtn').addEventListener('click', () => { setGameSpeed(2); startGame(); });
      document.getElementById('speed5xBtn').addEventListener('click', () => { setGameSpeed(5); startGame(); });

      // Game controls
      document.getElementById('saveBtn').addEventListener('click', () => saveGame());
      document.getElementById('resetBtn').addEventListener('click', () => resetGameWithConfirmation());

      // New game setup
      document.getElementById('startGameBtn').addEventListener('click', () => initNewGame());

      // Phase 2: Product system
      document.getElementById('newProductBtn').addEventListener('click', () => showNewProductModal());
      document.getElementById('cancelProductBtn').addEventListener('click', () => hideNewProductModal());
      document.getElementById('createProductBtn').addEventListener('click', () => handleCreateProduct());
      
      // R&D system
      document.getElementById('newRndBtn').addEventListener('click', () => showNewRndModal());
      
      // Keyboard controls
      document.addEventListener('keydown', (event) => {
        // Spacebar to play/pause
        if (event.code === 'Space' || event.key === ' ') {
          // Don't trigger if user is typing in an input field or modal is open
          const newGameModal = document.getElementById('newGameModal');
          const activeElement = document.activeElement;
          const isTyping = activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA';
          const isModalOpen = newGameModal.classList.contains('active');
          
          if (!isTyping && !isModalOpen) {
            event.preventDefault(); // Prevent page scroll
            
            if (isPlaying) {
              pauseGame();
            } else {
              startGame();
            }
          }
        }
      });
      
      // Mobile navigation functions
      setupMobileNavigation();
    });
    
    // ============================================
    // MOBILE NAVIGATION
    // ============================================
    function scrollToPanel(index) {
      const container = document.querySelector('.main-container');
      const panels = container.querySelectorAll('.panel');
      
      if (panels[index]) {
        panels[index].scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'start' });
        updateMobileNavActive(index);
      }
    }
    
    function updateMobileNavActive(index) {
      const buttons = document.querySelectorAll('.mobile-nav-btn');
      buttons.forEach((btn, i) => {
        if (i === index) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }
    
    function setupMobileNavigation() {
      const container = document.querySelector('.main-container');
      if (!container) return;
      
      // Note: Swiping between panels is disabled (overflow-x: hidden)
      // Users can only navigate using the bottom navigation buttons
      // The scroll event listener below won't fire since scrolling is disabled
      let scrollTimeout;
      container.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          const containerWidth = container.offsetWidth;
          const scrollLeft = container.scrollLeft;
          const currentIndex = Math.round(scrollLeft / containerWidth);
          updateMobileNavActive(currentIndex);
        }, 100);
      });
    }
    
    // ============================================
    // TESTING & DEBUG UTILITIES (Phase 7)
    // ============================================
    
    // Test save/load system with candidate pool
    function testSaveLoad() {
      console.log('=== Save/Load Test ===');
      console.log('Before save:');
      console.log('  Lifetime Earnings:', lifetimeEarnings);
      console.log('  Candidate Pool Developers:', candidatePool.developers.length);
      console.log('  Candidate Pool Marketers:', candidatePool.marketers.length);
      console.log('  Last Refresh Day:', candidatePool.lastRefreshDay);
      console.log('  Current Milestone:', getCurrentMilestone().name);
      
      const beforeSave = {
        lifetimeEarnings: lifetimeEarnings,
        devPoolSize: candidatePool.developers.length,
        marketerPoolSize: candidatePool.marketers.length,
        lastRefresh: candidatePool.lastRefreshDay,
        milestone: getCurrentMilestone().name
      };
      
      // Save
      const saved = saveGame();
      if (!saved) {
        console.error('Save failed!');
        return;
      }
      console.log('‚úÖ Save successful');
      
      // Modify state
      lifetimeEarnings += 50000;
      candidatePool.developers = [];
      console.log('Modified state (lifetime earnings +50000, cleared dev pool)');
      
      // Load
      const loaded = loadGame();
      if (!loaded) {
        console.error('Load failed!');
        return;
      }
      console.log('‚úÖ Load successful');
      
      console.log('After load:');
      console.log('  Lifetime Earnings:', lifetimeEarnings);
      console.log('  Candidate Pool Developers:', candidatePool.developers.length);
      console.log('  Candidate Pool Marketers:', candidatePool.marketers.length);
      console.log('  Last Refresh Day:', candidatePool.lastRefreshDay);
      console.log('  Current Milestone:', getCurrentMilestone().name);
      
      // Verify
      const afterLoad = {
        lifetimeEarnings: lifetimeEarnings,
        devPoolSize: candidatePool.developers.length,
        marketerPoolSize: candidatePool.marketers.length,
        lastRefresh: candidatePool.lastRefreshDay,
        milestone: getCurrentMilestone().name
      };
      
      const passed = 
        beforeSave.lifetimeEarnings === afterLoad.lifetimeEarnings &&
        beforeSave.devPoolSize === afterLoad.devPoolSize &&
        beforeSave.marketerPoolSize === afterLoad.marketerPoolSize &&
        beforeSave.lastRefresh === afterLoad.lastRefresh;
      
      if (passed) {
        console.log('‚úÖ Save/Load test PASSED - all data preserved correctly!');
      } else {
        console.error('‚ùå Save/Load test FAILED - data mismatch!');
        console.log('Before:', beforeSave);
        console.log('After:', afterLoad);
      }
      
      updateAllUI();
    }
    
    // Test milestone progression
    function testMilestoneProgression() {
      console.log('=== Milestone Progression Test ===');
      console.log('Current:', lifetimeEarnings, '-', getCurrentMilestone().name);
      
      HIRING_MILESTONES.forEach((milestone, index) => {
        console.log(`${index + 1}. ${milestone.badge} ${milestone.name} (${formatCurrency(milestone.threshold)})`);
        console.log(`   ${milestone.description}`);
      });
      
      console.log('\nTo test milestone unlocks, run:');
      console.log('lifetimeEarnings = 100000; checkMilestoneAchievement(0, lifetimeEarnings); updateFinancesUI();');
    }
    
    // Test candidate pool generation
    function testCandidatePool() {
      console.log('=== Candidate Pool Test ===');
      console.log('Generating new candidate pool...');
      generateCandidatePool();
      
      console.log('\nDevelopers:');
      candidatePool.developers.forEach((c, i) => {
        console.log(`${i + 1}. ${c.name} (${c.tierName}) - ${Math.round(c.efficiency * 100)}% efficiency, ${formatCurrency(c.monthlySalary)}/mo`);
      });
      
      console.log('\nMarketers:');
      candidatePool.marketers.forEach((c, i) => {
        console.log(`${i + 1}. ${c.name} (${c.tierName}) - ${Math.round(c.efficiency * 100)}% efficiency, ${formatCurrency(c.monthlySalary)}/mo`);
      });
      
      console.log('\nLast refresh day:', candidatePool.lastRefreshDay);
      console.log('Current milestone:', getCurrentMilestone().name);
    }
    
    // Expose test functions globally for console access
    window.testSaveLoad = testSaveLoad;
    window.testMilestoneProgression = testMilestoneProgression;
    window.testCandidatePool = testCandidatePool;
    
    console.log('üß™ Debug utilities loaded!');
    console.log('Available test functions:');
    console.log('  - testSaveLoad()');
    console.log('  - testMilestoneProgression()');
    console.log('  - testCandidatePool()');
  </script>
</body>
</html>
