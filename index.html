<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Software Company Simulator</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress Tailwind CDN production warning (appropriate for single-file application)
    const originalConsoleWarn = console.warn;
    console.warn = function(...args) {
      if (args[0]?.includes?.('cdn.tailwindcss.com should not be used in production')) {
        return; // Suppress this specific warning
      }
      originalConsoleWarn.apply(console, args);
    };
    
    // Configure Tailwind
    tailwind.config = {
      theme: {
        extend: {}
      }
    }
  </script>
  
  <!-- Lucide Icons (for consistent iconography) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* ============================================ */
    /* SOFTWARE COMPANY SIMULATOR - STYLES */
    /* Version 2.0 | Phase 1-2: Core + Products */
    /* ============================================ */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f9fafb;
      color: #111827;
      line-height: 1.6;
      padding-top: 130px;
      user-select: none;
    }
    
    /* Pause Border Overlay */
    .pause-border-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 9999;
      border: 3px solid #fbbf24;
      box-shadow: inset 0 0 0 2px rgba(251, 191, 36, 0.3);
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    
    .pause-border-overlay.active {
      opacity: 1;
    }
    
    /* Header Wrapper - Fixed Container */
    .header-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* Header */
    .header {
      background: linear-gradient(to right, #2563eb, #1d4ed8);
      color: white;
      padding: 1rem 1.5rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .header-controls {
      background: #1e40af;
      color: white;
      padding: 0.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .header-right {
      text-align: right;
    }
    
    .company-name {
      font-size: 1.25rem;
      font-weight: bold;
    }
    
    .day-counter {
      font-size: 0.875rem;
      color: #bfdbfe;
    }
    
    .day-counter small {
      font-size: inherit;
    }
    
    .cash-display {
      font-size: 1.75rem;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      color: white;
      background: none;
      padding: 0;
    }
    
    .cash-display.green, 
    .cash-display.yellow, 
    .cash-display.red, 
    .cash-display.flashing-red { 
      background: none;
      color: white;
    }
    
    .next-billing-info {
      font-size: 0.875rem;
      text-align: right;
      margin-top: 0.25rem;
      padding: 0;
      border-radius: 0;
      color: #6ee7b7;
      font-weight: 600;
    }
    
    .next-billing-info .cash-flow-positive {
      color: #6ee7b7;
      font-weight: 700;
    }
    
    .next-billing-info .cash-flow-negative {
      color: #fca5a5;
      font-weight: 700;
    }
    
    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    /* Filter Pills */
    .filter-container {
      background: white;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .filter-pills {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .filter-pill {
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .filter-pill:not(.active) {
      background: #f3f4f6;
      color: #374151;
    }
    
    .filter-pill:not(.active):hover {
      background: #e5e7eb;
    }
    
    /* Default active state - blue background with white text (for employee filters) */
    .filter-pill.active {
      background: #2563eb;
      color: white;
    }
    
    /* Product filter specific colors (override default blue) */
    .filter-pill.active[data-filter="in_development"] {
      background: #d97706;
      color: white;
    }
    
    .filter-pill.active[data-filter="published"],
    .filter-pill.active[data-filter="live"] {
      background: #059669;
      color: white;
    }
    
    .filter-pill.active[data-filter="deprecated"] {
      background: #dc2626;
      color: white;
    }
    
    /* Employee filter specific colors */
    .filter-pill.active[data-filter="marketer"] {
      background: #8b5cf6; /* Purple - matches marketer hire button */
      color: white;
    }
    
    .filter-pill.active[data-filter="unassigned"] {
      background: #dc2626; /* Red - indicates action needed */
      color: white;
    }
    
    .filter-pill.active[data-filter="promotion"] {
      background: #059669; /* Green - indicates ready/positive state */
      color: white;
    }
    
    /* Notification System */
    .notification-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    
    .notification {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-size: 0.95rem;
      font-weight: 600;
      min-width: 300px;
      max-width: 500px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideDown 0.3s ease-out, slideUp 0.3s ease-in 2.7s forwards;
      pointer-events: auto;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .notification.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .notification.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .notification-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .notification-text {
      flex: 1;
    }
    
    /* Removed duplicate slideDown - using the one below that accounts for centering */
    
    @media (max-width: 1024px) {
      .notification {
        min-width: 250px;
        max-width: 90vw;
        font-size: 0.85rem;
        padding: 0.75rem 1rem;
      }
      
      .notification-icon {
        font-size: 1.25rem;
      }
      
      .notification-container {
        top: 10px;
      }
    }
    
    .founder-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      font-size: 0.9rem;
      cursor: help;
    }
    
    .speed-controls {
      display: flex;
      gap: 0.5rem;
    }
    
    .speed-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    
    .speed-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .speed-btn.active {
      background: rgba(255,255,255,0.4);
    }
    
    /* Yellowish highlight for pause button when game is paused */
    #pauseBtn.active {
      background: #fef3c7;
      color: #78350f;
    }
    
    #pauseBtn.active:hover {
      background: #fde68a;
      border-color: #fbbf24;
    }
    
    .game-controls {
      display: flex;
      gap: 0.5rem;
    }
    
    .game-ctrl-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .game-ctrl-btn:hover {
      background: rgba(255,255,255,0.35);
      transform: translateY(-1px);
    }
    
    .game-ctrl-btn:active {
      transform: translateY(0);
    }
    
    .reset-btn {
      background: rgba(239, 68, 68, 0.3);
    }
    
    .reset-btn:hover {
      background: rgba(239, 68, 68, 0.5);
    }
    
    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      padding: 1rem;
      max-width: 1800px;
      margin: 0 auto;
    }
    
    /* Mobile Navigation */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      z-index: 999;
      padding: 0.5rem;
    }
    
    .mobile-nav-buttons {
      display: flex;
      justify-content: space-around;
      gap: 0.5rem;
    }
    
    .mobile-nav-btn {
      flex: 1;
      padding: 0.6rem 0.5rem;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      min-width: 0;
    }
    
    .mobile-nav-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    
    .mobile-nav-btn {
      position: relative;
    }
    
    .nav-notification-dot {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 10px;
      height: 10px;
      background: #ef4444;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);
      animation: pulse-notification 2s ease-in-out infinite;
    }
    
    @keyframes pulse-notification {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }
    
    /* Mobile Styles */
    @media (max-width: 1024px) {
      body {
        padding-top: 70px;
        padding-bottom: 70px;
      }
      
      /* Much smaller header on mobile */
      .header {
        padding: 0.75rem 1rem 1rem;
      }
      
      .header-left {
        gap: 0.15rem;
      }
      
      .company-name {
        font-size: 1rem;
      }
      
      .day-counter {
        font-size: 0.75rem;
      }
      
      .cash-display {
        font-size: 1.25rem;
      }
      
      .next-billing-info {
        font-size: 0.75rem;
        margin-top: 0.15rem;
      }
      
      .filter-pill {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
      }
      
      /* Product cards on mobile */
      .product-card-header {
        padding: 0.45rem;
      }
      
      .product-name {
        font-size: 0.7rem;
      }
      
      .product-status {
        font-size: 0.55rem;
        padding: 0.1rem 0.3rem;
      }
      
      .product-stats {
        gap: 0.5rem;
        font-size: 0.8rem;
      }
      
      .product-stat-icon {
        font-size: 0.9rem;
      }
      
      .product-details {
        padding: 0.75rem;
      }
      
      .product-detail-row {
        font-size: 0.8rem;
        padding: 0.3rem 0;
      }
      
      .header-controls {
        padding: 0.3rem 0.75rem;
      }
      
      .speed-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
      }
      
      .game-ctrl-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
      }
      
      /* Swipeable panels */
      .main-container {
        display: flex;
        overflow-x: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        gap: 0;
        padding: 0;
        margin: 0;
        width: 100vw;
        scrollbar-width: none;
      }
      
      .main-container::-webkit-scrollbar {
        display: none;
      }
      
      .panel {
        min-width: 100vw;
        scroll-snap-align: start;
        border-radius: 0;
        margin-top: 8.5vh;
        /* Dynamic height based on header + bottom nav + margin */
        height: calc(100vh - var(--header-height, 140px) - 70px);
        overflow-y: auto;
        padding: 1.5rem 0.5rem 1rem 0.5rem;
      }
      
      /* Hide desktop event log on mobile (it becomes its own panel) */
      #desktopEventLogWrapper {
        display: none !important;
      }
      
      /* Show mobile navigation */
      .mobile-nav {
        display: block;
      }
      
      /* Hide some controls on very small screens */
      @media (max-width: 640px) {
        .header-left {
          font-size: 0.85rem;
        }
        
        .speed-btn span {
          display: none;
        }
      }
    }
    
    
    /* Panels */
    .panel {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .panel-header {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.75rem;
      padding-bottom: 0.4rem;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Buttons */
    .btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.5rem 0.85rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.2s;
    }
    
    .btn:hover {
      background: #1d4ed8;
    }
    
    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .btn-success {
      background: #10b981;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-danger {
      background: #ef4444;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-sm {
      padding: 0.35rem 0.75rem;
      font-size: 0.85rem;
    }
    
    /* Pause Banner */
    /* Pause banner removed - pause state now shown by pause button color */
    .pause-banner {
      display: none !important;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-100%);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-100%);
      }
    }
    
    /* Event Log */
    .event-log {
      background: white;
      border-radius: 8px;
      padding: 0.75rem;
      margin-top: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      height: 120px;
      overflow-y: auto;
    }
    
    .event-log h3 {
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
      color: #6b7280;
    }
    
    .event {
      padding: 0.18rem 0;
      font-size: 0.7rem;
      color: #374151;
      line-height: 1.25;
    }

    .hire-btn-role{
      font-size: 0.6rem;
      background: lightblue;
      border-radius: 4px;
      padding: 4px;
    }
    
    .hire-btn-details{
      font-size: 0.7rem;
      color: #6b7280;
    }

    .cash-flow-positive{
      color: #0fc98b;
    }

    .cash-flow-negative{
      color: #f87171;
    }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      padding: 0.8rem;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px rgba(0,0,0,0.3);
      position: relative;
      top: -45px;
    }
    
    .modal-header {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      text-align: center;
      color: #2563eb;
      border-radius: 8px;
    }
    
    .modal-body {
      margin-bottom: 0.8rem;
    }
    
    .modal-footer {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    
    /* Team Penalty Question Mark */
    .team-penalty-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 0.65rem;
      font-weight: bold;
      cursor: pointer;
      margin-left: 0.25rem;
      transition: all 0.2s;
      border: 1.5px solid;
    }
    
    .team-penalty-icon:hover {
      transform: scale(1.15);
    }
    
    .team-penalty-icon.grey {
      background: #f3f4f6;
      color: #6b7280;
      border-color: #d1d5db;
    }
    
    .team-penalty-icon.orange {
      background: #fed7aa;
      color: #c2410c;
      border-color: #fb923c;
    }
    
    .team-penalty-icon.red {
      background: #fecaca;
      color: #991b1b;
      border-color: #ef4444;
    }
    
    /* Team Penalty Popup Overlay */
    .penalty-popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2000;
      cursor: pointer;
    }
    
    .penalty-popup-overlay.active {
      display: block;
    }
    
    /* Team Penalty Popup */
    .penalty-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      color: white;
      padding: 1.5rem 2rem;
      border-radius: 12px;
      z-index: 2001;
      text-align: center;
      min-width: 280px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      pointer-events: none;
      animation: fadeInScale 0.2s ease-out;
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    .penalty-popup-title {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 0.75rem;
    }
    
    .penalty-popup-message {
      font-size: 0.85rem;
      opacity: 0.9;
      line-height: 1.4;
    }
    
    .form-group {
      margin-bottom: 0.8rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.35rem;
      font-weight: 600;
      font-size: 0.9rem;
      color: #374151;
    }
    
    .form-group input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #2563eb;
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .radio-option:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }
    
    .radio-option input[type="radio"] {
      margin-right: 0.75rem;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .radio-option-content {
      flex: 1;
    }
    
    .radio-option-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .radio-option-desc {
      font-size: 0.85rem;
      color: #6b7280;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 1rem;
      color: #9ca3af;
      font-size: 0.85rem;
    }
    
    /* Loading state */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }
    
    /* ============================================ */
    /* PHASE 2: PRODUCT SYSTEM STYLES */
    /* ============================================ */
    
    /* Product Cards */
    .product-card {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      background: white;
      overflow: hidden;
    }
    
    .product-card-header {
      padding: 0.45rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .product-header-left {
      flex: 1;
      min-width: 0;
    }
    
    .product-title-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }
    
    .product-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .product-status {
      padding: 0.125rem 0.4rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
      font-weight: 500;
      flex-shrink: 0;
    }
    
    .status-dev {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    
    .status-published {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    
    .status-deprecated {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    
    .status-employee {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      margin-left: auto;
    }
    
    .product-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 0.7rem;
      font-size: 0.875rem;
    }
    
    .product-stat {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      color: #374151;
    }
    
    .product-stat-icon {
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .product-stat-value {
      font-weight: 500;
    }
    
    .product-stat-label {
      color: #6b7280;
    }
    
    .product-expand-icon {
      flex-shrink: 0;
      color: #9ca3af;
      font-size: 1.25rem;
      line-height: 1;
      transition: transform 0.3s ease-in-out;
    }
    
    .product-details {
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      padding: 0 1rem;
      transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
    }
    
    .product-details.expanded {
      max-height: 2000px;
      opacity: 1;
      padding: 0.8rem;
    }
    
    .product-info {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }
    
    .product-info strong {
      color: #111827;
    }
    
    .product-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.375rem 0;
      font-size: 0.875rem;
    }
    
    .product-detail-label {
      color: #6b7280;
    }
    
    .product-detail-value {
      font-weight: 500;
      color: #111827;
    }
    
    .progress-bar {
      width: 100%;
      height: 18px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin: 0.3rem 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .lifetime-indicator {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      line-height: 1.3;
    }
    
    .lifetime-green {
      background: #d1fae5;
      color: #065f46;
    }
    
    .lifetime-yellow {
      background: #fef3c7;
      color: #92400e;
    }
    
    .lifetime-orange {
      background: #fed7aa;
      color: #9a3412;
    }
    
    .lifetime-red {
      background: #fee2e2;
      color: #991b1b;
    }
    
    /* Product Template Selection */
    .product-template {
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.35rem 0.5rem;
      margin-bottom: 0.35rem;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .product-template:hover {
      border-color: #93c5fd;
      background: #f0f9ff;
      box-shadow: 0 1px 4px rgba(37, 99, 235, 0.15);
    }
    
    .product-template input[type="radio"] {
      margin-top: 0.1rem;
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: #2563eb;
      flex-shrink: 0;
    }
    
    .product-template:has(input[type="radio"]:checked) {
      border-color: #2563eb;
      background: #eff6ff;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .product-template:has(input[type="radio"]:checked) .template-name {
      color: #2563eb;
    }
    
    .product-template.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .product-template.disabled:hover {
      border-color: #d1d5db;
      background: #f3f4f6;
      box-shadow: none;
    }
    
    .product-template.disabled input[type="radio"] {
      cursor: not-allowed;
    }
    
    .template-content {
      flex: 1;
    }
    
    .template-name {
      font-weight: 600;
      font-size: 0.875rem;
      color: #111827;
      margin-bottom: 0.2rem;
      line-height: 1.2;
    }
    
    .template-details {
      font-size: 0.7rem;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.2rem;
    }
    
    .template-detail {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      white-space: nowrap;
    }
    
    .template-description {
      font-size: 0.7rem;
      color: #9ca3af;
      font-style: italic;
      margin-top: 0;
      line-height: 1.2;
    }
    
    .scrollable-list {
      max-height: 55vh;
      overflow-y: auto;
      padding-right: 0.5rem;
    }
    
    .scrollable-list::-webkit-scrollbar {
      width: 8px;
    }
    
    .scrollable-list::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    .scrollable-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    .scrollable-list::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .modal-intro {
      color: #6b7280;
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 3px solid #2563eb;
    }
    
    /* ============================================ */
    /* EMPLOYEE SYSTEM - Phase 3 */
    /* ============================================ */
    
    /* Employee Cards */
    .employee-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
    }
    
    .employee-card:hover {
      border-color: #2563eb;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }
    
    /* Selectable Employee Cards (for assignment modals with checkboxes) */
    .employee-card-selectable {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .employee-card-selectable:hover {
      border-color: #2563eb;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }
    
    .employee-card-selectable.selected {
      border-color: #2563eb;
      background: #eff6ff;
    }
    
    .employee-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
      accent-color: #2563eb;
    }
    
    .employee-card-info {
      flex: 1;
      min-width: 0;
    }
    
    /* Assigned Person Cards (in product assignment sections) */
    .assigned-person-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      padding: 0.25rem 0.5rem;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.7rem;
      min-width: 60%;
    }
    
    .assigned-person-name {
      color: #374151;
      font-weight: 500;
    }
    
    .person-role {
      color: #6b7280;
      font-weight: 400;
      font-size: 0.75rem;
    }
    
    .unassign-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.2rem 0.4rem;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: bold;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .unassign-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }
    
    .add-person-btn {
      background: white;
      color: #2563eb;
      border: 2px dashed #93c5fd;
      border-radius: 6px;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .add-person-btn:hover {
      background: #eff6ff;
      border-color: #2563eb;
      transform: translateY(-1px);
    }
    
    .team-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      padding: 0.3rem 0.4rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .team-section-header:hover {
      background: rgba(0,0,0,0.05);
    }
    
    .team-section-title {
      font-weight: bold;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .team-count {
      background: rgba(0,0,0,0.1);
      padding: 0.1rem 0.4rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .team-count.warning {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .team-toggle {
      font-size: 0.75rem;
      color: #6b7280;
      transition: transform 0.2s;
    }
    
    .team-toggle.expanded {
      transform: rotate(180deg);
    }
    
    .team-section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.15s ease-out;
    }
    
    .team-section-content.expanded {
      max-height: 1000px;
      transition: max-height 0.3s ease-in;
    }
    
    .employee-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }
    
    .employee-name {
      font-weight: bold;
      font-size: 0.9rem;
      color: #111827;
      margin-right: 0.5rem;
    }
    
    .employee-role {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .role-developer {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .role-marketer {
      background: #fce7f3;
      color: #be185d;
    }
    
    .employee-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.3rem;
      font-size: 0.75rem;
      color: #6b7280;
    }
    
    .employee-stat {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .skill-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .skill-junior { background: #fef3c7; color: #92400e; }
    .skill-intermediate { background: #dbeafe; color: #1e40af; }
    .skill-senior { background: #d1fae5; color: #065f46; }
    .skill-lead { background: #e9d5ff; color: #6b21a8; }
    .skill-expert { background: #fecaca; color: #991b1b; }
    
    .employee-assignment {
      font-size: 0.7rem;
      color: #9ca3af;
      padding: 0.25rem 0.35rem;
      background: #f9fafb;
      border-radius: 4px;
    }
    
    .assignment-active {
      color: #2563eb;
      background: #eff6ff;
      font-weight: 500;
    }
    
    .hire-section {
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .hire-section h3 {
      margin: 0 0 0.75rem 0;
      color: #374151;
      font-size: 1rem;
    }
    
    .hire-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .hire-btn {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.4rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .hire-btn:hover:not(:disabled) {
      border-color: #2563eb;
      background: #eff6ff;
      transform: translateY(-1px);
    }
    
    .hire-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .hire-btn-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .hire-btn-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #111827;
    }
    
    .hire-btn-stats {
      font-size: 0.8rem;
      color: #6b7280;
    }
    
    .hire-btn-cost {
      font-weight: bold;
      font-size: 0.95rem;
      color: #059669;
    }
    
    /* Office Info */
    .office-info {
      /*background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      */
    }
    
    .office-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    
    .office-info-left {
      flex: 1;
    }
    
    .office-actions {
      display: flex;
      gap: 0.35rem;
      margin-left: 0.5rem;
    }
    
    .office-name {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 0.35rem;
      color: #111827;
    }
    
    .office-stats {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.75rem;
      color: #6b7280;
    }
    
    .office-stat-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    
    .office-upgrade-section {
      border-top: 1px solid #e5e7eb;
    }
    
    .office-upgrade-btn {
      padding: 0.35rem 0.6rem;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      color: #4b5563;
      font-weight: 600;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    
    .office-upgrade-btn.upgrade {
      background: #d1fae5;
      border-color: #a7f3d0;
      color: #065f46;
    }
    
    .office-upgrade-btn.upgrade:hover:not(:disabled) {
      background: #a7f3d0;
      border-color: #6ee7b7;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }
    
    .office-upgrade-btn.downgrade {
      background: #fee2e2;
      border-color: #fecaca;
      color: #991b1b;
    }
    
    .office-upgrade-btn.downgrade:hover:not(:disabled) {
      background: #fecaca;
      border-color: #fca5a5;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
    }
    
    .office-upgrade-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
      color: #9ca3af;
      border-color: #e5e7eb;
    }
    
    .office-upgrade-details {
      background: #f9fafb;
      border-radius: 6px;
      padding: 0.5rem;
      font-size: 0.75rem;
      min-height: 5rem;
    }
    
    .upgrade-detail {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.15rem 0;
      color: #6b7280;
      font-size: 0.7rem;
      line-height: 1.4;
    }
    
    .upgrade-detail span:last-child {
      text-align: right;
    }
    
    .upgrade-detail strong {
      color: #111827;
      font-weight: 600;
    }
    
    /* ============================================ */
    /* FINANCES PANEL */
    /* ============================================ */
    
    .finance-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      padding: 0.75rem;
      transition: all 0.2s;
    }
    
    .finance-header {
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
      padding-bottom: 0.35rem;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .finance-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3rem 0;
      font-size: 0.85rem;
    }
    
    .finance-row-sub {
      font-size: 0.75rem;
      color: #6b7280;
      padding-left: 0.5rem;
      margin-top: -0.15rem;
      line-height: 1.3;
    }
    
    .finance-value {
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .finance-value.positive {
      color: #10b981;
    }
    
    .finance-value.negative {
      color: #ef4444;
    }
    
    .finance-value.neutral {
      color: #6b7280;
    }
    
    .finance-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 0.5rem 0;
    }
    
    /* Server Capacity */
    .server-capacity {
      margin-top: 0.5rem;
    }
    
    .capacity-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.35rem;
    }
    
    .capacity-bar {
      height: 16px;
      background: #f3f4f6;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .capacity-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      transition: all 0.3s;
      border-radius: 8px;
    }
    
    .capacity-fill.capacity-warning {
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    }
    
    .capacity-fill.capacity-critical {
      background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
    }
    
    .capacity-percent {
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.2rem;
      font-weight: 600;
    }
    
    /* Founder XP Tooltip */
    .founder-badge {
      position: relative;
    }
    
    .founder-xp-tooltip {
      position: absolute;
      top: 100%;
      left: 100%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      white-space: nowrap;
      margin-top: 0.5rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    
    .founder-badge:hover .founder-xp-tooltip {
      opacity: 1;
    }
    
    .xp-progress-bar {
      width: 150px;
      height: 6px;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 0.25rem;
    }
    
    .xp-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      transition: width 0.3s;
    }
    
    /* Candidate Cards */
    .candidate-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      background: white;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      animation: fadeInSlide 0.4s ease-out;
    }
    
    @keyframes fadeInSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .candidate-card:nth-child(1) { animation-delay: 0.05s; }
    .candidate-card:nth-child(2) { animation-delay: 0.1s; }
    .candidate-card:nth-child(3) { animation-delay: 0.15s; }
    .candidate-card:nth-child(4) { animation-delay: 0.2s; }
    
    .candidate-card:hover:not(.hired) {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      transform: translateY(-2px) scale(1.01);
    }
    
    .candidate-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      animation: pulse 0.5s ease-out;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
      }
      70% {
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }
    
    .candidate-card.hired {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f9fafb;
    }
    
    .candidate-card.hired::after {
      content: 'HIRED';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      font-size: 2rem;
      font-weight: bold;
      color: #10b981;
      opacity: 0.3;
      pointer-events: none;
    }
    
    .candidate-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.75rem;
    }
    
    .candidate-name {
      font-weight: 600;
      font-size: 1rem;
      color: #111827;
    }
    
    .candidate-tier-badge {
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .candidate-card:hover .candidate-tier-badge {
      transform: scale(1.05);
    }
    
    .candidate-description {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 0.75rem;
      line-height: 1.4;
    }
    
    .candidate-stats {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .candidate-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }
    
    .candidate-stat-label {
      color: #6b7280;
    }
    
    .candidate-stat-value {
      font-weight: 600;
      color: #111827;
    }
    
    .candidates-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    /* Milestone Achievement Notification */
    .milestone-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 2.5rem;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      animation: milestoneAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      text-align: center;
      max-width: 400px;
    }
    
    @keyframes milestoneAppear {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    .milestone-notification h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .milestone-notification p {
      margin: 0;
      font-size: 1rem;
      opacity: 0.95;
    }
    
    /* Tooltip Styles */
    .tooltip-container {
      position: relative;
      display: inline-block;
    }
    
    .tooltip-container .tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: none;
    }
    
    .tooltip-container .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #1f2937;
    }
    
    .tooltip-container:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    /* Pool Refresh Animation */
    @keyframes poolRefresh {
      0% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.3;
        transform: scale(0.95);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .candidates-refreshing .candidate-card {
      animation: poolRefresh 0.6s ease-in-out;
    }
    
    /* Milestone Progress Bar in Finance Panel */
    .milestone-progress-container {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e5e7eb;
    }
    
    .milestone-progress-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    
    .milestone-progress-current {
      font-weight: 600;
      color: #7c3aed;
    }
    
    .milestone-progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .milestone-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #7c3aed, #a78bfa);
      transition: width 0.3s ease-out;
      border-radius: 10px;
    }
    
    /* Pool Quality Badge in Hiring Modal */
    .pool-quality-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .pool-quality-icon {
      font-size: 1.2rem;
    }
    
    /* Pool Refresh Info */
    .pool-refresh-info {
      background: #fffbeb;
      border: 1px solid #fbbf24;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      color: #92400e;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .pool-refresh-icon {
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <!-- Pause Border Indicator -->
  <div class="pause-border-overlay" id="pauseBorderOverlay"></div>
  
  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- Team Penalty Popup Overlay -->
  <div class="penalty-popup-overlay" id="teamPenaltyPopupOverlay" onclick="hidePenaltyPopup()"></div>
  
  <!-- Team Penalty Popup -->
  <div class="penalty-popup" id="teamPenaltyPopup">
    <div class="penalty-popup-title" id="penaltyPopupTitle">Team penalty: 12%</div>
    <div class="penalty-popup-message">Crowded teams lose effectiveness due to communication overhead.</div>
  </div>

  <!-- Header Wrapper - Contains both header bars -->
  <div class="header-wrapper">
    <!-- Header -->
    <!-- New Redesigned Header with Tailwind -->
    <div id="gameHeader" class="bg-gradient-to-br from-blue-600 to-blue-700 text-white px-4 pt-3 pb-3 shadow-lg">
      <div class="max-w-md mx-auto">
        <div class="flex items-start justify-between mb-2">
          <div>
            <h1 class="text-2xl font-semibold mb-1" id="companyNameDisplay">My Startup</h1>
            <p class="text-blue-100 text-sm">
              Day <span id="dayCounter">0</span> Â· <span id="yearMonth">Year 0, Month 0</span>
            </p>
          </div>
          <div class="text-right">
            <div class="text-3xl font-bold" id="cashDisplay">$0</div>
            <div class="text-sm font-medium" id="nextBillingInfo"></div>
          </div>
        </div>

        <!-- Controls -->
        <div class="flex gap-2 justify-end">
          <button id="speedBtn" onclick="cycleSpeed()" 
                  class="px-3 py-2 text-sm font-medium rounded-lg transition-colors bg-blue-700 hover:bg-blue-800 text-white border border-blue-500">
            <span id="speedText">2x</span>
          </button>
          <button id="playPauseBtn" onclick="togglePlayPause()" 
                  class="flex items-center gap-1 px-3 py-3 text-sm font-medium rounded-lg transition-colors bg-blue-700 hover:bg-blue-800 text-white border border-blue-500">
            <i data-lucide="play" class="w-4 h-4"></i>
            <span id="playPauseText">Play</span>
          </button>
        </div>
      </div>
    </div>
  </div><!-- End Header Wrapper -->

  <!-- Pause Banner removed - pause state now shown by yellowish pause button -->

  <!-- Main Container -->
  <div class="main-container">
    <!-- Products Panel -->
    <div class="panel">
      <div class="panel-header">
        <span>Products (<span id="productCount">0</span>)</span>
        <button class="btn btn-success" id="newProductBtn">+ New Product</button>
      </div>
      
      <!-- Filter Pills -->
      <div class="filter-container">
        <div class="filter-pills">
          <button class="filter-pill active all" data-filter="all" onclick="filterProducts('all')">
            All (<span id="filterCountAll">0</span>)
          </button>
          <button class="filter-pill in-dev" data-filter="in_development" onclick="filterProducts('in_development')">
            In Dev (<span id="filterCountDev">0</span>)
          </button>
          <button class="filter-pill live" data-filter="published" onclick="filterProducts('published')">
            Live (<span id="filterCountLive">0</span>)
          </button>
          <!--<button class="filter-pill deprecated" data-filter="deprecated" onclick="filterProducts('deprecated')">
            Deprecated (<span id="filterCountDeprecated">0</span>)
          </button>-->
        </div>
      </div>
      
      <div id="productsContainer">
        <div class="empty-state">No products yet. Start building!</div>
      </div>
    </div>

    <!-- R&D Panel -->
    <div class="panel">
      <div class="panel-header">
        <span>ð¬ R&D</span>
        <button class="btn btn-primary" id="newRndBtn">+ New R&D Project</button>
      </div>
      <div id="rndContainer">
        <div class="empty-state">No R&D projects yet. Start researching!</div>
      </div>
    </div>

    <!-- Employees Panel -->
    <div class="panel">
      <div id="employeesContainer">
        <!-- Office Info -->
        <div class="office-info" id="officeInfo"></div>
        
        <!-- Employee Filter Pills -->
        <div class="product-filter-pills" style="margin-bottom: 0.25rem; flex-wrap: wrap;">
          <button class="filter-pill active" data-filter="all" onclick="filterEmployees('all')">
            All (<span id="employee-count-all">0</span>)
          </button>
          <button class="filter-pill" data-filter="developer" onclick="filterEmployees('developer')">
            Devs (<span id="employee-count-developer">0</span>)
          </button>
          <button class="filter-pill" data-filter="marketer" onclick="filterEmployees('marketer')">
            Marketers (<span id="employee-count-marketer">0</span>)
          </button>
          <button class="filter-pill" data-filter="managers" onclick="filterEmployees('managers')">
            Managers (<span id="employee-count-managers">0</span>)
          </button>
          <button class="filter-pill" data-filter="unassigned" onclick="filterEmployees('unassigned')">
            Unassigned (<span id="employee-count-unassigned">0</span>)
          </button>
          <button class="filter-pill" data-filter="promotion" onclick="filterEmployees('promotion')">
            Ready for Promotion (<span id="employee-count-promotion">0</span>)
          </button>
        </div>
        
        <!-- Employee List -->
        <div id="employeeList"></div>
      </div>
    </div>

    <!-- Finances Panel -->
    <div class="panel">
      <div class="panel-content" id="financesContent">
        <div class="loading">Loading financial data...</div>
      </div>
    </div>

    <!-- Event Log Panel (Mobile Only) -->
    <div class="panel" id="eventLogPanel">
      <div id="eventLogMobile"></div>
      
      <!-- Game Controls -->
      <div style="display: flex; gap: 0.5rem;">
        <button id="saveBtnMobile" onclick="saveGame()" 
                class="flex items-center gap-1 px-2 py-2 text-sm font-medium rounded-lg transition-colors bg-white/10 hover:bg-white/20 text-gray-700 border border-gray-300">
          <i data-lucide="save" class="w-4 h-4"></i>
          <span>Save</span>
        </button>
        <button id="resetBtnMobile" onclick="confirmReset()" 
                class="flex items-center gap-1 px-2 py-2 text-sm font-medium rounded-lg transition-colors bg-white/10 hover:bg-white/20 text-gray-700 border border-gray-300">
          <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
          <span>Reset</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Navigation (Bottom Tab Bar) - Redesigned with Tailwind -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg" style="z-index: 9998;">
    <div class="max-w-md mx-auto px-2 py-3 mb-1" style="padding-top:0.5rem; padding-bottom:0.5rem;">
      <div class="flex items-center justify-around">
        <button onclick="scrollToPanel(0)" id="nav-products"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-lg bg-blue-600 transition-colors">
          <i data-lucide="package" class="w-6 h-6 text-white"></i>
          <span class="text-xs text-white font-medium">Products</span>
        </button>
        <button onclick="scrollToPanel(1)" id="nav-rnd"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
          <i data-lucide="lightbulb" class="w-6 h-6 text-gray-600"></i>
          <span class="text-xs text-gray-600">R&D</span>
        </button>
        <button onclick="scrollToPanel(2)" id="nav-team"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors relative">
          <i data-lucide="users" class="w-6 h-6 text-gray-600"></i>
          <span class="text-xs text-gray-600">Team</span>
          <div class="nav-notification-dot absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full" style="display: none;"></div>
        </button>
        <button onclick="scrollToPanel(3)" id="nav-finance"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors relative">
          <i data-lucide="dollar-sign" class="w-6 h-6 text-gray-600"></i>
          <span class="text-xs text-gray-600">Finances</span>
        </button>
        <button onclick="scrollToPanel(4)" id="nav-log"
                class="flex flex-col items-center gap-1 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
          <i data-lucide="scroll-text" class="w-6 h-6 text-gray-600"></i>
          <span class="text-xs text-gray-600">Logs</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Event Log -->
  <div id="desktopEventLogWrapper" style="max-width: 1800px; margin: 0 auto; padding: 0 1.5rem 1.5rem;">
    <div class="event-log">
      <div id="eventLog"></div>
    </div>
    
    <!-- Game Controls -->
    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
      <button id="saveBtn" onclick="saveGame()" 
              class="flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-lg transition-colors bg-white/10 hover:bg-white/20 text-gray-700 border border-gray-300">
        <i data-lucide="save" class="w-4 h-4"></i>
        <span>Save</span>
      </button>
      <button id="resetBtn" onclick="confirmReset()" 
              class="flex items-center gap-1 px-3 py-2 text-sm font-medium rounded-lg transition-colors bg-white/10 hover:bg-white/20 text-gray-700 border border-gray-300">
        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
        <span>Reset</span>
      </button>
    </div>
  </div>

  <!-- New Product Modal -->
  <div class="modal-overlay" id="newProductModal">
    <div class="modal">
      <div class="modal-header">ð¨ Create New Product</div>
      <div class="modal-body">
        <div class="scrollable-list" id="productTemplatesList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="cancelProductBtn">Cancel</button>
        <button class="btn btn-success" id="createProductBtn">Start Building ð¨</button>
      </div>
    </div>
  </div>

  <!-- New R&D Project Modal -->
  <div class="modal-overlay" id="newRndModal">
    <div class="modal">
      <div class="modal-header">ð¬ Start R&D Project</div>
      <div class="modal-body">
        <div class="modal-intro">R&D projects provide permanent upgrades and unlock new products.</div>
        <div class="scrollable-list" id="rndProjectsList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideNewRndModal()">Cancel</button>
        <button class="btn btn-primary" onclick="handleCreateRndProject()">Start Research ð¬</button>
      </div>
    </div>
  </div>

  <!-- Assign to R&D Modal -->
  <div class="modal-overlay" id="assignToRndModal">
    <div class="modal">
      <div class="modal-header">ð¨âð» Assign Developers to R&D</div>
      <div class="modal-body">
        <div class="modal-intro">Select one or more developers to assign to this R&D project.</div>
        <div class="scrollable-list" id="availableDevelopersForRnd"></div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideAssignToRndModal()">Cancel</button>
        <button class="btn btn-primary" onclick="assignSelectedToRnd()" id="assignSelectedToRndBtn" disabled style="flex: 1;">
          Assign Selected (<span id="selectedRndCount">0</span>)
        </button>
      </div>
    </div>
  </div>

  <!-- Hire Developer Modal -->
  <!-- Select Employee Type Modal -->
  <div class="modal-overlay" id="selectEmployeeTypeModal">
    <div class="modal" style="max-width: 360px;">
      <div class="modal-header">ð¥ Hire New Employee</div>
      <div class="modal-body" style="padding: 1.5rem;">
        <p style="text-align: center; color: #6b7280; margin-bottom: 1.5rem; font-size: 0.9rem;">
          What type of employee do you want to hire?
        </p>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          <button onclick="selectEmployeeType('developer')" 
                  class="btn" 
                  style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; padding: 1rem; font-size: 1rem; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; color: white; border-radius: 8px;">
            <span style="font-size: 1.5rem;">ð¨âð»</span>
            <div style="text-align: left;">
              <div style="font-weight: 600;">Developer</div>
              <div style="font-size: 0.75rem; opacity: 0.9;">Build products & R&D</div>
            </div>
          </button>
          <button onclick="selectEmployeeType('marketer')" 
                  class="btn" 
                  style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; padding: 1rem; font-size: 1rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; color: white; border-radius: 8px;">
            <span style="font-size: 1.5rem;">ð¢</span>
            <div style="text-align: left;">
              <div style="font-weight: 600;">Marketer</div>
              <div style="font-size: 0.75rem; opacity: 0.9;">Acquire customers</div>
            </div>
          </button>
          <button id="hireManagerButton" onclick="selectEmployeeType('manager')" 
                  class="btn" 
                  style="display: none; align-items: center; justify-content: center; gap: 0.75rem; padding: 1rem; font-size: 1rem; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; border-radius: 8px;">
            <span style="font-size: 1.5rem;">ð</span>
            <div style="text-align: left;">
              <div style="font-weight: 600;">Manager</div>
              <div style="font-size: 0.75rem; opacity: 0.9;">Automate assignments</div>
            </div>
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideSelectEmployeeTypeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="hireDeveloperModal">
    <div class="modal">
      <div class="modal-header">ð¨âð» Hire Developer</div>
      <div class="modal-body">
        <div class="scrollable-list" id="hireDeveloperList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideHireDeveloperModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Hire Marketer Modal -->
  <div class="modal-overlay" id="hireMarketerModal">
    <div class="modal">
      <div class="modal-header">ð¢ Hire Marketer</div>
      <div class="modal-body">
        <div class="scrollable-list" id="hireMarketerList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideHireMarketerModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Hire Manager Modal -->
  <div class="modal-overlay" id="hireManagerModal">
    <div class="modal">
      <div class="modal-header">ð Hire Manager</div>
      <div class="modal-body">
        <div class="scrollable-list" id="hireManagerList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideHireManagerModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Manage Team Modal (Assign/Unassign Employees to Manager) -->
  <div class="modal-overlay" id="manageTeamModal">
    <div class="modal">
      <div class="modal-header" id="manageTeamModalHeader">ð Manage Team</div>
      <div class="modal-body">
        <div class="scrollable-list" id="manageTeamList"></div>
      </div>
      <div class="modal-footer" id="manageTeamModalFooter">
        <button class="btn" onclick="hideManageTeamModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Assign to Manager Modal (Select Manager for Employee) -->
  <div class="modal-overlay" id="assignToManagerModal">
    <div class="modal">
      <div class="modal-header" id="assignToManagerModalHeader">ð Assign to Manager</div>
      <div class="modal-body">
        <div class="scrollable-list" id="assignToManagerList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideAssignToManagerModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Assign Developer to Product Modal -->
  <div class="modal-overlay" id="assignDeveloperModal">
    <div class="modal">
      <div class="modal-header">ð¨âð» Assign Developers</div>
      <div class="modal-body">
        <div class="modal-intro" id="assignDeveloperProductName"></div>
        <div class="scrollable-list" id="assignDeveloperList"></div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideAssignDeveloperModal()">Cancel</button>
        <button class="btn btn-primary" onclick="assignSelectedDevelopers()" id="assignSelectedDevelopersBtn" disabled style="flex: 1;">
          Assign Selected (<span id="selectedDevelopersCount">0</span>)
        </button>
      </div>
    </div>
  </div>

  <!-- Assign Marketer to Product Modal -->
  <div class="modal-overlay" id="assignMarketerModal">
    <div class="modal">
      <div class="modal-header">ð¢ Assign Marketers</div>
      <div class="modal-body">
        <div class="modal-intro" id="assignMarketerProductName"></div>
        <div class="scrollable-list" id="assignMarketerList"></div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideAssignMarketerModal()">Cancel</button>
        <button class="btn btn-primary" onclick="assignSelectedMarketers()" id="assignSelectedMarketersBtn" disabled style="flex: 1;">
          Assign Selected (<span id="selectedMarketersCount">0</span>)
        </button>
      </div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div class="modal-overlay" id="gameOverModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white;">
        ð GAME OVER
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.2rem; font-weight: bold; color: #dc2626; margin-bottom: 1rem;">
          Your company went bankrupt! ð¸
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1.5rem; margin: 1rem 0;">
          <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;">Final Stats</div>
          <div style="display: grid; gap: 0.75rem; text-align: left;">
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
              <span style="color: #6b7280;">ð Survived:</span>
              <span style="font-weight: 600; color: #111827;" id="gameOverDays">0 days</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
              <span style="color: #6b7280;">ð¦ Products Created:</span>
              <span style="font-weight: 600; color: #111827;" id="gameOverProducts">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
              <span style="color: #6b7280;">ð¥ Team Size:</span>
              <span style="font-weight: 600; color: #111827;" id="gameOverTeam">1</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 6px;">
              <span style="color: #6b7280;">ð° Final Cash:</span>
              <span style="font-weight: 600; color: #dc2626;" id="gameOverCash">$0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 1rem;">
        <button class="btn btn-primary" onclick="restartGame()" style="flex: 1; padding: 1rem; font-size: 1.1rem;">
          ð Restart Game
        </button>
      </div>
    </div>
  </div>

  <!-- Fire Employee Confirmation Modal -->
  <div class="modal-overlay" id="fireEmployeeModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
        ð¥ Fire Employee
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="fireEmployeeName">
          Fire Employee Name?
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">Role:</span>
              <span style="font-weight: 600;" id="fireEmployeeRole">Senior Developer</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">Current Salary:</span>
              <span style="font-weight: 600;" id="fireEmployeeSalary">$7,000/month</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #dc2626; font-weight: 600;">Severance Pay:</span>
              <span style="font-weight: 700; color: #dc2626;" id="fireEmployeeSeverance">$7,000</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Monthly Savings:</span>
              <span style="font-weight: 700; color: #10b981;" id="fireEmployeeSavings">$7,000/mo</span>
            </div>
          </div>
        </div>
        <div style="color: #dc2626; font-size: 0.9rem; margin-top: 1rem;">
          â ï¸ This will cost <span id="fireEmployeeCost" style="font-weight: 700;">$7,000</span> immediately.
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideFireEmployeeModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmFireEmployee()" style="flex: 1; background: #ef4444; border-color: #dc2626; color: white;">
          ð¥ Confirm Fire
        </button>
      </div>
    </div>
  </div>

  <!-- Hire Confirmation Modal -->
  <div class="modal-overlay" id="hireConfirmModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        â Hire Employee
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="hireConfirmName">
          Candidate Name
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">Role:</span>
              <span style="font-weight: 600;" id="hireConfirmRole">Senior Developer</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">Efficiency:</span>
              <span style="font-weight: 600;" id="hireConfirmEfficiency">2.2x</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #dc2626; font-weight: 600;">Monthly Salary:</span>
              <span style="font-weight: 700; color: #dc2626;" id="hireConfirmSalary">$7,000/month</span>
            </div>
          </div>
        </div>
        <div style="color: #6b7280; font-size: 0.9rem; margin-top: 1rem;">
          ð¡ This candidate will be removed from the pool once hired.
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideHireConfirmModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmHireCandidate()" style="flex: 1; background: #10b981; border-color: #059669; color: white;">
          â Confirm Hire
        </button>
      </div>
    </div>
  </div>

  <!-- Promotion Negotiation Modal -->
  <div class="modal-overlay" id="promotionModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 0.75rem 1rem;">
        ð Promotion Negotiation
      </div>
      <div class="modal-body" style="text-align: center; padding: 0.75rem 1rem;">
        <div style="font-size: 0.95rem; font-weight: 600; color: #111827; margin-bottom: 0.25rem;" id="promotionEmployeeName">
          Employee Name
        </div>
        <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;" id="promotionEmployeeRole">
          Junior Developer â Intermediate Developer
        </div>
        
        <!-- Salary Info Side-by-Side -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
          <div style="background: #f9fafb; border-radius: 6px; padding: 0.5rem;">
            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem;">ð¼ Expectation</div>
            <div style="font-size: 1rem; font-weight: 700; color: #111827;" id="promotionExpectation">$5,000/mo</div>
          </div>
          <div style="background: white; border: 2px solid #7c3aed; border-radius: 6px; padding: 0.5rem;">
            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem;">ðµ Your Offer</div>
            <div style="font-size: 1rem; font-weight: 700; color: #7c3aed;" id="promotionOfferDisplay">$5,000/mo</div>
          </div>
        </div>
        
        <!-- Slider -->
        <div style="margin-bottom: 0.5rem;">
          <input 
            type="range" 
            id="promotionSalarySlider" 
            min="0" 
            max="100" 
            value="100" 
            step="1"
            style="width: 100%; margin-bottom: 0.25rem;"
          >
          <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #9ca3af;">
            <span id="promotionMinSalary">$4,000</span>
            <span id="promotionMaxSalary">$6,000</span>
          </div>
        </div>
        
        <!-- Acceptance Chance -->
        <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; padding: 0.4rem 0.5rem; margin-bottom: 0.5rem;" id="promotionAcceptanceChance">
          <span style="font-size: 0.8rem; color: #92400e;">
            ð <strong>Acceptance:</strong> <span id="promotionProbability">100%</span>
          </span>
        </div>
        
        <!-- Rejection History (hidden by default) -->
        <div id="promotionRejectionInfo" style="display: none; background: #fee2e2; border: 1px solid #ef4444; border-radius: 4px; padding: 0.4rem 0.5rem; margin-bottom: 0.5rem;">
          <div style="font-size: 0.75rem; color: #991b1b; text-align: center; font-weight: 600;">
            â ï¸ <span id="promotionRejectionText">Rejected 1/3</span> - After 3 rejections, they quit!
          </div>
        </div>
        
        <!-- Compact Tip -->
        <div style="color: #6b7280; font-size: 0.7rem; text-align: center;">
          ð¡ Higher offers = better acceptance. <strong>3 rejections = employee quits</strong>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem; padding: 0.5rem 1rem;">
        <button class="btn" onclick="hidePromotionModal()" style="flex: 1; padding: 0.4rem;">Cancel</button>
        <button class="btn" onclick="makePromotionOffer()" style="flex: 1; padding: 0.4rem; background: #8b5cf6; border-color: #7c3aed; color: white;">
          ð° Make Offer
        </button>
      </div>
    </div>
  </div>

  <!-- Manager Promotion Negotiation Modal -->
  <div class="modal-overlay" id="managerPromotionModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; padding: 0.75rem 1rem;">
        ð Manager Promotion
      </div>
      <div class="modal-body" style="text-align: center; padding: 0.75rem 1rem;">
        <div style="font-size: 0.95rem; font-weight: 600; color: #111827; margin-bottom: 0.25rem;" id="managerPromotionName">
          Manager Name
        </div>
        <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem;" id="managerPromotionCapacity">
          Capacity: 4 â 5
        </div>
        
        <!-- Salary Info Side-by-Side -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
          <div style="background: #f9fafb; border-radius: 6px; padding: 0.5rem;">
            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem;">ð¼ Expectation</div>
            <div style="font-size: 1rem; font-weight: 700; color: #111827;" id="managerPromotionExpectation">$25,000/mo</div>
          </div>
          <div style="background: white; border: 2px solid #9333ea; border-radius: 6px; padding: 0.5rem;">
            <div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 0.25rem;">ðµ Your Offer</div>
            <div style="font-size: 1rem; font-weight: 700; color: #9333ea;" id="managerPromotionOfferDisplay">$25,000/mo</div>
          </div>
        </div>
        
        <!-- Slider -->
        <div style="margin-bottom: 0.5rem;">
          <input 
            type="range" 
            id="managerPromotionSalarySlider" 
            min="0" 
            max="100" 
            value="100" 
            step="1"
            style="width: 100%; margin-bottom: 0.25rem;"
          >
          <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #9ca3af;">
            <span id="managerPromotionMinSalary">$20,000</span>
            <span id="managerPromotionMaxSalary">$30,000</span>
          </div>
        </div>
        
        <!-- Acceptance Chance -->
        <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; padding: 0.4rem 0.5rem; margin-bottom: 0.5rem;" id="managerPromotionAcceptanceChance">
          <span style="font-size: 0.8rem; color: #92400e;">
            ð <strong>Acceptance:</strong> <span id="managerPromotionProbability">100%</span>
          </span>
        </div>
        
        <!-- Rejection History -->
        <div id="managerPromotionRejectionInfo" style="display: none; background: #fee2e2; border: 1px solid #ef4444; border-radius: 4px; padding: 0.4rem 0.5rem; margin-bottom: 0.5rem;">
          <div style="font-size: 0.75rem; color: #991b1b; text-align: center; font-weight: 600;">
            â ï¸ <span id="managerPromotionRejectionText">Rejected 1/3</span> - After 3 rejections, they quit!
          </div>
        </div>
        
        <!-- Compact Tip -->
        <div style="color: #6b7280; font-size: 0.7rem; text-align: center;">
          ð¡ Higher offers = better acceptance. <strong>3 rejections = manager quits</strong>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem; padding: 0.5rem 1rem;">
        <button class="btn" onclick="hideManagerPromotionModal()" style="flex: 1; padding: 0.4rem;">Cancel</button>
        <button class="btn" onclick="makeManagerPromotionOffer()" style="flex: 1; padding: 0.4rem; background: #a855f7; border-color: #9333ea; color: white;">
          ð° Make Offer
        </button>
      </div>
    </div>
  </div>

  <!-- Fire Manager Confirmation Modal -->
  <div class="modal-overlay" id="fireManagerModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
        ð¥ Fire Manager
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem;" id="fireManagerName">
          Manager Name
        </div>
        <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; text-align: left;">
          <div style="font-size: 0.85rem; color: #991b1b; margin-bottom: 0.5rem;">
            <strong>â ï¸ Warning:</strong>
          </div>
          <ul style="font-size: 0.8rem; color: #7f1d1d; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
            <li>Manager will be immediately terminated</li>
            <li id="fireManagerManagedCount">5 managed employees will become unmanaged</li>
            <li>Employees will continue current work but won't be auto-assigned</li>
            <li id="fireManagerSeverance">Severance: $20,000 (1 month salary)</li>
            <li>Monthly savings: <span id="fireManagerMonthlySavings">$20,000/mo</span></li>
          </ul>
        </div>
        <div style="font-size: 0.75rem; color: #6b7280;">
          Are you sure you want to fire this manager?
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideFireManagerModal()">Cancel</button>
        <button class="btn" onclick="confirmFireManager()" style="background: #ef4444; border-color: #dc2626; color: white;">
          Confirm Fire
        </button>
      </div>
    </div>
  </div>

  <!-- Upgrade Office Confirmation Modal -->
  <div class="modal-overlay" id="upgradeOfficeModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        â¬ï¸ Upgrade Office
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="upgradeOfficeName">
          Home Office â Startup Space
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">ð¥ Capacity:</span>
              <span style="font-weight: 600;" id="upgradeOfficeCapacity">3 â 10 people</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">ð° Monthly Rent:</span>
              <span style="font-weight: 600;" id="upgradeOfficeRent">$0 â $2,000</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #dc2626; font-weight: 600;">ð¨ Setup Cost:</span>
              <span style="font-weight: 700; color: #dc2626;" id="upgradeOfficeSetupCost">$4,000</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #dc2626; font-weight: 600;">Monthly Cost Increase:</span>
              <span style="font-weight: 700; color: #dc2626;" id="upgradeOfficeCostIncrease">+$2,000</span>
            </div>
          </div>
        </div>
        <div style="color: #6b7280; font-size: 0.9rem; margin-top: 1rem;">
          ð¡ The setup cost is paid immediately and covers moving expenses.
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideUpgradeOfficeModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmUpgradeOffice()" style="flex: 1; background: #10b981; border-color: #059669; color: white;">
          â¬ï¸ Confirm Upgrade
        </button>
      </div>
    </div>
  </div>

  <!-- Downgrade Office Confirmation Modal -->
  <div class="modal-overlay" id="downgradeOfficeModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">
        â¬ï¸ Downgrade Office
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="downgradeOfficeName">
          Startup Space â Home Office
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">ð¥ Capacity:</span>
              <span style="font-weight: 600;" id="downgradeOfficeCapacity">10 â 3 people</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">ð° Monthly Rent:</span>
              <span style="font-weight: 600;" id="downgradeOfficeRent">$2,000 â $0/month</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Monthly Savings:</span>
              <span style="font-weight: 700; color: #10b981;" id="downgradeOfficeSavings">$2,000/mo</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Upfront Cost:</span>
              <span style="font-weight: 700; color: #10b981;">$0 (Free!)</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideDowngradeOfficeModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmDowngradeOffice()" style="flex: 1; background: #6b7280; border-color: #4b5563; color: white;">
          â¬ï¸ Confirm Downgrade
        </button>
      </div>
    </div>
  </div>

  <!-- Downgrade Server Confirmation Modal -->
  <div class="modal-overlay" id="downgradeServerModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">
        â¬ï¸ Downgrade Server
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #111827; margin-bottom: 1rem;" id="downgradeServerName">
          Standard Cloud â Basic VPS
        </div>
        <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
          <div style="display: grid; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">ð Capacity:</span>
              <span style="font-weight: 600;" id="downgradeServerCapacity">5,000 â 1,000 subs</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #6b7280;">ð° Monthly Fee:</span>
              <span style="font-weight: 600;" id="downgradeServerFee">$150 â $50/month</span>
            </div>
            <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0; padding-top: 0.5rem;"></div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Monthly Savings:</span>
              <span style="font-weight: 700; color: #10b981;" id="downgradeServerSavings">$100/mo</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #10b981; font-weight: 600;">Upfront Cost:</span>
              <span style="font-weight: 700; color: #10b981;">$0 (Free!)</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 0.5rem;">
        <button class="btn" onclick="hideDowngradeServerModal()" style="flex: 1;">Cancel</button>
        <button class="btn" onclick="confirmDowngradeServer()" style="flex: 1; background: #6b7280; border-color: #4b5563; color: white;">
          â¬ï¸ Confirm Downgrade
        </button>
      </div>
    </div>
  </div>

  <!-- New Game Setup Modal -->
  <div class="modal-overlay active" id="newGameModal">
    <div class="modal">
      <div class="modal-header">ð Start Your Software Company</div>
      <div class="modal-body">
        <form id="newGameForm">
          <div class="form-group">
            <label style="margin-bottom: 0;">Company Name:</label>
            <div style="display: flex; gap: 0.4rem;">
              <input type="text" id="companyNameInput" value="TechVentures" required style="flex: 1;">
              <button type="button" class="btn btn-sm" onclick="document.getElementById('companyNameInput').value = generateRandomCompanyName();" style="padding: 0.5rem 0.8rem; font-size: 0.9rem;">ð²</button>
            </div>
          </div>

          <div class="form-group">
            <label style="margin-bottom: 0;">Founder Name:</label>
            <div style="display: flex; gap: 0.4rem;">
              <input type="text" id="founderNameInput" value="Alex Chen" required style="flex: 1;">
              <button type="button" class="btn btn-sm" onclick="document.getElementById('founderNameInput').value = generateRandomFounderName();" style="padding: 0.5rem 0.8rem; font-size: 0.9rem;">ð²</button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
            <!-- Currency Selection -->
            <div class="form-group" style="margin-bottom: 0;">
              <label>Currency:</label>
              <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.5rem; border: 2px solid #2563eb; background: #eff6ff; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="currency" value="USD" checked style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => {l.style.borderColor='#e5e7eb'; l.style.background='white';}); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <span style="font-weight: 500; font-size: 0.85rem;">USD ($)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="currency" value="EUR" style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => {l.style.borderColor='#e5e7eb'; l.style.background='white';}); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <span style="font-weight: 500; font-size: 0.85rem;">EUR (â¬)</span>
                </label>
              </div>
            </div>

            <!-- Starting Capital -->
            <div class="form-group" style="margin-bottom: 0;">
              <label>Starting Capital:</label>
              <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="capital" value="100000" style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => l.style.borderColor='#e5e7eb'); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.8rem;">$100k / â¬100k</div>
                    <div style="font-size: 0.7rem; color: #6b7280;">Very Easy</div>
                  </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="capital" value="50000" style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => l.style.borderColor='#e5e7eb'); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.8rem;">$50k / â¬50k</div>
                    <div style="font-size: 0.7rem; color: #6b7280;">Easy</div>
                  </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.5rem; border: 2px solid #2563eb; background: #eff6ff; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="capital" value="25000" checked style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => {l.style.borderColor='#e5e7eb'; l.style.background='white';}); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.8rem;">$25k / â¬25k</div>
                    <div style="font-size: 0.7rem; color: #2563eb;">Normal â­</div>
                  </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                  <input type="radio" name="capital" value="10000" style="margin: 0;" onchange="this.parentElement.parentElement.querySelectorAll('label').forEach(l => {l.style.borderColor='#e5e7eb'; l.style.background='white';}); this.parentElement.style.borderColor='#2563eb'; this.parentElement.style.background='#eff6ff';">
                  <div style="flex: 1;">
                    <div style="font-weight: 500; font-size: 0.8rem;">$10k / â¬10k</div>
                    <div style="font-size: 0.7rem; color: #6b7280;">Hard</div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="startGameBtn" style="font-size: 1rem; padding: 0.6rem 1.5rem;">
          ð Start My Company!
        </button>
      </div>
    </div>
  </div>

  <script>
    /* ============================================ */
    /* SOFTWARE COMPANY SIMULATOR - JAVASCRIPT */
    /* Version 2.0 | Phase 1-2: Core + Products */
    /* ============================================ */

    // ============================================
    // GAME STATE (Global Variables)
    // ============================================
    let currency = "USD";
    let currentDay = 0;
    let cash = 25000;
    let lifetimeEarnings = 0; // Track total earnings for unlock milestones
    let companyName = "My Startup";
    let isPlaying = false;
    let gameSpeed = 1;
    let tickTimer = null;

    let founder = {
      id: 'founder',
      name: "Founder",
      efficiency: 1.0,
      baseEfficiency: 1.0,
      skill: "intermediate", // Founder starts as intermediate level
      tierName: "Founder",
      monthlySalary: 0, // Founder doesn't take a salary
      experienceMonths: 0,
      assignedProduct: null,
      readyForPromotion: false,
      efficiencyCap: 4.0, // 400% cap (same as expert employees)
      isFounder: true,
      // Manager system fields
      managerId: null,
      isManaged: false
    };

    let products = [];
    let developers = [];
    let marketers = [];
    let eventLog = [];
    
    // Manager System
    let managers = [];
    let lastManagerOptimization = 0;
    
    // ============================================
    // REUSABLE DIALOG COMPONENT SYSTEM
    // ============================================
    
    class Dialog {
      constructor(options = {}) {
        this.id = options.id || 'dialog-' + Date.now();
        this.title = options.title || '';
        this.description = options.description || '';
        this.content = options.content || '';
        this.onConfirm = options.onConfirm || null;
        this.onCancel = options.onCancel || null;
        this.confirmText = options.confirmText || 'Confirm';
        this.cancelText = options.cancelText || 'Cancel';
        this.confirmClass = options.confirmClass || 'bg-indigo-600 hover:bg-indigo-700';
        this.showCancel = options.showCancel !== false;
        this.maxWidth = options.maxWidth || 'max-w-sm';
        
        this.element = null;
        this.isOpen = false;
      }
      
      render() {
        const dialogHTML = `
          <div id="${this.id}" class="fixed inset-0 z-50 hidden" style="z-index: 10000;">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-black/50 transition-opacity" onclick="window.dialogs['${this.id}'].close()"></div>
            
            <!-- Dialog Container -->
            <div class="fixed inset-0 overflow-y-auto">
              <div class="flex min-h-full items-center justify-center p-4">
                <!-- Dialog Content -->
                <div class="${this.maxWidth} w-full bg-white rounded-lg shadow-xl transform transition-all">
                  <!-- Header -->
                  <div class="px-6 pt-5 pb-4">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                          ${this.title}
                        </h3>
                        ${this.description ? `<p class="mt-2 text-sm text-gray-500">${this.description}</p>` : ''}
                      </div>
                      <button onclick="window.dialogs['${this.id}'].close()" class="ml-4 text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Content -->
                  <div class="px-6 py-4" id="${this.id}-content">
                    ${this.content}
                  </div>
                  
                  <!-- Footer -->
                  <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex gap-2 ${this.showCancel ? 'justify-end' : 'justify-center'}">
                    ${this.showCancel ? `
                      <button onclick="window.dialogs['${this.id}'].cancel()" 
                              class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        ${this.cancelText}
                      </button>
                    ` : ''}
                    <button onclick="window.dialogs['${this.id}'].confirm()" 
                            class="flex-1 px-4 py-2 text-sm font-medium text-white ${this.confirmClass} rounded-lg">
                      ${this.confirmText}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Remove existing if any
        const existing = document.getElementById(this.id);
        if (existing) existing.remove();
        
        // Add to body
        document.body.insertAdjacentHTML('beforeend', dialogHTML);
        this.element = document.getElementById(this.id);
        
        // Store in global registry
        if (!window.dialogs) window.dialogs = {};
        window.dialogs[this.id] = this;
        
        return this;
      }
      
      open() {
        if (!this.element) this.render();
        this.element.classList.remove('hidden');
        this.isOpen = true;
        document.body.style.overflow = 'hidden';
        return this;
      }
      
      close() {
        if (this.element) {
          this.element.classList.add('hidden');
          this.isOpen = false;
          document.body.style.overflow = '';
        }
        return this;
      }
      
      confirm() {
        if (this.onConfirm) {
          const result = this.onConfirm();
          if (result !== false) this.close();
        } else {
          this.close();
        }
      }
      
      cancel() {
        if (this.onCancel) {
          this.onCancel();
        }
        this.close();
      }
      
      updateContent(newContent) {
        const contentEl = document.getElementById(`${this.id}-content`);
        if (contentEl) {
          contentEl.innerHTML = newContent;
        }
        return this;
      }
      
      destroy() {
        if (this.element) {
          this.element.remove();
          this.element = null;
        }
        if (window.dialogs && window.dialogs[this.id]) {
          delete window.dialogs[this.id];
        }
      }
    }
    
    // Initialize dialog registry
    window.dialogs = window.dialogs || {};
    
    // R&D System
    let rndProjects = []; // Active R&D projects (similar to products)
    let completedRndProjects = []; // IDs of completed R&D projects
    let unlockedProducts = ['Task Manager']; // Initially only Task Manager is unlocked
    let nextRndProjectId = 10000;  // Start at 10000 to avoid ID collision with products

    let currentServerTier = 0; // Shared Hosting (free)
    let currentOfficeTier = 0; // Home Office (no rent)
    
    let nextProductId = 1;
    
    // NEW: Candidate pool system - refreshed monthly based on milestones
    let candidatePool = {
      developers: [],     // Array of 4 developer candidates
      marketers: [],      // Array of 4 marketer candidates
      managers: [],       // Array of 2 manager candidates
      lastRefreshDay: 0   // Day when pool was last refreshed
    };
    
    // OLD: Legacy candidate system (will be replaced)
    let developerCandidates = {}; // { tierIndex: [candidate1, candidate2, candidate3, candidate4] }
    let marketerCandidates = {}; // { tierIndex: [candidate1, candidate2, candidate3, candidate4] }
    let lastCandidateRefresh = 0; // Track which month we last refreshed
    let candidateToHire = null; // Temporary storage for confirmation modal

    // ============================================
    // PRODUCT TEMPLATES (15 products)
    // ============================================
    const PRODUCT_TEMPLATES = [
      {
        name: "Task Manager",
        developmentEffort: 3,
        lifetimeMonths: 36,
        monthlyPriceUSD: 14,
        monthlyPriceEUR: 12,
        description: "Simple to-do list app"
      },
      {
        name: "Time Tracking App",
        developmentEffort: 6,
        lifetimeMonths: 36,
        monthlyPriceUSD: 16,
        monthlyPriceEUR: 14,
        description: "Employee time logging"
      },
      {
        name: "Password Manager",
        developmentEffort: 9,
        lifetimeMonths: 36,
        monthlyPriceUSD: 16,
        monthlyPriceEUR: 14,
        description: "Secure credential vault"
      },
      {
        name: "Form Builder",
        developmentEffort: 12,
        lifetimeMonths: 40,
        monthlyPriceUSD: 14,
        monthlyPriceEUR: 12,
        description: "Drag-and-drop forms"
      },
      {
        name: "CRM Lite",
        developmentEffort: 18,
        lifetimeMonths: 40,
        monthlyPriceUSD: 24,
        monthlyPriceEUR: 22,
        description: "Basic CRM"
      },
      {
        name: "Social Media Manager",
        developmentEffort: 18,
        lifetimeMonths: 48,
        monthlyPriceUSD: 28,
        monthlyPriceEUR: 25,
        description: "Post scheduling & analytics"
      },
      {
        name: "Email Marketing Tool",
        developmentEffort: 24,
        lifetimeMonths: 48,
        monthlyPriceUSD: 28,
        monthlyPriceEUR: 26,
        description: "Campaign management"
      },
      {
        name: "Analytics Dashboard",
        developmentEffort: 30,
        lifetimeMonths: 48,
        monthlyPriceUSD: 28,
        monthlyPriceEUR: 26,
        description: "Data viz tool"
      },
      {
        name: "Invoicing Software",
        developmentEffort: 36,
        lifetimeMonths: 60,
        monthlyPriceUSD: 30,
        monthlyPriceEUR: 28,
        description: "Billing & invoices"
      },
      {
        name: "Project Management Suite",
        developmentEffort: 48,
        lifetimeMonths: 72,
        monthlyPriceUSD: 40,
        monthlyPriceEUR: 36,
        description: "Full PM tool"
      },
      {
        name: "Video Conferencing Tool",
        developmentEffort: 48,
        lifetimeMonths: 48,
        monthlyPriceUSD: 17,
        monthlyPriceEUR: 15,
        description: "Remote meetings"
      },
      {
        name: "HR Management System",
        developmentEffort: 72,
        lifetimeMonths: 72,
        monthlyPriceUSD: 44,
        monthlyPriceEUR: 40,
        description: "Employee management"
      },
      {
        name: "E-commerce Platform",
        developmentEffort: 96,
        lifetimeMonths: 108,
        monthlyPriceUSD: 55,
        monthlyPriceEUR: 50,
        description: "Online store builder"
      },
      {
        name: "AI Chatbot",
        developmentEffort: 132,
        lifetimeMonths: 60,
        monthlyPriceUSD: 64,
        monthlyPriceEUR: 58,
        description: "Customer service bot"
      },
      {
        name: "ERP System",
        developmentEffort: 240,
        lifetimeMonths: 120,
        monthlyPriceUSD: 80,
        monthlyPriceEUR: 72,
        description: "Enterprise resource planning"
      }
    ];

    // ============================================
    // R&D PROJECT TEMPLATES
    // ============================================
    const RND_CATEGORIES = {
      GROWTH: 'growth',
      RETENTION: 'retention',
      EFFICIENCY: 'efficiency',
      UNLOCK: 'unlock'
    };

    const RND_PROJECTS = [
      // ORGANIC GROWTH STREET (Sequential)
      {
        id: 'growth_1',
        name: "SEO & Content Marketing",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 9,
        effect: { type: 'organic_growth', value: 0.05 },
        description: "Optimize for search engines and create valuable content",
        prerequisites: []
      },
      {
        id: 'growth_2',
        name: "Viral Referral System",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 24, // 6 months * 2
        effect: { type: 'organic_growth', value: 0.10 },
        description: "Implement gamified referrals and social sharing",
        prerequisites: ['growth_1']
      },
      {
        id: 'growth_3',
        name: "AI Growth Engine",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 36, // 12 months * 2
        effect: { type: 'organic_growth', value: 0.15 },
        description: "Predictive algorithms and automated personalization",
        prerequisites: ['growth_2']
      },
      // ORGANIC GROWTH STREET (Sequential)
      {
        id: 'growth_4',
        name: "Community & Ecosystem Platform",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 60, // 18 months * 2
        effect: { type: 'organic_growth', value: 0.20 },
        description: "Build user communities, integrations, and creator ecosystems that drive sustained engagement",
        prerequisites: ['growth_3']
      },
      {
        id: 'growth_5',
        name: "Global Brand Authority",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 120, // 24 months * 2
        effect: { type: 'organic_growth', value: 0.25 },
        description: "Achieve category leadership through brand trust, thought leadership, and network effects",
        prerequisites: ['growth_4']
      },
      {
        id: 'growth_6',
        name: "Market Penetration Strategy",
        category: RND_CATEGORIES.GROWTH,
        developmentEffort: 240, // 12 months * 2
        effect: { type: 'organic_growth', value: 0.35 },
        description: "Develop a systematic approach to market penetration and expansion",
        prerequisites: ['growth_5']
      },

      
      // CHURN REDUCTION STREET (Sequential)
      {
        id: 'retention_1',
        name: "Customer Success Portal",
        category: RND_CATEGORIES.RETENTION,
        developmentEffort: 24, // 4 months * 2
        effect: { type: 'churn_reduction', value: 0.10 },
        description: "Self-service help center and onboarding guides",
        prerequisites: []
      },
      {
        id: 'retention_2',
        name: "Predictive Retention Analytics",
        category: RND_CATEGORIES.RETENTION,
        developmentEffort: 36, // 8 months * 2
        effect: { type: 'churn_reduction', value: 0.10 },
        description: "Identify at-risk customers before they leave",
        prerequisites: ['retention_1']
      },
      {
        id: 'retention_3',
        name: "Hyper-Personalization Engine",
        category: RND_CATEGORIES.RETENTION,
        developmentEffort: 72, // 12 months * 2
        effect: { type: 'churn_reduction', value: 0.15 },
        description: "AI-driven personalized experiences and proactive support",
        prerequisites: ['retention_2']
      },
      {
        id: 'retention_4',
        name: "Personalized Marketing Engine",
        category: RND_CATEGORIES.RETENTION,
        developmentEffort: 240, // 12 months * 2
        effect: { type: 'churn_reduction', value: 0.10 },
        description: "Personalized marketing campaigns and targeted promotions",
        prerequisites: ['retention_3']
      },
      
      // EMPLOYEE EFFECTIVENESS STREET (Sequential)
      {
        id: 'efficiency_1',
        name: "Modern Dev Tools & CI/CD",
        category: RND_CATEGORIES.EFFICIENCY,
        developmentEffort: 48, // 3 months * 2
        effect: { type: 'employee_efficiency', value: 0.10 },
        description: "Automated testing, deployment pipelines, and modern IDEs",
        prerequisites: []
      },
      {
        id: 'efficiency_2',
        name: "Knowledge Management Platform",
        category: RND_CATEGORIES.EFFICIENCY,
        developmentEffort: 60, // 6 months * 2
        effect: { type: 'employee_efficiency', value: 0.10 },
        description: "Internal wiki, training resources, and best practices library",
        prerequisites: ['efficiency_1']
      },
      {
        id: 'efficiency_3',
        name: "AI Coding Assistant",
        category: RND_CATEGORIES.EFFICIENCY,
        developmentEffort: 180, // 10 months * 2
        effect: { type: 'employee_efficiency', value: 0.15 },
        description: "AI-powered code completion, debugging, and refactoring",
        prerequisites: ['efficiency_2']
      },
      
      // PRODUCT UNLOCK STREET (Sequential chain)
      {
        id: 'unlock_time_tracking',
        name: "Advanced Task Scheduling Research",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 6, // 2 months * 2
        effect: { type: 'unlock_product', value: 'Time Tracking App' },
        description: "Research advanced time tracking algorithms",
        prerequisites: []
      },
      {
        id: 'unlock_form_builder',
        name: "Dynamic Form Generation",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 8, // 2 months * 2
        effect: { type: 'unlock_product', value: 'Form Builder' },
        description: "Develop dynamic form rendering technology",
        prerequisites: ['unlock_time_tracking']
      },
      {
        id: 'unlock_invoicing',
        name: "Automated Billing Systems",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 8, // 3 months * 2
        effect: { type: 'unlock_product', value: 'Invoicing Software' },
        description: "Create automated billing and invoice generation",
        prerequisites: ['unlock_form_builder']
      },
      {
        id: 'unlock_crm',
        name: "Customer Relationship Modeling",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 12, // 4 months * 2
        effect: { type: 'unlock_product', value: 'CRM Lite' },
        description: "Design customer relationship database architecture",
        prerequisites: ['unlock_invoicing']
      },
      {
        id: 'unlock_password',
        name: "Encryption & Secure Storage",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 12, // 3 months * 2
        effect: { type: 'unlock_product', value: 'Password Manager' },
        description: "Research encryption and secure credential storage",
        prerequisites: ['unlock_crm']
      },
      {
        id: 'unlock_email_marketing',
        name: "Campaign Automation Engine",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 12, // 5 months * 2
        effect: { type: 'unlock_product', value: 'Email Marketing Tool' },
        description: "Build campaign automation and email delivery systems",
        prerequisites: ['unlock_password']
      },
      {
        id: 'unlock_analytics',
        name: "Data Visualization Framework",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 24, // 6 months * 2
        effect: { type: 'unlock_product', value: 'Analytics Dashboard' },
        description: "Create advanced data visualization libraries",
        prerequisites: ['unlock_email_marketing']
      },
      {
        id: 'unlock_social_media',
        name: "Social Media API Integration",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 24, // 6 months * 2
        effect: { type: 'unlock_product', value: 'Social Media Manager' },
        description: "Integrate with major social media platforms",
        prerequisites: ['unlock_analytics']
      },
      {
        id: 'unlock_project_mgmt',
        name: "Agile Workflow Architecture",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 36, // 8 months * 2
        effect: { type: 'unlock_product', value: 'Project Management Suite' },
        description: "Design agile project management workflows",
        prerequisites: ['unlock_social_media']
      },
      {
        id: 'unlock_hr',
        name: "Enterprise HR Systems",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 36, // 10 months * 2
        effect: { type: 'unlock_product', value: 'HR Management System' },
        description: "Build enterprise-grade HR management infrastructure",
        prerequisites: ['unlock_project_mgmt']
      },
      {
        id: 'unlock_ecommerce',
        name: "Payment Gateway & Shopping Cart",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 36, // 12 months * 2
        effect: { type: 'unlock_product', value: 'E-commerce Platform' },
        description: "Integrate payment processing and shopping cart",
        prerequisites: ['unlock_hr']
      },
      {
        id: 'unlock_video',
        name: "Real-time Video Streaming",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 48, // 15 months * 2
        effect: { type: 'unlock_product', value: 'Video Conferencing Tool' },
        description: "Develop real-time video and audio streaming technology",
        prerequisites: ['unlock_ecommerce']
      },
      {
        id: 'unlock_ai_chatbot',
        name: "Natural Language Processing",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 48, // 20 months * 2
        effect: { type: 'unlock_product', value: 'AI Chatbot' },
        description: "Research NLP and conversational AI",
        prerequisites: ['unlock_video']
      },
      {
        id: 'unlock_erp',
        name: "Enterprise Integration Framework",
        category: RND_CATEGORIES.UNLOCK,
        developmentEffort: 60, // 24 months * 2
        effect: { type: 'unlock_product', value: 'ERP System' },
        description: "Build enterprise resource planning integration framework",
        prerequisites: ['unlock_ai_chatbot']
      }
    ];

    // ============================================
    // HIRING MILESTONE SYSTEM
    // ============================================
    // Milestones based on lifetime earnings determine hiring pool quality
    const HIRING_MILESTONES = [
      { threshold: 0, name: "Startup", badge: "ð±", description: "Entry-Level Talent" },
      { threshold: 100000, name: "Small Business", badge: "ð", description: "Growing Talent Pool" },
      { threshold: 500000, name: "Growing Company", badge: "ð", description: "Quality Candidates" },
      { threshold: 2000000, name: "Established Company", badge: "ð¢", description: "Senior Talent Available" },
      { threshold: 10000000, name: "Major Player", badge: "â­", description: "Elite Talent Pool" },
      { threshold: 1000000000, name: "Fortune 500", badge: "ð°", description: "Fortune 500 Talent Pool" }
    ];

    // Probability tables: [Junior%, Intermediate%, Senior%, Lead%, Expert%]
    const DEVELOPER_TIER_PROBABILITIES = {
      0:        [100, 0,  0,  0,  0],  // Startup: 100% Junior
      100000:   [70,  25, 5,  0,  0],  // Small Business: Mostly Junior, some Intermediate
      500000:   [40,  40, 15, 5,  0],  // Growing Company: Balanced mix
      2000000:  [20,  30, 30, 15, 5],  // Established: More Senior talent
      10000000: [5,   20, 35, 25, 15]  // Major Player: Mostly Senior/Lead/Expert
    };

    const MARKETER_TIER_PROBABILITIES = {
      0:        [100, 0,  0,  0,  0],  // Startup: 100% Junior
      100000:   [70,  25, 5,  0,  0],  // Small Business: Mostly Junior, some Intermediate
      500000:   [40,  40, 15, 5,  0],  // Growing Company: Balanced mix
      2000000:  [20,  30, 30, 15, 5],  // Established: More Senior talent
      10000000: [5,   20, 35, 25, 15]  // Major Player: Mostly Senior/Lead/Expert
    };

    // ============================================
    // EMPLOYEE & OFFICE TIERS (Phase 3)
    // ============================================
    // Employee progression: 100 months of work = 1.0x efficiency gain
    const EXPERIENCE_RATE = 0.01; // Efficiency gain per month of work
    
    const DEVELOPER_TIERS = [
      {
        name: "Junior Developer",
        skill: "junior",
        efficiency: 0.5,
        efficiencyCap: 1.0, // Promotes to Intermediate at 1.0x
        monthlySalaryUSD: 3000,
        monthlySalaryEUR: 2700
      },
      {
        name: "Intermediate Developer",
        skill: "intermediate",
        efficiency: 1.0,
        efficiencyCap: 1.5, // Promotes to Senior at 1.5x
        monthlySalaryUSD: 5000,
        monthlySalaryEUR: 4500
      },
      {
        name: "Senior Developer",
        skill: "senior",
        efficiency: 1.5,
        efficiencyCap: 2.0, // Promotes to Lead at 2.0x
        monthlySalaryUSD: 7000,
        monthlySalaryEUR: 6300
      },
      {
        name: "Lead Developer",
        skill: "lead",
        efficiency: 2.0,
        efficiencyCap: 3.0, // Promotes to Expert at 3.0x
        monthlySalaryUSD: 9000,
        monthlySalaryEUR: 8100
      },
      {
        name: "Expert Developer",
        skill: "expert",
        efficiency: 3.0,
        efficiencyCap: 5.0, // Max efficiency, no further promotion
        monthlySalaryUSD: 12000,
        monthlySalaryEUR: 10800
      }
    ];

    const MARKETER_TIERS = [
      {
        name: "Junior Marketer",
        skill: "junior",
        efficiency: 0.5,
        efficiencyCap: 1.0, // Promotes to Intermediate at 1.0x
        monthlySalaryUSD: 2500,
        monthlySalaryEUR: 2250
      },
      {
        name: "Intermediate Marketer",
        skill: "intermediate",
        efficiency: 1.0,
        efficiencyCap: 1.5, // Promotes to Senior at 1.5x
        monthlySalaryUSD: 4000,
        monthlySalaryEUR: 3600
      },
      {
        name: "Senior Marketer",
        skill: "senior",
        efficiency: 1.5,
        efficiencyCap: 2.0, // Promotes to Lead at 2.0x
        monthlySalaryUSD: 5500,
        monthlySalaryEUR: 4950
      },
      {
        name: "Lead Marketer",
        skill: "lead",
        efficiency: 2.0,
        efficiencyCap: 3.0, // Promotes to Expert at 3.0x
        monthlySalaryUSD: 7000,
        monthlySalaryEUR: 6300
      },
      {
        name: "Expert Marketer",
        skill: "expert",
        efficiency: 3.0,
        efficiencyCap: 5.0, // Max efficiency, no further promotion
        monthlySalaryUSD: 10000,
        monthlySalaryEUR: 9000
      }
    ];

    const OFFICE_TIERS = [
      {
        name: "Home Office",
        capacity: 3,
        monthlyRentUSD: 0,
        monthlyRentEUR: 0,
        utilitiesBaseUSD: 200,
        utilitiesBaseEUR: 180,
        utilitiesPerPersonUSD: 80,
        utilitiesPerPersonEUR: 72
      },
      {
        name: "Small Office",
        capacity: 8,
        monthlyRentUSD: 2500,
        monthlyRentEUR: 2250,
        utilitiesBaseUSD: 800,
        utilitiesBaseEUR: 720,
        utilitiesPerPersonUSD: 120,
        utilitiesPerPersonEUR: 108
      },
      {
        name: "Medium Office",
        capacity: 15,
        monthlyRentUSD: 8000,
        monthlyRentEUR: 7200,
        utilitiesBaseUSD: 2000,
        utilitiesBaseEUR: 1800,
        utilitiesPerPersonUSD: 100,
        utilitiesPerPersonEUR: 90
      },
      {
        name: "Large Office",
        capacity: 30,
        monthlyRentUSD: 30000,
        monthlyRentEUR: 27000,
        utilitiesBaseUSD: 5500,
        utilitiesBaseEUR: 5000,
        utilitiesPerPersonUSD: 80,
        utilitiesPerPersonEUR: 72
      },
      {
        name: "Enterprise HQ",
        capacity: 100,
        monthlyRentUSD: 250000,
        monthlyRentEUR: 225000,
        utilitiesBaseUSD: 20000,
        utilitiesBaseEUR: 18000,
        utilitiesPerPersonUSD: 70,
        utilitiesPerPersonEUR: 63
      }
    ];

    const SERVER_TIERS = [
      {
        name: "Shared Hosting",
        maxSubscribers: 100,
        monthlyFeeUSD: 10,      // Free tier
        monthlyFeeEUR: 9,
        upgradeCostUSD: 0,
        upgradeCostEUR: 0
      },
      {
        name: "VPS Basic",
        maxSubscribers: 500,
        monthlyFeeUSD: 200,
        monthlyFeeEUR: 180,
        upgradeCostUSD: 200,
        upgradeCostEUR: 180
      },
      {
        name: "VPS Standard",
        maxSubscribers: 2000,
        monthlyFeeUSD: 800,
        monthlyFeeEUR: 720,
        upgradeCostUSD: 800,
        upgradeCostEUR: 720
      },
      {
        name: "VPS Premium",
        maxSubscribers: 5000,
        monthlyFeeUSD: 2200,
        monthlyFeeEUR: 2000,
        upgradeCostUSD: 2200,
        upgradeCostEUR: 2000
      },
      {
        name: "Dedicated Server",
        maxSubscribers: 15000,
        monthlyFeeUSD: 8000,
        monthlyFeeEUR: 7200,
        upgradeCostUSD: 8000,
        upgradeCostEUR: 7200
      },
      {
        name: "Cloud Infrastructure",
        maxSubscribers: 50000,
        monthlyFeeUSD: 35000,
        monthlyFeeEUR: 32000,
        upgradeCostUSD: 35000,
        upgradeCostEUR: 32000
      },
      {
        name: "Enterprise Cloud",
        maxSubscribers: 999999, // Unlimited
        monthlyFeeUSD: 500000,
        monthlyFeeEUR: 450000,
        upgradeCostUSD: 0,       // No more upgrades
        upgradeCostEUR: 0
      }
    ];

    // ============================================
    // EMPLOYEE UNLOCK THRESHOLDS
    // ============================================
    const EMPLOYEE_UNLOCK_THRESHOLDS = {
      junior: 0,           // Always unlocked
      intermediate: 100000,
      senior: 500000,
      lead: 1000000,
      expert: 5000000
    };

    // Regional name database for realistic name combinations
    const REGIONAL_NAMES = {
      "US_Canada": {
        firstNames: [
          "James", "Mary", "John", "Patricia", "Robert", "Jennifer", "Michael", "Linda", "William", "Barbara",
          "David", "Elizabeth", "Richard", "Susan", "Joseph", "Jessica", "Thomas", "Sarah", "Christopher", "Karen",
          "Charles", "Lisa", "Daniel", "Nancy", "Matthew", "Betty", "Anthony", "Margaret", "Mark", "Sandra",
          "Donald", "Ashley", "Steven", "Kimberly", "Andrew", "Emily", "Paul", "Donna", "Joshua", "Michelle",
          "Kenneth", "Carol", "Kevin", "Amanda", "Brian", "Dorothy", "George", "Melissa", "Timothy", "Deborah",
          "Ronald", "Stephanie", "Edward", "Rebecca", "Jason", "Sharon", "Jeffrey", "Laura", "Ryan", "Cynthia",
          "Jacob", "Kathleen", "Gary", "Amy", "Nicholas", "Angela", "Eric", "Shirley", "Jonathan", "Anna",
          "Stephen", "Brenda", "Larry", "Pamela", "Justin", "Emma", "Scott", "Nicole", "Brandon", "Helen",
          "Benjamin", "Samantha", "Samuel", "Katherine", "Raymond", "Christine", "Gregory", "Debra", "Frank", "Rachel",
          "Alexander", "Carolyn", "Patrick", "Janet", "Jack", "Catherine", "Dennis", "Maria", "Jerry", "Heather"
        ],
        lastNames: [
          "Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez",
          "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson", "Thomas", "Taylor", "Moore", "Jackson", "Martin",
          "Lee", "Perez", "Thompson", "White", "Harris", "Sanchez", "Clark", "Ramirez", "Lewis", "Robinson",
          "Walker", "Young", "Allen", "King", "Wright", "Scott", "Torres", "Nguyen", "Hill", "Flores",
          "Green", "Adams", "Nelson", "Baker", "Hall", "Rivera", "Campbell", "Mitchell", "Carter", "Roberts",
          "Gomez", "Phillips", "Evans", "Turner", "Diaz", "Parker", "Cruz", "Edwards", "Collins", "Reyes",
          "Stewart", "Morris", "Morales", "Murphy", "Cook", "Rogers", "Gutierrez", "Ortiz", "Morgan", "Cooper",
          "Peterson", "Bailey", "Reed", "Kelly", "Howard", "Ramos", "Kim", "Cox", "Ward", "Richardson",
          "Watson", "Brooks", "Chavez", "Wood", "James", "Bennett", "Gray", "Mendoza", "Ruiz", "Hughes",
          "Price", "Alvarez", "Castillo", "Sanders", "Patel", "Myers", "Long", "Ross", "Foster", "Jimenez"
        ]
      },
      "Latin_Hispanic": {
        firstNames: [
          "JosÃ©", "MarÃ­a", "Juan", "Ana", "Carlos", "Carmen", "Luis", "Rosa", "Miguel", "Isabel",
          "Antonio", "Laura", "Francisco", "Patricia", "Javier", "Elena", "Manuel", "Marta", "Pedro", "Sofia",
          "Diego", "Lucia", "Fernando", "Teresa", "Rafael", "Monica", "Jorge", "Claudia", "Ricardo", "Angela",
          "Alejandro", "Beatriz", "Eduardo", "Silvia", "Roberto", "Gloria", "Daniel", "Adriana", "Raul", "Diana",
          "Sergio", "Julia", "Pablo", "Paola", "Andres", "Gabriela", "Oscar", "Veronica", "Marco", "Cristina",
          "Enrique", "Sandra", "Alberto", "Natalia", "Guillermo", "Mariana", "Gonzalo", "Daniela", "Rodrigo", "Carolina",
          "Gabriel", "Valentina", "Arturo", "Andrea", "Victor", "Alejandra", "Ramon", "Lorena", "Alfredo", "Rocio",
          "Felipe", "Cecilia", "Lorenzo", "Susana", "Emilio", "Blanca", "Hector", "Victoria", "Octavio", "Pilar",
          "Salvador", "Alicia", "Julio", "Dolores", "Ruben", "Raquel", "Mateo", "Ines", "Leonardo", "Esperanza",
          "Santiago", "Catalina", "Tomas", "Amparo", "Nicolas", "Concepcion", "Hugo", "Mercedes", "Adrian", "Soledad"
        ],
        lastNames: [
          "Garcia", "Rodriguez", "Martinez", "Hernandez", "Lopez", "Gonzalez", "Perez", "Sanchez", "Ramirez", "Torres",
          "Flores", "Rivera", "Gomez", "Diaz", "Cruz", "Morales", "Reyes", "Gutierrez", "Ortiz", "Mendoza",
          "Ruiz", "Alvarez", "Castillo", "Jimenez", "Romero", "Vargas", "Herrera", "Medina", "Aguilar", "Castro",
          "Ramos", "Moreno", "Vazquez", "Rojas", "Fernandez", "Delgado", "Silva", "Navarro", "Soto", "Mendez",
          "Vega", "Nunez", "Guerrero", "Dominguez", "Campos", "Pena", "Santos", "Rios", "Cardenas", "Leon",
          "Ayala", "Cabrera", "Sandoval", "Fuentes", "Calderon", "Figueroa", "Pacheco", "Carrillo", "Duran", "Cortez",
          "Velazquez", "Salazar", "Maldonado", "Acosta", "Cervantes", "Garza", "Luna", "Sosa", "Suarez", "Lara",
          "Molina", "Ochoa", "Ortega", "Peralta", "Estrada", "Contreras", "Ibarra", "Marin", "Bautista", "Orozco",
          "Espinoza", "Murillo", "Valencia", "Rosales", "Aguirre", "Villarreal", "Franco", "Ponce", "Benitez", "Camacho",
          "Mercado", "Salas", "Cuevas", "Barrera", "Zamora", "Escobar", "Miranda", "Montes", "Cordova", "Padilla"
        ]
      },
      "UK": {
        firstNames: [
          "Oliver", "Amelia", "George", "Olivia", "Harry", "Emily", "Jack", "Isla", "Jacob", "Ava",
          "Charlie", "Jessica", "Thomas", "Poppy", "Oscar", "Sophie", "William", "Isabella", "James", "Lily",
          "Mohammed", "Grace", "Henry", "Ella", "Alfie", "Scarlett", "Leo", "Chloe", "Noah", "Mia",
          "Arthur", "Freya", "Muhammad", "Florence", "Freddie", "Evie", "Archie", "Ruby", "Isaac", "Sienna",
          "Albert", "Daisy", "Joshua", "Phoebe", "Alexander", "Alice", "Edward", "Charlotte", "Max", "Isabelle",
          "Daniel", "Maya", "Samuel", "Eva", "Lucas", "Lucy", "Mason", "Elsie", "Harrison", "Rosie",
          "Sebastian", "Sophia", "Theo", "Matilda", "Ethan", "Hannah", "Adam", "Millie", "Benjamin", "Layla",
          "Logan", "Ivy", "Finley", "Violet", "Elijah", "Holly", "Muhammad", "Evelyn", "Jaxon", "Willow",
          "Lewis", "Harriet", "Dylan", "Zara", "Jayden", "Esme", "Zachary", "Imogen", "Reuben", "Emma",
          "Toby", "Maisie", "Luca", "Thea", "Hugo", "Georgina", "Nathan", "Molly", "Felix", "Abigail"
        ],
        lastNames: [
          "Smith", "Jones", "Williams", "Taylor", "Brown", "Davies", "Evans", "Wilson", "Thomas", "Johnson",
          "Roberts", "Walker", "Wright", "Robinson", "Thompson", "White", "Hughes", "Edwards", "Green", "Hall",
          "Lewis", "Harris", "Clarke", "Patel", "Jackson", "Wood", "Turner", "Martin", "Cooper", "Hill",
          "Ward", "Morris", "Moore", "Clark", "Lee", "King", "Baker", "Harrison", "Morgan", "Allen",
          "James", "Scott", "Phillips", "Watson", "Davis", "Parker", "Price", "Bennett", "Wood", "Barnes",
          "Ross", "Henderson", "Mills", "Gibson", "Graham", "Simpson", "Hunter", "Thomson", "Webb", "Fraser",
          "Reid", "Murray", "Stevens", "Matthews", "Robertson", "Mason", "Hunt", "Shaw", "Russell", "Palmer",
          "Mitchell", "Richardson", "Walsh", "Gray", "Cook", "Powell", "Kelly", "Cameron", "Butler", "Stewart",
          "Bailey", "Young", "Foster", "Knight", "Chapman", "Fox", "Harvey", "Cole", "Barker", "Jenkins",
          "Warren", "Marshall", "Pearson", "Ferguson", "Hamilton", "Bryant", "Reynolds", "Ellis", "Austin", "Payne"
        ]
      },
      "Netherlands": {
        firstNames: [
          "Daan", "Emma", "Sem", "Julia", "Lucas", "Sophie", "Milan", "Anna", "Levi", "Tess",
          "Luuk", "Lisa", "Lars", "Saar", "Finn", "Eva", "Thijs", "Mila", "Bram", "Noa",
          "Jesse", "Isa", "Stijn", "Lotte", "Thomas", "Fleur", "Max", "Sara", "Tim", "Fenna",
          "Sam", "Lynn", "Ruben", "Luna", "Tom", "Amy", "Gijs", "Zoey", "Jasper", "Evi",
          "Jan", "Maria", "Pieter", "Anna", "Henk", "Karin", "Kees", "Sandra", "Willem", "Linda",
          "Jeroen", "Marieke", "Bas", "Esther", "Niels", "Ingrid", "Sander", "Laura", "Joost", "Marloes",
          "Martijn", "Charlotte", "Arjan", "Annemarie", "Remco", "Monique", "Wouter", "Nicole", "Dennis", "Suzanne",
          "Mark", "Astrid", "Peter", "Bianca", "Erik", "Renee", "Bart", "Maaike", "Rob", "Judith",
          "Patrick", "Sabine", "Ronald", "Yvonne", "Frank", "Patricia", "Marcel", "Wendy", "Hans", "Jeanette",
          "Gerrit", "Anja", "Maarten", "Mirjam", "Vincent", "Pauline", "Michiel", "Anita", "Stefan", "Ilse"
        ],
        lastNames: [
          "de Jong", "Jansen", "de Vries", "van den Berg", "van Dijk", "Bakker", "Janssen", "Visser", "Smit", "Meijer",
          "de Boer", "Mulder", "de Groot", "Bos", "Vos", "Peters", "Hendriks", "van Leeuwen", "Dekker", "Brouwer",
          "de Wit", "Dijkstra", "Smits", "de Graaf", "van der Meer", "van der Linden", "Kok", "Jacobs", "de Haan", "Vermeulen",
          "van den Heuvel", "van der Veen", "van den Broek", "de Bruijn", "de Bruin", "van der Heijden", "Schouten", "van Beek", "Willems", "van Vliet",
          "van de Ven", "Hoekstra", "Maas", "Verhoeven", "Koster", "van Dam", "van der Wal", "Prins", "Blom", "Huisman",
          "Peeters", "de Lange", "Aarts", "Adriaansen", "Albers", "Baars", "Beek", "Bosch", "Claassen", "Damen",
          "Driessen", "Evers", "Franssen", "Gerritsen", "Goossens", "Groen", "Groot", "Haan", "Hermans", "Hofs",
          "Jans", "Jonker", "Kamp", "Klein", "Koning", "Kramer", "Kuiper", "Laan", "Martens", "Moll",
          "Nijhuis", "Pol", "Post", "Prins", "Roos", "Sanders", "Scholten", "Schroder", "Steenber", "Stolk",
          "Timmermans", "Vink", "Vogel", "de Vos", "Vrielink", "de Waal", "Wit", "Wolters", "Zwart", "van Beek"
        ]
      },
      "Germany": {
        firstNames: [
          "Lukas", "Emma", "Leon", "Mia", "Ben", "Hannah", "Paul", "Sophia", "Jonas", "Anna",
          "Felix", "Lena", "Noah", "Lea", "Elias", "Marie", "Finn", "Laura", "Luis", "Sophie",
          "Maximilian", "Charlotte", "Alexander", "Maria", "David", "Emily", "Niklas", "Lisa", "Tim", "Johanna",
          "Jan", "Lara", "Max", "Julia", "Moritz", "Sarah", "Philipp", "Katharina", "Simon", "Franziska",
          "Tobias", "Luisa", "Sebastian", "Amelie", "Fabian", "Leonie", "Julian", "Clara", "Florian", "Elena",
          "Michael", "Petra", "Thomas", "Monika", "Andreas", "Sabine", "Markus", "Susanne", "Stefan", "Claudia",
          "Christian", "Birgit", "Martin", "Andrea", "Daniel", "Martina", "Frank", "Angelika", "Peter", "Christine",
          "Wolfgang", "Karin", "Klaus", "Gabriele", "JÃ¼rgen", "Renate", "Dieter", "Ursula", "Hans", "Ingrid",
          "Heinz", "Helga", "Manfred", "Brigitte", "Werner", "Erika", "GÃ¼nter", "Heike", "Helmut", "Ute",
          "Karl", "Gisela", "Horst", "Christa", "Rainer", "Elisabeth", "Walter", "Ilse", "Bernd", "Hildegard"
        ],
        lastNames: [
          "MÃ¼ller", "Schmidt", "Schneider", "Fischer", "Weber", "Meyer", "Wagner", "Becker", "Schulz", "Hoffmann",
          "SchÃ¤fer", "Koch", "Bauer", "Richter", "Klein", "Wolf", "SchrÃ¶der", "Neumann", "Schwarz", "Zimmermann",
          "Braun", "KrÃ¼ger", "Hofmann", "Hartmann", "Lange", "Schmitt", "Werner", "Schmitz", "Krause", "Meier",
          "Lehmann", "Schmid", "Schulze", "Maier", "KÃ¶hler", "Herrmann", "KÃ¶nig", "Walter", "Mayer", "Huber",
          "Kaiser", "Fuchs", "Peters", "Lang", "Scholz", "MÃ¶ller", "WeiÃ", "Jung", "Hahn", "Schubert",
          "Vogel", "Friedrich", "Keller", "GÃ¼nther", "Frank", "Berger", "Winkler", "Roth", "Beck", "Baumann",
          "Kraus", "BÃ¶hm", "Simon", "Graf", "Sauer", "Heinrich", "Otto", "Seidel", "Wolff", "Brandt",
          "Pfeiffer", "Vogt", "Ludwig", "Paul", "Horn", "Busch", "Arnold", "Thomas", "Sommer", "Martin",
          "Engel", "Lorenz", "Pohl", "GroÃ", "Stein", "Haas", "Bergmann", "Schuster", "Kramer", "BÃ¶hme",
          "Lindner", "JÃ¤ger", "Michel", "KrÃ¤mer", "Voigt", "Winter", "Kuhn", "Nagel", "Ritter", "Franke"
        ]
      },
      "France": {
        firstNames: [
          "Louis", "Emma", "Gabriel", "Jade", "RaphaÃ«l", "Louise", "Arthur", "Alice", "Jules", "ChloÃ©",
          "Adam", "LÃ©a", "Lucas", "Manon", "Hugo", "ZoÃ©", "LÃ©o", "Lola", "MaÃ«l", "Camille",
          "Tom", "InÃ¨s", "Nathan", "Sarah", "Ethan", "Lilou", "Noah", "Eva", "ThÃ©o", "Juliette",
          "Antoine", "Marie", "Paul", "Claire", "Jean", "Sophie", "Pierre", "Anne", "FranÃ§ois", "Julie",
          "Nicolas", "Isabelle", "Julien", "Nathalie", "Alexandre", "Catherine", "Thomas", "Stephanie", "Maxime", "Sandrine",
          "David", "Sylvie", "Laurent", "ValÃ©rie", "SÃ©bastien", "Christine", "Guillaume", "Patricia", "Romain", "Martine",
          "Vincent", "Monique", "Olivier", "Nicole", "Mathieu", "FranÃ§oise", "Eric", "Brigitte", "Michel", "VÃ©ronique",
          "Philippe", "Annie", "Alain", "Jacqueline", "Bernard", "Danielle", "Patrick", "Dominique", "Christian", "Christiane",
          "Jacques", "Denise", "Marcel", "Michelle", "RenÃ©", "Paulette", "Henri", "Jeanne", "Robert", "Simone",
          "AndrÃ©", "Colette", "Georges", "Yvette", "Charles", "Madeleine", "Claude", "Suzanne", "Roger", "HÃ©lÃ¨ne"
        ],
        lastNames: [
          "Martin", "Bernard", "Dubois", "Thomas", "Robert", "Richard", "Petit", "Durand", "Leroy", "Moreau",
          "Simon", "Laurent", "Lefebvre", "Michel", "Garcia", "David", "Bertrand", "Roux", "Vincent", "Fournier",
          "Morel", "Girard", "AndrÃ©", "Lefevre", "Mercier", "Dupont", "Lambert", "Bonnet", "FranÃ§ois", "Martinez",
          "Legrand", "Garnier", "Faure", "Rousseau", "Blanc", "Guerin", "Muller", "Henry", "Roussel", "Nicolas",
          "Perrin", "Morin", "Mathieu", "Clement", "Gauthier", "Dumont", "Lopez", "Fontaine", "Chevalier", "Robin",
          "Masson", "Sanchez", "Gerard", "Nguyen", "Boyer", "Denis", "Lemaire", "Duval", "Joly", "Gautier",
          "Roger", "Roche", "Roy", "Noel", "Meyer", "Lucas", "Meunier", "Jean", "Perez", "Marchand",
          "Dufour", "Blanchard", "Marie", "Barbier", "Brun", "Dumas", "Brunet", "Schmitt", "Lacroix", "Renard",
          "Arnaud", "Ballard", "Fabre", "Olivier", "Toussaint", "Lemoine", "Menard", "Rolland", "Caron", "Riviere",
          "Leclerc", "Benoit", "Vidal", "Picard", "Boucher", "Renaud", "Giraud", "Hubert", "Aubry", "Maillard"
        ]
      },
      "Scandinavian": {
        firstNames: [
          "Lars", "Anna", "Erik", "Karin", "Per", "Maria", "Jan", "Kristina", "Anders", "Eva",
          "Johan", "Marie", "Nils", "Ingrid", "Karl", "Margareta", "Mikael", "Elisabeth", "Fredrik", "Birgitta",
          "Peter", "Sofia", "Magnus", "Emma", "Hans", "Helena", "Sven", "Inger", "Olof", "Annika",
          "Gustav", "Linnea", "Oscar", "Maja", "Viktor", "Julia", "Emil", "Sara", "Axel", "Ebba",
          "BjÃ¶rn", "Astrid", "TorbjÃ¶rn", "Matilda", "Lennart", "Elin", "Bengt", "Johanna", "Kjell", "Katarina",
          "Ole", "Hanne", "Stig", "Lise", "Thor", "Solveig", "Morten", "Ingeborg", "Henrik", "Grete",
          "Leif", "Liv", "Arne", "Randi", "Knut", "Marit", "Geir", "Berit", "Tor", "Anne",
          "Petter", "Astrid", "Jens", "Sigrid", "Andreas", "Kristin", "Christian", "Hilde", "Martin", "Nina",
          "Thomas", "Mette", "Jonas", "Siri", "Daniel", "Else", "Tobias", "Agnes", "Felix", "Ida",
          "Rasmus", "Frida", "Alexander", "Elsa", "William", "Alma", "Filip", "Saga", "Lukas", "Wilma"
        ],
        lastNames: [
          "Andersson", "Johansson", "Karlsson", "Nilsson", "Eriksson", "Larsson", "Olsson", "Persson", "Svensson", "Gustafsson",
          "Pettersson", "Jonsson", "Jansson", "Hansson", "Bengtsson", "JÃ¶nsson", "Lindberg", "Jakobsson", "Magnusson", "Olofsson",
          "LindstrÃ¶m", "Lindqvist", "Lindgren", "Berg", "Axelsson", "BergstrÃ¶m", "Lundberg", "Lundgren", "Lind", "Lundqvist",
          "Hansen", "Johansen", "Olsen", "Larsen", "Andersen", "Pedersen", "Nilsen", "Kristiansen", "Jensen", "Karlsen",
          "Christiansen", "Pettersen", "SÃ¸rensen", "Rasmussen", "Andreassen", "Berg", "Haugen", "Hagen", "Johansen", "Mikkelsen",
          "Nielsen", "Jensen", "Petersen", "Madsen", "Christensen", "Rasmussen", "MÃ¸ller", "Larsen", "SÃ¸rensen", "JÃ¸rgensen",
          "Virtanen", "Korhonen", "MÃ¤kinen", "Nieminen", "HÃ¤mÃ¤lÃ¤inen", "Laine", "Heikkinen", "Koskinen", "JÃ¤rvinen", "Lehtonen",
          "BjÃ¶rk", "Holm", "StrÃ¶m", "Sandberg", "Forsberg", "Ãberg", "LundstrÃ¶m", "SÃ¶derberg", "Fransson", "SjÃ¶berg",
          "Wallin", "EngstrÃ¶m", "Eklund", "Danielsson", "HÃ¥kansson", "Lundin", "BjÃ¶rklund", "Bergman", "Gunnarsson", "Holmberg",
          "WikstrÃ¶m", "Isaksson", "Samuelsson", "NystrÃ¶m", "Hedlund", "Arvidsson", "Strand", "HellstrÃ¶m", "Nordin", "Blom"
        ]
      },
      "Italian": {
        firstNames: [
          "Francesco", "Sofia", "Alessandro", "Giulia", "Lorenzo", "Martina", "Leonardo", "Chiara", "Andrea", "Aurora",
          "Mattia", "Greta", "Gabriele", "Alice", "Riccardo", "Emma", "Tommaso", "Giorgia", "Davide", "Beatrice",
          "Giuseppe", "Anna", "Antonio", "Maria", "Marco", "Sara", "Giovanni", "Francesca", "Roberto", "Laura",
          "Luca", "Elena", "Paolo", "Valentina", "Stefano", "Alessandra", "Angelo", "Simona", "Salvatore", "Elisa",
          "Pietro", "Claudia", "Vincenzo", "Federica", "Domenico", "Monica", "Claudio", "Paola", "Nicola", "Silvia",
          "Michele", "Daniela", "Matteo", "Roberta", "Luigi", "Cristina", "Fabio", "Barbara", "Daniele", "Patrizia",
          "Simone", "Antonella", "Carlo", "Sabrina", "Alberto", "Manuela", "Filippo", "Giovanna", "Massimo", "Carla",
          "Enrico", "Lucia", "Emanuele", "Rossella", "Federico", "Serena", "Cristian", "Ilaria", "Diego", "Michela",
          "Valerio", "Emanuela", "Edoardo", "Stefania", "Giacomo", "Angela", "Alessio", "Lorena", "Manuel", "Giuseppina",
          "Samuele", "Valeria", "Raffaele", "Annalisa", "Gianluca", "Ivana", "Gianmarco", "Tiziana", "Dario", "Eleonora"
        ],
        lastNames: [
          "Rossi", "Russo", "Ferrari", "Esposito", "Bianchi", "Romano", "Colombo", "Ricci", "Marino", "Greco",
          "Bruno", "Gallo", "Conti", "De Luca", "Costa", "Giordano", "Mancini", "Rizzo", "Lombardi", "Moretti",
          "Barbieri", "Fontana", "Santoro", "Mariani", "Rinaldi", "Caruso", "Ferrara", "Galli", "Martini", "Leone",
          "Longo", "Gentile", "Martinelli", "Vitale", "Lombardo", "Serra", "Coppola", "De Santis", "D'Angelo", "Marchetti",
          "Parisi", "Villa", "Conte", "Ferraro", "Fabbri", "Bianco", "Sorrentino", "Grasso", "Valentini", "Benedetti",
          "Caputo", "Barone", "Grassi", "Testa", "Cattaneo", "Monti", "Giuliani", "Guerra", "Palmieri", "Bernardi",
          "Martino", "Fiore", "De Rosa", "Ferretti", "Bellini", "Basile", "Riva", "Donato", "Piras", "Vitali",
          "Battaglia", "Sartori", "Neri", "Costantini", "Milani", "Pagano", "Ruggiero", "Sorrentino", "D'Amico", "Orlando",
          "Damico", "Negri", "Sala", "Silvestri", "Pellegrini", "Palumbo", "Sanna", "Farina", "Rizzi", "Monti",
          "Cattaneo", "Morelli", "Amato", "Carbone", "Giordano", "Rizzo", "Lombardo", "Ferraro", "Galli", "Fontana"
        ]
      },
      "Turkish": {
        firstNames: [
          "Mehmet", "AyÅe", "Ahmet", "Fatma", "Mustafa", "Emine", "Ali", "Hatice", "HÃ¼seyin", "Zeynep",
          "Hasan", "Elif", "Ä°brahim", "Hacer", "Osman", "Sultan", "Yusuf", "Meryem", "Ä°smail", "Esma",
          "Emre", "Selin", "Burak", "Derya", "Can", "Ãzge", "Murat", "Ebru", "Serkan", "Aylin",
          "Kemal", "GÃ¼l", "Cem", "Deniz", "Volkan", "Canan", "Onur", "Burcu", "Berk", "PÄ±nar",
          "Koray", "Merve", "Baran", "Dilara", "Eren", "AslÄ±", "Ege", "Ä°rem", "Tolga", "Yasemin",
          "Kaan", "TuÄÃ§e", "BarÄ±Å", "Gamze", "ÃaÄlar", "Åebnem", "Alper", "Melis", "Umut", "Belgin",
          "Selim", "Nurcan", "Orkun", "Serpil", "Taner", "Filiz", "Erhan", "GÃ¼lay", "Hakan", "Serap",
          "YaÅar", "MÃ¼ge", "Engin", "Sibel", "Halil", "Sevda", "Recep", "Aysel", "Ãmer", "Hanife",
          "SÃ¼leyman", "Fadime", "Ramazan", "GÃ¼lsÃ¼m", "Mahmut", "Åerife", "Celal", "GÃ¼ler", "Salih", "Havva",
          "Veli", "Zeliha", "Orhan", "Neriman", "Kadir", "Sabiha", "Zeki", "Åeyma", "Adem", "Rukiye"
        ],
        lastNames: [
          "YÄ±lmaz", "Kaya", "Demir", "Åahin", "Ãelik", "YÄ±ldÄ±z", "YÄ±ldÄ±rÄ±m", "ÃztÃ¼rk", "AydÄ±n", "Ãzdemir",
          "Arslan", "DoÄan", "KÄ±lÄ±Ã§", "Aslan", "Ãetin", "Kara", "KoÃ§", "Kurt", "Ãzkan", "ÅimÅek",
          "ErdoÄan", "GÃ¼neÅ", "Aksoy", "AvcÄ±", "TÃ¼rk", "Ãzer", "Eren", "Bulut", "Kaplan", "Bozkurt",
          "Polat", "TaÅ", "ÃzgÃ¼r", "DemirtaÅ", "TunÃ§", "Korkmaz", "Åen", "Ãz", "GÃ¼ler", "Acar",
          "ÃakÄ±r", "AktaÅ", "Tekin", "Yavuz", "Bayram", "Keskin", "AteÅ", "Sezer", "Parlak", "Yaman",
          "Turan", "Soylu", "Bayar", "Karaca", "Ãzkan", "SÃ¶nmez", "Uysal", "AkyÃ¼z", "Ãzkaya", "ÃiftÃ§i",
          "Toprak", "Åeker", "Duman", "Topal", "KÄ±rmÄ±zÄ±", "SarÄ±", "Beyaz", "Mavi", "YeÅil", "Ayhan",
          "GÃ¼l", "DaÄ", "Deniz", "KÃ¶k", "Dal", "TaÅkÄ±n", "Erdem", "ÃnlÃ¼", "Kaynak", "SavaÅ",
          "BarÄ±Å", "Bilgin", "Ãzmen", "GenÃ§", "AkÄ±n", "Durmaz", "EryÄ±lmaz", "YalÃ§Ä±n", "GÃ¼ven", "AkgÃ¼l",
          "Ãzkan", "Ãolak", "GÃ¼zel", "Tan", "Ay", "ÃztÃ¼rk", "AydoÄan", "Ergin", "KoÃ§ak", "Akbulut"
        ]
      },
      "Japanese": {
        firstNames: [
          "Haruto", "Hina", "Yuto", "Yui", "Sota", "Sakura", "Ren", "Himari", "Yusei", "Koharu",
          "Haruki", "Honoka", "Yuki", "Akari", "Riku", "Aoi", "Kaito", "Riko", "Yamato", "Mio",
          "Hiroshi", "Yuki", "Takashi", "Keiko", "Taro", "Yoko", "Satoshi", "Naomi", "Masato", "Kazuko",
          "Kenji", "Kumiko", "Yoshio", "Michiko", "Makoto", "Ayako", "Shinji", "Reiko", "Takeshi", "Junko",
          "Kenichi", "Tomoko", "Koji", "Noriko", "Daisuke", "Mariko", "Masahiro", "Mitsuko", "Hiroyuki", "Akiko",
          "Akira", "Sachiko", "Osamu", "Yumiko", "Minoru", "Kyoko", "Shigeru", "Hideko", "Tetsuya", "Yoshiko",
          "Kazuo", "Chieko", "Nobuo", "Etsuko", "Hideo", "Kiyoko", "Masao", "Fumiko", "Yoshihiro", "Hisako",
          "Takeshi", "Teruko", "Yukio", "Sadako", "Toshio", "Kazue", "Mitsuru", "Masako", "Isamu", "Setsuko",
          "Kenta", "Megumi", "Shota", "Aya", "Daiki", "Mai", "Ryota", "Yuka", "Koki", "Rina",
          "Hayato", "Nana", "Shun", "Ai", "Ryusei", "Miyu", "Taiga", "Kana", "Ryo", "Asuka"
        ],
        lastNames: [
          "Sato", "Suzuki", "Takahashi", "Tanaka", "Watanabe", "Ito", "Yamamoto", "Nakamura", "Kobayashi", "Kato",
          "Yoshida", "Yamada", "Sasaki", "Yamaguchi", "Saito", "Matsumoto", "Inoue", "Kimura", "Hayashi", "Shimizu",
          "Yamazaki", "Mori", "Abe", "Ikeda", "Hashimoto", "Yamashita", "Ishikawa", "Nakajima", "Maeda", "Fujita",
          "Ogawa", "Goto", "Okada", "Hasegawa", "Murakami", "Kondo", "Ishii", "Saito", "Sakamoto", "Endo",
          "Aoki", "Fujii", "Nishimura", "Fukuda", "Ota", "Miura", "Okamoto", "Kawakami", "Hara", "Kaneko",
          "Nakagawa", "Harada", "Matsuda", "Fujiwara", "Ueda", "Sugiyama", "Takeuchi", "Nomura", "Ono", "Kikuchi",
          "Sawada", "Imai", "Nishikawa", "Maruyama", "Takada", "Morita", "Mizuno", "Murata", "Matsui", "Kubo",
          "Tamura", "Kojima", "Nakano", "Sakurai", "Shibata", "Miyazaki", "Masuda", "Noguchi", "Ohno", "Tsuchiya",
          "Hirata", "Arai", "Fukushima", "Inaba", "Nagai", "Wada", "Kuroda", "Miyamoto", "Horiuchi", "Ishida",
          "Kawasaki", "Horikawa", "Minami", "Yoshikawa", "Ichikawa", "Nagano", "Yamanaka", "Tsuji", "Fujimoto", "Takagi"
        ]
      },
      "Chinese": {
        firstNames: [
          "Wei", "Li", "Min", "Jing", "Ming", "Hui", "Yan", "Fang", "Lei", "Ying",
          "Hao", "Na", "Tao", "Xia", "Qiang", "Juan", "Jun", "Hong", "Cheng", "Mei",
          "Yong", "Lin", "Gang", "Xin", "Bo", "Xiong", "Peng", "Ling", "Feng", "Yu",
          "Jie", "Qin", "Long", "Ping", "Hai", "Rong", "Bin", "Yun", "Kun", "Dan",
          "Xiang", "Jian", "Wen", "Shu", "Dong", "Lan", "Yang", "Qing", "Hua", "Li",
          "Zhi", "Xiu", "Kai", "Shan", "Liang", "Fei", "Chao", "Yuan", "Yi", "Xue",
          "Xiaobo", "Xiaoli", "Xiaowei", "Xiaomei", "Xiaofeng", "Xiaoyu", "Xiaojun", "Xiaohui", "Xiaoyan", "Xiaojing",
          "Zhiwei", "Zhiqiang", "Zhihao", "Zhiyuan", "Zhipeng", "Zhihong", "Zhixin", "Zhiming", "Zhigang", "Zhijian",
          "Jiahui", "Jiaming", "Jiawei", "Jiahao", "Jiaxin", "Jiayun", "Jiaxiang", "Jiaying", "Jiaqiang", "Jiayu",
          "Yifan", "Yiming", "Yihao", "Yichen", "Yitao", "Yilin", "Yijun", "Yibo", "Yixuan", "Yifeng"
        ],
        lastNames: [
          "Wang", "Li", "Zhang", "Liu", "Chen", "Yang", "Huang", "Zhao", "Wu", "Zhou",
          "Xu", "Sun", "Ma", "Zhu", "Hu", "Guo", "He", "Gao", "Lin", "Luo",
          "Zheng", "Liang", "Song", "Tang", "Xu", "Han", "Feng", "Deng", "Cao", "Peng",
          "Zeng", "Xiao", "Tian", "Dong", "Pan", "Yuan", "Cai", "Jiang", "Yu", "Du",
          "Ye", "Cheng", "Su", "Wei", "Lu", "Ding", "Ren", "Shen", "Yao", "Lu",
          "Jiang", "Cui", "Zhong", "Tan", "Zou", "Xiong", "Jin", "Lu", "Hao", "Kong",
          "Bai", "Cui", "Kang", "Mao", "Qiu", "Qin", "Jiang", "Shi", "Gu", "Dai",
          "Xia", "Fan", "Fang", "Shi", "Yao", "Tan", "Sheng", "Zou", "Xiong", "Lu",
          "Mo", "Zhuang", "Yan", "Guan", "Meng", "Long", "Wan", "Duan", "Zhang", "Qian",
          "Tang", "Yin", "Li", "Yi", "Chang", "Wu", "Qiao", "Xie", "Zou", "Yu"
        ]
      },
      "African": {
        firstNames: [
          "Kwame", "Ama", "Kofi", "Akosua", "Kwesi", "Abena", "Yaw", "Yaa", "Kwabena", "Afia",
          "Chidi", "Amara", "Emeka", "Ngozi", "Chinwe", "Nneka", "Obi", "Ada", "Ikenna", "Chioma",
          "Tendai", "Rudo", "Tafadzwa", "Anesu", "Tinashe", "Rufaro", "Shamiso", "Tapiwa", "Munashe", "Rumbidzai",
          "Thabo", "Nomsa", "Sipho", "Zanele", "Mandla", "Lindiwe", "Bongani", "Nokuthula", "Mpho", "Lerato",
          "Kamau", "Wanjiru", "Mwangi", "Njeri", "Kariuki", "Wangari", "Kiptoo", "Cheruto", "Kipchoge", "Chepkoech",
          "Sekou", "Aminata", "Mamadou", "Fatoumata", "Ibrahim", "Aissatou", "Ousmane", "Mariam", "Moussa", "Kadiatou",
          "Kwame", "Akua", "Kofi", "Efua", "Yaw", "Adwoa", "Kwabena", "Abenaa", "Kwesi", "Akosua",
          "Oluwaseun", "Adaeze", "Olufemi", "Ifunanya", "Babatunde", "Chiamaka", "Temitope", "Chidinma", "Adekunle", "Folake",
          "Tunde", "Bisi", "Femi", "Funke", "Kunle", "Ronke", "Dele", "Yetunde", "Tunji", "Sade",
          "Nkosi", "Thandi", "Sizwe", "Zinhle", "Jabu", "Nonhlanhla", "Lungile", "Zodwa", "Musa", "Bongi"
        ],
        lastNames: [
          "Okafor", "Mensah", "Diallo", "Mwangi", "Nkosi", "Kamau", "Adeyemi", "Okoro", "Banda", "Mbatha",
          "Nkrumah", "Asante", "Boateng", "Owusu", "Ofori", "Agyeman", "Appiah", "Acheampong", "Darko", "Osei",
          "Okonkwo", "Eze", "Nwosu", "Obiora", "Chukwu", "Iheanacho", "Ugochukwu", "Chikezie", "Anyanwu", "Ekwueme",
          "Moyo", "Ncube", "Dube", "Sibanda", "Mpofu", "Ndlovu", "Nyathi", "Mlilo", "Tshuma", "Nkomo",
          "Dlamini", "Ngcobo", "Zulu", "Khoza", "Ndebele", "Mthembu", "Buthelezi", "Khumalo", "Sithole", "Mkhize",
          "Kimani", "Njoroge", "Ochieng", "Otieno", "Nyambura", "Waithaka", "Kipkorir", "Kiprotich", "Rotich", "Koech",
          "Traore", "Kone", "Toure", "Coulibaly", "Keita", "Sissoko", "Camara", "Diarra", "Cisse", "Dembele",
          "Mensah", "Koffi", "Yeboah", "Amoah", "Asamoah", "Bonsu", "Essien", "Frimpong", "Gyasi", "Koranteng",
          "Adebayo", "Ogunleye", "Akinyemi", "Oluwole", "Adeleke", "Afolabi", "Oladipo", "Ogundele", "Olaniyan", "Adewale",
          "Mashaba", "Molefe", "Tshabalala", "Ngwenya", "Mahlangu", "Mokwena", "Maluleke", "Chauke", "Baloyi", "Mathebula"
        ]
      },
      "Arab_MiddleEast": {
        firstNames: [
          "Mohammed", "Fatima", "Ahmed", "Aisha", "Ali", "Maryam", "Omar", "Khadija", "Hassan", "Zainab",
          "Abdullah", "Noor", "Ibrahim", "Layla", "Youssef", "Sara", "Khalid", "Hana", "Hamza", "Amina",
          "Mustafa", "Yasmin", "Mahmoud", "Zahra", "Kareem", "Nour", "Tariq", "Salma", "Rami", "Nadia",
          "Faisal", "Amal", "Said", "Lina", "Rashid", "Dina", "Majid", "Reem", "Samir", "Leila",
          "Jamal", "Huda", "Kamal", "Samira", "Adnan", "Hala", "Waleed", "Mona", "Basel", "Rana",
          "Ziad", "Rania", "Nabil", "Sana", "Hadi", "Nada", "Mazen", "Lama", "Talal", "Maya",
          "Sami", "Hind", "Rayan", "Dalia", "Marwan", "Jana", "Fadi", "Noura", "Bilal", "Heba",
          "Khaled", "Laila", "Fahad", "Basma", "Sultan", "Nada", "Nawaf", "Ghada", "Mansour", "Arwa",
          "Aziz", "Safaa", "Hakim", "Nisreen", "Jalal", "Suha", "Munir", "Samar", "Nasser", "Rasha",
          "Qasim", "Marwa", "Saleh", "Sabah", "Tamer", "Rawan", "Usman", "Shireen", "Yahya", "Thuraya"
        ],
        lastNames: [
          "Al-Farsi", "Hassan", "Abbas", "Mansour", "Khalil", "Rahman", "Al-Rashid", "Salem", "Al-Saud", "Hamdan",
          "Al-Ali", "Al-Ahmad", "Al-Hassan", "Al-Hussein", "Al-Mahmoud", "Al-Said", "Al-Omar", "Al-Khalil", "Al-Nasser", "Al-Qadir",
          "Abdullah", "Mohammed", "Ahmad", "Mahmoud", "Ibrahim", "Youssef", "Khalid", "Hamza", "Omar", "Ali",
          "Hussain", "Haddad", "Mansour", "Nasser", "Qasim", "Rashid", "Saad", "Saleh", "Tariq", "Waleed",
          "Amin", "Aziz", "Bashar", "Farid", "Habib", "Jamil", "Kamal", "Latif", "Majid", "Nadir",
          "Radi", "Sami", "Tahir", "Umar", "Wasim", "Yasin", "Zaki", "Adel", "Faisal", "Jamal",
          "Al-Masri", "Al-Shami", "Al-Misri", "Al-Maghribi", "Al-Tunisi", "Al-Jazairi", "Al-Libi", "Al-Sudani", "Al-Yamani", "Al-Iraqi",
          "Al-Kuwaiti", "Al-Emirati", "Al-Qatari", "Al-Bahraini", "Al-Omani", "Al-Jordani", "Al-Lubnani", "Al-Falastini", "Al-Suri", "Al-Masri",
          "Sheikh", "Emir", "Sharif", "Pasha", "Bey", "Khan", "Sultan", "Malik", "Amir", "Sayyid",
          "Habib", "Karim", "Latif", "Majeed", "Nasir", "Qadir", "Rashid", "Sadiq", "Tahir", "Wali"
        ]
      },
      "Indian": {
        firstNames: [
          "Aarav", "Aadhya", "Vivaan", "Ananya", "Aditya", "Diya", "Arjun", "Saanvi", "Sai", "Pari",
          "Arnav", "Avni", "Ayaan", "Sara", "Krishna", "Anvi", "Dhruv", "Angel", "Aryan", "Pihu",
          "Shaurya", "Navya", "Ishaan", "Ira", "Reyansh", "Prisha", "Atharv", "Shanaya", "Advait", "Kavya",
          "Vihaan", "Kiara", "Aadhyan", "Myra", "Om", "Anika", "Shivansh", "Riya", "Rudra", "Tara",
          "Raj", "Priya", "Rohan", "Pooja", "Amit", "Anjali", "Rahul", "Neha", "Vikram", "Shreya",
          "Karan", "Megha", "Varun", "Divya", "Nikhil", "Deepika", "Manish", "Ritu", "Suresh", "Kavita",
          "Rajesh", "Sunita", "Manoj", "Shweta", "Ashok", "Nisha", "Sanjay", "Rekha", "Rakesh", "Geeta",
          "Ramesh", "Seema", "Prakash", "Meena", "Ravi", "Radha", "Sunil", "Usha", "Anil", "Kiran",
          "Vijay", "Asha", "Ajay", "Poonam", "Vinod", "Lata", "Dinesh", "Suman", "Mukesh", "Sangeeta",
          "Mohan", "Savita", "Kishore", "Renuka", "Praveen", "Vandana", "Ganesh", "Kamala", "Mahesh", "Indira"
        ],
        lastNames: [
          "Kumar", "Sharma", "Singh", "Patel", "Gupta", "Shah", "Reddy", "Jain", "Agarwal", "Verma",
          "Yadav", "Mehta", "Chopra", "Kapoor", "Malhotra", "Bhatia", "Nair", "Iyer", "Menon", "Pillai",
          "Rao", "Desai", "Kulkarni", "Joshi", "Shukla", "Mishra", "Pandey", "Trivedi", "Dubey", "Tiwari",
          "Sinha", "Roy", "Das", "Banerjee", "Mukherjee", "Chatterjee", "Ghosh", "Bose", "Sen", "Dutta",
          "Choudhury", "Bhattacharya", "Chakraborty", "Mazumdar", "Sengupta", "Ganguly", "Biswas", "Dey", "Paul", "Sarkar",
          "Khan", "Ahmed", "Ali", "Hussain", "Ansari", "Shaikh", "Siddiqui", "Qureshi", "Malik", "Rizvi",
          "Rajan", "Krishnan", "Narayanan", "Raman", "Subramanian", "Venkatesh", "Ramesh", "Ganesh", "Suresh", "Mahesh",
          "Saxena", "Srivastava", "Agnihotri", "Chaturvedi", "Upadhyay", "Dwivedi", "Tripathi", "Pathak", "Dixit", "Ojha",
          "Jha", "Thakur", "Kaur", "Gill", "Dhillon", "Grewal", "Sandhu", "Bajwa", "Brar", "Randhawa",
          "Modi", "Gandhi", "Nehru", "Ambedkar", "Bose", "Tagore", "Naidu", "Prasad", "Babu", "Chand"
        ]
      },
      "Greek": {
        firstNames: [
          "Alexandros", "Maria", "Dimitris", "Eleni", "Georgios", "Katerina", "Ioannis", "Sofia", "Konstantinos", "Vasiliki",
          "Nikos", "Anna", "Panagiotis", "Ioanna", "Andreas", "Dimitra", "Christos", "Anastasia", "Michalis", "Panagiota",
          "Vasilis", "Christina", "Giannis", "Despina", "Kostas", "Stavroula", "Stelios", "Fotini", "Petros", "Evanthia",
          "Spyros", "Athena", "Apostolos", "Georgia", "Manolis", "Paraskevi", "Thanasis", "Efthymia", "Antonis", "Angeliki",
          "Yannis", "Nikoletta", "Giorgos", "Chrysoula", "Odysseas", "Zoe", "Ilias", "Irini", "Markos", "Kalliopi",
          "Pavlos", "Theodora", "Stefanos", "Helen", "Dimitrios", "Alexandra", "Filippos", "Olympia", "Leonidas", "Electra",
          "Achilles", "Aphrodite", "Theseus", "Artemis", "Perseus", "Hera", "Heracles", "Persephone", "Jason", "Daphne",
          "Nikolas", "Sophia", "Theodoros", "Evangelina", "Marios", "Konstantina", "Stavros", "Eleftheria", "Fotios", "Antigone",
          "Aristotelis", "Penelope", "Platon", "Iphigenia", "Sokrates", "Cassandra", "Pythagoras", "Melina", "Archimedes", "Demeter",
          "Alexandros", "Danae", "Dionysios", "Lydia", "Odysseas", "Chloe", "Thanos", "Nefeli", "Grigoris", "Ariadne"
        ],
        lastNames: [
          "Papadopoulos", "Pappas", "Georgiou", "Nikolaou", "Dimitriou", "Ioannou", "Konstantinou", "Christodoulou", "Petrou", "Oikonomou",
          "Vasileiou", "Angelopoulos", "Karagiannis", "Antoniou", "Vlachos", "Andreou", "Michalopoulos", "Athanasiadis", "Stavropoulos", "Papadakis",
          "Nikolaidis", "Makris", "Papanikolaou", "Karamanlis", "Koutsopoulos", "Economou", "Kokkinos", "Theodorou", "Alexandrou", "Doukas",
          "Panagopoulos", "Sidiropoulos", "Antonopoulos", "Sotirou", "Roussos", "Solomos", "Diamantis", "Lambrou", "Karas", "Manolopoulos",
          "Sotiropoulos", "Pantelis", "Demetriou", "Kostakis", "Samaras", "Papadimitriou", "Kontou", "Leontis", "Mavros", "Nikos",
          "Pappas", "Christou", "Vassilios", "Theodosiou", "Anastasios", "Zacharopoulos", "Xenakis", "Yiannakis", "Tzavellas", "Vrettos",
          "Sideris", "Rizos", "Psarros", "Orphanos", "Nikas", "Mitropoulos", "Loizou", "Kyriakou", "Kalogeropoulos", "Ifantis",
          "Hadjis", "Giannakis", "Fotopoulos", "Elias", "Drakos", "Constantinou", "Ballas", "Apostolou", "Alexiou", "Vlassis",
          "Tsipras", "Simitis", "Karamanlis", "Papandreou", "Venizelos", "Mitsotakis", "Samaras", "Rallis", "Mavromichalis", "Kanellopoulos",
          "Zografos", "Xanthopoulos", "Voulgaris", "Sfakianakis", "Roussopoulos", "Papageorgiou", "Nikolopoulos", "Manousakis", "Lampros", "Kostis"
        ]
      },
      "Russian_Slavic": {
        firstNames: [
          "Alexander", "Anastasia", "Dmitry", "Maria", "Ivan", "Ekaterina", "Mikhail", "Anna", "Sergey", "Olga",
          "Andrey", "Elena", "Vladimir", "Natalia", "Alexey", "Tatiana", "Nikolay", "Irina", "Pavel", "Svetlana",
          "Maxim", "Yulia", "Artem", "Oksana", "Denis", "Victoria", "Roman", "Ludmila", "Igor", "Nina",
          "Oleg", "Vera", "Yuri", "Galina", "Viktor", "Inna", "Evgeny", "Larisa", "Konstantin", "Valentina",
          "Anton", "Daria", "Stanislav", "Alina", "Kirill", "Sofia", "Ruslan", "Nadezhda", "Ilya", "Marina",
          "Anatoly", "Raisa", "Boris", "Zinaida", "Grigory", "Lyubov", "Leonid", "Klavdiya", "Fyodor", "Polina",
          "Petr", "Varvara", "Vasily", "Zlata", "Matvey", "Kira", "Yaroslav", "Milena", "Gleb", "Kristina",
          "Danila", "Elizaveta", "Timofey", "Veronika", "Egor", "Ulyana", "Mark", "Karina", "Lev", "Diana",
          "Bogdan", "Violetta", "Miroslav", "Angelina", "Vladislav", "Margarita", "Stepan", "Valeriya", "Rodion", "Zhanna",
          "Arseny", "Tamara", "Makar", "Alla", "Savva", "Yana", "Platon", "Maya", "Zakhar", "Liliya"
        ],
        lastNames: [
          "Ivanov", "Petrov", "Sidorov", "Smirnov", "Kuznetsov", "Popov", "Volkov", "Sokolov", "Lebedev", "Kozlov",
          "Novikov", "Morozov", "Petrov", "Vasiliev", "Zaitsev", "Pavlov", "Semenov", "Golubev", "Vinogradov", "Bogdanov",
          "Vorobiev", "Fedorov", "Mikhailov", "Belyaev", "Tarasov", "Belov", "Komarov", "Orlov", "Kiselev", "Makarov",
          "Andreev", "Kovalev", "Ilyin", "Gusev", "Titov", "Kuzmin", "Kudryavtsev", "Baranov", "Kulikov", "Alexeev",
          "Stepanov", "Yakovlev", "Sorokin", "Sergeev", "Romanov", "Zakharov", "Borisov", "Korolev", "Gerasimov", "Ponomarev",
          "Grigoriev", "Lazarev", "Medvedev", "Ermolaev", "Nikitin", "Sobolev", "Ryabov", "Polyakov", "Tsvetkov", "Danilov",
          "Zhukov", "Frolov", "Zhuravlev", "Nikolaev", "Krylov", "Maksimov", "Sidorov", "Osipov", "Belozerov", "Vladimirov",
          "Savin", "Voronin", "Mironov", "Gavrilov", "Tikhonov", "Antonov", "Karpov", "Kalinin", "Nesterov", "Egorov",
          "Matveev", "Bobrov", "Dmitriev", "Evstigneev", "Faddeev", "Filippov", "Fomin", "Glebov", "Markov", "Nosov",
          "Putin", "Medvedev", "Yeltsin", "Gorbachev", "Brezhnev", "Khrushchev", "Stalin", "Lenin", "Tolstoy", "Dostoevsky"
        ]
      }
    };
    
    // Helper function to convert Russian/Slavic male surname to female form
    function convertSlavicSurnameToFemale(surname) {
      // Surnames ending in -ov, -ev â add 'a' (-ova, -eva)
      if (surname.endsWith('ov') || surname.endsWith('ev')) {
        return surname + 'a';
      }
      // Surnames ending in -in â add 'a' (-ina)
      if (surname.endsWith('in')) {
        return surname + 'a';
      }
      // Surnames ending in -sky, -ski â change to -skaya
      if (surname.endsWith('sky') || surname.endsWith('ski')) {
        return surname.slice(0, -1) + 'aya';
      }
      // Surnames ending in -ich â don't change (uncommon for modern surnames)
      // Surnames ending in -enko, -ko â don't change (Ukrainian surnames)
      // Default: return as-is (for surnames that don't follow standard patterns)
      return surname;
    }
    
    // Female first names for Russian/Slavic region (to detect gender)
    const slavicFemaleFirstNames = [
      "Anastasia", "Maria", "Ekaterina", "Anna", "Olga", "Elena", "Natalia", "Tatiana", "Irina", "Svetlana",
      "Yulia", "Oksana", "Victoria", "Ludmila", "Nina", "Vera", "Galina", "Inna", "Larisa", "Valentina",
      "Daria", "Alina", "Sofia", "Nadezhda", "Marina", "Raisa", "Zinaida", "Lyubov", "Klavdiya", "Polina",
      "Varvara", "Zlata", "Kira", "Milena", "Kristina", "Elizaveta", "Veronika", "Ulyana", "Karina", "Diana",
      "Violetta", "Angelina", "Margarita", "Valeriya", "Zhanna", "Tamara", "Alla", "Yana", "Maya", "Liliya"
    ];
    
    // Flag mapping for regions
    const REGION_FLAGS = {
      "US_Canada": ["ðºð¸", "ð¨ð¦"],
      "Latin_Hispanic": ["ð²ð½", "ðªð¸", "ð¦ð·", "ð§ð·", "ð¨ð´", "ð¨ð±", "ðµðª", "ð»ðª", "ðµð¹", "ð¨ðº"],
      "UK": ["ð¬ð§"],
      "Netherlands": ["ð³ð±"],
      "Germany": ["ð©ðª"],
      "France": ["ð«ð·"],
      "Scandinavian": ["ð¸ðª", "ð³ð´", "ð©ð°", "ð«ð®", "ð®ð¸"],
      "Italian": ["ð®ð¹"],
      "Turkish": ["ð¹ð·"],
      "Japanese": ["ð¯ðµ"],
      "Chinese": ["ð¨ð³"],
      "African": ["ð³ð¬", "ð¿ð¦", "ð°ðª", "ðªð¬", "ð¬ð­", "ðªð¹", "ð¹ð¿", "ðºð¬", "ð²ð¦", "ð©ð¿"],
      "Arab_MiddleEast": ["ð¸ð¦", "ð¦ðª", "ðªð¬", "ð¯ð´", "ð±ð§", "ð°ð¼", "ð´ð²", "ð¶ð¦", "ð§ð­", "ð®ð¶"],
      "Indian": ["ð®ð³"],
      "Greek": ["ð¬ð·"],
      "Russian_Slavic": ["ð·ðº", "ðºð¦", "ð§ð¾", "ðµð±", "ð¨ð¿", "ð¸ð°", "ð§ð¬", "ð·ð¸", "ð­ð·", "ð²ð©"]
    };
    
    // Helper function to get flag for a region
    function getFlagForRegion(region) {
      const flags = REGION_FLAGS[region];
      if (!flags || flags.length === 0) return "ð"; // Default flag
      return flags[Math.floor(Math.random() * flags.length)];
    }
    
    // Helper function to pick random region and generate name from that region
    function generateNameFromRegion() {
      const regions = Object.keys(REGIONAL_NAMES);
      const randomRegion = regions[Math.floor(Math.random() * regions.length)];
      const regionData = REGIONAL_NAMES[randomRegion];
      
      const firstName = regionData.firstNames[Math.floor(Math.random() * regionData.firstNames.length)];
      let lastName = regionData.lastNames[Math.floor(Math.random() * regionData.lastNames.length)];
      
      // Special handling for Russian/Slavic surnames (female forms)
      if (randomRegion === 'Russian_Slavic' && slavicFemaleFirstNames.includes(firstName)) {
        lastName = convertSlavicSurnameToFemale(lastName);
      }
      
      const flag = getFlagForRegion(randomRegion);
      
      return {
        name: `${firstName} ${lastName}`,
        region: randomRegion,
        flag: flag
      };
    }

    const COMPANY_PREFIXES = [
      // Tech/Modern
      "Quantum", "Cyber", "Tech", "Digital", "Cloud", "Smart", "Innovative", "Next", "Future", "Apex",
      "Peak", "Prime", "Elite", "Stellar", "Zenith", "Nexus", "Vertex", "Pivot", "Spark", "Swift",
      "Agile", "Bright", "Clear", "Dynamic", "Epic", "Flash", "Global", "Hyper", "Infinite", "Kinetic",
      // Creative/Modern
      "Nova", "Pulse", "Echo", "Vibe", "Flux", "Aura", "Prism", "Surge", "Lumina", "Catalyst",
      "Horizon", "Velocity", "Momentum", "Aurora", "Cascade", "Fusion", "Helix", "Radiant", "Synapse", "Titanium",
      // Abstract/Professional
      "Alpha", "Beta", "Sigma", "Omega", "Zeta", "Vertex", "Vector", "Matrix", "Cipher", "Pixel",
      "Byte", "Synth", "Forge", "Atlas", "Orbit", "Pulse", "Node", "Edge", "Core", "Axis"
    ];

    const COMPANY_SUFFIXES = [
      // Classic Tech
      "Solutions", "Systems", "Technologies", "Software", "Labs", "Works", "Studios", "Ventures", "Innovations", "Digital",
      "Tech", "Apps", "Cloud", "Data", "AI", "Logic", "Dynamics", "Platform", "Services", "Group",
      "Media", "Networks", "Interactive", "Designs", "Development", "Engineering", "Products", "Analytics", "Hub", "Core",
      // Modern/Startup
      "Labs", "Studio", "Forge", "Factory", "Agency", "Collective", "Nexus", "Hub", "Space", "Labs",
      "Inc", "Corp", "Ltd", "Worldwide", "Partners", "Associates", "Consulting", "Strategies", "Intelligence", "Insights",
      // Trendy/Creative
      "House", "Club", "Guild", "Academy", "Institute", "Foundation", "Alliance", "Federation", "League", "Syndicate",
      "Frameworks", "Architects", "Builders", "Creators", "Makers", "Innovators", "Pioneers", "Disruptors", "Visionaries", "Explorers"
    ];

    let nextEmployeeId = 1;

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function formatCurrency(amount) {
      const rounded = Math.round(amount);
      const formatted = rounded.toLocaleString();
      return currency === "USD" ? `$${formatted}` : `â¬${formatted}`;
    }

    function logEvent(message) {
      const event = {
        day: currentDay,
        message: message
      };
      eventLog.unshift(event); // Add to beginning
      if (eventLog.length > 50) eventLog.pop(); // Keep last 50
      updateEventLog();
    }
    
    // ============================================
    // NOTIFICATION SYSTEM
    // ============================================
    
    function showNotification(message, type = 'success') {
      const container = document.getElementById('notificationContainer');
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      // Set icon based on type
      let icon = 'â';
      if (type === 'success') icon = 'â';
      if (type === 'warning') icon = 'â ï¸';
      if (type === 'error') icon = 'â';
      
      notification.innerHTML = `
        <span class="notification-icon">${icon}</span>
        <span class="notification-text">${message}</span>
      `;
      
      // Add to container
      container.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    function updateEventLog() {
      const container = document.getElementById('eventLog');
      const mobileContainer = document.getElementById('eventLogMobile');
      
      const logHTML = eventLog.slice(0, 20).map(e => 
        `<div class="event">Day ${e.day}: ${e.message}</div>`
      ).join('');
      
      container.innerHTML = logHTML;
      if (mobileContainer) {
        mobileContainer.innerHTML = logHTML;
      }
    }

    function updateCashDisplay() {
      const display = document.getElementById('cashDisplay');
      display.textContent = formatCurrency(cash);
      
      // Color coding
      display.className = 'cash-display';
      if (cash < 0) {
        display.classList.add('flashing-red');
      } else if (cash < 5000) {
        display.classList.add('red');
      } else if (cash < 20000) {
        display.classList.add('yellow');
      } else {
        display.classList.add('green');
      }
      
      // Calculate and display next billing cash flow
      const nextBillingInfo = document.getElementById('nextBillingInfo');
      const cashFlow = calculateNetCashFlow();
      const daysUntilBilling = currentDay === 0 ? 30 : (30 - (currentDay % 30));
      
      const flowClass = cashFlow >= 0 ? 'cash-flow-positive' : 'cash-flow-negative';
      const flowSign = cashFlow >= 0 ? '+' : '';
      
      nextBillingInfo.innerHTML = `<span class="${flowClass}">${flowSign}${formatCurrency(cashFlow)}</span>`;
    }

    function updateDayDisplay() {
      document.getElementById('dayCounter').textContent = currentDay;
      const year = Math.floor(currentDay / 360);
      const month = Math.floor((currentDay % 360) / 30);
      document.getElementById('yearMonth').textContent = `Year ${year}, Month ${month}`;
    }

    function updateFounderDisplay() {
      // Founder is now displayed in the Team panel as a regular employee
      // This function is kept for backward compatibility but does nothing
      // All founder display is handled in updateEmployeesUI()
    }

    // ============================================
    // PHASE 2: PRODUCT FUNCTIONS
    // ============================================
    function createProduct(template) {
      // Check if product with same name already exists and is not deprecated
      const existingProduct = products.find(p => p.name === template.name && p.status !== "deprecated");
      
      if (existingProduct) {
        const statusText = existingProduct.status === "in_development" ? "still in development" : "still active";
        logEvent(`â Cannot create "${template.name}" - one is ${statusText}. Wait for it to be deprecated first.`);
        return;
      }
      
      const product = {
        id: nextProductId++,
        name: template.name,
        developmentEffort: template.developmentEffort,
        currentProgress: 0,
        status: "in_development",
        createdAt: Date.now(), // Timestamp for sorting
        publishDate: null,
        lifetimeMonths: template.lifetimeMonths,
        remainingLifetimeMonths: template.lifetimeMonths,
        deprecationDate: null,
        monthlyPrice: currency === "USD" ? template.monthlyPriceUSD : template.monthlyPriceEUR,
        subscribers: 0,
        churnRate: 0.05,
        marketingMultiplier: 1.0,
        assignedDevelopers: [], // No auto-assignment
        assignedMarketers: []
      };
      
      products.push(product);
      
      logEvent(`ð Created "${product.name}"`);
      updateProductsUI();
    }
    
    function assignFounderToProduct(productId) {
      // Unassign founder from all products first (both dev and marketing)
      products.forEach(p => {
        const devIndex = p.assignedDevelopers.indexOf('founder');
        if (devIndex > -1) {
          p.assignedDevelopers.splice(devIndex, 1);
        }
        const mktIndex = p.assignedMarketers.indexOf('founder');
        if (mktIndex > -1) {
          p.assignedMarketers.splice(mktIndex, 1);
        }
      });
      
      // Assign to new product as developer
      const product = products.find(p => p.id === productId);
      if (product) {
        product.assignedDevelopers.push('founder');
        founder.assignedProduct = productId;
        logEvent(`ð¨âð¼ ${founder.name} assigned to develop "${product.name}"`);
      }
      
      updateProductsUI();
    }
    
    function assignFounderToProductAsMarketer(productId) {
      // Unassign founder from all products first (both dev and marketing)
      products.forEach(p => {
        const devIndex = p.assignedDevelopers.indexOf('founder');
        if (devIndex > -1) {
          p.assignedDevelopers.splice(devIndex, 1);
        }
        const mktIndex = p.assignedMarketers.indexOf('founder');
        if (mktIndex > -1) {
          p.assignedMarketers.splice(mktIndex, 1);
        }
      });
      
      // Assign to new product as marketer
      const product = products.find(p => p.id === productId);
      if (product) {
        product.assignedMarketers.push('founder');
        founder.assignedProduct = productId;
        logEvent(`ð¢ ${founder.name} assigned to market "${product.name}"`);
      }
      
      updateProductsUI();
    }
    
    function unassignFounderFromProduct(productId) {
      const product = products.find(p => p.id === productId);
      if (product) {
        // Check both developer and marketer assignments
        const devIndex = product.assignedDevelopers.indexOf('founder');
        const mktIndex = product.assignedMarketers.indexOf('founder');
        
        if (devIndex > -1) {
          product.assignedDevelopers.splice(devIndex, 1);
          founder.assignedProduct = null;
          logEvent(`ð¨âð¼ ${founder.name} unassigned from developing "${product.name}"`);
        } else if (mktIndex > -1) {
          product.assignedMarketers.splice(mktIndex, 1);
          founder.assignedProduct = null;
          logEvent(`ð¢ ${founder.name} unassigned from marketing "${product.name}"`);
        }
      }
      
      updateProductsUI();
    }
    
    function assignEmployeeToProduct(employeeId, productId) {
      const employee = [...developers, ...marketers].find(e => e.id === employeeId);
      const product = products.find(p => p.id === productId);
      
      if (!employee || !product) return;
      
      // Unassign from previous product
      if (employee.assignedProduct) {
        const oldProduct = products.find(p => p.id === employee.assignedProduct);
        if (oldProduct) {
          if (employee.role === 'developer') {
            const index = oldProduct.assignedDevelopers.indexOf(employeeId);
            if (index > -1) oldProduct.assignedDevelopers.splice(index, 1);
          } else {
            const index = oldProduct.assignedMarketers.indexOf(employeeId);
            if (index > -1) oldProduct.assignedMarketers.splice(index, 1);
          }
        }
      }
      
      // Assign to new product
      employee.assignedProduct = productId;
      if (employee.role === 'developer' && product.status === 'in_development') {
        product.assignedDevelopers.push(employeeId);
        logEvent(`ð¨âð» ${employee.name} assigned to develop "${product.name}"`);
      } else if (employee.role === 'marketer' && product.status === 'published') {
        product.assignedMarketers.push(employeeId);
        logEvent(`ð¢ ${employee.name} assigned to market "${product.name}"`);
      }
      
      updateProductsUI();
      updateEmployeesUI();
    }
    
    function unassignEmployeeFromProduct(employeeId) {
      const employee = [...developers, ...marketers].find(e => e.id === employeeId);
      if (!employee || !employee.assignedProduct) return;
      
      const product = products.find(p => p.id === employee.assignedProduct);
      if (product) {
        if (employee.role === 'developer') {
          const index = product.assignedDevelopers.indexOf(employeeId);
          if (index > -1) product.assignedDevelopers.splice(index, 1);
        } else {
          const index = product.assignedMarketers.indexOf(employeeId);
          if (index > -1) product.assignedMarketers.splice(index, 1);
        }
        logEvent(`${employee.role === 'developer' ? 'ð¨âð»' : 'ð¢'} ${employee.name} unassigned from "${product.name}"`);
      }
      
      employee.assignedProduct = null;
      updateProductsUI();
      updateEmployeesUI();
    }
    
    function updateProductDevelopment() {
      const effects = getRndEffects();
      const efficiencyMultiplier = 1 + effects.employeeEfficiency;
      
      products.forEach(product => {
        if (product.status === 'in_development') {
          let dailyProgress = 0;
          
          // Apply team overhead penalty based on team size
          const teamSize = product.assignedDevelopers.length;
          
          // Founder contribution
          if (product.assignedDevelopers.includes('founder')) {
            const baseEfficiency = founder.efficiency * efficiencyMultiplier;
            const effectiveEfficiency = getEffectiveEfficiency(baseEfficiency, teamSize);
            const contribution = effectiveEfficiency / 30; // 1 month = 30 days
            dailyProgress += contribution;
          }
          
          // Employee developer contributions
          product.assignedDevelopers.forEach(devId => {
            if (devId !== 'founder') {
              const developer = developers.find(d => d.id === devId);
              if (developer) {
                const baseEfficiency = developer.efficiency * efficiencyMultiplier;
                const effectiveEfficiency = getEffectiveEfficiency(baseEfficiency, teamSize);
                const contribution = effectiveEfficiency / 30;
                dailyProgress += contribution;
              }
            }
          });
          
          product.currentProgress += dailyProgress;
          
          // Check if completed
          if (product.currentProgress >= product.developmentEffort) {
            publishProduct(product);
          }
        }
      });
    }
    
    // ============================================
    // R&D SYSTEM
    // ============================================
    
    function getRndEffects() {
      const effects = {
        organicGrowth: 0,
        churnReduction: 0,
        employeeEfficiency: 0
      };
      
      completedRndProjects.forEach(projectId => {
        const project = RND_PROJECTS.find(p => p.id === projectId);
        if (project) {
          if (project.effect.type === 'organic_growth') {
            effects.organicGrowth += project.effect.value;
          } else if (project.effect.type === 'churn_reduction') {
            effects.churnReduction += project.effect.value;
          } else if (project.effect.type === 'employee_efficiency') {
            effects.employeeEfficiency += project.effect.value;
          }
        }
      });
      
      return effects;
    }
    
    function isProductUnlocked(productName) {
      return unlockedProducts.includes(productName);
    }
    
    function canStartRndProject(projectId) {
      const project = RND_PROJECTS.find(p => p.id === projectId);
      if (!project) return false;
      
      // Check if already completed
      if (completedRndProjects.includes(projectId)) return false;
      
      // Check if already in progress
      if (rndProjects.find(p => p.templateId === projectId)) return false;
      
      // Check prerequisites
      for (const prereqId of project.prerequisites) {
        if (!completedRndProjects.includes(prereqId)) {
          return false;
        }
      }
      
      return true;
    }
    
    function hasAvailableProductTemplates() {
      // Check if there are any unlocked product templates that aren't already active
      return PRODUCT_TEMPLATES.some(template => {
        // Must be unlocked
        if (!isProductUnlocked(template.name)) return false;
        
        // Must not already exist (unless deprecated)
        const existingProduct = products.find(p => p.name === template.name && p.status !== "deprecated");
        return !existingProduct;
      });
    }
    
    function hasAvailableRndProjects() {
      // Check if there are any R&D projects that can be started
      return RND_PROJECTS.some(project => canStartRndProject(project.id));
    }
    
    function updateNewProductButtonState() {
      const btn = document.getElementById('newProductBtn');
      if (!btn) return;
      
      const hasAvailable = hasAvailableProductTemplates();
      
      if (hasAvailable) {
        // Enable - green
        btn.disabled = false;
        btn.style.background = '#10b981';
        btn.style.cursor = 'pointer';
        btn.style.opacity = '1';
      } else {
        // Disable - grey
        btn.disabled = true;
        btn.style.background = '#9ca3af';
        btn.style.cursor = 'not-allowed';
        btn.style.opacity = '0.6';
      }
    }
    
    function updateNewRndButtonState() {
      const btn = document.getElementById('newRndBtn');
      if (!btn) return;
      
      const hasAvailable = hasAvailableRndProjects();
      
      if (hasAvailable) {
        // Enable - blue
        btn.disabled = false;
        btn.style.background = '#3b82f6';
        btn.style.cursor = 'pointer';
        btn.style.opacity = '1';
      } else {
        // Disable - grey
        btn.disabled = true;
        btn.style.background = '#9ca3af';
        btn.style.cursor = 'not-allowed';
        btn.style.opacity = '0.6';
      }
    }
    
    function startRndProject(templateId) {
      const template = RND_PROJECTS.find(p => p.id === templateId);
      if (!template) {
        logEvent("â R&D project template not found");
        return;
      }
      
      if (!canStartRndProject(templateId)) {
        logEvent("â Prerequisites not met for this R&D project");
        return;
      }
      
      const newProject = {
        id: nextRndProjectId++,
        templateId: template.id,
        name: template.name,
        category: template.category,
        developmentEffort: template.developmentEffort,
        currentProgress: 0,
        assignedDevelopers: [],
        effect: template.effect,
        description: template.description
      };
      
      rndProjects.push(newProject);
      logEvent(`ð¬ Started R&D: ${newProject.name}`);
      updateRndUI();
    }
    
    function updateRndDevelopment() {
      const effects = getRndEffects();
      const efficiencyMultiplier = 1 + effects.employeeEfficiency;
      
      rndProjects.forEach(project => {
        let dailyProgress = 0;
        
        // Apply team overhead penalty based on team size
        const teamSize = project.assignedDevelopers.length;
        
        // Founder contribution
        if (project.assignedDevelopers.includes('founder')) {
          const baseEfficiency = founder.efficiency * efficiencyMultiplier;
          const effectiveEfficiency = getEffectiveEfficiency(baseEfficiency, teamSize);
          const contribution = effectiveEfficiency / 30;
          dailyProgress += contribution;
        }
        
        // Employee developer contributions
        project.assignedDevelopers.forEach(devId => {
          if (devId !== 'founder') {
            const developer = developers.find(d => d.id === devId);
            if (developer) {
              const baseEfficiency = developer.efficiency * efficiencyMultiplier;
              const effectiveEfficiency = getEffectiveEfficiency(baseEfficiency, teamSize);
              const contribution = effectiveEfficiency / 30;
              dailyProgress += contribution;
            }
          }
        });
        
        project.currentProgress += dailyProgress;
        
        // Check if completed
        if (project.currentProgress >= project.developmentEffort) {
          completeRndProject(project);
        }
      });
    }
    
    function completeRndProject(project) {
      // Mark as completed
      completedRndProjects.push(project.templateId);
      
      // Apply effect
      if (project.effect.type === 'unlock_product') {
        unlockedProducts.push(project.effect.value);
        logEvent(`ð R&D Complete! Unlocked product: ${project.effect.value}`);
        showNotification(`ð¬ R&D Complete: ${project.name} - Unlocked ${project.effect.value}!`, 'success');
      } else if (project.effect.type === 'organic_growth') {
        const percentage = (project.effect.value * 100).toFixed(0);
        logEvent(`ð R&D Complete! Organic growth +${percentage}%`);
        showNotification(`ð¬ R&D Complete: ${project.name} - Organic growth +${percentage}%!`, 'success');
      } else if (project.effect.type === 'churn_reduction') {
        const percentage = (project.effect.value * 100).toFixed(0);
        logEvent(`ð R&D Complete! Churn reduction -${percentage}%`);
        showNotification(`ð¬ R&D Complete: ${project.name} - Churn reduction -${percentage}%!`, 'success');
      } else if (project.effect.type === 'employee_efficiency') {
        const percentage = (project.effect.value * 100).toFixed(0);
        logEvent(`ð R&D Complete! Employee efficiency +${percentage}%`);
        showNotification(`ð¬ R&D Complete: ${project.name} - Employee efficiency +${percentage}%!`, 'success');
      }
      
      // Remove from active projects
      const index = rndProjects.findIndex(p => p.id === project.id);
      if (index !== -1) {
        rndProjects.splice(index, 1);
      }
      
      updateRndUI();
    }
    
    function updateRndUI() {
      const container = document.getElementById('rndContainer');
      const effects = getRndEffects();
      
      // Build bonus display section
      let bonusHTML = '';
      const hasAnyBonus = effects.organicGrowth > 0 || effects.churnReduction > 0 || effects.employeeEfficiency > 0;
      
      if (hasAnyBonus) {
        bonusHTML += '<div style="margin-bottom: 0.5rem; padding: 0.4rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">';
        bonusHTML += '<div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-bottom: 0.35rem;">ð¯ R&D Bonuses</div>';
        bonusHTML += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
        
        if (effects.organicGrowth > 0) {
          bonusHTML += '<div style="display: flex; align-items: center; gap: 0.1rem; padding: 0.15rem 0.3rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">';
          bonusHTML += '<span style="font-size: 0.7rem;">ð</span>';
          bonusHTML += '<span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">+' + (effects.organicGrowth * 100).toFixed(0) + '%</span>';
          bonusHTML += '<span style="font-size: 0.7rem; color: #6b7280;">growth</span>';
          bonusHTML += '</div>';
        }
        
        if (effects.churnReduction > 0) {
          bonusHTML += '<div style="display: flex; align-items: center; gap: 0.1rem; padding: 0.15rem 0.3rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">';
          bonusHTML += '<span style="font-size: 0.7rem;">ð¡ï¸</span>';
          bonusHTML += '<span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">-' + (effects.churnReduction * 100).toFixed(0) + '%</span>';
          bonusHTML += '<span style="font-size: 0.7rem; color: #6b7280;">churn</span>';
          bonusHTML += '</div>';
        }
        
        if (effects.employeeEfficiency > 0) {
          bonusHTML += '<div style="display: flex; align-items: center; gap: 0.1rem; padding: 0.15rem 0.3rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">';
          bonusHTML += '<span style="font-size: 0.7rem;">â¡</span>';
          bonusHTML += '<span style="font-size: 0.75rem; font-weight: 600; color: #10b981;">+' + (effects.employeeEfficiency * 100).toFixed(0) + '%</span>';
          bonusHTML += '<span style="font-size: 0.7rem; color: #6b7280;">efficiency</span>';
          bonusHTML += '</div>';
        }
        
        bonusHTML += '</div>';
        bonusHTML += '</div>';
      }
      
      if (rndProjects.length === 0) {
        container.innerHTML = bonusHTML + '<div class="empty-state">No active R&D projects. Start researching!</div>';
        return;
      }
      
      // Note: R&D project team sections are no longer collapsible, so no cleanup needed
      
      const efficiencyMultiplier = 1 + effects.employeeEfficiency;
      
      const projectsHTML = rndProjects.map(project => {
        const progress = (project.currentProgress / project.developmentEffort) * 100;
        const progressClamped = Math.min(progress, 100);
        
        // Get assigned developers
        const devCount = project.assignedDevelopers.length;
        
        // Effect display
        let effectText = '';
        if (project.effect.type === 'unlock_product') {
          effectText = `ð Unlocks: ${project.effect.value}`;
        } else if (project.effect.type === 'organic_growth') {
          effectText = `ð Organic Growth +${(project.effect.value * 100).toFixed(0)}%`;
        } else if (project.effect.type === 'churn_reduction') {
          effectText = `ð¡ï¸ Churn Reduction -${(project.effect.value * 100).toFixed(0)}%`;
        } else if (project.effect.type === 'employee_efficiency') {
          effectText = `â¡ Employee Efficiency +${(project.effect.value * 100).toFixed(0)}%`;
        }
        
        // Calculate total efficiency with team overhead penalty
        const teamSize = project.assignedDevelopers.length;
        let totalEfficiency = 0;
        
        if (project.assignedDevelopers.includes('founder')) {
          const baseEfficiency = founder.efficiency * efficiencyMultiplier;
          totalEfficiency += getEffectiveEfficiency(baseEfficiency, teamSize);
        }
        project.assignedDevelopers.forEach(devId => {
          if (devId !== 'founder') {
            const developer = developers.find(d => d.id === devId);
            if (developer) {
              const baseEfficiency = developer.efficiency * efficiencyMultiplier;
              totalEfficiency += getEffectiveEfficiency(baseEfficiency, teamSize);
            }
          }
        });
        
        const daysLeft = totalEfficiency > 0 ? 
          Math.ceil((project.developmentEffort - project.currentProgress) / (totalEfficiency / 30)) : 
          'â';
        
        // Main card container (matching product card structure but not collapsible)
        let html = '<div class="product-card">';
        
        // Header section (matching product card design)
        html += '<div class="product-card-header">';
        html += '<div class="product-header">';
        
        // Left side: Name, status, and stats
        html += '<div class="product-header-left">';
        html += '<div class="product-title-row">';
        html += '<div class="product-name">ð¬ ' + project.name + '</div>';
        html += '<div class="product-status status-dev">In Progress</div>';
        html += '</div>';
        
        // Stats (progress % and estimated completion)
        html += '<div class="product-stats">';
        
        html += '<div class="product-stat">';
        html += '<span class="product-stat-icon">ð</span>';
        html += '<span class="product-stat-value">' + Math.round(progressClamped) + '%</span>';
        html += '</div>';
        
        html += '<div class="product-stat">';
        html += '<span class="product-stat-icon">ð</span>';
        html += '<span class="product-stat-label">~' + (daysLeft === 'â' ? 'â' : daysLeft + ' days') + '</span>';
        html += '</div>';
        
        html += '</div>'; // Close stats
        html += '</div>'; // Close header-left
        
        html += '</div>'; // Close header
        html += '</div>'; // Close card-header
        
        // Details section (always expanded for R&D)
        html += '<div class="product-details expanded">';
        
        // Description
        html += '<div class="product-detail-row">';
        html += '<span style="color: #6b7280; font-size: 0.875rem;">' + project.description + '</span>';
        html += '</div>';
        
        // Effect text
        html += '<div class="product-detail-row">';
        html += '<span style="color: #1f2937; font-size: 0.875rem; font-weight: 600;">' + effectText + '</span>';
        html += '</div>';
        
        // Progress bar in single line (matching product card design)
        html += '<div style="display: flex; align-items: center; gap: 0.75rem; margin: 0.75rem 0;">';
        
        // Label
        html += '<span style="font-size: 0.875rem; color: #374151; font-weight: 500; white-space: nowrap;">Progress</span>';
        
        // Progress bar with percentage inside
        html += '<div style="flex: 1; position: relative; background: #e5e7eb; border-radius: 8px; height: 24px; overflow: hidden;">';
        html += '<div style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: ' + progressClamped + '%; transition: width 0.3s ease;"></div>';
        html += '<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: ' + (progressClamped > 50 ? '#ffffff' : '#374151') + ';">';
        html += Math.round(progressClamped) + '%';
        html += '</div>';
        html += '</div>';
        
        // Total man-months
        html += '<span style="font-size: 0.875rem; color: #6b7280; white-space: nowrap;">' + project.developmentEffort + ' months</span>';
        
        html += '</div>';
        
        // Show warning if no developers assigned
        if (project.assignedDevelopers.length === 0) {
          html += '<div style="padding: 0.5rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.875rem; color: #92400e;">';
          html += 'â ï¸ No developers assigned! Assign developers to start research.';
          html += '</div>';
        }
        
        // Development Team section (non-collapsible, matching product card design)
        html += '<div style="margin-top: 0.5rem;">';
        html += '<div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 0.875rem;">';
        html += 'ð¥ Development Team (' + devCount + ')' + generatePenaltyIcon(devCount);
        html += '</div>';
        
        html += '<div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">';
        
        // Add developer button (moved to top)
        html += '<button class="add-person-btn" onclick="showAssignToRndModal(' + project.id + ')">â Add Developer</button>';
        
        // Show assigned developers
        project.assignedDevelopers.forEach(devId => {
          if (devId === 'founder') {
            html += '<div class="assigned-person-card">';
            html += '<span class="assigned-person-name">' + founder.name + ' <span class="person-role">(Founder)</span></span>';
            html += '<button class="unassign-btn" onclick="unassignFromRnd(' + project.id + ', \'founder\')">â</button>';
            html += '</div>';
          } else {
            const dev = developers.find(d => d.id === devId);
            if (dev) {
              const skillLabel = dev.skill.charAt(0).toUpperCase() + dev.skill.slice(1);
              html += '<div class="assigned-person-card">';
              html += '<span class="assigned-person-name">' + dev.name + ' <span class="person-role">(' + skillLabel + ')</span></span>';
              html += '<button class="unassign-btn" onclick="unassignFromRnd(' + project.id + ', ' + devId + ')">â</button>';
              html += '</div>';
            }
          }
        });
        
        html += '</div></div>'; // Close team cards and team section
        html += '</div>'; // Close details section
        html += '</div>'; // Close card
        
        return html;
      }).join('');
      
      // Set container HTML with bonus section + projects
      container.innerHTML = bonusHTML + projectsHTML;
      
      // Update "New R&D Project" button state based on availability
      updateNewRndButtonState();
    }
    
    function showNewRndModal() {
      pauseGame(); // Auto-pause when opening modal
      const modal = document.getElementById('newRndModal');
      const list = document.getElementById('rndProjectsList');
      
      // Group projects by category, only showing available or in-progress projects
      const grouped = {
        [RND_CATEGORIES.GROWTH]: [],
        [RND_CATEGORIES.RETENTION]: [],
        [RND_CATEGORIES.EFFICIENCY]: [],
        [RND_CATEGORIES.UNLOCK]: []
      };
      
      RND_PROJECTS.forEach(project => {
        // Skip completed projects
        const isCompleted = completedRndProjects.includes(project.id);
        if (isCompleted) return;
        
        // Check if project is in progress or can be started
        const isInProgress = rndProjects.find(p => p.templateId === project.id);
        const canStart = canStartRndProject(project.id);
        
        // Only show available or in-progress projects (hide locked ones)
        if (isInProgress || canStart) {
          grouped[project.category].push(project);
        }
      });
      
      // Find first available project for default selection
      let firstAvailableId = null;
      for (const project of RND_PROJECTS) {
        const isCompleted = completedRndProjects.includes(project.id);
        if (!isCompleted && canStartRndProject(project.id)) {
          firstAvailableId = project.id;
          break;
        }
      }
      
      const categoryNames = {
        [RND_CATEGORIES.GROWTH]: 'ð Organic Growth',
        [RND_CATEGORIES.RETENTION]: 'ð¡ï¸ Churn Reduction',
        [RND_CATEGORIES.EFFICIENCY]: 'â¡ Employee Efficiency',
        [RND_CATEGORIES.UNLOCK]: 'ð Product Unlocks'
      };
      
      // Check if any projects are available
      const availableCategories = Object.entries(grouped)
        .filter(([category, projects]) => projects.length > 0); // Only show categories with available projects
      
      if (availableCategories.length === 0) {
        list.innerHTML = '<div class="empty-state">No R&D projects available. All projects are either completed or in progress!</div>';
        modal.classList.add('active');
        return;
      }
      
      list.innerHTML = availableCategories
        .map(([category, projects]) => {
          const projectsHtml = projects.map(project => {
            const isInProgress = rndProjects.find(p => p.templateId === project.id);
            
            let statusNote = '';
            let disabledClass = '';
            let disabled = '';
            
            if (isInProgress) {
              statusNote = '<div style="color: #3b82f6; font-size: 0.7rem; margin-top: 0.15rem; line-height: 1.2;">ð In Progress</div>';
              disabledClass = 'disabled';
              disabled = 'disabled';
            }
            
            let effectText = '';
            if (project.effect.type === 'unlock_product') {
              effectText = `ð Unlocks: ${project.effect.value}`;
            } else if (project.effect.type === 'organic_growth') {
              effectText = `+${(project.effect.value * 100).toFixed(0)}% growth`;
            } else if (project.effect.type === 'churn_reduction') {
              effectText = `-${(project.effect.value * 100).toFixed(0)}% churn`;
            } else if (project.effect.type === 'employee_efficiency') {
              effectText = `+${(project.effect.value * 100).toFixed(0)}% efficiency`;
            }
            
            return `
              <label class="product-template ${disabledClass}">
                <input type="radio" name="rndTemplate" value="${project.id}" ${project.id === firstAvailableId ? 'checked' : ''} ${disabled}>
                <div class="template-content">
                  <div class="template-name">${project.name}</div>
                  <div class="template-details">
                    <div class="template-detail">ð ${project.developmentEffort} months</div>
                    <div class="template-detail">${effectText}</div>
                  </div>
                  <div class="template-description">${project.description}</div>
                  ${statusNote}
                </div>
              </label>
            `;
          }).join('');
          
          return `
            <div style="margin-bottom: 1rem;">
              <h3 style="margin-bottom: 0.5rem; font-size: 0.95rem; color: #374151;">${categoryNames[category]}</h3>
              ${projectsHtml}
            </div>
          `;
        }).join('');
      
      modal.classList.add('active');
    }
    
    function hideNewRndModal() {
      document.getElementById('newRndModal').classList.remove('active');
      startGame(); // Resume game when cancelled
    }
    
    function handleCreateRndProject() {
      const selected = document.querySelector('input[name="rndTemplate"]:checked');
      if (!selected) {
        //logEvent("â Please select an R&D project");
        return;
      }
      
      const projectId = selected.value;
      startRndProject(projectId);
      hideNewRndModal();
    }
    
    function showAssignToRndModal(projectId) {
      pauseGame(); // Auto-pause when opening modal
      currentAssignRndProjectId = projectId;
      selectedDevelopersForRnd.clear(); // Reset selection
      updateAssignToRndButton();
      
      const project = rndProjects.find(p => p.id === projectId);
      if (!project) return;
      
      const modal = document.getElementById('assignToRndModal');
      const list = document.getElementById('availableDevelopersForRnd');
      
      // Store current project ID for assignment
      modal.dataset.projectId = projectId;
      
      // Get available developers (not assigned to ANY project - product or R&D)
      const availableDevelopers = [];
      
      // Check if founder is available (not assigned to any product or R&D project)
      const founderAssignment = getFounderAssignment();
      if (!founderAssignment) {
        availableDevelopers.push({
          id: 'founder',
          name: founder.name,
          role: 'Founder',
          efficiency: founder.efficiency,
          assignment: null
        });
      }
      
      // Add employee developers (only if not assigned to ANY product or R&D project)
      developers.forEach(dev => {
        const devAssignment = getDevAssignment(dev.id);
        if (!devAssignment) {
          const skillLabel = dev.skill.charAt(0).toUpperCase() + dev.skill.slice(1);
          availableDevelopers.push({
            id: dev.id,
            name: dev.name,
            role: skillLabel,
            efficiency: dev.efficiency,
            assignment: null
          });
        }
      });
      
      if (availableDevelopers.length === 0) {
        list.innerHTML = '<div class="empty-state">No available developers. All developers are currently assigned to products or R&D projects. Unassign them first to reassign.</div>';
      } else {
        list.innerHTML = availableDevelopers.map(dev => {
          const devIdStr = typeof dev.id === 'string' ? `'${dev.id}'` : dev.id;
          return `
            <div class="employee-card-selectable" onclick="toggleRndDeveloperSelection(${devIdStr})" id="rnd-card-${dev.id}">
              <input type="checkbox" class="employee-checkbox" id="rnd-checkbox-${dev.id}" onchange="toggleRndDeveloperSelection(${devIdStr})" onclick="event.stopPropagation();">
              <div class="employee-card-info">
                <div class="employee-header" style="margin-bottom: 0.4rem;">
                  <span class="employee-name">${dev.name}</span>
                  <span class="employee-role">${dev.role}</span>
                </div>
                <div class="employee-stats">
                  <span>â¡ Efficiency: ${Math.round(dev.efficiency * 100)}%</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      modal.classList.add('active');
    }
    
    function hideAssignToRndModal() {
      document.getElementById('assignToRndModal').classList.remove('active');
      currentAssignRndProjectId = null;
      selectedDevelopersForRnd.clear();
      startGame(); // Resume game when cancelled
    }
    
    function toggleRndDeveloperSelection(devId) {
      if (selectedDevelopersForRnd.has(devId)) {
        selectedDevelopersForRnd.delete(devId);
      } else {
        selectedDevelopersForRnd.add(devId);
      }
      
      // Update UI
      const card = document.getElementById('rnd-card-' + devId);
      const checkbox = document.getElementById('rnd-checkbox-' + devId);
      if (card && checkbox) {
        if (selectedDevelopersForRnd.has(devId)) {
          card.classList.add('selected');
          checkbox.checked = true;
        } else {
          card.classList.remove('selected');
          checkbox.checked = false;
        }
      }
      
      updateAssignToRndButton();
    }
    
    function updateAssignToRndButton() {
      const btn = document.getElementById('assignSelectedToRndBtn');
      const count = document.getElementById('selectedRndCount');
      if (btn && count) {
        count.textContent = selectedDevelopersForRnd.size;
        btn.disabled = selectedDevelopersForRnd.size === 0;
      }
    }
    
    function assignToRnd(projectId, developerId) {
      const project = rndProjects.find(p => p.id === projectId);
      if (!project) return;
      
      if (!project.assignedDevelopers.includes(developerId)) {
        project.assignedDevelopers.push(developerId);
        
        const devName = developerId === 'founder' ? founder.name : developers.find(d => d.id === developerId)?.name;
        logEvent(`ð¨âð» ${devName} assigned to R&D: ${project.name}`);
      }
      
      hideAssignToRndModal();
      updateRndUI();
    }
    
    function unassignFromRnd(projectId, developerId) {
      const project = rndProjects.find(p => p.id === projectId);
      if (!project) return;
      
      const index = project.assignedDevelopers.indexOf(developerId);
      if (index !== -1) {
        project.assignedDevelopers.splice(index, 1);
        
        const devName = developerId === 'founder' ? founder.name : developers.find(d => d.id === developerId)?.name;
        logEvent(`â©ï¸ ${devName} unassigned from R&D: ${project.name}`);
      }
      
      updateRndUI();
    }
    
    function getFounderAssignment() {
      // Check products
      for (const product of products) {
        if (product.assignedDevelopers?.includes('founder')) {
          return `${product.name} (Product)`;
        }
        if (product.assignedMarketers?.includes('founder')) {
          return `${product.name} (Marketing)`;
        }
      }
      // Check R&D
      for (const project of rndProjects) {
        if (project.assignedDevelopers.includes('founder')) {
          return `${project.name} (R&D)`;
        }
      }
      return null;
    }
    
    function getDevAssignment(devId) {
      // Check products
      for (const product of products) {
        if (product.assignedDevelopers?.includes(devId)) {
          return `${product.name}`;
        }
      }
      // Check R&D
      for (const project of rndProjects) {
        if (project.assignedDevelopers.includes(devId)) {
          return `${project.name} (R&D)`;
        }
      }
      return null;
    }
    
    function publishProduct(product) {
      product.status = 'published';
      product.publishDate = currentDay;
      product.currentProgress = product.developmentEffort; // Cap at 100%
      
      // Auto-unassign all developers (including founder) since development is complete
      if (product.assignedDevelopers.includes('founder')) {
        founder.assignedProduct = null;
        logEvent(`ð¨âð¼ ${founder.name} unassigned from development (product published)`);
      }
      product.assignedDevelopers = [];
      
      logEvent(`ð "${product.name}" published and ready for customers!`);
      showNotification(`ð ${product.name} published and ready for customers!`, 'success');
      updateProductsUI();
    }
    
    function checkProductLifecycles() {
      products.forEach(product => {
        if (product.status === 'published') {
          const monthsSincePublish = (currentDay - product.publishDate) / 30;
          product.remainingLifetimeMonths = product.lifetimeMonths - monthsSincePublish;
          
          if (product.remainingLifetimeMonths <= 0) {
            product.status = 'deprecated';
            product.deprecationDate = currentDay;
            product.remainingLifetimeMonths = 0;
            
            // Auto-unassign all marketers (including founder) since product is end-of-life
            if (product.assignedMarketers.includes('founder')) {
              founder.assignedProduct = null;
              logEvent(`ð¢ ${founder.name} unassigned from marketing (product deprecated)`);
            }
            product.assignedMarketers = [];
            
            logEvent(`â ï¸ "${product.name}" is now deprecated (end of life)`);
            showNotification(`â ï¸ ${product.name} is now deprecated (end of life)`, 'warning');
            updateProductsUI();
          }
        }
      });
    }
    
    function updateCustomerAcquisition() {
      // Check server capacity first
      const server = SERVER_TIERS[currentServerTier];
      const totalSubs = getTotalSubscribers();
      const availableCapacity = server.maxSubscribers - totalSubs;
      
      // Get R&D effects
      const effects = getRndEffects();
      const organicGrowthMultiplier = 1 + effects.organicGrowth;
      const churnReductionMultiplier = 1 - effects.churnReduction;
      
      products.forEach(product => {
        if (product.status === 'published') {
          let dailyGrowth = 0;
          
          // Organic growth (word of mouth, search, etc.)
          // Base: 0.5-1 subscribers per day + small bonus based on existing user base
          const organicBase = 0.5 + (Math.random() * 0.5); // 0.5 to 1.0 per day
          const wordOfMouthBonus = Math.sqrt(product.subscribers) * 0.01; // Scales slowly with subscriber count
          dailyGrowth += (organicBase + wordOfMouthBonus) * organicGrowthMultiplier;
          
          // Marketer contributions (much higher than organic)
          // Apply team overhead penalty based on marketing team size
          const mktTeamSize = product.assignedMarketers.length;
          
          product.assignedMarketers.forEach(mktId => {
            if (mktId === 'founder') {
              // Founder as marketer
              const effectiveEfficiency = getEffectiveEfficiency(founder.efficiency, mktTeamSize);
              dailyGrowth += 5 * effectiveEfficiency;
            } else {
              const marketer = marketers.find(m => m.id === mktId);
              if (marketer) {
                // Base growth: 5 subscribers per day per 1x marketer
                const effectiveEfficiency = getEffectiveEfficiency(marketer.efficiency, mktTeamSize);
                dailyGrowth += 5 * effectiveEfficiency;
              }
            }
          });
          
          // Calculate potential growth
          const randomFactor = 0.8 + (Math.random() * 0.4); // 80%-120%
          const potentialGrowth = Math.max(1, Math.round(dailyGrowth * randomFactor));
          
          // Check server capacity before adding subscribers
          const currentTotalSubs = getTotalSubscribers();
          const actualGrowth = Math.min(potentialGrowth, server.maxSubscribers - currentTotalSubs);
          
          if (actualGrowth > 0) {
            product.subscribers += actualGrowth;
          } else if (potentialGrowth > 0 && actualGrowth === 0) {
            // Server is full, log once per day (only for first product that hits limit)
            const lastWarningDay = product.lastCapacityWarning || -999;
            if (currentDay > lastWarningDay) {
              logEvent(`â ï¸ Server full! "${product.name}" cannot gain subscribers. Upgrade server!`);
              showNotification(`â ï¸ Server capacity full! Upgrade server to gain more subscribers.`, 'warning');
              product.lastCapacityWarning = currentDay;
            }
          }
          
          // Normal churn for published products (much lower than deprecated)
          // Churn rate: 1-2% of subscribers leave per day
          if (product.subscribers > 10) { // Only apply churn if there are enough subscribers
            const baseChurnRate = 0.01 + (Math.random() * 0.01); // 1-2% daily churn
            const adjustedChurnRate = baseChurnRate * churnReductionMultiplier; // Apply R&D reduction
            const subscribersLost = Math.ceil(product.subscribers * adjustedChurnRate);
            product.subscribers = Math.max(0, product.subscribers - subscribersLost);
          }
        }
        
        // Deprecated products lose subscribers over time
        if (product.status === 'deprecated' && product.subscribers > 0) {
          // Churn rate: 10-15% of subscribers leave per day
          const churnRate = 0.05 + (Math.random() * 0.05); // 5-10% daily churn
          const subscribersLost = Math.max(1, Math.ceil(product.subscribers * churnRate));
          const previousSubscribers = product.subscribers;
          product.subscribers = Math.max(0, product.subscribers - subscribersLost);
          
          // Log when product fully dies (last subscriber leaves)
          if (previousSubscribers > 0 && product.subscribers === 0) {
            logEvent(`ð "${product.name}" has lost all subscribers and is now hidden. You can create it again!`);
          }
        }
      });
    }
    
    function updateProductsUI() {
      const container = document.getElementById('productsContainer');
      
      // Get R&D effects for efficiency calculations
      const effects = getRndEffects();
      const efficiencyMultiplier = 1 + effects.employeeEfficiency;
      
      // Filter out deprecated products with 0 subscribers (they're done, hide them)
      const visibleProducts = products.filter(p => {
        return !(p.status === 'deprecated' && p.subscribers === 0);
      });
      
      // Sort by creation date descending (newest first)
      visibleProducts.sort((a, b) => {
        const aCreated = a.createdAt || 0; // Fallback for old saves without createdAt
        const bCreated = b.createdAt || 0;
        return bCreated - aCreated; // Descending order
      });
      
      if (visibleProducts.length === 0) {
        container.innerHTML = '<div class="empty-state">No products yet. Start building!</div>';
        // Clear expanded states when no products
        expandedTeamSections = {};
        return;
      }
      
      // Note: Product team sections (dev/mkt) are no longer collapsible, so no cleanup needed
      // Only R&D project team sections use expandedTeamSections now
      
      container.innerHTML = visibleProducts.map(product => {
        const isExpanded = expandedProductCards[product.id] === true;
        
        // Main card container
        let html = '<div class="product-card" data-status="' + product.status + '" data-id="' + product.id + '">';
        
        // Collapsible Header (always visible)
        html += '<div class="product-card-header" onclick="toggleProductCard(' + product.id + ')">';
        html += '<div class="product-header">';
        
        // Left side: Name, status, and stats
        html += '<div class="product-header-left">';
        html += '<div class="product-title-row">';
        html += '<div class="product-name">' + product.name + '</div>';
        html += '<div class="product-status status-' + (product.status === 'in_development' ? 'dev' : product.status) + '">';
        html += product.status === 'in_development' ? 'In Development' : 
                product.status === 'published' ? 'Live' : 'Deprecated';
        html += '</div>';
        html += '</div>';
        
        // Stats based on status
        html += '<div class="product-stats">';
        
        if (product.status === 'in_development') {
          const progress = Math.min(100, (product.currentProgress / product.developmentEffort) * 100);
          
          html += '<div class="product-stat">';
          html += '<span class="product-stat-icon">ð</span>';
          html += '<span class="product-stat-value">' + Math.round(progress) + '%</span>';
          html += '</div>';
          
          // Number of assigned developers
          const devCount = product.assignedDevelopers.length;
          html += '<div class="product-stat">';
          html += '<span class="product-stat-icon">ð¥</span>';
          html += '<span class="product-stat-value">' + devCount + '</span>';
          html += '</div>';
          
          // Calculate estimated completion with team overhead penalty
          const teamSize = product.assignedDevelopers.length;
          let totalEfficiency = 0;
          
          if (product.assignedDevelopers.includes('founder')) {
            const baseEfficiency = founder.efficiency * efficiencyMultiplier;
            totalEfficiency += getEffectiveEfficiency(baseEfficiency, teamSize);
          }
          product.assignedDevelopers.forEach(devId => {
            if (devId !== 'founder') {
              const developer = developers.find(d => d.id === devId);
              if (developer) {
                const baseEfficiency = developer.efficiency * efficiencyMultiplier;
                totalEfficiency += getEffectiveEfficiency(baseEfficiency, teamSize);
              }
            }
          });
          const daysLeft = totalEfficiency > 0 ? 
            Math.ceil((product.developmentEffort - product.currentProgress) / (totalEfficiency / 30)) : 
            'â';
          
          html += '<div class="product-stat">';
          html += '<span class="product-stat-icon">ð</span>';
          html += '<span class="product-stat-label">~' + (daysLeft === 'â' ? 'â' : daysLeft + ' days') + '</span>';
          html += '</div>';
        }
        
        if (product.status === 'published') {
          const monthlyRevenue = product.subscribers * product.monthlyPrice;
          
          html += '<div class="product-stat">';
          html += '<span class="product-stat-icon">ð°</span>';
          html += '<span class="product-stat-value">' + formatCurrency(monthlyRevenue) + '</span>';
          html += '<span class="product-stat-label">/mo</span>';
          html += '</div>';
          
          // Number of assigned people (developers + marketers)
          const totalAssignees = product.assignedDevelopers.length + product.assignedMarketers.length;
          html += '<div class="product-stat">';
          html += '<span class="product-stat-icon">ð¥</span>';
          html += '<span class="product-stat-value">' + totalAssignees + '</span>';
          html += '</div>';
          
          const monthsLeft = Math.round(product.remainingLifetimeMonths);
          const yearsLeft = Math.floor(monthsLeft / 12);
          const remainingMonths = monthsLeft % 12;
          let lifetimeText = '';
          if (yearsLeft > 0) lifetimeText = yearsLeft + 'y';
          if (remainingMonths > 0) {
            if (lifetimeText) lifetimeText += ' ';
            lifetimeText += remainingMonths + 'm';
          }
          
          html += '<div class="product-stat">';
          html += '<span class="product-stat-icon">â°</span>';
          html += '<span class="product-stat-label">' + lifetimeText + '</span>';
          html += '</div>';
        }
        
        if (product.status === 'deprecated') {
          html += '<div class="product-stat">';
          html += '<span class="product-stat-icon">ð¥</span>';
          html += '<span class="product-stat-value">' + product.subscribers.toLocaleString() + '</span>';
          html += '<span class="product-stat-label">subs</span>';
          html += '</div>';
          
          const deprecatedRevenue = product.subscribers * product.monthlyPrice;
          html += '<div class="product-stat">';
          html += '<span class="product-stat-icon">ð°</span>';
          html += '<span class="product-stat-label">' + formatCurrency(deprecatedRevenue) + '/mo</span>';
          html += '</div>';
        }
        
        html += '</div>'; // Close stats
        html += '</div>'; // Close header-left
        
        // Right side: Expand/collapse icon
        html += '<div class="product-expand-icon" id="product-expand-icon-' + product.id + '" style="transform: rotate(' + (isExpanded ? '180deg' : '0deg') + ');">';
        html += isExpanded ? 'â²' : 'â¼';
        html += '</div>';
        
        html += '</div>'; // Close header
        html += '</div>'; // Close card-header
        
        // Details section (shown when expanded)
        html += '<div class="product-details' + (isExpanded ? ' expanded' : '') + '" id="product-details-' + product.id + '">';
        
        // Additional details based on status
        if (product.status === 'in_development') {
          const progressPercent = Math.min(100, (product.currentProgress / product.developmentEffort) * 100);
          
          // Progress bar in single line
          html += '<div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem; margin-bottom: 0.75rem;">';
          
          // Label
          html += '<span style="font-size: 0.875rem; color: #374151; font-weight: 500; white-space: nowrap;">Progress</span>';
          
          // Progress bar with percentage inside
          html += '<div style="flex: 1; position: relative; background: #e5e7eb; border-radius: 8px; height: 24px; overflow: hidden;">';
          html += '<div style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: ' + progressPercent + '%; transition: width 0.3s ease;"></div>';
          html += '<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: ' + (progressPercent > 50 ? '#ffffff' : '#374151') + ';">';
          html += Math.round(progressPercent) + '%';
          html += '</div>';
          html += '</div>';
          
          // Total man-months
          html += '<span style="font-size: 0.875rem; color: #6b7280; white-space: nowrap;">' + product.developmentEffort + ' months</span>';
          
          html += '</div>';
          
          // Development Team section (non-collapsible)
          const devCount = product.assignedDevelopers.length;
          
          html += '<div style="margin-top: 0.5rem;">';
          html += '<div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 0.875rem;">';
          html += 'ð¥ Development Team (' + devCount + ')' + generatePenaltyIcon(devCount);
          html += '</div>';
          
          html += '<div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">';
          
          // Add developer button (moved to top)
          html += '<button class="add-person-btn" onclick="showAssignDeveloperModal(' + product.id + ')">â Add Developer</button>';
          
          const founderAssigned = product.assignedDevelopers.includes('founder');
          if (founderAssigned) {
            html += '<div class="assigned-person-card">';
            html += '<span class="assigned-person-name">' + founder.name + ' <span class="person-role">(Founder)</span></span>';
            html += '<button class="unassign-btn" onclick="unassignFounderFromProduct(' + product.id + ')">â</button>';
            html += '</div>';
          }
          
          product.assignedDevelopers.forEach(devId => {
            if (devId !== 'founder') {
              const dev = developers.find(d => d.id === devId);
              if (dev) {
                const skillLabel = dev.skill.charAt(0).toUpperCase() + dev.skill.slice(1);
                html += '<div class="assigned-person-card">';
                html += '<span class="assigned-person-name">' + dev.name + ' <span class="person-role">(' + skillLabel + ')</span></span>';
                html += '<button class="unassign-btn" onclick="unassignEmployeeFromProduct(' + dev.id + ')">â</button>';
                html += '</div>';
              }
            }
          });
          html += '</div></div>';
        }
        
        if (product.status === 'published') {
          html += '<div class="product-detail-row">';
          html += '<span class="product-detail-label">Subscribers</span>';
          html += '<span class="product-detail-value">' + product.subscribers.toLocaleString() + '</span>';
          html += '</div>';
          
          html += '<div class="product-detail-row">';
          html += '<span class="product-detail-label">Price per customer</span>';
          html += '<span class="product-detail-value">' + formatCurrency(product.monthlyPrice) + '</span>';
          html += '</div>';
          
          // Marketing Team section (non-collapsible)
          const mktCount = product.assignedMarketers.length;
          
          html += '<div style="margin-top: 0.5rem;">';
          html += '<div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 0.875rem;">';
          html += 'ð¢ Marketing Team (' + mktCount + ')' + generatePenaltyIcon(mktCount);
          html += '</div>';
          
          html += '<div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">';
          
          // Add marketer button (moved to top)
          html += '<button class="add-person-btn" onclick="showAssignMarketerModal(' + product.id + ')">â Add Marketer</button>';
          
          const founderAssignedAsMarketer = product.assignedMarketers.includes('founder');
          if (founderAssignedAsMarketer) {
            html += '<div class="assigned-person-card">';
            html += '<span class="assigned-person-name">' + founder.name + ' <span class="person-role">(Founder)</span></span>';
            html += '<button class="unassign-btn" onclick="unassignFounderFromProduct(' + product.id + ')">â</button>';
            html += '</div>';
          }
          
          product.assignedMarketers.forEach(mktId => {
            if (mktId !== 'founder') {
              const mkt = marketers.find(m => m.id === mktId);
              if (mkt) {
                const skillLabel = mkt.skill.charAt(0).toUpperCase() + mkt.skill.slice(1);
                html += '<div class="assigned-person-card">';
                html += '<span class="assigned-person-name">' + mkt.name + ' <span class="person-role">(' + skillLabel + ')</span></span>';
                html += '<button class="unassign-btn" onclick="unassignEmployeeFromProduct(' + mkt.id + ')">â</button>';
                html += '</div>';
              }
            }
          });
          html += '</div></div>';
        }
        
        if (product.status === 'deprecated') {
          html += '<div class="product-detail-row">';
          html += '<span class="product-detail-label">Decline Rate</span>';
          html += '<span class="product-detail-value" style="color: #dc2626;">declining fast</span>';
          html += '</div>';
        }
        
        html += '</div>'; // Close details
        html += '</div>'; // Close card
        return html;
      }).join('');
      
      // No need to restore states - they're applied directly in HTML generation above
      
      // Update filter counts
      updateFilterCounts();
      
      // Reapply current filter after UI update
      filterProducts(currentProductFilter);
      
      // Update "New Product" button state based on availability
      updateNewProductButtonState();
    }
    
    // Product filtering system
    let currentProductFilter = 'all';
    let expandedProductCards = {}; // Track which product cards are expanded
    
    let currentEmployeeFilter = 'all';
    let expandedEmployeeCards = {}; // Track which employee cards are expanded
    
    function filterProducts(filter) {
      currentProductFilter = filter;
      
      // Update active state on filter pills
      document.querySelectorAll('.filter-pill').forEach(pill => {
        pill.classList.remove('active');
        if (pill.dataset.filter === filter) {
          pill.classList.add('active');
        }
      });
      
      // Filter product cards
      const allCards = document.querySelectorAll('.product-card');
      allCards.forEach(card => {
        const status = card.dataset.status;
        if (filter === 'all') {
          card.style.display = '';
        } else {
          card.style.display = status === filter ? '' : 'none';
        }
      });
    }
    
    function toggleProductCard(productId) {
      const details = document.getElementById('product-details-' + productId);
      const icon = document.getElementById('product-expand-icon-' + productId);
      
      if (details && icon) {
        const isExpanded = details.classList.contains('expanded');
        
        if (isExpanded) {
          details.classList.remove('expanded');
          icon.textContent = 'â¼';
          icon.style.transform = 'rotate(0deg)';
          expandedProductCards[productId] = false;
        } else {
          details.classList.add('expanded');
          icon.textContent = 'â²';
          icon.style.transform = 'rotate(180deg)';
          expandedProductCards[productId] = true;
        }
      }
    }
    
    // Employee filtering system
    function filterEmployees(filter) {
      currentEmployeeFilter = filter;
      
      // Update active state on filter pills (only in employee panel)
      const employeePanel = document.querySelector('#employeesContainer');
      if (employeePanel) {
        employeePanel.querySelectorAll('.filter-pill').forEach(pill => {
          pill.classList.remove('active');
          if (pill.dataset.filter === filter) {
            pill.classList.add('active');
          }
        });
      }
      
      // Re-render employees with filter
      updateEmployeesUI();
    }
    
    function toggleEmployeeCard(employeeId) {
      const details = document.getElementById('employee-details-' + employeeId);
      const icon = document.getElementById('employee-expand-icon-' + employeeId);
      
      if (details && icon) {
        const isExpanded = details.classList.contains('expanded');
        
        if (isExpanded) {
          details.classList.remove('expanded');
          icon.textContent = 'â¼';
          icon.style.transform = 'rotate(0deg)';
          delete expandedEmployeeCards[employeeId]; // Remove from tracking
        } else {
          details.classList.add('expanded');
          icon.textContent = 'â²';
          icon.style.transform = 'rotate(180deg)';
          expandedEmployeeCards[employeeId] = currentDay; // Store the day it was expanded
        }
      }
    }
    
    function autoCollapseOldEmployeeCards() {
      // Auto-collapse employee cards that have been expanded for 60+ days
      const cardsToCollapse = [];
      
      for (const employeeId in expandedEmployeeCards) {
        const expandedDay = expandedEmployeeCards[employeeId];
        const daysSinceExpanded = currentDay - expandedDay;
        
        if (daysSinceExpanded >= 60) {
          cardsToCollapse.push(employeeId);
        }
      }
      
      // Collapse cards that have been open too long
      if (cardsToCollapse.length > 0) {
        cardsToCollapse.forEach(employeeId => {
          delete expandedEmployeeCards[employeeId];
        });
        
        // Refresh employee UI to reflect collapsed state
        updateEmployeesUI();
      }
    }
    
    function updateEmployeeFilterCounts() {
      const allEmployees = [founder, ...developers, ...marketers];
      
      // Count unassigned employees
      const unassignedCount = allEmployees.filter(emp => {
        const empId = emp.id === founder.id || emp.name === founder.name ? founder.id : emp.id;
        
        // Check if assigned to any product
        const isAssignedToProduct = products.some(p => 
          p.assignedDevelopers.includes(empId) || p.assignedMarketers.includes(empId)
        );
        
        // Check if assigned to any R&D project
        const isAssignedToRnd = rndProjects.some(p => p.assignedDevelopers.includes(empId));
        
        return !isAssignedToProduct && !isAssignedToRnd;
      }).length;
      
      // Count by filter (founder only shown in "All" filter)
      const counts = {
        all: allEmployees.length + managers.length, // Include managers in all count
        developer: developers.length, // Founder excluded from developer count
        marketer: marketers.length,
        managers: managers.length, // Managers count
        unassigned: unassignedCount,
        promotion: allEmployees.filter(e => e.readyForPromotion).length + managers.filter(m => m.readyForPromotion).length
      };
      
      // Update count displays
      Object.keys(counts).forEach(filter => {
        const countEl = document.getElementById('employee-count-' + filter);
        if (countEl) {
          countEl.textContent = counts[filter];
        }
      });
    }
    
    function updateFilterCounts() {
      // Filter out products with 0 subscribers that are deprecated
      const visibleProducts = products.filter(p => {
        return !(p.status === 'deprecated' && p.subscribers === 0);
      });
      
      const counts = {
        all: visibleProducts.length,
        'in_development': visibleProducts.filter(p => p.status === 'in_development').length,
        'published': visibleProducts.filter(p => p.status === 'published').length,
        'deprecated': visibleProducts.filter(p => p.status === 'deprecated').length
      };
      
      document.getElementById('productCount').textContent = counts.all;
      document.getElementById('filterCountAll').textContent = counts.all;
      document.getElementById('filterCountDev').textContent = counts['in_development'];
      document.getElementById('filterCountLive').textContent = counts['published'];
      //document.getElementById('filterCountDeprecated').textContent = counts['deprecated'];
    }
    
    function showNewProductModal() {
      pauseGame(); // Auto-pause when opening modal
      const modal = document.getElementById('newProductModal');
      const list = document.getElementById('productTemplatesList');
      
      // Create sorted array of templates by development effort (ascending)
      const sortedTemplates = PRODUCT_TEMPLATES.map((template, originalIndex) => ({
        template,
        originalIndex
      })).sort((a, b) => a.template.developmentEffort - b.template.developmentEffort);
      
      // Filter to only show unlocked products
      const unlockedTemplates = sortedTemplates.filter(({template}) => {
        return isProductUnlocked(template.name);
      });
      
      // Filter out products that already exist (active or in development)
      const availableTemplates = unlockedTemplates.filter(({template}) => {
        const existingProduct = products.find(p => p.name === template.name && p.status !== "deprecated");
        return !existingProduct; // Only show if it doesn't exist or is deprecated
      });
      
      // Check if there are any available products
      if (availableTemplates.length === 0) {
        const hasUnlockedButActive = unlockedTemplates.length > 0;
        if (hasUnlockedButActive) {
          list.innerHTML = '<div class="empty-state">All unlocked products are already active! Complete R&D projects to unlock new products.</div>';
        } else {
          list.innerHTML = '<div class="empty-state">No products unlocked yet. Complete R&D projects to unlock new products!</div>';
        }
        modal.classList.add('active');
        return;
      }
      
      // Find first available template index for default selection
      const firstAvailableIndex = availableTemplates[0].originalIndex;
      
      // Render product templates (sorted by development effort, only unlocked and not active)
      list.innerHTML = availableTemplates.map(({template, originalIndex}) => {
        const price = currency === "USD" ? 
          `$${template.monthlyPriceUSD}/mo` : 
          `â¬${template.monthlyPriceEUR}/mo`;
        
        const years = Math.floor(template.lifetimeMonths / 12);
        const remainingMonths = template.lifetimeMonths % 12;
        const lifeDisplay = remainingMonths > 0 ? 
          `${years}y ${remainingMonths}m` : 
          `${years} years`;
        
        return `
          <label class="product-template">
            <input type="radio" name="productTemplate" value="${originalIndex}" ${originalIndex === firstAvailableIndex ? 'checked' : ''}>
            <div class="template-content">
              <div class="template-name">${template.name}</div>
              <div class="template-details">
                <div class="template-detail">ð ${template.developmentEffort} months dev</div>
                <div class="template-detail">â³ ${lifeDisplay} life</div>
                <div class="template-detail">ð° ${price}</div>
              </div>
              <div class="template-description">${template.description}</div>
            </div>
          </label>
        `;
      }).join('');
      
      modal.classList.add('active');
    }
    
    function hideNewProductModal(resumeGame = true) {
      document.getElementById('newProductModal').classList.remove('active');
      if (resumeGame) {
        startGame(); // Resume game when cancelled
      }
    }
    
    function handleCreateProduct() {
      const selectedIndex = parseInt(document.querySelector('input[name="productTemplate"]:checked').value);
      const template = PRODUCT_TEMPLATES[selectedIndex];
      
      createProduct(template);
      hideNewProductModal(true); // Resume game after creating product
    }

    // ============================================
    // GAME LOOP
    // ============================================
    function startGame() {
      if (isPlaying) return;
      isPlaying = true;
      updateSpeedButtons();
      
      // Hide pause border
      const pauseBorder = document.getElementById('pauseBorderOverlay');
      if (pauseBorder) {
        pauseBorder.classList.remove('active');
      }
      
      gameTick();
    }

    function pauseGame() {
      isPlaying = false;
      if (tickTimer) clearTimeout(tickTimer);
      updateSpeedButtons();
      
      // Show pause border
      const pauseBorder = document.getElementById('pauseBorderOverlay');
      if (pauseBorder) {
        pauseBorder.classList.add('active');
      }
    }

    function setGameSpeed(speed) {
      gameSpeed = speed;
      updateSpeedButtons();
      if (isPlaying) {
        // Restart with new speed
        pauseGame();
        startGame();
      }
    }

    function updateSpeedButtons() {
      // Update play/pause button
      const playPauseBtn = document.getElementById('playPauseBtn');
      const playPauseText = document.getElementById('playPauseText');
      const playPauseIcon = playPauseBtn?.querySelector('[data-lucide]');
      
      if (playPauseBtn) {
        if (isPlaying) {
          playPauseBtn.className = 'flex items-center gap-1 px-3 py-3 text-sm font-medium rounded-lg transition-colors bg-white/20 hover:bg-white/30 text-white border border-white/30';
          if (playPauseText) playPauseText.textContent = 'Pause';
          if (playPauseIcon) playPauseIcon.setAttribute('data-lucide', 'pause');
        } else {
          playPauseBtn.className = 'flex items-center gap-1 px-3 py-3 text-sm font-medium rounded-lg transition-colors bg-blue-700 hover:bg-blue-800 text-white border border-blue-500';
          if (playPauseText) playPauseText.textContent = 'Play';
          if (playPauseIcon) playPauseIcon.setAttribute('data-lucide', 'play');
        }
        
        // Reinitialize Lucide icons
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }
      
      // Update speed button text
      const speedText = document.getElementById('speedText');
      if (speedText) {
        speedText.textContent = `${gameSpeed}x`;
      }
      
      // Also update old buttons if they exist (for backwards compatibility)
      const oldButtons = document.querySelectorAll('.speed-btn');
      if (oldButtons.length > 0) {
        oldButtons.forEach(btn => btn.classList.remove('active'));
        if (!isPlaying) {
          const pauseBtn = document.getElementById('pauseBtn');
          if (pauseBtn) pauseBtn.classList.add('active');
        } else {
          if (gameSpeed === 1) {
            const playBtn = document.getElementById('playBtn');
            if (playBtn) playBtn.classList.add('active');
          } else if (gameSpeed === 2) {
            const speed2xBtn = document.getElementById('speed2xBtn');
            if (speed2xBtn) speed2xBtn.classList.add('active');
          }
        }
      }
    }
    
    function togglePlayPause() {
      if (isPlaying) {
        pauseGame();
      } else {
        startGame();
      }
    }
    
    function cycleSpeed() {
      const speeds = [1, 2, 3];
      const currentIndex = speeds.indexOf(gameSpeed);
      const nextSpeed = speeds[(currentIndex + 1) % speeds.length];
      setGameSpeed(nextSpeed);
    }
    
    // ============================================
    // SERVER UPGRADE DIALOG
    // ============================================
    
    function showServerUpgradeDialog() {
      const server = SERVER_TIERS[currentServerTier];
      const nextTier = SERVER_TIERS[currentServerTier + 1];
      
      if (!nextTier) {
        showNotification('Already at maximum server tier!', 'info');
        return;
      }
      
      const upgradeCost = currency === "USD" ? nextTier.upgradeCostUSD : nextTier.upgradeCostEUR;
      const nextFee = currency === "USD" ? nextTier.monthlyFeeUSD : nextTier.monthlyFeeEUR;
      const currentFee = currency === "USD" ? server.monthlyFeeUSD : server.monthlyFeeEUR;
      const canAfford = canUpgradeServer();
      
      const dialogContent = `
        <div class="space-y-4">
          <div class="bg-gray-50 rounded-lg p-3 space-y-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <i data-lucide="bar-chart-3" class="w-4 h-4 text-gray-600"></i>
                <span class="text-sm text-gray-700">Capacity Upgrade:</span>
              </div>
              <span class="font-medium text-gray-900">
                ${server.maxSubscribers.toLocaleString()}
                <i data-lucide="arrow-right" class="inline w-3.5 h-3.5 mx-1.5 text-gray-400"></i>
                <span class="text-indigo-700">
                  ${nextTier.maxSubscribers.toLocaleString()}
                </span>
              </span>
            </div>
            
            <div class="border-t border-gray-200"></div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <i data-lucide="dollar-sign" class="w-4 h-4 text-gray-600"></i>
                <span class="text-sm text-gray-700">Monthly Cost:</span>
              </div>
              <span class="font-medium text-gray-900">
                ${formatCurrency(currentFee)}
                <i data-lucide="arrow-right" class="inline w-3.5 h-3.5 mx-1.5 text-gray-400"></i>
                <span class="text-indigo-700">
                  ${formatCurrency(nextFee)}
                </span>
              </span>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <i data-lucide="zap" class="w-4 h-4 text-orange-500"></i>
                <span class="text-sm text-gray-700">Setup Fee:</span>
              </div>
              <span class="font-semibold text-gray-900">
                ${formatCurrency(upgradeCost)}
              </span>
            </div>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="flex items-start gap-2">
              <i data-lucide="info" class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"></i>
              <p class="text-xs text-blue-900">
                The setup fee is a one-time charge. Monthly costs will be added to your expenses starting next billing cycle.
              </p>
            </div>
          </div>
          
          ${!canAfford ? `
            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
              <div class="flex items-start gap-2">
                <i data-lucide="alert-circle" class="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0"></i>
                <p class="text-xs text-red-900">
                  Insufficient funds! You need ${formatCurrency(upgradeCost)} but only have ${formatCurrency(cash)}.
                </p>
              </div>
            </div>
          ` : ''}
        </div>
      `;
      
      const dialog = new Dialog({
        id: 'server-upgrade-dialog',
        title: `<i data-lucide="server" class="inline w-5 h-5 text-indigo-600 mr-2"></i>Upgrade to ${nextTier.name}`,
        description: 'Increase your server capacity to support more subscribers',
        content: dialogContent,
        confirmText: 'Upgrade Now',
        cancelText: 'Cancel',
        confirmClass: canAfford ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-gray-400 cursor-not-allowed',
        onConfirm: () => {
          if (canAfford) {
            upgradeServer();
            return true; // Close dialog
          }
          return false; // Keep dialog open
        },
        onCancel: () => {
          startGame(); // Resume game when cancelled
        }
      });
      
      dialog.render().open();
      
      // Initialize Lucide icons in dialog
      setTimeout(() => {
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }, 0);
    }
    
    function upgradeServer() {
      if (currentServerTier >= SERVER_TIERS.length - 1) {
        showNotification('Already at maximum server tier!', 'warning');
        return;
      }
      
      if (!canUpgradeServer()) {
        showNotification('Insufficient funds to upgrade server!', 'error');
        return;
      }
      
      const nextTier = SERVER_TIERS[currentServerTier + 1];
      const upgradeCost = currency === "USD" ? nextTier.upgradeCostUSD : nextTier.upgradeCostEUR;
      
      cash -= upgradeCost;
      currentServerTier++;
      
      logEvent(`ð¥ï¸ Upgraded server to ${nextTier.name} for ${formatCurrency(upgradeCost)}`);
      showNotification(`Server upgraded to ${nextTier.name}!`, 'success');
      
      updateCashDisplay();
      updateFinancesUI();
    }
    
    // Alias for reset function (used by new header button)
    function confirmReset() {
      resetGameWithConfirmation();
    }

    // ============================================
    // MANAGER SYSTEM - OPTIMIZATION FUNCTIONS
    // ============================================
    
    function runManagerOptimization() {
      // Show manager overview
      console.log(`ð Active Managers: ${managers.length}`);
      let totalCapacityUsed = 0;
      managers.forEach(m => {
        totalCapacityUsed += m.managedEmployees.length;
        console.log(`   - ${m.name}: ${m.managedEmployees.length}/${m.capacity} capacity, ${m.efficiency}% efficiency`);
      });
      console.log('');
      
      // Step 0.5: SYNC - Ensure all employees in manager arrays have isManaged = true
      const allEmployees = [founder, ...developers, ...marketers];
      let syncedCount = 0;
      
      for (const manager of managers) {
        for (const empId of manager.managedEmployees) {
          const emp = allEmployees.find(e => 
            (e.id === empId || (e.id === 'founder' && empId === 'founder'))
          );
          
          if (emp) {
            // Sync isManaged and managerId if they don't match
            if (!emp.isManaged || emp.managerId !== manager.id) {
              emp.isManaged = true;
              emp.managerId = manager.id;
              syncedCount++;
              console.log(`ð§ Synced ${emp.name}: isManaged=true, managerId=${manager.id}`);
            }
          } else {
            console.log(`â ï¸ Employee ID ${empId} in ${manager.name}'s list but not found in game state`);
          }
        }
      }
      
      if (syncedCount > 0) {
        console.log(`â Synced ${syncedCount} employee(s) with manager data`);
        console.log('');
      }
      
      // Step 1: Collect all managed employees (pooled across all managers)
      // Includes founder but excludes managers themselves
      const managedEmployees = allEmployees.filter(e => 
        e.isManaged && 
        e.role !== 'manager' // Managers are not employees to be assigned
      );
      
      if (managedEmployees.length === 0) {
        console.log('â No managed employees found. Skipping optimization.');
        return; // No managed employees, nothing to do
      }
      
      // Verify count matches manager capacity
      if (managedEmployees.length !== totalCapacityUsed) {
        console.log(`â ï¸ WARNING: Found ${managedEmployees.length} managed employees but manager capacity shows ${totalCapacityUsed}`);
      }
      
      console.log(`ð Manager optimization running with ${managedEmployees.length} managed employees`);
      
      // Show breakdown
      const managedDevCount = managedEmployees.filter(e => e.role === 'developer').length;
      const managedMktCount = managedEmployees.filter(e => e.role === 'marketer').length;
      const managedFounder = managedEmployees.find(e => e.id === 'founder');
      
      console.log(`  Breakdown: ${managedDevCount} developers, ${managedMktCount} marketers${managedFounder ? ', founder (can do dev work)' : ''}`);
      
      // Step 2: Separate by role and assignment status
      
      // Helper function to check if assignment is valid
      function isValidAssignment(employee) {
        if (!employee.assignedProduct) return false;
        
        const assignedTo = products.find(p => p.id === employee.assignedProduct);
        const assignedToRnd = rndProjects.find(r => r.id === employee.assignedProduct);
        
        // Product/project doesn't exist anymore
        if (!assignedTo && !assignedToRnd) return false;
        
        // Check based on role
        if (employee.role === 'developer') {
          // Developers: in_development (not deprecated) OR rnd (not completed)
          if (assignedTo) {
            return assignedTo.status === 'in_development' && assignedTo.status !== 'deprecated';
          }
          if (assignedToRnd) {
            return assignedToRnd.status !== 'completed'; // RND must not be completed
          }
          return false;
        } else if (employee.role === 'marketer') {
          // Marketers: only published products (not deprecated), NO rnd projects
          if (assignedToRnd) return false; // Marketers cannot work on R&D
          if (assignedTo) {
            return assignedTo.status === 'published' && assignedTo.status !== 'deprecated';
          }
          return false;
        } else if (employee.id === 'founder') {
          // Founder: anything except deprecated
          if (assignedTo) {
            return assignedTo.status !== 'deprecated';
          }
          if (assignedToRnd) {
            return assignedToRnd.status !== 'completed'; // Can work on active R&D
          }
          return false;
        }
        
        return false;
      }
      
      // Separate into unassigned and assigned
      const unassignedDevs = managedEmployees.filter(e => 
        (e.role === 'developer' || e.id === 'founder') && !isValidAssignment(e)
      );
      
      const unassignedMarketers = managedEmployees.filter(e => 
        e.role === 'marketer' && !isValidAssignment(e)
      );
      
      const assignedDevs = managedEmployees.filter(e => 
        (e.role === 'developer' || e.id === 'founder') && isValidAssignment(e)
      );
      
      const assignedMarketers = managedEmployees.filter(e => 
        e.role === 'marketer' && isValidAssignment(e)
      );
      
      console.log(`  Unassigned: ${unassignedDevs.length} devs, ${unassignedMarketers.length} marketers`);
      if (unassignedDevs.length > 0) {
        console.log(`    Unassigned devs: ${unassignedDevs.map(e => `${e.name} (assigned to: ${e.assignedProduct})`).join(', ')}`);
      }
      if (unassignedMarketers.length > 0) {
        console.log(`    Unassigned marketers: ${unassignedMarketers.map(e => `${e.name} (assigned to: ${e.assignedProduct})`).join(', ')}`);
      }
      console.log(`  Assigned: ${assignedDevs.length} devs, ${assignedMarketers.length} marketers`);
      
      // Step 2.5: Sync arrays - ensure assigned employees are in product/project arrays
      // This fixes cases where employee.assignedProduct is set but arrays aren't updated
      console.log('');
      console.log('ð Syncing assigned employees with product/project arrays...');
      let syncCount = 0;
      
      for (const emp of [...assignedDevs, ...assignedMarketers]) {
        const empId = emp.id === 'founder' || emp.name === founder.name ? 'founder' : emp.id;
        const productId = emp.assignedProduct;
        
        if (!productId) {
          console.log(`  â ï¸ ${emp.name} has no assignedProduct set (should not happen in assigned list)`);
          continue;
        }
        
        const product = products.find(p => p.id === productId);
        const rndProject = rndProjects.find(r => r.id === productId);
        const target = product || rndProject;
        
        if (!target) {
          console.log(`  â ï¸ ${emp.name} assigned to non-existent product/project ID: ${productId} - clearing assignment`);
          emp.assignedProduct = null;
          continue;
        }
        
        // Check if it's an R&D project (exists in rndProjects array)
        if (rndProject) {
          // R&D project
          if (!rndProject.assignedDevelopers) {
            console.log(`  â ï¸ R&D project ${rndProject.name} has no assignedDevelopers array! Creating...`);
            rndProject.assignedDevelopers = [];
          }
          if (!rndProject.assignedDevelopers.includes(empId)) {
            rndProject.assignedDevelopers.push(empId);
            console.log(`  â Synced ${emp.name} â ${rndProject.name} (R&D) - added to array`);
            syncCount++;
          }
        } else if (product) {
          // Product
          if (emp.role === 'developer' || emp.id === 'founder') {
            if (!product.assignedDevelopers.includes(empId)) {
              product.assignedDevelopers.push(empId);
              console.log(`  â Synced ${emp.name} â ${product.name} (Product Dev) - added to array`);
              syncCount++;
            }
          } else if (emp.role === 'marketer') {
            if (!product.assignedMarketers.includes(empId)) {
              product.assignedMarketers.push(empId);
              console.log(`  â Synced ${emp.name} â ${product.name} (Product Mkt) - added to array`);
              syncCount++;
            }
          }
        } else {
          console.log(`  â ï¸ ERROR: ${emp.name} assigned to ID ${productId} but not found in products or rndProjects!`);
        }
      }
      
      if (syncCount > 0) {
        console.log(`â Synced ${syncCount} employees to product/project arrays`);
      } else {
        console.log(`â All employees already in sync`);
      }
      console.log('');
      
      // Step 3: Assign unassigned employees first (PRIORITY)
      assignUnassignedEmployees(unassignedDevs, unassignedMarketers);
      
      // Step 4: Rebalance existing assignments (ONLY if everyone is assigned)
      // Re-check for unassigned after assignment step
      const stillUnassignedDevs = managedEmployees.filter(e => 
        (e.role === 'developer' || e.id === 'founder') && !isValidAssignment(e)
      );
      const stillUnassignedMarketers = managedEmployees.filter(e => 
        e.role === 'marketer' && !isValidAssignment(e)
      );
      
      if (stillUnassignedDevs.length > 0 || stillUnassignedMarketers.length > 0) {
        console.log(`â ï¸ Skipping rebalancing: ${stillUnassignedDevs.length + stillUnassignedMarketers.length} employees still unassigned`);
        console.log(`   Having everyone working is more important than balanced distribution.`);
      } else {
        console.log(`â All managed employees are assigned. Checking if rebalancing needed...`);
        rebalanceEmployees(assignedDevs, assignedMarketers);
      }
      
      // Step 5: Update last optimization time
      lastManagerOptimization = currentDay;
      
      // Step 6: Log summary and verify assignments
      console.log('');
      console.log('ð OPTIMIZATION COMPLETE - VERIFYING ASSIGNMENTS:');
      console.log('='.repeat(60));
      
      // Count how many are assigned now
      let assignedCount = 0;
      let unassignedCount = 0;
      
      managedEmployees.forEach(emp => {
        const empName = emp.name || founder.name;
        const empId = emp.id === 'founder' || emp.name === founder.name ? 'founder' : emp.id;
        
        if (emp.assignedProduct) {
          // Find where they're assigned
          const product = products.find(p => p.id === emp.assignedProduct);
          const rndProject = rndProjects.find(r => r.id === emp.assignedProduct);
          const target = product || rndProject;
          
          if (target) {
            // Check if they're in the product/project array
            let isInArray = false;
            
            if (product) {
              isInArray = product.assignedDevelopers?.includes(empId) || product.assignedMarketers?.includes(empId) || false;
            } else if (rndProject) {
              isInArray = rndProject.assignedDevelopers?.includes(empId) || false;
            }
            
            console.log(`â ${empName} (${emp.role}) â ${target.name} ${isInArray ? 'â' : 'â ï¸ NOT IN ARRAY'}`);
            assignedCount++;
          } else {
            console.log(`â ï¸ ${empName} (${emp.role}) â Product ID ${emp.assignedProduct} NOT FOUND`);
            unassignedCount++;
          }
        } else {
          console.log(`â ${empName} (${emp.role}) â UNASSIGNED`);
          unassignedCount++;
        }
      });
      
      console.log('='.repeat(60));
      console.log(`Summary: ${assignedCount} assigned, ${unassignedCount} unassigned`);
      console.log('');
      
      //logEvent(`ð Manager optimization complete: ${assignedCount}/${managedEmployees.length} employees assigned`);
      
      // Update UI
      updateProductsUI();
      updateRndUI();
      updateEmployeesUI();
    }
    
    function assignUnassignedEmployees(devs, marketers) {
      // Get products/projects needing developers (including founder who can do dev work)
      // - Products: in_development AND not deprecated
      // - R&D Projects: not completed
      const devProjects = [
        ...products.filter(p => p.status === 'in_development' && p.status !== 'deprecated'),
        ...rndProjects.filter(r => r.status !== 'completed')
      ];
      
      // Get products needing marketers
      // - Products: published AND not deprecated
      // - NO R&D projects (marketers can't work on R&D)
      const mktProducts = products.filter(p => p.status === 'published' && p.status !== 'deprecated');
      
      console.log(`  Available dev projects: ${devProjects.length}`);
      if (devProjects.length > 0) {
        console.log(`    Dev projects: ${devProjects.map(p => `${p.name} (id:${p.id})`).join(', ')}`);
      }
      console.log(`  Available mkt products: ${mktProducts.length}`);
      if (mktProducts.length > 0) {
        console.log(`    Mkt products: ${mktProducts.map(p => `${p.name} (id:${p.id})`).join(', ')}`);
      }
      
      // Assign developers
      //console.log(`\n  ð Assigning ${devs.length} unassigned developers...`);
      for (const dev of devs) {
        const devName = dev.name || founder.name;
        const devId = dev.id === 'founder' || dev.name === founder.name ? 'founder' : dev.id;
        
        //console.log(`\n    ð¤ Processing ${devName}:`);
        //console.log(`       - ID: ${devId}`);
        //console.log(`       - Current assignedProduct: ${dev.assignedProduct || 'none'}`);
        //console.log(`       - isManaged: ${dev.isManaged}`);
        //console.log(`       - managerId: ${dev.managerId}`);
        
        const target = findBestAssignment(dev, devProjects);
        
        if (target) {
          const empId = dev.id === 'founder' || dev.name === founder.name ? 'founder' : dev.id;
          
          console.log(`       â Found best assignment: ${target.name} (ID: ${target.id})`);
          
          // Update employee's assignment
          dev.assignedProduct = target.id;
          console.log(`       â Set assignedProduct = ${target.id}`);
          
          // Update product/project's array
          // Check if it's an R&D project by checking if it exists in rndProjects array
          const project = rndProjects.find(r => r.id === target.id);
          const product = products.find(p => p.id === target.id);
          
          console.log(`       ð Checking target ID ${target.id}:`);
          console.log(`           - Found in products: ${!!product}`);
          console.log(`           - Found in rndProjects: ${!!project}`);
          
          if (project) {
            // R&D project
            if (!project.assignedDevelopers) {
              console.log(`       â ï¸ R&D project ${project.name} has no assignedDevelopers array! Creating...`);
              project.assignedDevelopers = [];
            }
            if (!project.assignedDevelopers.includes(empId)) {
              project.assignedDevelopers.push(empId);
              console.log(`       â Added to R&D project array. Now: [${project.assignedDevelopers.join(', ')}]`);
            } else {
              console.log(`       â¹ Already in R&D project array`);
            }
          } else if (product) {
            // Product
            if (!product.assignedDevelopers.includes(empId)) {
              product.assignedDevelopers.push(empId);
              console.log(`       â Added to product devs array. Now: [${product.assignedDevelopers.join(', ')}]`);
            } else {
              console.log(`       â¹ Already in product devs array`);
            }
          } else {
            console.log(`       â ERROR: Target not found in products OR rndProjects!`);
          }
          
          console.log(`  â ASSIGNED ${devName} (Dev) to ${target.name} (${project ? 'R&D' : 'Product'})`);
          logEvent(`ð Assigned ${devName} to ${target.name} (Dev)`);
        } else {
          console.log(`       â No suitable dev project found`);
          console.log(`  â  No dev project available for ${devName}`);
        }
      }
      
      // Assign marketers
      for (const marketer of marketers) {
        const target = findBestAssignment(marketer, mktProducts);
        if (target) {
          // Update employee's assignment
          marketer.assignedProduct = target.id;
          
          // Update product's array
          const product = products.find(p => p.id === target.id);
          if (product && !product.assignedMarketers.includes(marketer.id)) {
            product.assignedMarketers.push(marketer.id);
          }
          
          console.log(`  â Assigned ${marketer.name} (Mkt) to ${target.name} - ID: ${marketer.id} â Product ID: ${target.id}`);
          logEvent(`ð Assigned ${marketer.name} to ${target.name} (Mkt)`);
        } else {
          console.log(`  â  No mkt product available for ${marketer.name}`);
        }
      }
    }
    
    function findBestAssignment(employee, availableProducts) {
      if (availableProducts.length === 0) return null;
      
      // Find product with lowest total efficiency (to balance distribution)
      let minEfficiency = Infinity;
      let bestProduct = null;
      
      for (const product of availableProducts) {
        const totalEff = calculateProductEfficiency(product, employee.role);
        if (totalEff < minEfficiency) {
          minEfficiency = totalEff;
          bestProduct = product;
        }
      }
      
      return bestProduct;
    }
    
    function calculateProductEfficiency(product, role) {
      const allEmployees = [founder, ...developers, ...marketers];
      
      // For developers, include founder (founder can do dev work)
      // For marketers, only include actual marketers
      const assigned = allEmployees.filter(e => {
        if (e.assignedProduct !== product.id) return false;
        if (role === 'developer') {
          return e.role === 'developer' || e.id === 'founder';
        } else if (role === 'marketer') {
          return e.role === 'marketer';
        }
        return false;
      });
      
      let totalEfficiency = 0;
      for (const emp of assigned) {
        const teamSize = assigned.length;
        const effectiveEff = getEffectiveEfficiency(emp.efficiency, teamSize);
        totalEfficiency += effectiveEff;
      }
      
      return totalEfficiency;
    }
    
    function rebalanceEmployees(devs, marketers) {
      // Rebalance developers
      if (devs.length > 0) {
        rebalanceRole(devs, 'developer');
      }
      
      // Rebalance marketers
      if (marketers.length > 0) {
        rebalanceRole(marketers, 'marketer');
      }
    }
    
    function rebalanceRole(employees, role) {
      // Get all products/projects for this role
      // For developers/founder: in_development (not deprecated) + active R&D
      // For marketers: published (not deprecated)
      const workItems = role === 'developer'
        ? [
            ...products.filter(p => p.status === 'in_development' && p.status !== 'deprecated'),
            ...rndProjects.filter(r => r.status !== 'completed')
          ]
        : products.filter(p => p.status === 'published' && p.status !== 'deprecated');
      
      if (workItems.length === 0) {
        console.log(`  No work items for ${role}s to rebalance`);
        return;
      }
      
      console.log(`  Rebalancing ${employees.length} ${role}s across ${workItems.length} items`);
      
      // Calculate current efficiency distribution
      const distribution = workItems.map(item => {
        const allEmployees = [founder, ...developers, ...marketers];
        
        // Count ALL employees (managed + unmanaged) for distribution calculation
        const allAssigned = allEmployees.filter(e => {
          if (e.assignedProduct !== item.id) return false;
          
          if (role === 'developer') {
            return e.role === 'developer' || e.id === 'founder';
          } else if (role === 'marketer') {
            return e.role === 'marketer';
          }
          return false;
        });
        
        // But track which ones are managed (these are the ones we can move)
        const managedAssigned = allAssigned.filter(e => e.isManaged);
        
        return {
          item,
          efficiency: calculateProductEfficiency(item, role),
          totalAssigned: allAssigned.length, // Total employees (for smart distribution)
          assigned: managedAssigned // Managed employees (for moving)
        };
      });
      
      // Sort by efficiency (ascending)
      distribution.sort((a, b) => a.efficiency - b.efficiency);
      
      if (distribution.length < 2) {
        console.log(`  Only one item, no rebalancing needed`);
        return;
      }
      
      // Calculate target distribution (split evenly)
      const totalEmployees = employees.length;
      const targetPerItem = totalEmployees / workItems.length;
      
      console.log(`  Total managed ${role}s: ${totalEmployees}`);
      console.log(`  Target per item: ${targetPerItem.toFixed(1)} (${Math.floor(targetPerItem)}-${Math.ceil(targetPerItem)} employees)`);
      
      // Show current distribution
      console.log(`  Current distribution (total/managed):`);
      distribution.forEach(d => {
        console.log(`    - ${d.item.name}: ${d.totalAssigned} total (${d.assigned.length} managed) - efficiency: ${d.efficiency.toFixed(2)}`);
      });
      
      // STEP 1: CRITICAL - Fill any projects with 0 TOTAL employees first
      // Having a project with 0 employees is worse than unbalanced distribution
      const emptyProjects = distribution.filter(d => d.totalAssigned === 0);
      const nonEmptyProjects = distribution.filter(d => d.totalAssigned > 0);
      
      if (emptyProjects.length > 0 && nonEmptyProjects.length > 0) {
        console.log(`  â ï¸ CRITICAL: ${emptyProjects.length} project(s) with 0 employees!`);
        console.log(`    Empty: ${emptyProjects.map(d => d.item.name).join(', ')}`);
        
        let criticalMoves = 0;
        const maxCriticalMoves = Math.min(3, emptyProjects.length); // Fill up to 3 empty projects per tick
        
        // Sort non-empty by most TOTAL employees (take from largest teams)
        nonEmptyProjects.sort((a, b) => b.totalAssigned - a.totalAssigned);
        
        for (const empty of emptyProjects) {
          if (criticalMoves >= maxCriticalMoves) break;
          
          // Find a project with 2+ TOTAL employees AND at least 1 MANAGED employee to take from
          const donor = nonEmptyProjects.find(d => d.totalAssigned >= 2 && d.assigned.length > 0);
          if (!donor) {
            console.log(`    â ï¸ Cannot fill ${empty.item.name} - no projects with 2+ total employees and managed employees to move`);
            break;
          }
          
          // Take the highest efficiency MANAGED employee from the donor
          const employeesToMove = donor.assigned.filter(e => employees.includes(e));
          if (employeesToMove.length === 0) {
            console.log(`    â ï¸ Cannot move from ${donor.item.name} - no managed employees to move`);
            continue;
          }
          
          employeesToMove.sort((a, b) => b.efficiency - a.efficiency);
          const emp = employeesToMove[0];
          const empId = emp.id === 'founder' || emp.name === founder.name ? 'founder' : emp.id;
          const empName = emp.name || founder.name;
          
          console.log(`  ð¨ CRITICAL MOVE: ${empName} (ID: ${empId})`);
          console.log(`    From: ${donor.item.name} (${donor.totalAssigned} total, ${donor.assigned.length} managed) â To: ${empty.item.name} (0 total)`);
          
          // Remove from donor
          const donorProject = rndProjects.find(r => r.id === donor.item.id);
          const donorProduct = products.find(p => p.id === donor.item.id);
          
          if (donorProject) {
            donorProject.assignedDevelopers = donorProject.assignedDevelopers.filter(id => id !== empId);
            console.log(`    â Removed from R&D project (${donorProject.assignedDevelopers.length} devs remaining)`);
          } else if (donorProduct) {
            if (role === 'developer') {
              donorProduct.assignedDevelopers = donorProduct.assignedDevelopers.filter(id => id !== empId);
              console.log(`    â Removed from product devs (${donorProduct.assignedDevelopers.length} devs remaining)`);
            } else {
              donorProduct.assignedMarketers = donorProduct.assignedMarketers.filter(id => id !== empId);
              console.log(`    â Removed from product marketers (${donorProduct.assignedMarketers.length} marketers remaining)`);
            }
          }
          
          // Add to empty project
          const emptyProject = rndProjects.find(r => r.id === empty.item.id);
          const emptyProduct = products.find(p => p.id === empty.item.id);
          
          if (emptyProject) {
            if (!emptyProject.assignedDevelopers) emptyProject.assignedDevelopers = [];
            if (!emptyProject.assignedDevelopers.includes(empId)) {
              emptyProject.assignedDevelopers.push(empId);
              console.log(`    â Added to R&D project (${emptyProject.assignedDevelopers.length} devs now assigned)`);
            }
          } else if (emptyProduct) {
            if (role === 'developer') {
              if (!emptyProduct.assignedDevelopers.includes(empId)) {
                emptyProduct.assignedDevelopers.push(empId);
                console.log(`    â Added to product devs (${emptyProduct.assignedDevelopers.length} devs now assigned)`);
              }
            } else {
              if (!emptyProduct.assignedMarketers.includes(empId)) {
                emptyProduct.assignedMarketers.push(empId);
                console.log(`    â Added to product marketers (${emptyProduct.assignedMarketers.length} marketers now assigned)`);
              }
            }
          }
          
          // Update employee's assignment
          emp.assignedProduct = empty.item.id;
          
          // Update local tracking (both managed and total counts)
          donor.assigned = donor.assigned.filter(e => e.id !== empId);
          donor.totalAssigned--;
          empty.assigned.push(emp);
          empty.totalAssigned++;
          
          criticalMoves++;
          
          logEvent(`ð¨ Manager filled empty project: ${empName} â ${empty.item.name}`);
        }
        
        if (criticalMoves > 0) {
          console.log(`  â Filled ${criticalMoves} empty project(s)`);
          // Continue to balanced distribution with updated state
        }
      }
      
      // STEP 2: Balanced distribution (only if no critical issues remain)
      const stillEmpty = distribution.filter(d => d.totalAssigned === 0);
      if (stillEmpty.length > 0) {
        console.log(`  â¸ï¸ Skipping balanced distribution - still have empty projects to fill on next tick`);
        return;
      }
      
      // Find items that are over/under staffed based on TOTAL employees
      const overStaffed = distribution.filter(d => d.totalAssigned > Math.ceil(targetPerItem) && d.assigned.length > 0);
      const underStaffed = distribution.filter(d => d.totalAssigned < Math.floor(targetPerItem));
      
      if (overStaffed.length === 0 || underStaffed.length === 0) {
        console.log(`  â Distribution is already balanced`);
        return;
      }
      
      console.log(`  Overstaffed items (${overStaffed.length}): ${overStaffed.map(d => `${d.item.name} (${d.totalAssigned} total, ${d.assigned.length} managed)`).join(', ')}`);
      console.log(`  Understaffed items (${underStaffed.length}): ${underStaffed.map(d => `${d.item.name} (${d.totalAssigned} total, ${d.assigned.length} managed)`).join(', ')}`);
      
      // Move employees from overstaffed to understaffed to reach balance
      let moveCount = 0;
      const maxMovesPerTick = Math.min(3, totalEmployees); // Max 3 moves per tick
      
      // Sort: move from most overstaffed to most understaffed (based on TOTAL employees)
      overStaffed.sort((a, b) => (b.totalAssigned - Math.ceil(targetPerItem)) - (a.totalAssigned - Math.ceil(targetPerItem)));
      underStaffed.sort((a, b) => (Math.floor(targetPerItem) - a.totalAssigned) - (Math.floor(targetPerItem) - b.totalAssigned));
      
      for (const over of overStaffed) {
        if (moveCount >= maxMovesPerTick) break;
        
        // Check if we have managed employees to move
        if (over.assigned.length === 0) {
          console.log(`  â ï¸ ${over.item.name} is overstaffed (${over.totalAssigned} total) but has no managed employees to move`);
          continue;
        }
        
        // How many TOTAL employees should we move from this item?
        const excessCount = over.totalAssigned - Math.ceil(targetPerItem);
        
        for (let i = 0; i < excessCount && moveCount < maxMovesPerTick; i++) {
          // Find an understaffed item to move to (based on TOTAL employees)
          const under = underStaffed.find(u => u.totalAssigned < Math.floor(targetPerItem));
          if (!under) break;
          
          // Pick the best MANAGED employee to move (highest efficiency)
          const employeesToMove = over.assigned.filter(e => employees.includes(e));
          if (employeesToMove.length === 0) break;
          
          employeesToMove.sort((a, b) => b.efficiency - a.efficiency);
          const emp = employeesToMove[0];
          
          // Calculate gain
          const currentDiff = Math.abs(over.efficiency - under.efficiency);
          const newOverEff = calculateProductEfficiency(over.item, role) - emp.efficiency;
          const newUnderEff = calculateProductEfficiency(under.item, role) + emp.efficiency;
          const newDiff = Math.abs(newOverEff - newUnderEff);
          const gain = (currentDiff - newDiff) / currentDiff;
          
          // Only move if it improves balance (reduces the efficiency gap)
          if (gain > 0
          ) {
            const empId = emp.id === 'founder' || emp.name === founder.name ? 'founder' : emp.id;
            const empName = emp.name || founder.name;
            
            console.log(`  ð Rebalancing ${empName} (ID: ${empId})`);
            console.log(`    From: ${over.item.name} (ID: ${over.item.id}) - ${over.totalAssigned} total (${over.assigned.length} managed)`);
            console.log(`    To: ${under.item.name} (ID: ${under.item.id}) - ${under.totalAssigned} total (${under.assigned.length} managed)`);
            console.log(`    Gain: ${(gain * 100).toFixed(1)}% (closer to balanced distribution)`);
            
            // Remove from old product/project
            const oldProject = rndProjects.find(r => r.id === over.item.id);
            const oldProduct = products.find(p => p.id === over.item.id);
            
            if (oldProject) {
              // Removing from R&D project
              oldProject.assignedDevelopers = oldProject.assignedDevelopers.filter(id => id !== empId);
              console.log(`    â Removed from R&D project (${oldProject.assignedDevelopers.length} devs remaining)`);
            } else if (oldProduct) {
              // Removing from product
              if (role === 'developer') {
                oldProduct.assignedDevelopers = oldProduct.assignedDevelopers.filter(id => id !== empId);
                console.log(`    â Removed from product devs (${oldProduct.assignedDevelopers.length} devs remaining)`);
              } else {
                oldProduct.assignedMarketers = oldProduct.assignedMarketers.filter(id => id !== empId);
                console.log(`    â Removed from product marketers (${oldProduct.assignedMarketers.length} marketers remaining)`);
              }
            }
            
            // Add to new product/project
            const newProject = rndProjects.find(r => r.id === under.item.id);
            const newProduct = products.find(p => p.id === under.item.id);
            
            if (newProject) {
              // Adding to R&D project
              if (!newProject.assignedDevelopers) {
                newProject.assignedDevelopers = [];
              }
              if (!newProject.assignedDevelopers.includes(empId)) {
                newProject.assignedDevelopers.push(empId);
                console.log(`    â Added to R&D project (${newProject.assignedDevelopers.length} devs now assigned)`);
              }
            } else if (newProduct) {
              // Adding to product
              if (role === 'developer') {
                if (!newProduct.assignedDevelopers.includes(empId)) {
                  newProduct.assignedDevelopers.push(empId);
                  console.log(`    â Added to product devs (${newProduct.assignedDevelopers.length} devs now assigned)`);
                }
              } else {
                if (!newProduct.assignedMarketers.includes(empId)) {
                  newProduct.assignedMarketers.push(empId);
                  console.log(`    â Added to product marketers (${newProduct.assignedMarketers.length} marketers now assigned)`);
                }
              }
            }
            
            // Update employee's assignment
            emp.assignedProduct = under.item.id;
            
            // Update local distribution tracking (both managed and total)
            over.assigned = over.assigned.filter(e => e.id !== empId);
            over.totalAssigned--;
            over.efficiency = calculateProductEfficiency(over.item, role);
            under.assigned.push(emp);
            under.totalAssigned++;
            under.efficiency = calculateProductEfficiency(under.item, role);
            
            moveCount++;
            
            console.log(`  âï¸  Moved ${empName} from ${over.item.name} to ${under.item.name} (balanced distribution)`);
            
            logEvent(
              `ð Moved ${empName} from ${over.item.name} to ${under.item.name} ` +
              `(balanced team distribution)`
            );
          }
        }
      }
      
      if (moveCount > 0) {
        console.log(`  â Completed ${moveCount} rebalancing moves`);
        console.log(`  Final distribution (total/managed):`);
        workItems.forEach(item => {
          const allEmployees = [founder, ...developers, ...marketers];
          
          // Count ALL employees
          const allAssigned = allEmployees.filter(e => {
            if (e.assignedProduct !== item.id) return false;
            if (role === 'developer') {
              return e.role === 'developer' || e.id === 'founder';
            } else if (role === 'marketer') {
              return e.role === 'marketer';
            }
            return false;
          });
          
          // Count only managed employees
          const managedAssigned = allAssigned.filter(e => e.isManaged);
          
          const eff = calculateProductEfficiency(item, role);
          console.log(`    - ${item.name}: ${allAssigned.length} total (${managedAssigned.length} managed) - efficiency: ${eff.toFixed(2)}`);
        });
      } else {
        console.log(`  â No moves needed - distribution is balanced`);
      }
    }
    
    function findRebalanceOpportunities(distribution) {
      const opportunities = [];
      
      // Get lowest and highest efficiency items
      const lowest = distribution[0];
      const highest = distribution[distribution.length - 1];
      
      console.log(`  Analyzing rebalance from ${highest.item.name} (${highest.assigned.length} managed) to ${lowest.item.name} (${lowest.assigned.length} managed)`);
      
      // Try moving employees from high to low
      for (const emp of highest.assigned) {
        // Calculate gain if we move this employee
        const currentHighEff = highest.efficiency;
        const currentLowEff = lowest.efficiency;
        
        // Calculate efficiency without this employee at high
        const highTeamSize = highest.assigned.length;
        const empEffAtHigh = getEffectiveEfficiency(emp.efficiency, highTeamSize);
        const newHighEff = currentHighEff - empEffAtHigh;
        
        // Calculate efficiency with this employee at low
        const lowTeamSize = lowest.assigned.length;
        const empEffAtLow = getEffectiveEfficiency(emp.efficiency, lowTeamSize + 1);
        const newLowEff = currentLowEff + empEffAtLow;
        
        // Calculate balance improvement
        const oldDiff = Math.abs(currentHighEff - currentLowEff);
        const newDiff = Math.abs(newHighEff - newLowEff);
        const improvement = (oldDiff - newDiff) / oldDiff;
        
        console.log(`    ${emp.name}: oldDiff=${oldDiff.toFixed(2)}, newDiff=${newDiff.toFixed(2)}, improvement=${(improvement*100).toFixed(1)}%`);
        
        if (improvement > 0) {
          opportunities.push({
            employee: emp,
            fromProduct: highest.item,
            toProduct: lowest.item,
            gain: improvement
          });
        }
      }
      
      // Sort by gain (descending)
      return opportunities.sort((a, b) => b.gain - a.gain);
    }

    function gameTick() {
      currentDay++;
      updateDayDisplay();
      updateCashDisplay();
      
      // Auto-collapse employee cards that have been expanded for 60+ days
      autoCollapseOldEmployeeCards();

      // R&D Development
      updateRndDevelopment();

      // Phase 2: Product development
      updateProductDevelopment();
      
      // Check product lifecycles daily
      checkProductLifecycles();
      
      // Phase 3: Customer acquisition (daily)
      updateCustomerAcquisition();
      
      // Update employee experience and check for promotions
      updateEmployeeExperience();
      
      // Manager optimization (every 5 days)
      if (currentDay % 5 === 0 && managers.length > 0) {
        console.log('');
        console.log('ð¯ DAY ' + currentDay + ' - TRIGGERING MANAGER OPTIMIZATION');
        console.log('='.repeat(60));
        runManagerOptimization();
      }
      
      // Check if candidate pool needs refresh (every 30 days)
      refreshCandidatePoolIfNeeded();
      
      // Phase 3: Monthly billing (every 30 days)
      if (currentDay % 30 === 0) {
        handleMonthlyBilling();
      }
      
      // Update UI
      updateFounderDisplay();
      updateProductsUI();
      updateRndUI();
      updateEmployeesUI();
      updateFinancesUI();
      
      // Update hiring modals if they're open
      refreshOpenHiringModals();
      
      // Auto-save every 5 days
      if (currentDay % 5 === 0 && currentDay > 0) {
        saveGame();
      }
      
      // Check game over
      if (cash < 0) {
        pauseGame();
        logEvent("ð GAME OVER! Company bankrupt!");
        showGameOver();
      }

      // Schedule next tick
      if (isPlaying) {
        tickTimer = setTimeout(gameTick, 1000 / gameSpeed);
      }
    }

    // ============================================
    // EMPLOYEE MANAGEMENT (Phase 3)
    // ============================================
    
    function generateEmployeeName() {
      return generateNameFromRegion(); // Returns {name, region, flag}
    }
    
    function getCurrentTeamSize() {
      return 1 + developers.length + marketers.length + managers.length; // 1 for founder
    }
    
    function getOfficeCapacity() {
      return OFFICE_TIERS[currentOfficeTier].capacity;
    }
    
    function canHireMoreEmployees() {
      return getCurrentTeamSize() < getOfficeCapacity();
    }
    
    // ============================================
    // HIRING MILESTONE & CANDIDATE POOL SYSTEM
    // ============================================
    
    function getCurrentMilestone() {
      // Find the highest milestone threshold reached based on lifetime earnings
      let currentMilestone = HIRING_MILESTONES[0];
      for (const milestone of HIRING_MILESTONES) {
        if (lifetimeEarnings >= milestone.threshold) {
          currentMilestone = milestone;
        } else {
          break;
        }
      }
      return currentMilestone;
    }
    
    function getNextMilestone() {
      const current = getCurrentMilestone();
      const currentIndex = HIRING_MILESTONES.findIndex(m => m.threshold === current.threshold);
      if (currentIndex < HIRING_MILESTONES.length - 1) {
        return HIRING_MILESTONES[currentIndex + 1];
      }
      return null; // Already at max milestone
    }
    
    function selectTierByProbability(probabilities) {
      // probabilities = [70, 25, 5, 0, 0] for example
      // Returns tier index (0-4 for Junior to Expert)
      const random = Math.random() * 100;
      let cumulative = 0;
      
      for (let i = 0; i < probabilities.length; i++) {
        cumulative += probabilities[i];
        if (random <= cumulative) {
          return i; // Returns 0-4 (tier index in DEVELOPER_TIERS/MARKETER_TIERS)
        }
      }
      
      return 0; // Default to Junior (index 0) if something goes wrong
    }
    
    function generateCandidate(type) {
      // type: "developer" or "marketer"
      
      // Get current milestone
      const milestone = getCurrentMilestone();
      
      // Get probability distribution for this milestone
      const probabilities = type === "developer" 
        ? DEVELOPER_TIER_PROBABILITIES[milestone.threshold]
        : MARKETER_TIER_PROBABILITIES[milestone.threshold];
      
      // Randomly select tier based on probabilities
      const tierIndex = selectTierByProbability(probabilities);
      const tier = type === "developer" ? DEVELOPER_TIERS[tierIndex] : MARKETER_TIERS[tierIndex];
      
      // Apply Â±20% fluctuation to efficiency
      const baseEfficiency = tier.efficiency;
      const efficiency = generateRandomEfficiency(baseEfficiency);
      
      // Apply Â±20% fluctuation to salary
      const baseSalary = currency === "USD" ? tier.monthlySalaryUSD : tier.monthlySalaryEUR;
      const salaryVariation = 0.8 + (Math.random() * 0.4); // 0.8 to 1.2 (Â±20%)
      const monthlySalary = Math.round(baseSalary * salaryVariation);
      
      // Generate candidate with name data
      const nameData = generateEmployeeName();
      return {
        id: nextEmployeeId++,
        name: nameData.name,
        flag: nameData.flag,
        region: nameData.region,
        role: type,
        tier: tierIndex,
        tierName: tier.name,
        skill: tier.skill,
        efficiency: efficiency,
        monthlySalary: monthlySalary,
        assignedProduct: null,
        // Manager system fields
        managerId: null,
        isManaged: false
      };
    }
    
    function generateCandidatePool() {
      // Generate 4 developers
      candidatePool.developers = [];
      for (let i = 0; i < 4; i++) {
        candidatePool.developers.push(generateCandidate("developer"));
      }
      
      // Generate 4 marketers
      candidatePool.marketers = [];
      for (let i = 0; i < 4; i++) {
        candidatePool.marketers.push(generateCandidate("marketer"));
      }
      
      // Generate 2 managers (only if unlocked)
      candidatePool.managers = [];
      if (lifetimeEarnings >= 2000000) {
        for (let i = 0; i < 2; i++) {
          candidatePool.managers.push(generateManagerCandidate());
        }
      }
      
      candidatePool.lastRefreshDay = currentDay;
      
      const milestone = getCurrentMilestone();
      //logEvent(`ð Hiring pool refreshed! ${milestone.badge} ${milestone.description}`);
    }
    
    function refreshCandidatePoolIfNeeded() {
      // Refresh every 30 days (monthly)
      if (currentDay % 30 === 0 && currentDay > 0) {
        generateCandidatePool();
        
        // If hiring modals are open, refresh them with new candidates
        refreshOpenHiringModals();
      }
    }
    
    function refreshOpenHiringModals() {
      // Check if developer hiring modal is open and refresh it
      const devModal = document.getElementById('hireDeveloperModal');
      if (devModal && devModal.classList.contains('active')) {
        updateHireDeveloperModalContent();
      }
      
      // Check if marketer hiring modal is open and refresh it
      const mktModal = document.getElementById('hireMarketerModal');
      if (mktModal && mktModal.classList.contains('active')) {
        updateHireMarketerModalContent();
      }
      
      // Check if manager hiring modal is open and refresh it
      const mgrModal = document.getElementById('hireManagerModal');
      if (mgrModal && mgrModal.classList.contains('active')) {
        updateHireManagerModalContent();
      }
    }
    
    function checkMilestoneAchievement(previousEarnings, newEarnings) {
      const previousMilestone = HIRING_MILESTONES.find(m => previousEarnings >= m.threshold && (HIRING_MILESTONES[HIRING_MILESTONES.indexOf(m) + 1]?.threshold > previousEarnings || HIRING_MILESTONES.indexOf(m) === HIRING_MILESTONES.length - 1));
      const newMilestone = getCurrentMilestone();
      
      if (previousMilestone && newMilestone.threshold > previousMilestone.threshold) {
        logEvent(`ð Milestone achieved: ${newMilestone.name}!`);
        logEvent(`â¨ Your company's reputation has improved - better talent will apply!`);
        
        // Show visual notification
        showMilestoneNotification(newMilestone);
        
        // Immediately refresh candidate pool with new probabilities
        generateCandidatePool();
      }
    }
    
    // Show milestone achievement notification
    function showMilestoneNotification(milestone) {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = 'milestone-notification';
      notification.innerHTML = `
        <h3>ð Milestone Achieved!</h3>
        <p><strong>${milestone.name}</strong></p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">Your company's reputation has improved!<br>Better talent will now apply for positions.</p>
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 4 seconds
      setTimeout(() => {
        notification.style.animation = 'milestoneAppear 0.3s ease-out reverse';
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 4000);
    }
    
    // ============================================
    // FINANCES CALCULATIONS
    // ============================================
    
    function calculateMonthlyIncome() {
      let totalRevenue = 0;
      
      products.forEach(product => {
        if (product.status === 'published' || product.status === 'deprecated') {
          totalRevenue += product.subscribers * product.monthlyPrice;
        }
      });
      
      return {
        grossRevenue: totalRevenue,
        netIncome: totalRevenue
      };
    }
    
    function calculateMonthlyCosts() {
      const office = OFFICE_TIERS[currentOfficeTier];
      const teamSize = getCurrentTeamSize();
      
      const rent = currency === "USD" ? office.monthlyRentUSD : office.monthlyRentEUR;
      const utilitiesBase = currency === "USD" ? office.utilitiesBaseUSD : office.utilitiesBaseEUR;
      const utilitiesPerPerson = currency === "USD" ? office.utilitiesPerPersonUSD : office.utilitiesPerPersonEUR;
      const utilities = utilitiesBase + (utilitiesPerPerson * teamSize);
      
      // Insurance: 2% of gross revenue + base per employee (including managers)
      const income = calculateMonthlyIncome();
      const insuranceBase = currency === "USD" ? 100 : 90;
      const insurance = (income.grossRevenue * 0.02) + (insuranceBase * (developers.length + marketers.length + managers.length));
      
      // Salaries (including managers)
      const salaries = [...developers, ...marketers, ...managers].reduce((sum, emp) => sum + emp.monthlySalary, 0);
      
      // Server hosting fee (fixed monthly cost for tier)
      const server = SERVER_TIERS[currentServerTier];
      const serverFee = currency === "USD" ? server.monthlyFeeUSD : server.monthlyFeeEUR;
      
      return {
        rent: rent,
        utilities: utilities,
        insurance: insurance,
        salaries: salaries,
        serverFee: serverFee,
        total: rent + utilities + insurance + salaries + serverFee
      };
    }
    
    function calculateNetCashFlow() {
      const income = calculateMonthlyIncome();
      const costs = calculateMonthlyCosts();
      return income.netIncome - costs.total;
    }
    
    function calculateBurnRate() {
      const cashFlow = calculateNetCashFlow();
      if (cashFlow >= 0) return Infinity; // Profitable, no burn
      
      const monthlyBurn = Math.abs(cashFlow);
      if (monthlyBurn === 0) return Infinity;
      
      return Math.floor(cash / monthlyBurn);
    }
    
    function getTotalSubscribers() {
      return products.reduce((sum, p) => {
        if (p.status === 'published' || p.status === 'deprecated') {
          return sum + p.subscribers;
        }
        return sum;
      }, 0);
    }
    
    function getServerCapacityPercentage() {
      const server = SERVER_TIERS[currentServerTier];
      const totalSubs = getTotalSubscribers();
      return Math.min(100, Math.round((totalSubs / server.maxSubscribers) * 100));
    }
    
    function canUpgradeServer() {
      if (currentServerTier >= SERVER_TIERS.length - 1) return false;
      const nextTier = SERVER_TIERS[currentServerTier + 1];
      const cost = currency === "USD" ? nextTier.upgradeCostUSD : nextTier.upgradeCostEUR;
      return cash >= cost;
    }
    
    function upgradeServer() {
      if (!canUpgradeServer()) return;
      
      const nextTier = SERVER_TIERS[currentServerTier + 1];
      const cost = currency === "USD" ? nextTier.upgradeCostUSD : nextTier.upgradeCostEUR;
      
      cash -= cost;
      currentServerTier++;
      
      logEvent(`ð¥ï¸ Server upgraded to ${nextTier.name}!`);
      logEvent(`  ð Capacity: ${SERVER_TIERS[currentServerTier - 1].maxSubscribers} â ${nextTier.maxSubscribers} subscribers`);
      logEvent(`  ð° Monthly Fee: ${formatCurrency(currency === "USD" ? SERVER_TIERS[currentServerTier - 1].monthlyFeeUSD : SERVER_TIERS[currentServerTier - 1].monthlyFeeEUR)} â ${formatCurrency(currency === "USD" ? nextTier.monthlyFeeUSD : nextTier.monthlyFeeEUR)}/month`);
      logEvent(`  ð¨ Upgrade Cost Paid: ${formatCurrency(cost)}`);
      
      updateCashDisplay();
      updateFinancesUI();
    }
    
    function canDowngradeServer() {
      if (currentServerTier <= 0) return false;
      const prevTier = SERVER_TIERS[currentServerTier - 1];
      const totalSubs = getTotalSubscribers();
      return totalSubs <= prevTier.maxSubscribers;
    }
    
    function downgradeServer() {
      pauseGame(); // Auto-pause when opening modal
      if (!canDowngradeServer()) {
        const prevTier = SERVER_TIERS[currentServerTier - 1];
        const totalSubs = getTotalSubscribers();
        alert(`â Cannot downgrade!\n\nYou have ${totalSubs.toLocaleString()} subscribers but ${prevTier.name} only supports ${prevTier.maxSubscribers.toLocaleString()}.\n\nReduce subscriber count first (wait for churn or deprecate products).`);
        startGame(); // Auto-resume after alert
        return;
      }
      
      const currentTier = SERVER_TIERS[currentServerTier];
      const prevTier = SERVER_TIERS[currentServerTier - 1];
      const oldFee = currency === "USD" ? currentTier.monthlyFeeUSD : currentTier.monthlyFeeEUR;
      const newFee = currency === "USD" ? prevTier.monthlyFeeUSD : prevTier.monthlyFeeEUR;
      const savings = oldFee - newFee;
      
      // Show modal instead of confirm
      document.getElementById('downgradeServerName').textContent = `${currentTier.name} â ${prevTier.name}`;
      document.getElementById('downgradeServerCapacity').textContent = `${currentTier.maxSubscribers.toLocaleString()} â ${prevTier.maxSubscribers.toLocaleString()} subscribers`;
      document.getElementById('downgradeServerFee').textContent = `${formatCurrency(oldFee)} â ${formatCurrency(newFee)}/month`;
      document.getElementById('downgradeServerSavings').textContent = `${formatCurrency(savings)}/mo`;
      document.getElementById('downgradeServerModal').classList.add('active');
    }
    
    function hideDowngradeServerModal() {
      document.getElementById('downgradeServerModal').classList.remove('active');
      startGame(); // Auto-resume when closing modal
    }
    
    function confirmDowngradeServer() {
      const currentTier = SERVER_TIERS[currentServerTier];
      const prevTier = SERVER_TIERS[currentServerTier - 1];
      const oldFee = currency === "USD" ? currentTier.monthlyFeeUSD : currentTier.monthlyFeeEUR;
      const newFee = currency === "USD" ? prevTier.monthlyFeeUSD : prevTier.monthlyFeeEUR;
      const savings = oldFee - newFee;
      
      currentServerTier--;
      
      logEvent(`ð Server downgraded to ${prevTier.name}`);
      logEvent(`  ð Capacity: ${currentTier.maxSubscribers.toLocaleString()} â ${prevTier.maxSubscribers.toLocaleString()} subscribers`);
      logEvent(`  ð° Monthly Fee Reduced: ${formatCurrency(oldFee)} â ${formatCurrency(newFee)}/month (saves ${formatCurrency(savings)}/mo)`);
      
      hideDowngradeServerModal();
      updateFinancesUI();
    }
    
    // ============================================
    // CANDIDATE POOL SYSTEM
    // ============================================
    
    function generateRandomEfficiency(baseEfficiency) {
      // Â±20% deviation (40% total range)
      const minEfficiency = baseEfficiency * 0.8;
      const maxEfficiency = baseEfficiency * 1.2;
      const randomEfficiency = minEfficiency + Math.random() * (maxEfficiency - minEfficiency);
      return Math.round(randomEfficiency * 100) / 100; // Round to 2 decimals
    }
    
    function generateCandidateForTier(tierIndex, role) {
      const tier = role === 'developer' ? DEVELOPER_TIERS[tierIndex] : MARKETER_TIERS[tierIndex];
      const efficiency = generateRandomEfficiency(tier.efficiency);
      
      // Calculate salary based on absolute efficiency value
      // Use the 1.0x efficiency tier as the base reference ($5,000 for devs, $4,000 for marketers)
      const tiers = role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
      const baseReferenceSalary = currency === "USD" ? tiers[1].monthlySalaryUSD : tiers[1].monthlySalaryEUR; // Intermediate tier (1.0x)
      
      // Salary = Base Reference Salary Ã Actual Efficiency Ã Â±10% random variation
      const baseSalary = baseReferenceSalary * efficiency;
      
      // Add Â±10% random variation to salary (total 20% range)
      const salaryVariation = 0.90 + (Math.random() * 0.20); // 0.90 to 1.10
      const finalSalary = Math.round(baseSalary * salaryVariation);
      
      return {
        id: Math.random().toString(36).substr(2, 9), // Unique ID for this candidate
        name: generateEmployeeName(),
        role: role,
        tier: tierIndex,
        tierName: tier.name,
        skill: tier.skill,
        efficiency: efficiency,
        monthlySalary: finalSalary
      };
    }
    
    function refreshCandidatePools() {
      // Generate 4 candidates for each developer tier
      developerCandidates = {};
      for (let i = 0; i < DEVELOPER_TIERS.length; i++) {
        developerCandidates[i] = [];
        for (let j = 0; j < 4; j++) {
          developerCandidates[i].push(generateCandidateForTier(i, 'developer'));
        }
      }
      
      // Generate 4 candidates for each marketer tier
      marketerCandidates = {};
      for (let i = 0; i < MARKETER_TIERS.length; i++) {
        marketerCandidates[i] = [];
        for (let j = 0; j < 4; j++) {
          marketerCandidates[i].push(generateCandidateForTier(i, 'marketer'));
        }
      }
      
      lastCandidateRefresh = getCurrentMonth();
      //logEvent("ð Candidate pools refreshed for this month");
    }
    
    function getCurrentMonth() {
      return Math.floor(currentDay / 30);
    }
    
    function checkAndRefreshCandidates() {
      const currentMonth = getCurrentMonth();
      if (currentMonth > lastCandidateRefresh) {
        refreshCandidatePools();
      }
    }
    
    function removeCandidateFromPool(candidateId, role, tierIndex) {
      if (role === 'developer') {
        developerCandidates[tierIndex] = developerCandidates[tierIndex].filter(c => c.id !== candidateId);
      } else {
        marketerCandidates[tierIndex] = marketerCandidates[tierIndex].filter(c => c.id !== candidateId);
      }
    }
    
    // ============================================
    // HIRING EMPLOYEES
    // ============================================
    
    function hireDeveloper(tierIndex) {
      if (!canHireMoreEmployees()) {
        logEvent("â Office at capacity! Upgrade your office to hire more people.");
        return;
      }
      
      const tier = DEVELOPER_TIERS[tierIndex];
      const salary = currency === "USD" ? tier.monthlySalaryUSD : tier.monthlySalaryEUR;
      
      if (cash < salary) {
        logEvent(`â Not enough cash to hire ${tier.name}. Need ${formatCurrency(salary)}`);
        return;
      }
      
      const employee = {
        id: nextEmployeeId++,
        name: generateEmployeeName(),
        role: "developer",
        tier: tierIndex,
        tierName: tier.name,
        skill: tier.skill,
        efficiency: tier.efficiency,
        monthlySalary: salary,
        assignedProduct: null,
        // Manager system fields
        managerId: null,
        isManaged: false
      };
      
      developers.push(employee);
      cash -= salary; // Pay first month upfront
      
      logEvent(`â Hired ${employee.name} as ${tier.name} for ${formatCurrency(salary)}/mo`);
      updateCashDisplay();
      updateEmployeesUI();
    }
    
    function hireMarketer(tierIndex) {
      if (!canHireMoreEmployees()) {
        logEvent("â Office at capacity! Upgrade your office to hire more people.");
        return;
      }
      
      const tier = MARKETER_TIERS[tierIndex];
      const salary = currency === "USD" ? tier.monthlySalaryUSD : tier.monthlySalaryEUR;
      
      if (cash < salary) {
        logEvent(`â Not enough cash to hire ${tier.name}. Need ${formatCurrency(salary)}`);
        return;
      }
      
      const employee = {
        id: nextEmployeeId++,
        name: generateEmployeeName(),
        role: "marketer",
        tier: tierIndex,
        tierName: tier.name,
        skill: tier.skill,
        efficiency: tier.efficiency,
        monthlySalary: salary,
        assignedProduct: null,
        // Manager system fields
        managerId: null,
        isManaged: false
      };
      
      marketers.push(employee);
      cash -= salary; // Pay first month upfront
      
      logEvent(`â Hired ${employee.name} as ${tier.name} for ${formatCurrency(salary)}/mo`);
      updateCashDisplay();
      updateEmployeesUI();
    }
    
    function showUpgradeOfficeModal() {
      pauseGame(); // Auto-pause when opening modal
      
      if (currentOfficeTier >= OFFICE_TIERS.length - 1) {
        logEvent("â Already at maximum office tier!");
        startGame();
        return;
      }
      
      const currentTier = OFFICE_TIERS[currentOfficeTier];
      const nextTier = OFFICE_TIERS[currentOfficeTier + 1];
      const setupCost = currency === "USD" ? nextTier.monthlyRentUSD * 2 : nextTier.monthlyRentEUR * 2;
      const currentRent = currency === "USD" ? currentTier.monthlyRentUSD : currentTier.monthlyRentEUR;
      const nextRent = currency === "USD" ? nextTier.monthlyRentUSD : nextTier.monthlyRentEUR;
      const rentIncrease = nextRent - currentRent;
      
      // Show modal with details
      document.getElementById('upgradeOfficeName').textContent = `${currentTier.name} â ${nextTier.name}`;
      document.getElementById('upgradeOfficeCapacity').textContent = `${currentTier.capacity} â ${nextTier.capacity} people`;
      document.getElementById('upgradeOfficeRent').textContent = `${formatCurrency(currentRent)} â ${formatCurrency(nextRent)}`;
      document.getElementById('upgradeOfficeSetupCost').textContent = formatCurrency(setupCost);
      document.getElementById('upgradeOfficeCostIncrease').textContent = `+${formatCurrency(rentIncrease)}`;
      
      // Check if can afford
      const upgradeBtn = document.querySelector('#upgradeOfficeModal .modal-footer button:last-child');
      if (cash < setupCost) {
        upgradeBtn.disabled = true;
        upgradeBtn.style.opacity = '0.5';
        upgradeBtn.style.cursor = 'not-allowed';
      } else {
        upgradeBtn.disabled = false;
        upgradeBtn.style.opacity = '1';
        upgradeBtn.style.cursor = 'pointer';
      }
      
      document.getElementById('upgradeOfficeModal').classList.add('active');
    }
    
    function hideUpgradeOfficeModal() {
      document.getElementById('upgradeOfficeModal').classList.remove('active');
      startGame(); // Auto-resume when closing modal
    }
    
    function confirmUpgradeOffice() {
      const currentTier = OFFICE_TIERS[currentOfficeTier];
      const nextTier = OFFICE_TIERS[currentOfficeTier + 1];
      const setupCost = currency === "USD" ? nextTier.monthlyRentUSD * 2 : nextTier.monthlyRentEUR * 2;
      const currentRent = currency === "USD" ? currentTier.monthlyRentUSD : currentTier.monthlyRentEUR;
      const nextRent = currency === "USD" ? nextTier.monthlyRentUSD : nextTier.monthlyRentEUR;
      
      if (cash < setupCost) {
        logEvent(`â Not enough cash to upgrade office. Need ${formatCurrency(setupCost)}`);
        hideUpgradeOfficeModal();
        return;
      }
      
      cash -= setupCost;
      currentOfficeTier++;
      
      logEvent(`ð¢ Upgraded to ${nextTier.name}!`);
      logEvent(`  ð¥ Capacity: ${currentTier.capacity} â ${nextTier.capacity} people`);
      logEvent(`  ð° Monthly Rent: ${formatCurrency(currentRent)} â ${formatCurrency(nextRent)}/mo`);
      logEvent(`  ð¨ Setup Cost Paid: ${formatCurrency(setupCost)}`);
      
      hideUpgradeOfficeModal();
      updateCashDisplay();
      updateEmployeesUI();
    }
    
    function canDowngradeOffice() {
      if (currentOfficeTier <= 0) return false;
      const prevTier = OFFICE_TIERS[currentOfficeTier - 1];
      const teamSize = getCurrentTeamSize();
      return teamSize <= prevTier.capacity;
    }
    
    function showDowngradeOfficeModal() {
      pauseGame(); // Auto-pause when opening modal
      if (!canDowngradeOffice()) {
        const prevTier = OFFICE_TIERS[currentOfficeTier - 1];
        const teamSize = getCurrentTeamSize();
        alert(`â Cannot downgrade!\n\nYou have ${teamSize} people but ${prevTier.name} only fits ${prevTier.capacity}.\n\nFire employees first to reduce team size.`);
        startGame(); // Auto-resume after alert
        return;
      }
      
      const currentTier = OFFICE_TIERS[currentOfficeTier];
      const prevTier = OFFICE_TIERS[currentOfficeTier - 1];
      const oldRent = currency === "USD" ? currentTier.monthlyRentUSD : currentTier.monthlyRentEUR;
      const newRent = currency === "USD" ? prevTier.monthlyRentUSD : prevTier.monthlyRentEUR;
      const savings = oldRent - newRent;
      
      // Show modal with details
      document.getElementById('downgradeOfficeName').textContent = `${currentTier.name} â ${prevTier.name}`;
      document.getElementById('downgradeOfficeCapacity').textContent = `${currentTier.capacity} â ${prevTier.capacity} people`;
      document.getElementById('downgradeOfficeRent').textContent = `${formatCurrency(oldRent)} â ${formatCurrency(newRent)}/month`;
      document.getElementById('downgradeOfficeSavings').textContent = `${formatCurrency(savings)}/mo`;
      document.getElementById('downgradeOfficeModal').classList.add('active');
    }
    
    function hideDowngradeOfficeModal() {
      document.getElementById('downgradeOfficeModal').classList.remove('active');
      startGame(); // Auto-resume when closing modal
    }
    
    function confirmDowngradeOffice() {
      const currentTier = OFFICE_TIERS[currentOfficeTier];
      const prevTier = OFFICE_TIERS[currentOfficeTier - 1];
      const oldRent = currency === "USD" ? currentTier.monthlyRentUSD : currentTier.monthlyRentEUR;
      const newRent = currency === "USD" ? prevTier.monthlyRentUSD : prevTier.monthlyRentEUR;
      const savings = oldRent - newRent;
      
      currentOfficeTier--;
      
      logEvent(`ð Office downgraded to ${prevTier.name}`);
      logEvent(`  ð¥ Capacity: ${currentTier.capacity} â ${prevTier.capacity} people`);
      logEvent(`  ð° Monthly Rent Reduced: ${formatCurrency(oldRent)} â ${formatCurrency(newRent)}/month (saves ${formatCurrency(savings)}/mo)`);
      
      hideDowngradeOfficeModal();
      updateEmployeesUI();
    }
    
    let employeeToFire = null;
    
    function fireEmployee(employeeId) {
      pauseGame(); // Auto-pause when opening modal
      const employee = [...developers, ...marketers].find(e => e.id === employeeId);
      if (!employee) return;
      
      const severancePay = employee.monthlySalary;
      
      if (cash < severancePay) {
        alert(`â Cannot afford severance pay!\n\nFiring ${employee.name} requires ${formatCurrency(severancePay)} in severance.\n\nCurrent cash: ${formatCurrency(cash)}`);
        startGame(); // Auto-resume after alert
        return;
      }
      
      // Store employee ID for confirmation
      employeeToFire = employeeId;
      
      // Show modal instead of confirm
      document.getElementById('fireEmployeeName').textContent = `Fire ${employee.name}?`;
      document.getElementById('fireEmployeeRole').textContent = employee.tierName;
      document.getElementById('fireEmployeeSalary').textContent = `${formatCurrency(employee.monthlySalary)}/month`;
      document.getElementById('fireEmployeeSeverance').textContent = formatCurrency(severancePay);
      document.getElementById('fireEmployeeSavings').textContent = `${formatCurrency(employee.monthlySalary)}/mo`;
      document.getElementById('fireEmployeeCost').textContent = formatCurrency(severancePay);
      document.getElementById('fireEmployeeModal').classList.add('active');
    }
    
    function hideFireEmployeeModal() {
      document.getElementById('fireEmployeeModal').classList.remove('active');
      employeeToFire = null;
      startGame(); // Auto-resume when closing modal
    }
    
    function confirmFireEmployee() {
      if (employeeToFire === null) return;
      
      const employee = [...developers, ...marketers].find(e => e.id === employeeToFire);
      if (!employee) {
        hideFireEmployeeModal();
        return;
      }
      
      const severancePay = employee.monthlySalary;
      
      // Pay severance
      cash -= severancePay;
      
      // Unassign from all products
      products.forEach(product => {
        if (employee.role === 'developer') {
          product.assignedDevelopers = product.assignedDevelopers.filter(id => id !== employeeToFire);
        } else {
          product.assignedMarketers = product.assignedMarketers.filter(id => id !== employeeToFire);
        }
      });
      
      // Unassign from all R&D projects
      rndProjects.forEach(project => {
        if (employee.role === 'developer') {
          project.assignedDevelopers = project.assignedDevelopers.filter(id => id !== employeeToFire);
        }
      });
      
      // Remove from manager's managed employees list
      if (employee.isManaged && employee.managerId) {
        removeEmployeeFromAllManagers(employeeToFire);
      }
      
      // Remove from team
      if (employee.role === 'developer') {
        developers = developers.filter(d => d.id !== employeeToFire);
      } else {
        marketers = marketers.filter(m => m.id !== employeeToFire);
      }
      
      logEvent(`ð¥ Fired ${employee.name} (${employee.tierName})`);
      logEvent(`  ð¸ Severance Paid: ${formatCurrency(severancePay)}`);
      logEvent(`  ð° Monthly Savings: ${formatCurrency(employee.monthlySalary)}/month`);
      
      hideFireEmployeeModal();
      updateCashDisplay();
      updateEmployeesUI();
      updateProductsUI();
    }
    
    // Promotion modal variables
    let employeeToPromote = null;
    let promotionRole = null;
    let promotionExpectation = 0;
    let promotionMinSalary = 0;
    let promotionMaxSalary = 0;
    
    function showPromotionModal(employeeId, role) {
      pauseGame(); // Auto-pause when opening modal
      
      const employee = role === 'developer' 
        ? developers.find(d => d.id === employeeId)
        : marketers.find(m => m.id === employeeId);
        
      if (!employee || !employee.readyForPromotion) return;
      
      employeeToPromote = employeeId;
      promotionRole = role;
      promotionExpectation = employee.salaryExpectationForNextRank;
      
      // Set salary range: 50% below expectation to 20% above expectation
      promotionMinSalary = Math.round(promotionExpectation * 0.5);
      promotionMaxSalary = Math.round(promotionExpectation * 1.2);
      
      const tiers = role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
      const currentTierName = employee.tierName;
      const nextTierName = tiers[employee.tier + 1].name;
      
      // Update modal content
      document.getElementById('promotionEmployeeName').textContent = employee.name;
      document.getElementById('promotionEmployeeRole').textContent = `${currentTierName} â ${nextTierName}`;
      document.getElementById('promotionExpectation').textContent = `${formatCurrency(promotionExpectation)}/mo`;
      document.getElementById('promotionMinSalary').textContent = formatCurrency(promotionMinSalary);
      document.getElementById('promotionMaxSalary').textContent = formatCurrency(promotionMaxSalary);
      
      // Set up slider
      const slider = document.getElementById('promotionSalarySlider');
      slider.min = promotionMinSalary;
      slider.max = promotionMaxSalary;
      slider.value = promotionExpectation; // Start at expectation
      
      // Update display
      updatePromotionOffer();
      
      // Add slider event listener
      slider.oninput = updatePromotionOffer;
      
      // Handle rejection display
      const rejectionCount = employee.promotionRejectionCount || 0;
      if (rejectionCount > 0) {
        updatePromotionRejectionDisplay(rejectionCount);
      } else {
        // Hide rejection info for fresh promotion attempt
        document.getElementById('promotionRejectionInfo').style.display = 'none';
      }
      
      // Show modal
      document.getElementById('promotionModal').classList.add('active');
    }
    
    function updatePromotionOffer() {
      const slider = document.getElementById('promotionSalarySlider');
      const offer = parseInt(slider.value);
      
      // Update offer display
      document.getElementById('promotionOfferDisplay').textContent = `${formatCurrency(offer)}/mo`;
      
      // Calculate and display acceptance probability
      const probability = calculatePromotionAcceptanceProbability(offer, promotionExpectation);
      const percentDisplay = Math.round(probability * 100);
      document.getElementById('promotionProbability').textContent = `${percentDisplay}%`;
      
      // Update acceptance chance box color based on probability
      const chanceBox = document.getElementById('promotionAcceptanceChance');
      if (probability >= 0.9) {
        chanceBox.style.background = '#d1fae5';
        chanceBox.style.borderColor = '#10b981';
      } else if (probability >= 0.7) {
        chanceBox.style.background = '#fef3c7';
        chanceBox.style.borderColor = '#fbbf24';
      } else if (probability >= 0.4) {
        chanceBox.style.background = '#fed7aa';
        chanceBox.style.borderColor = '#f97316';
      } else {
        chanceBox.style.background = '#fecaca';
        chanceBox.style.borderColor = '#ef4444';
      }
    }
    
    function hidePromotionModal() {
      document.getElementById('promotionModal').classList.remove('active');
      employeeToPromote = null;
      promotionRole = null;
      // Keep game paused after closing modal
      startGame();
    }
    
    function makePromotionOffer() {
      if (employeeToPromote === null) return;
      
      const slider = document.getElementById('promotionSalarySlider');
      const offer = parseInt(slider.value);
      
      const employee = promotionRole === 'developer' 
        ? developers.find(d => d.id === employeeToPromote)
        : marketers.find(m => m.id === employeeToPromote);
        
      if (!employee) {
        hidePromotionModal();
        return;
      }
      
      // Calculate acceptance probability
      const probability = calculatePromotionAcceptanceProbability(offer, promotionExpectation);
      const accepted = Math.random() < probability;
      
      if (accepted) {
        // Employee accepts!
        promoteEmployee(employee, offer, promotionRole);
        logEvent(`â ${employee.name} accepted the promotion offer of ${formatCurrency(offer)}/month!`);
        // Notification is shown by promoteEmployee() function
        hidePromotionModal();
        updateEmployeesUI();
      } else {
        // Employee rejects - increment rejection count
        employee.promotionRejectionCount = (employee.promotionRejectionCount || 0) + 1;
        
        const percentDiff = Math.round(((offer - promotionExpectation) / promotionExpectation) * 100);
        logEvent(`â ${employee.name} rejected the offer of ${formatCurrency(offer)}/month (${percentDiff}% ${percentDiff >= 0 ? 'above' : 'below'} expectation) - Rejection ${employee.promotionRejectionCount}/3`);
        showNotification(`â ${employee.name} rejected the offer (${employee.promotionRejectionCount}/3)`, 'error');
        
        // Check if this is the 3rd rejection
        if (employee.promotionRejectionCount >= 3) {
          // Employee quits!
          logEvent(`ð ${employee.name} has quit after 3 rejected promotion offers!`);
          showNotification(`ð ${employee.name} quit!`, 'error');
          
          // Unassign from manager (if assigned)
          if (employee.isManaged && employee.managerId) {
            removeEmployeeFromAllManagers(employee.id);
          }
          
          // Unassign from all products
          products.forEach(product => {
            if (employee.role === 'developer') {
              product.assignedDevelopers = product.assignedDevelopers.filter(id => id !== employee.id);
            } else {
              product.assignedMarketers = product.assignedMarketers.filter(id => id !== employee.id);
            }
          });
          
          // Unassign from R&D projects
          if (employee.role === 'developer') {
            rndProjects.forEach(project => {
              project.assignedDevelopers = project.assignedDevelopers.filter(id => id !== employee.id);
            });
          }
          
          // Remove from team (no severance pay - they quit)
          if (employee.role === 'developer') {
            developers = developers.filter(d => d.id !== employee.id);
          } else {
            marketers = marketers.filter(m => m.id !== employee.id);
          }
          
          hidePromotionModal();
          updateEmployeesUI();
          updateProductsUI();
          updateRndUI();
        } else {
          // Show rejection count and keep modal open
          updatePromotionRejectionDisplay(employee.promotionRejectionCount);
        }
      }
    }
    
    function updatePromotionRejectionDisplay(rejectionCount) {
      const rejectionInfo = document.getElementById('promotionRejectionInfo');
      const rejectionText = document.getElementById('promotionRejectionText');
      
      rejectionInfo.style.display = 'block';
      
      // Compact format: "Rejected X/3"
      rejectionText.textContent = `Rejected ${rejectionCount}/3`;
      
      // Update warning color based on rejection count
      if (rejectionCount === 2) {
        rejectionInfo.style.background = '#fca5a5';
        rejectionInfo.style.borderColor = '#dc2626';
      }
    }
    
    // ============================================
    // MANAGER PROMOTION & FIRING
    // ============================================
    
    let managerToPromote = null;
    let managerToFire = null;
    let managerPromotionExpectation = 0;
    let managerPromotionMinSalary = 0;
    let managerPromotionMaxSalary = 0;
    
    // Helper function to calculate manager's current capacity dynamically
    // If manager is ready for promotion, they don't get the extra capacity until they accept
    function getManagerCapacity(manager) {
      if (manager.readyForPromotion) {
        // Manager is waiting for promotion - use capacity before the increase
        // Find the previous capacity tier by subtracting 1 from what efficiency would give
        const potentialCapacity = Math.floor(manager.efficiency / 25);
        return potentialCapacity - 1; // Don't grant new capacity until promotion accepted
      }
      return Math.floor(manager.efficiency / 25);
    }
    
    function showManagerPromotionModal(managerId) {
      pauseGame(); // Auto-pause when opening modal
      
      const manager = managers.find(m => m.id === managerId || m.id.toString() === managerId.toString());
      if (!manager || !manager.readyForPromotion) return;
      
      managerToPromote = managerId;
      managerPromotionExpectation = manager.proposedSalary;
      
      // Set salary range: 50% below expectation to 20% above expectation
      managerPromotionMinSalary = Math.round(managerPromotionExpectation * 0.5);
      managerPromotionMaxSalary = Math.round(managerPromotionExpectation * 1.2);
      
      const currentCapacity = Math.floor((manager.efficiency - 1) / 25); // Capacity before promotion
      const newCapacity = Math.floor(manager.efficiency / 25); // Capacity after promotion
      
      // Update modal content
      document.getElementById('managerPromotionName').textContent = manager.name;
      document.getElementById('managerPromotionCapacity').textContent = `Capacity: ${currentCapacity} â ${newCapacity}`;
      document.getElementById('managerPromotionExpectation').textContent = `${formatCurrency(managerPromotionExpectation)}/mo`;
      document.getElementById('managerPromotionMinSalary').textContent = formatCurrency(managerPromotionMinSalary);
      document.getElementById('managerPromotionMaxSalary').textContent = formatCurrency(managerPromotionMaxSalary);
      
      // Set up slider
      const slider = document.getElementById('managerPromotionSalarySlider');
      slider.min = managerPromotionMinSalary;
      slider.max = managerPromotionMaxSalary;
      slider.value = managerPromotionExpectation; // Start at expectation
      
      // Update display
      updateManagerPromotionOffer();
      
      // Add slider event listener
      slider.oninput = updateManagerPromotionOffer;
      
      // Handle rejection display
      const rejectionCount = manager.promotionAttempts || 0;
      if (rejectionCount > 0) {
        updateManagerPromotionRejectionDisplay(rejectionCount);
      } else {
        document.getElementById('managerPromotionRejectionInfo').style.display = 'none';
      }
      
      // Show modal
      document.getElementById('managerPromotionModal').classList.add('active');
    }
    
    function updateManagerPromotionOffer() {
      const slider = document.getElementById('managerPromotionSalarySlider');
      const offer = parseInt(slider.value);
      
      // Update offer display
      document.getElementById('managerPromotionOfferDisplay').textContent = `${formatCurrency(offer)}/mo`;
      
      // Calculate and display acceptance probability
      const probability = calculatePromotionAcceptanceProbability(offer, managerPromotionExpectation);
      const probabilityPercent = Math.round(probability * 100);
      document.getElementById('managerPromotionProbability').textContent = `${probabilityPercent}%`;
      
      // Color-code based on probability
      const acceptanceChanceDiv = document.getElementById('managerPromotionAcceptanceChance');
      if (probabilityPercent >= 90) {
        acceptanceChanceDiv.style.background = '#d1fae5';
        acceptanceChanceDiv.style.borderColor = '#10b981';
      } else if (probabilityPercent >= 70) {
        acceptanceChanceDiv.style.background = '#fef3c7';
        acceptanceChanceDiv.style.borderColor = '#fbbf24';
      } else if (probabilityPercent >= 40) {
        acceptanceChanceDiv.style.background = '#fed7aa';
        acceptanceChanceDiv.style.borderColor = '#f97316';
      } else {
        acceptanceChanceDiv.style.background = '#fee2e2';
        acceptanceChanceDiv.style.borderColor = '#ef4444';
      }
    }
    
    function updateManagerPromotionRejectionDisplay(rejectionCount) {
      const rejectionInfo = document.getElementById('managerPromotionRejectionInfo');
      const rejectionText = document.getElementById('managerPromotionRejectionText');
      
      rejectionInfo.style.display = 'block';
      rejectionText.textContent = `Rejected ${rejectionCount}/3`;
      
      if (rejectionCount === 2) {
        rejectionInfo.style.background = '#fca5a5';
        rejectionInfo.style.borderColor = '#dc2626';
      }
    }
    
    function makeManagerPromotionOffer() {
      if (managerToPromote === null) return;
      
      const slider = document.getElementById('managerPromotionSalarySlider');
      const offer = parseInt(slider.value);
      
      const manager = managers.find(m => m.id === managerToPromote || m.id.toString() === managerToPromote.toString());
      if (!manager) {
        hideManagerPromotionModal();
        return;
      }
      
      // Calculate acceptance probability
      const probability = calculatePromotionAcceptanceProbability(offer, managerPromotionExpectation);
      const accepted = Math.random() < probability;
      
      if (accepted) {
        // Manager accepts!
        const oldSalary = manager.monthlySalary;
        manager.monthlySalary = offer;
        manager.readyForPromotion = false;
        manager.promotionAttempts = 0;
        manager.proposedSalary = null;
        
        const newCapacity = Math.floor(manager.efficiency / 25);
        
        logEvent(`â ${manager.name} (Manager) accepted promotion! Salary: ${formatCurrency(oldSalary)} â ${formatCurrency(offer)}/mo, Capacity: ${newCapacity}`);
        showNotification(`ð ${manager.name} promoted! Capacity: ${newCapacity}`, 'success');
        
        hideManagerPromotionModal();
        updateEmployeesUI();
      } else {
        // Manager rejects - increment rejection count
        manager.promotionAttempts = (manager.promotionAttempts || 0) + 1;
        
        const percentDiff = Math.round(((offer - managerPromotionExpectation) / managerPromotionExpectation) * 100);
        logEvent(`â ${manager.name} (Manager) rejected the offer of ${formatCurrency(offer)}/month (${percentDiff}% ${percentDiff >= 0 ? 'above' : 'below'} expectation) - Rejection ${manager.promotionAttempts}/3`);
        showNotification(`â ${manager.name} rejected the offer (${manager.promotionAttempts}/3)`, 'error');
        
        // Check if this is the 3rd rejection
        if (manager.promotionAttempts >= 3) {
          // Manager quits!
          logEvent(`ð ${manager.name} (Manager) has quit after 3 rejected promotions!`);
          showNotification(`ð ${manager.name} quit!`, 'error');
          
          // Unmanage all employees
          manager.managedEmployees.forEach(empId => {
            if (empId === 'founder') {
              founder.isManaged = false;
              founder.managerId = null;
            } else {
              const emp = [...developers, ...marketers].find(e => e.id === empId || e.id.toString() === empId.toString());
              if (emp) {
                emp.isManaged = false;
                emp.managerId = null;
              }
            }
          });
          
          // Remove manager from array (no severance - they quit)
          managers = managers.filter(m => m.id !== manager.id && m.id.toString() !== manager.id.toString());
          
          hideManagerPromotionModal();
          updateEmployeesUI();
        } else {
          // Show rejection count and keep modal open
          updateManagerPromotionRejectionDisplay(manager.promotionAttempts);
        }
      }
    }
    
    function hideManagerPromotionModal() {
      document.getElementById('managerPromotionModal').classList.remove('active');
      managerToPromote = null;
      startGame();
    }
    
    function showFireManagerModal(managerId) {
      pauseGame(); // Auto-pause when opening modal
      
      const manager = managers.find(m => m.id === managerId || m.id.toString() === managerId.toString());
      if (!manager) return;
      
      managerToFire = managerId;
      
      // Update modal content
      document.getElementById('fireManagerName').textContent = manager.name;
      document.getElementById('fireManagerManagedCount').textContent = `${manager.managedEmployees.length} managed employees will become unmanaged`;
      document.getElementById('fireManagerSeverance').textContent = `Severance: ${formatCurrency(manager.monthlySalary)} (1 month salary)`;
      document.getElementById('fireManagerMonthlySavings').textContent = `${formatCurrency(manager.monthlySalary)}/mo`;
      
      // Show modal
      document.getElementById('fireManagerModal').classList.add('active');
    }
    
    function confirmFireManager() {
      if (managerToFire === null) return;
      
      const manager = managers.find(m => m.id === managerToFire || m.id.toString() === managerToFire.toString());
      if (!manager) {
        hideFireManagerModal();
        return;
      }
      
      const severancePay = manager.monthlySalary;
      
      // Pay severance
      cash -= severancePay;
      
      // Unmanage all employees managed by this manager
      manager.managedEmployees.forEach(empId => {
        if (empId === 'founder') {
          founder.isManaged = false;
          founder.managerId = null;
        } else {
          const emp = [...developers, ...marketers].find(e => e.id === empId || e.id.toString() === empId.toString());
          if (emp) {
            emp.isManaged = false;
            emp.managerId = null;
          }
        }
      });
      
      // Remove manager from array
      managers = managers.filter(m => m.id !== manager.id && m.id.toString() !== manager.id.toString());
      
      logEvent(`ð¥ Fired ${manager.name} (Manager)`);
      logEvent(`  ð¸ Severance Paid: ${formatCurrency(severancePay)}`);
      logEvent(`  ð° Monthly Savings: ${formatCurrency(manager.monthlySalary)}/month`);
      logEvent(`  ð¥ ${manager.managedEmployees.length} employees are now unmanaged`);
      
      hideFireManagerModal();
      updateCashDisplay();
      updateEmployeesUI();
    }
    
    function hideFireManagerModal() {
      document.getElementById('fireManagerModal').classList.remove('active');
      managerToFire = null;
      startGame();
    }
    
    // ============================================
    // EMPLOYEE EXPERIENCE & PROGRESSION
    // ============================================
    
    function updateEmployeeExperience() {
      // Update experience for founder
      const founderIsWorking = products.some(p => 
        (p.status === 'in_development' || p.status === 'published') && 
        (p.assignedDevelopers.includes(founder.id) || p.assignedMarketers.includes(founder.id))
      ) || rndProjects.some(p => p.assignedDevelopers.includes(founder.id));
      
      if (founderIsWorking) {
        founder.experienceMonths = (founder.experienceMonths || 0) + (1/30); // 1 day = 1/30 month
        
        // Update founder's efficiency (100% to 200% cap)
        const baseEfficiency = founder.baseEfficiency || 1.0;
        const gainedEfficiency = founder.experienceMonths * EXPERIENCE_RATE;
        const newEfficiency = Math.min(baseEfficiency + gainedEfficiency, founder.efficiencyCap);
        founder.efficiency = newEfficiency;
        
        // Founder never needs "promotion" - just keeps gaining efficiency until 400% cap
      }
      
      // Update experience for developers
      developers.forEach(dev => {
        // Check if developer is assigned to any work
        const isWorking = products.some(p => 
          (p.status === 'in_development' || p.status === 'published') && 
          p.assignedDevelopers.includes(dev.id)
        ) || rndProjects.some(p => p.assignedDevelopers.includes(dev.id));
        
        if (isWorking) {
          dev.experienceMonths = (dev.experienceMonths || 0) + (1/30); // 1 day = 1/30 month
          
          // Check for promotion
          checkEmployeePromotion(dev, 'developer');
        }
      });
      
      // Update experience for marketers
      marketers.forEach(mkt => {
        // Check if marketer is assigned to any work
        const isWorking = products.some(p => 
          p.status === 'published' && 
          p.assignedMarketers.includes(mkt.id)
        );
        
        if (isWorking) {
          mkt.experienceMonths = (mkt.experienceMonths || 0) + (1/30); // 1 day = 1/30 month
          
          // Check for promotion
          checkEmployeePromotion(mkt, 'marketer');
        }
      });
    }
    
    function checkEmployeePromotion(employee, role) {
      const tiers = role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
      const currentTier = tiers[employee.tier];
      
      // Calculate efficiency based on experience
      // Use employee's base efficiency (what they were hired at) as the starting point
      const baseEfficiency = employee.baseEfficiency || currentTier.efficiency;
      const gainedEfficiency = employee.experienceMonths * EXPERIENCE_RATE;
      
      // If employee is ready for promotion but not promoted, cap at current efficiency cap
      let newEfficiency;
      if (employee.readyForPromotion) {
        // Employee is stuck at cap until promoted
        newEfficiency = currentTier.efficiencyCap;
      } else {
        // Employee can still gain efficiency
        newEfficiency = Math.min(baseEfficiency + gainedEfficiency, currentTier.efficiencyCap);
      }
      
      // Update efficiency
      employee.efficiency = newEfficiency;
      
      // Check if reached cap and ready for promotion
      if (newEfficiency >= currentTier.efficiencyCap && employee.tier < tiers.length - 1 && !employee.readyForPromotion) {
        // Mark as ready for promotion (not auto-promote)
        employee.readyForPromotion = true;
        employee.promotionRejectionCount = 0; // Reset rejection count for this promotion
        
        // Generate salary expectation for next rank with Â±20% fluctuation (normal distribution)
        const nextTier = tiers[employee.tier + 1];
        const baseSalary = currency === 'USD' ? nextTier.monthlySalaryUSD : nextTier.monthlySalaryEUR;
        employee.salaryExpectationForNextRank = generateSalaryExpectation(baseSalary);
        
        logEvent(`ð¯ ${employee.name} (${employee.tierName}) is ready for promotion!`);
        showNotification(`ð¯ ${employee.name} ready for promotion!`, 'info');
      }
    }
    
    function calculateManagerPromotionSalary(manager, newCapacity, oldCapacity) {
      // Calculate salary based on new capacity: capacity * 2000 with Â±15% variance
      // Example: newCapacity 6 = 12000 (Â±15%) = 10200-13800
      
      const baseSalary = newCapacity * 2000;
      const variance = 0.85 + (Math.random() * 0.30); // 0.85 to 1.15 for Â±15%
      const proposedSalary = Math.round(baseSalary * variance);
      
      return proposedSalary;
    }
    
    function generateSalaryExpectation(baseSalary) {
      // Generate salary expectation with Â±20% fluctuation using normal distribution
      // Using Box-Muller transform to generate normally distributed random value
      const u1 = Math.random();
      const u2 = Math.random();
      const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
      
      // z0 is now a standard normal (mean=0, stddev=1)
      // We want mean=1.0 (base salary), stddev=0.1 (so ~95% within Â±20%)
      const multiplier = 1.0 + (z0 * 0.1);
      
      // Clamp to Â±20% range
      const clampedMultiplier = Math.max(0.8, Math.min(1.2, multiplier));
      
      return Math.round(baseSalary * clampedMultiplier);
    }
    
    function calculatePromotionAcceptanceProbability(offer, expectation) {
      // If offer >= expectation, 100% acceptance
      if (offer >= expectation) {
        return 1.0;
      }
      
      // Calculate percentage difference (negative value)
      const percentDiff = ((offer - expectation) / expectation) * 100;
      
      // Create acceptance probability curve:
      // -5% or better: ~90% chance
      // -10%: ~80% chance
      // -15%: ~60% chance
      // -20%: ~40% chance
      // -25%: ~20% chance
      // -30%: ~10% chance
      // -35%: ~5% chance
      // -40% or worse: ~1% chance
      
      // Using exponential decay formula: probability = e^(k * percentDiff)
      // Where k controls the steepness of the curve
      const k = 0.08; // Tuned for desired curve
      const probability = Math.exp(k * percentDiff);
      
      // Ensure minimum 1% chance
      return Math.max(0.01, Math.min(1.0, probability));
    }
    
    function promoteEmployee(employee, offeredSalary, role) {
      const tiers = role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
      const oldTierName = employee.tierName;
      const oldSalary = employee.monthlySalary;
      
      employee.tier += 1;
      const newTier = tiers[employee.tier];
      
      employee.tierName = newTier.name;
      employee.skill = newTier.skill;
      employee.monthlySalary = offeredSalary;
      employee.efficiency = newTier.efficiency; // Reset to new tier base
      employee.baseEfficiency = newTier.efficiency; // Reset base efficiency for new tier
      employee.experienceMonths = 0; // Reset experience for new tier
      employee.readyForPromotion = false; // Clear promotion flag
      employee.salaryExpectationForNextRank = null; // Clear expectation
      employee.promotionRejectionCount = 0; // Reset rejection count
      
      // Log promotion with salary change
      const salaryIncrease = employee.monthlySalary - oldSalary;
      logEvent(`ð ${employee.name} promoted from ${oldTierName} to ${employee.tierName}! Salary: ${formatCurrency(oldSalary)} â ${formatCurrency(employee.monthlySalary)} (+${formatCurrency(salaryIncrease)})`);
      showNotification(`ð ${employee.name} promoted to ${employee.tierName}!`, 'success');
    }
    
    function updateEmployeesUI() {
      // Update office info
      const office = OFFICE_TIERS[currentOfficeTier];
      const teamSize = getCurrentTeamSize();
      const officeInfo = document.getElementById('officeInfo');
      
      const rent = currency === "USD" ? office.monthlyRentUSD : office.monthlyRentEUR;
      
      // Action buttons for top-right (text with colored backgrounds)
      let actionButtons = '';
      const canUpgradeOffice = currentOfficeTier < OFFICE_TIERS.length - 1;
      const canDowngrade = canDowngradeOffice();
      
      if (canUpgradeOffice || canDowngrade) {
        actionButtons = '<div class="office-actions">';
        
        // Downgrade button (left)
        if (canDowngrade) {
          actionButtons += `
            <button 
              class="office-upgrade-btn downgrade" 
              onclick="showDowngradeOfficeModal()"
              title="Downgrade office"
            >
              Downgrade
            </button>
          `;
        }
        
        // Upgrade button (right)
        if (canUpgradeOffice) {
          actionButtons += `
            <button 
              class="office-upgrade-btn upgrade" 
              onclick="showUpgradeOfficeModal()"
              title="Upgrade office"
            >
              Upgrade
            </button>
          `;
        }
        
        actionButtons += '</div>';
      }
      
      const isFull = teamSize >= office.capacity;
      
      officeInfo.innerHTML = `
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.6rem 0.8rem 0.6rem 0.8rem; margin-bottom: 0.5rem;">
          <!-- Top Row: Office Name + Action Buttons -->
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
            <div class="office-name" style="font-weight: 600; font-size: 1rem; color: #1f2937;">
              ð¢ ${office.name}
            </div>
            ${actionButtons}
          </div>
          
          <!-- Bottom Row: Employee Count + Hire + Rent -->
          <div style="display: flex; align-items: center; gap: 2rem;">
            <!-- Employee Count + Hire Button -->
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1rem;">ð¥</span>
              <span style="font-size: 1rem; font-weight: 500; color: ${isFull ? '#dc2626' : '#374151'};">
                ${teamSize} / ${office.capacity}
              </span>
              <button 
                onclick="showHireModal()" 
                ${isFull ? 'disabled' : ''}
                style="
                  padding: 0.25rem 0.625rem;
                  border-radius: 6px;
                  border: none;
                  background: ${isFull ? '#e5e7eb' : '#3b82f6'};
                  color: ${isFull ? '#9ca3af' : 'white'};
                  font-size: 0.75rem;
                  font-weight: 600;
                  cursor: ${isFull ? 'not-allowed' : 'pointer'};
                  transition: background 0.2s;
                "
                ${!isFull ? 'onmouseover="this.style.background=\'#2563eb\'" onmouseout="this.style.background=\'#3b82f6\'"' : ''}
                title="${isFull ? 'Office is full - upgrade to hire more' : 'Hire new employee'}"
              >+ Hire</button>
            </div>
            
            <!-- Rent -->
            <div style="display: flex; align-items: center; gap: 0.35rem; color: #6b7280; font-size: 0.9rem;">
              ${rent > 0 ? `<span>ð°</span><span>${formatCurrency(rent)}/mo</span>` : '<span>ð </span><span>No rent</span>'}
            </div>
          </div>
        </div>
      `;
      
      // Update employee list
      const employeeList = document.getElementById('employeeList');
      
      // Filter employees based on currentEmployeeFilter
      let employeesToDisplay = [founder, ...developers, ...marketers];
      
      if (currentEmployeeFilter === 'developer') {
        employeesToDisplay = developers; // Founder excluded from developer filter
      } else if (currentEmployeeFilter === 'marketer') {
        employeesToDisplay = marketers;
      } else if (currentEmployeeFilter === 'unassigned') {
        // Filter to show only unassigned employees
        employeesToDisplay = employeesToDisplay.filter(emp => {
          const empId = emp.id === founder.id || emp.name === founder.name ? founder.id : emp.id;
          
          // Check if assigned to any product
          const isAssignedToProduct = products.some(p => 
            p.assignedDevelopers.includes(empId) || p.assignedMarketers.includes(empId)
          );
          
          // Check if assigned to any R&D project
          const isAssignedToRnd = rndProjects.some(p => p.assignedDevelopers.includes(empId));
          
          return !isAssignedToProduct && !isAssignedToRnd;
        });
      } else if (currentEmployeeFilter === 'promotion') {
        employeesToDisplay = employeesToDisplay.filter(e => e.readyForPromotion);
      }
      
      // Sort employees by efficiency (descending) - highest efficiency at the top
      employeesToDisplay.sort((a, b) => {
        // Calculate current efficiency for employee A
        let efficiencyA;
        if (a.id === founder.id || a.name === founder.name) {
          // Founder
          const gainedEfficiencyA = (founder.experienceMonths || 0) * EXPERIENCE_RATE;
          efficiencyA = Math.min(founder.baseEfficiency + gainedEfficiencyA, founder.efficiencyCap);
        } else {
          // Regular employee
          const tiersA = a.role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
          const currentTierA = tiersA[a.tier];
          const gainedEfficiencyA = (a.experienceMonths || 0) * EXPERIENCE_RATE;
          const baseEfficiencyA = a.baseEfficiency || currentTierA.efficiency;
          efficiencyA = Math.min(baseEfficiencyA + gainedEfficiencyA, currentTierA.efficiencyCap);
        }
        
        // Calculate current efficiency for employee B
        let efficiencyB;
        if (b.id === founder.id || b.name === founder.name) {
          // Founder
          const gainedEfficiencyB = (founder.experienceMonths || 0) * EXPERIENCE_RATE;
          efficiencyB = Math.min(founder.baseEfficiency + gainedEfficiencyB, founder.efficiencyCap);
        } else {
          // Regular employee
          const tiersB = b.role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
          const currentTierB = tiersB[b.tier];
          const gainedEfficiencyB = (b.experienceMonths || 0) * EXPERIENCE_RATE;
          const baseEfficiencyB = b.baseEfficiency || currentTierB.efficiency;
          efficiencyB = Math.min(baseEfficiencyB + gainedEfficiencyB, currentTierB.efficiencyCap);
        }
        
        // Sort descending (highest efficiency first)
        return efficiencyB - efficiencyA;
      });
      
      // Helper function to render an employee card (collapsible design)
      function renderEmployeeCard(emp, isFounder = false) {
        const empId = isFounder ? 'founder' : emp.id;
        const isExpanded = expandedEmployeeCards.hasOwnProperty(empId); // Card is expanded if it exists in tracking
        
        // Find assignment
        let assignment = null;
        let assignmentType = '';
        
        const productAssignment = products.find(p => 
          p.assignedDevelopers.includes(empId) || p.assignedMarketers.includes(empId)
        );
        
        if (productAssignment) {
          assignment = productAssignment;
          assignmentType = 'Product';
        } else if (isFounder || emp.role === 'developer') {
          // Check R&D assignment (founder and developers only, not marketers)
          const rndAssignment = rndProjects.find(p => p.assignedDevelopers.includes(empId));
          if (rndAssignment) {
            assignment = rndAssignment;
            assignmentType = 'R&D';
          }
        }
        
        // Calculate efficiency and progress
        let currentEfficiency, progressPercent, nextTierName, isMaxLevel;
        
        if (isFounder) {
          const experienceMonths = founder.experienceMonths || 0;
          const gainedEfficiency = experienceMonths * EXPERIENCE_RATE;
          currentEfficiency = Math.min(founder.baseEfficiency + gainedEfficiency, founder.efficiencyCap);
          progressPercent = ((currentEfficiency - 1.0) / (founder.efficiencyCap - 1.0)) * 100;
          nextTierName = 'Mastery';
          isMaxLevel = currentEfficiency >= founder.efficiencyCap;
        } else {
          const tiers = emp.role === 'developer' ? DEVELOPER_TIERS : MARKETER_TIERS;
          const currentTier = tiers[emp.tier];
          const experienceMonths = emp.experienceMonths || 0;
          const gainedEfficiency = experienceMonths * EXPERIENCE_RATE;
          const baseEfficiency = emp.baseEfficiency || currentTier.efficiency;
          currentEfficiency = Math.min(baseEfficiency + gainedEfficiency, currentTier.efficiencyCap);
          progressPercent = (currentEfficiency - baseEfficiency) / (currentTier.efficiencyCap - baseEfficiency) * 100;
          nextTierName = emp.tier < tiers.length - 1 ? tiers[emp.tier + 1].name : 'Max Level';
          isMaxLevel = emp.tier >= tiers.length - 1 && currentEfficiency >= currentTier.efficiencyCap;
        }
        
        const positionName = isFounder ? 'Founder' : emp.tierName;
        const salary = isFounder ? 'No salary' : formatCurrency(emp.monthlySalary) + '/mo';
        
        // Check if employee is managed by a manager (for visual indicator)
        const empIdForCheck = isFounder ? 'founder' : empId;
        const currentManager = managers.find(m => 
          m.managedEmployees.includes(empIdForCheck) || 
          m.managedEmployees.includes(empIdForCheck.toString()) ||
          (emp.isManaged && (m.id === emp.managerId || m.id.toString() === emp.managerId?.toString()))
        );
        const isManaged = !!currentManager;
        
        // Card HTML (matching product card structure)
        let html = '<div class="product-card employee-card-collapsible"';
        if (isFounder) {
          // Founder gets special golden styling, plus managed indicator if applicable
          html += ' style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);';
          if (isManaged) {
            html += ' border-left: 6px solid #e9d5ff;';
          }
          html += '"';
        } else if (isManaged) {
          // Add left border indicator for managed employees (matching manager card color)
          html += ' style="border-left: 6px solid #e9d5ff;"';
        }
        html += '>';
        
        // Header (always visible) - clickable to expand/collapse
        html += '<div class="product-card-header" onclick="toggleEmployeeCard(\'' + empId + '\')">';
        html += '<div class="product-header">';
        
        // Left side: Name, position, and stats
        html += '<div class="product-header-left">';
        html += '<div class="product-title-row">';
        html += '<div class="product-name">' + (isFounder ? 'ð¤ ' : '') + emp.name + '</div>';
        html += '<div class="product-status status-employee">';
        html += (isFounder ? 'ð¨âð» ' : (emp.role === 'developer' ? 'ð¨âð» ' : 'ð¢ ')) + positionName;
        html += '</div>';
        html += '</div>';
        
        // Stats (salary and assignment status)
        html += '<div class="product-stats">';
        
        html += '<div class="product-stat">';
        html += '<span class="product-stat-icon">ð°</span>';
        html += '<span class="product-stat-label">' + salary + '</span>';
        html += '</div>';
        
        html += '<div class="product-stat" style="margin-left: auto;">';
        html += '<span class="product-stat-icon">' + (assignment ? 'â' : 'â') + '</span>';
        html += '<span class="product-stat-label">' + (assignment ? 'Assigned' : 'Unassigned') + '</span>';
        html += '</div>';
        
        html += '</div>'; // Close stats
        html += '</div>'; // Close header-left
        
        // Promotion indicator (exclamation mark)
        if (emp.readyForPromotion) {
          html += '<div style="display: flex; align-items: center;">';
          html += '<div style="width: 28px; height: 28px; border-radius: 50%; background: #ef4444; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; font-weight: bold; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);">';
          html += '!';
          html += '</div>';
          html += '</div>';
        }
        
        // Right side: Expand/collapse icon
        html += '<div class="product-expand-icon" id="employee-expand-icon-' + empId + '" style="transform: rotate(' + (isExpanded ? '180deg' : '0deg') + ');">';
        html += isExpanded ? 'â²' : 'â¼';
        html += '</div>';
        
        html += '</div>'; // Close header
        html += '</div>'; // Close card-header
        
        // Details section (shown when expanded)
        html += '<div class="product-details' + (isExpanded ? ' expanded' : '') + '" id="employee-details-' + empId + '">';
        
        // Efficiency
        html += '<div class="product-detail-row">';
        html += '<span class="product-detail-label">â¡ Efficiency</span>';
        html += '<span class="product-detail-value">' + (currentEfficiency * 100).toFixed(0) + '%</span>';
        html += '</div>';
        
        // Progress bar
        if (!isMaxLevel && !emp.readyForPromotion) {
          html += '<div style="margin: 0.75rem 0;">';
          html += '<div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">';
          html += '<span>ð Progress to ' + nextTierName + '</span>';
          html += '<span>' + Math.round(progressPercent) + '%</span>';
          html += '</div>';
          html += '<div style="position: relative; background: #e5e7eb; border-radius: 8px; height: 24px; overflow: hidden;">';
          html += '<div style="background: linear-gradient(90deg, ' + (isFounder ? '#f59e0b, #f97316' : '#3b82f6, #8b5cf6') + '); height: 100%; width: ' + progressPercent + '%; transition: width 0.3s ease;"></div>';
          html += '<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: ' + (progressPercent > 50 ? '#ffffff' : '#374151') + ';">';
          html += Math.round(progressPercent) + '%';
          html += '</div></div></div>';
        } else if (emp.readyForPromotion) {
          html += '<div style="color: #10b981; padding: 0.5rem; background: #d1fae5; border-radius: 6px; text-align: center; font-size: 0.875rem; margin: 0.75rem 0; font-weight: 600;">';
          html += 'ð Ready for Promotion';
          html += '</div>';
        } else if (isMaxLevel) {
          html += '<div style="color: #10b981; padding: 0.5rem; background: #d1fae5; border-radius: 6px; text-align: center; font-size: 0.875rem; margin: 0.75rem 0; font-weight: 600;">';
          html += 'â­ Maximum Level Reached';
          html += '</div>';
        }
        
        // Assignment info
        html += '<div class="product-detail-row">';
        html += '<span class="product-detail-label">ð Assigned to</span>';
        html += '<span class="product-detail-value">';
        if (assignment) {
          html += assignment.name + (assignmentType === 'R&D' ? ' (R&D)' : '');
        } else {
          html += '<span style="color: #9ca3af;">Not assigned</span>';
        }
        html += '</span>';
        html += '</div>';
        
        // Action buttons
        // Promote button (if ready for promotion) - full width
        if (emp.readyForPromotion) {
          html += '<div style="margin-top: 0.5rem;">';
          html += '<button class="btn" onclick="event.stopPropagation(); showPromotionModal(' + (isFounder ? "'founder'" : emp.id) + ', \'' + (isFounder ? 'developer' : emp.role) + '\')" style="width: 100%; background: #10b981; border-color: #059669; color: white; padding: 0.5rem;">ð Promote</button>';
          html += '</div>';
        }
        
        // Fire button + Manager assignment button (side by side)
        // Note: empIdForCheck and currentManager already defined above for managed indicator
        const empIdForModal = isFounder ? "'founder'" : emp.id;
        
        // Show Fire + Manager buttons row (if not founder OR if managers are unlocked)
        if (!isFounder || (lifetimeEarnings >= 2000000 && managers.length > 0)) {
          html += '<div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">';
          
          // Fire button (1x width) - only for non-founder
          if (!isFounder) {
            html += '<button class="btn" onclick="event.stopPropagation(); fireEmployee(' + emp.id + ')" style="flex: 1; background: #ef4444; border-color: #dc2626; padding: 0.5rem;">ð¥ Fire</button>';
          }
          
          // Manager assignment button (3x width) - show if managers are unlocked
          if (lifetimeEarnings >= 2000000 && managers.length > 0) {
            if (isManaged && currentManager) {
              // Show managed status - clickable to change manager
              html += '<div onclick="event.stopPropagation(); showAssignToManagerModal(' + empIdForModal + ')" style="flex: 3; background: #e9d5ff; border: 1px solid #c4b5fd; color: #6b21a8; padding: 0.5rem; font-size: 0.85rem; font-weight: 600; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#ddd6fe\'" onmouseout="this.style.background=\'#e9d5ff\'">';
              html += 'ð Managed by: ' + currentManager.name;
              html += '</div>';
            } else {
              // Show assignment button
              html += '<button class="btn" onclick="event.stopPropagation(); showAssignToManagerModal(' + empIdForModal + ')" style="flex: 3; background: #e9d5ff; border: none; color: #6b21a8; padding: 0.5rem; font-size: 0.85rem; font-weight: 600;">';
              html += 'ð Assign to Manager';
              html += '</button>';
            }
          }
          
          html += '</div>';
        }
        
        html += '</div>'; // Close details
        html += '</div>'; // Close card
        
        return html;
      }
      
      // Generate managers section (only for 'all', 'managers', or 'promotion' filter)
      let managersHTML = '';
      const showManagers = currentEmployeeFilter === 'all' || currentEmployeeFilter === 'managers' || currentEmployeeFilter === 'promotion';
      
      // Filter managers based on the current filter
      let managersToDisplay = managers;
      if (currentEmployeeFilter === 'promotion') {
        managersToDisplay = managers.filter(m => m.readyForPromotion);
      }
      
      if (managersToDisplay.length > 0 && showManagers) {
        managersHTML = `
          <div style="margin-bottom: 0.5rem;">
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              ${managersToDisplay.map(manager => {
                // Calculate current capacity dynamically (respects readyForPromotion)
                const currentCapacity = getManagerCapacity(manager);
                
                return `
                <div style="background: #e9d5ff; border-radius: 8px; padding: 0.6rem; color: #1f2937; position: relative;">
                  ${manager.readyForPromotion ? `
                    <div style="position: absolute; top: -8px; right: -8px; width: 28px; height: 28px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer;" 
                         onclick="showManagerPromotionModal('${manager.id}')" 
                         title="Ready for promotion - Click to negotiate">
                      â
                    </div>
                  ` : ''}
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <div style="font-weight: 600; font-size: 0.95rem; color: #6b21a8;">
                      ${manager.flag} ${manager.name}
                    </div>
                    <div style="text-align: right; display: flex;gap: 0.5rem;align-items: center;">
                      <div style="font-size: 0.65rem; color: #6b21a8; opacity: 0.7;">Monthly</div>
                      <div style="font-weight: 600; font-size: 0.9rem; color: #6b21a8; margin-right:1rem;">${formatCurrency(manager.monthlySalary)}</div>
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.8rem;">
                    <div style="background: rgba(255,255,255,0.5); padding: 0.3rem; border-radius: 6px; display: flex; align-items: center; gap: 0.3rem;">
                      <div style="color: #6b21a8; opacity: 0.7; font-size: 0.65rem;">Efficiency:</div>
                      <div style="font-weight: 600; color: #6b21a8;">${manager.efficiency}%</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.5); padding: 0.3rem; border-radius: 6px; display: flex; align-items: center; gap: 0.3rem;">
                      <div style="color: #6b21a8; opacity: 0.7; font-size: 0.65rem;">Capacity:</div>
                      <div style="font-weight: 600; color: #6b21a8;">${manager.managedEmployees.length} / ${currentCapacity}</div>
                    </div>
                  </div>
                  <div style="margin-top: 0.25rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <button 
                      onclick="showFireManagerModal('${manager.id}')" 
                      style="padding: 0.35rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: #dc2626; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"
                      onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'"
                      onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'"
                    >
                      ð¥ Fire
                    </button>
                    <button 
                      onclick="showManageTeamModal('${manager.id}')" 
                      style="padding: 0.35rem; background: rgba(255,255,255,0.5); border: 1px solid rgba(107, 33, 168, 0.3); border-radius: 6px; color: #6b21a8; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"
                      onmouseover="this.style.background='rgba(255,255,255,0.7)'"
                      onmouseout="this.style.background='rgba(255,255,255,0.5)'"
                    >
                      ð¥ Manage Team
                    </button>
                  </div>
                </div>
              `;
              }).join('')}
            </div>
          </div>
        `;
      }
      
      // Generate all employee cards (skip if 'managers' filter is selected)
      let employeesHTML = '';
      if (currentEmployeeFilter !== 'managers') {
        employeesHTML = employeesToDisplay.map(emp => {
          const isFounder = emp.id === founder.id || emp.name === founder.name;
          return renderEmployeeCard(emp, isFounder);
        }).join('');
      }
      
      // Set employee list HTML (managers first, then employees)
      if (employeeList) {
        employeeList.innerHTML = managersHTML + employeesHTML;
      }
      
      // Update filter counts
      updateEmployeeFilterCounts();
      
      // Sync filter button states with currentEmployeeFilter (preserve filter selection during game ticks)
      const employeePanel = document.querySelector('#employeesContainer');
      if (employeePanel) {
        employeePanel.querySelectorAll('.filter-pill').forEach(pill => {
          pill.classList.remove('active');
          if (pill.dataset.filter === currentEmployeeFilter) {
            pill.classList.add('active');
          }
        });
      }
      
      // Update navigation notifications
      updateNavigationNotifications();
    }
    
    // Initialize finance UI structure (called once)
    let financeUIInitialized = false;
    
    function initFinanceUI() {
      if (financeUIInitialized) return;
      
      const financesContent = document.getElementById('financesContent');
      financesContent.innerHTML = `
        <!-- Content with Tailwind styling -->
        <div class="max-w-lg mx-auto px-2 space-y-3">
          
          <!-- Monthly Finances Card -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="pb-2 pt-4 px-4">
              <div class="flex items-center gap-2">
                <div class="bg-blue-100 p-1.5 rounded-lg">
                  <i data-lucide="dollar-sign" class="w-4 h-4 text-blue-600"></i>
                </div>
                <h2 class="font-semibold">Monthly Finances</h2>
              </div>
            </div>
            <div class="space-y-3 px-4 pb-4">
              <!-- Next Billing Cycle -->
              <div class="bg-gray-50 rounded-lg p-2.5">
                <div class="flex items-center justify-center gap-2 mb-0.5">
                  <i data-lucide="calendar" class="w-3.5 h-3.5 text-gray-500"></i>
                  <span class="text-xs text-gray-600">Next Billing Cycle</span>
                </div>
                <div class="text-center font-semibold text-gray-900" id="finance-billing-days"></div>
              </div>

              <div class="border-t border-gray-200"></div>

              <!-- Income -->
              <div class="flex items-start justify-between">
                <div class="flex items-start gap-2">
                  <i data-lucide="trending-up" class="w-4 h-4 text-green-600 mt-0.5"></i>
                  <div>
                    <div class="font-medium text-gray-900 text-sm">Income:</div>
                    <div class="text-xs text-gray-500" id="finance-income-breakdown"></div>
                  </div>
                </div>
                <div class="font-semibold text-green-600" id="finance-income-total"></div>
              </div>

              <!-- Expenses -->
              <div class="flex items-start justify-between">
                <div class="flex items-start gap-2">
                  <i data-lucide="trending-down" class="w-4 h-4 text-red-600 mt-0.5"></i>
                  <div>
                    <div class="font-medium text-gray-900 text-sm">Expenses:</div>
                    <div class="text-xs text-gray-500" id="finance-expenses-breakdown"></div>
                  </div>
                </div>
                <div class="font-semibold text-red-600" id="finance-expenses-total"></div>
              </div>

              <div class="border-t border-gray-200"></div>

              <!-- Net Cash Flow -->
              <div class="flex items-center justify-between bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-2.5">
                <div class="flex items-center gap-2">
                  <i data-lucide="bar-chart-3" class="w-4 h-4 text-gray-700"></i>
                  <span class="font-semibold text-gray-900 text-sm">Net Cash Flow:</span>
                </div>
                <div class="font-bold" id="finance-cashflow"></div>
              </div>

              <!-- Burn Rate -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i data-lucide="zap" class="w-4 h-4 text-orange-500"></i>
                  <span class="font-medium text-gray-900 text-sm">Burn Rate:</span>
                </div>
                <div class="font-semibold text-gray-700" id="finance-burnrate"></div>
              </div>
            </div>
          </div>

          <!-- Lifetime Earnings & Reputation Card -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="pb-2 pt-4 px-4">
              <div class="flex items-center gap-2">
                <div class="bg-purple-100 p-1.5 rounded-lg">
                  <i data-lucide="bar-chart-3" class="w-4 h-4 text-purple-600"></i>
                </div>
                <h2 class="font-semibold">Lifetime Earnings & Reputation</h2>
              </div>
            </div>
            <div class="space-y-3 px-4 pb-4">
              <!-- Total Earned -->
              <div class="flex items-center justify-between">
                <span class="font-medium text-gray-900 text-sm">Total Earned:</span>
                <span class="font-bold text-green-600" id="finance-lifetime"></span>
              </div>

              <div class="border-t border-gray-200"></div>

              <!-- Reputation -->
              <div>
                <div class="flex items-center justify-between mb-1.5">
                  <div class="flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-3.5 h-3.5 text-green-600"></i>
                    <span class="font-medium text-gray-900 text-sm" id="finance-milestone-name"></span>
                  </div>
                  <span class="text-xs text-gray-500" id="finance-milestone-percent"></span>
                </div>
                <div class="h-1.5 mb-1.5 rounded-full overflow-hidden" style="background-color: #e5e7eb;">
                  <div class="h-full bg-green-600 transition-all duration-300" id="finance-milestone-bar" style="width: 0%"></div>
                </div>
                <div id="finance-milestone-next"></div>
              </div>
            </div>
          </div>

          <!-- Server Capacity Card -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="pb-2 pt-4 px-4">
              <div class="flex items-center gap-2">
                <div class="bg-indigo-100 p-1.5 rounded-lg">
                  <i data-lucide="server" class="w-4 h-4 text-indigo-600"></i>
                </div>
                <h2 class="font-semibold" id="finance-server-name"></h2>
              </div>
            </div>
            <div class="space-y-3 px-4 pb-4">
              <!-- Capacity -->
              <div>
                <div class="flex items-center justify-between mb-1.5">
                  <span class="text-xs text-gray-600" id="finance-server-subs"></span>
                  <span class="text-xs font-medium text-gray-600" id="finance-server-percent"></span>
                </div>
                <div class="h-1.5 rounded-full overflow-hidden" style="background-color: #e5e7eb;">
                  <div class="h-full transition-all duration-300" id="finance-server-bar" style="width: 0%"></div>
                </div>
              </div>

              <div id="finance-server-action"></div>
            </div>
          </div>
        </div>
      `;
      
      // Initialize Lucide icons
      if (window.lucide) {
        window.lucide.createIcons();
      }
      
      financeUIInitialized = true;
    }
    
    // Update finance UI (only updates values, no HTML regeneration)
    function updateFinancesUI() {
      // Initialize UI if not already done
      if (!financeUIInitialized) {
        initFinanceUI();
        return;
      }
      
      const income = calculateMonthlyIncome();
      const costs = calculateMonthlyCosts();
      const cashFlow = calculateNetCashFlow();
      const burnRate = calculateBurnRate();
      
      const totalSubs = getTotalSubscribers();
      const server = SERVER_TIERS[currentServerTier];
      const capacityPercent = getServerCapacityPercentage();
      
      // Calculate days until next billing
      const daysUntilBilling = currentDay === 0 ? 30 : (30 - (currentDay % 30));
      
      // Get milestone information
      const milestone = getCurrentMilestone();
      const nextMilestone = getNextMilestone();
      let reputationProgress = 0;
      if (nextMilestone) {
        reputationProgress = ((lifetimeEarnings - milestone.threshold) / (nextMilestone.threshold - milestone.threshold)) * 100;
        reputationProgress = Math.min(100, Math.max(0, reputationProgress));
      }
      
      // Update billing days
      const billingEl = document.getElementById('finance-billing-days');
      if (billingEl) {
        billingEl.textContent = `In ${daysUntilBilling} ${daysUntilBilling === 1 ? 'day' : 'days'}`;
      }
      
      // Update income
      const incomeBreakdownEl = document.getElementById('finance-income-breakdown');
      if (incomeBreakdownEl) {
        incomeBreakdownEl.textContent = `Revenue: ${formatCurrency(income.grossRevenue)}`;
      }
      const incomeTotalEl = document.getElementById('finance-income-total');
      if (incomeTotalEl) {
        incomeTotalEl.textContent = formatCurrency(income.netIncome);
      }
      
      // Update expenses
      const expensesBreakdownEl = document.getElementById('finance-expenses-breakdown');
      if (expensesBreakdownEl) {
        let breakdown = ``;
        if (costs.rent > 0) breakdown += `Rent: ${formatCurrency(costs.rent)}, `;
        breakdown += `Utilities: ${formatCurrency(costs.utilities)}, Insurance: ${formatCurrency(costs.insurance)}`;
        if (costs.salaries > 0) breakdown += `, Salaries: ${formatCurrency(costs.salaries)}`;
        if (costs.serverFee > 0) breakdown += `, Server: ${formatCurrency(costs.serverFee)}`;
        expensesBreakdownEl.textContent = breakdown;
      }
      const expensesTotalEl = document.getElementById('finance-expenses-total');
      if (expensesTotalEl) {
        expensesTotalEl.textContent = formatCurrency(costs.total);
      }
      
      // Update cash flow
      const cashFlowEl = document.getElementById('finance-cashflow');
      if (cashFlowEl) {
        cashFlowEl.textContent = formatCurrency(cashFlow);
        cashFlowEl.className = `font-bold ${cashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`;
      }
      
      // Update burn rate
      const burnRateEl = document.getElementById('finance-burnrate');
      if (burnRateEl) {
        burnRateEl.textContent = burnRate === Infinity ? 'â (Profitable!)' : `${burnRate} ${burnRate === 1 ? 'month' : 'months'}`;
      }
      
      // Update lifetime earnings
      const lifetimeEl = document.getElementById('finance-lifetime');
      if (lifetimeEl) {
        lifetimeEl.textContent = formatCurrency(lifetimeEarnings);
      }
      
      // Update milestone
      const milestoneNameEl = document.getElementById('finance-milestone-name');
      if (milestoneNameEl) {
        milestoneNameEl.textContent = milestone.name;
      }
      const milestonePercentEl = document.getElementById('finance-milestone-percent');
      if (milestonePercentEl) {
        milestonePercentEl.textContent = `${Math.round(reputationProgress)}%`;
      }
      const milestoneBarEl = document.getElementById('finance-milestone-bar');
      if (milestoneBarEl) {
        milestoneBarEl.style.width = `${reputationProgress}%`;
      }
      const milestoneNextEl = document.getElementById('finance-milestone-next');
      if (milestoneNextEl) {
        if (nextMilestone) {
          milestoneNextEl.innerHTML = `
            <div class="flex items-center gap-1 text-xs text-gray-600">
              <span>Next:</span>
              <span class="font-medium">${nextMilestone.name}</span>
              <span>at</span>
              <span class="font-medium text-green-600">${formatCurrency(nextMilestone.threshold)}</span>
            </div>
          `;
        } else {
          milestoneNextEl.innerHTML = `
            <div class="text-xs text-orange-600">
              â­ Maximum reputation! You attract the best talent!
            </div>
          `;
        }
      }
      
      // Update server
      const serverNameEl = document.getElementById('finance-server-name');
      if (serverNameEl) {
        serverNameEl.textContent = server.name;
      }
      const serverSubsEl = document.getElementById('finance-server-subs');
      if (serverSubsEl) {
        serverSubsEl.textContent = `${totalSubs.toLocaleString()} / ${server.maxSubscribers.toLocaleString()} subscribers`;
      }
      const serverPercentEl = document.getElementById('finance-server-percent');
      if (serverPercentEl) {
        serverPercentEl.textContent = `${Math.round(capacityPercent)}%`;
      }
      const serverBarEl = document.getElementById('finance-server-bar');
      if (serverBarEl) {
        serverBarEl.style.width = `${capacityPercent}%`;
        // Update color based on capacity
        serverBarEl.className = `h-full transition-all duration-300 ${
          capacityPercent >= 90 ? 'bg-red-600' : 
          capacityPercent >= 75 ? 'bg-orange-500' : 
          'bg-indigo-600'
        }`;
      }
      
      // Update server action button
      const serverActionEl = document.getElementById('finance-server-action');
      if (serverActionEl) {
        const canUpgrade = currentServerTier < SERVER_TIERS.length - 1;
        if (canUpgrade) {
          serverActionEl.innerHTML = `
            <button onclick="showServerUpgradeDialog()" 
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-2 rounded-lg font-medium transition-colors">
              Upgrade Server
            </button>
          `;
        } else {
          serverActionEl.innerHTML = `
            <div class="text-center text-xs text-gray-500 py-2">
              ð Maximum server tier!
            </div>
          `;
        }
      }
      
      // Update navigation notifications
      updateNavigationNotifications();
    }
    
    function updateHireDeveloperModalContent() {
      const list = document.getElementById('hireDeveloperList');
      const hasCapacity = canHireMoreEmployees();
      const milestone = getCurrentMilestone();
      const daysUntilRefresh = 30 - (currentDay % 30);
      
      // Header with simple company status
      let headerHTML = `
        <div style="background: white; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem;">
          <div style="font-size: 0.75rem; color: #6b7280;">
            <strong style="color: #111827;">Company Status:</strong> ${milestone.badge} ${milestone.name}
          </div>
        </div>
        
        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.25rem;">
          <span>ð</span>
          <span>Pool refreshes in <strong>${daysUntilRefresh} day${daysUntilRefresh > 1 ? 's' : ''}</strong></span>
        </div>
      `;
      
      // Candidate cards in 2x2 grid
      const candidatesHTML = candidatePool.developers.map((candidate, index) => {
        const canAfford = cash >= candidate.monthlySalary;
        const tier = DEVELOPER_TIERS[candidate.tier];
        
        return `
          <button 
            class="hire-btn" 
            onclick="showHireConfirmation('${candidate.id}', 'developer', ${index});"
            ${!canAfford || !hasCapacity ? 'disabled' : ''}
            style="padding: 0.6rem; min-height: auto;"
          >
            <div style="text-align: left;">
              <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.4rem;">${candidate.flag || 'ð'} ${candidate.name}</div>
              <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.8rem;">
                <div><span class="skill-badge skill-${tier.skill}" style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">${tier.name}</span></div>
                <div>â¡ ${Math.round(candidate.efficiency * 100)}% efficiency</div>
                <div style="color: ${!canAfford ? '#dc2626' : '#059669'}; font-weight: 600;">ð¼ ${formatCurrency(candidate.monthlySalary)}/mo</div>
                ${!canAfford ? '<div style="color: #ef4444; font-size: 0.75rem;">â ï¸ Cannot afford</div>' : ''}
                ${!hasCapacity ? '<div style="color: #ef4444; font-size: 0.75rem;">â ï¸ No office capacity</div>' : ''}
              </div>
            </div>
          </button>
        `;
      }).join('');
      
      list.innerHTML = headerHTML + '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">' + candidatesHTML + '</div>';
    }
    
    function updateNavigationNotifications() {
      // Check for unassigned employees (Team panel notification)
      const allEmployees = [founder, ...developers, ...marketers];
      const hasUnassignedEmployees = allEmployees.some(emp => {
        const empId = emp.id === founder.id || emp.name === founder.name ? founder.id : emp.id;
        
        // Check if assigned to any product
        const isAssignedToProduct = products.some(p => 
          p.assignedDevelopers.includes(empId) || p.assignedMarketers.includes(empId)
        );
        
        // Check if assigned to any R&D project
        const isAssignedToRnd = rndProjects.some(p => p.assignedDevelopers.includes(empId));
        
        return !isAssignedToProduct && !isAssignedToRnd;
      });
      
      // Check for server capacity > 90% (Finance panel notification)
      const capacityPercent = getServerCapacityPercentage();
      const isServerCritical = capacityPercent >= 90;
      
      // Update Team tab notification
      const teamNav = document.getElementById('nav-team');
      if (teamNav) {
        // Remove existing notification dot if present
        const existingDot = teamNav.querySelector('.nav-notification-dot');
        if (existingDot) {
          existingDot.remove();
        }
        
        // Add notification dot if there are unassigned employees
        if (hasUnassignedEmployees) {
          const dot = document.createElement('div');
          dot.className = 'nav-notification-dot';
          teamNav.appendChild(dot);
        }
      }
      
      // Update Finance tab notification
      const financeNav = document.getElementById('nav-finance');
      if (financeNav) {
        // Remove existing notification dot if present
        const existingDot = financeNav.querySelector('.nav-notification-dot');
        if (existingDot) {
          existingDot.remove();
        }
        
        // Add notification dot if server capacity is critical
        if (isServerCritical) {
          const dot = document.createElement('div');
          dot.className = 'nav-notification-dot';
          financeNav.appendChild(dot);
        }
      }
    }
    
    // ============================================
    // UNIFIED HIRING FLOW
    // ============================================
    
    function showHireModal() {
      pauseGame(); // Auto-pause when opening modal
      
      // Check if office is full
      const office = OFFICE_TIERS[currentOfficeTier];
      const teamSize = getCurrentTeamSize();
      
      if (teamSize >= office.capacity) {
        showNotification('Office is full! Upgrade your office first.', 'warning');
        startGame(); // Resume since we're not showing modal
        return;
      }
      
      // Show/hide manager button based on lifetime earnings
      const managerButton = document.getElementById('hireManagerButton');
      if (lifetimeEarnings >= 2000000) {
        managerButton.style.display = 'flex';
      } else {
        managerButton.style.display = 'none';
      }
      
      document.getElementById('selectEmployeeTypeModal').classList.add('active');
    }
    
    function hideSelectEmployeeTypeModal() {
      document.getElementById('selectEmployeeTypeModal').classList.remove('active');
      startGame(); // Resume game when cancelled
    }
    
    function selectEmployeeType(type) {
      // Hide the type selection modal
      document.getElementById('selectEmployeeTypeModal').classList.remove('active');
      
      // Show the appropriate hiring modal (without starting game since we're going to another modal)
      if (type === 'developer') {
        showHireDeveloperModalDirect();
      } else if (type === 'marketer') {
        showHireMarketerModalDirect();
      } else if (type === 'manager') {
        showHireManagerModalDirect();
      }
    }
    
    // Direct show functions that don't pause again (since we're already paused)
    function showHireDeveloperModalDirect() {
      // Ensure candidate pool is initialized
      if (candidatePool.developers.length === 0) {
        generateCandidatePool();
      }
      
      const modal = document.getElementById('hireDeveloperModal');
      updateHireDeveloperModalContent();
      modal.classList.add('active');
    }
    
    function showHireMarketerModalDirect() {
      // Ensure candidate pool is initialized
      if (candidatePool.marketers.length === 0) {
        generateCandidatePool();
      }
      
      const modal = document.getElementById('hireMarketerModal');
      updateHireMarketerModalContent();
      modal.classList.add('active');
    }
    
    function showHireDeveloperModal() {
      pauseGame(); // Auto-pause when opening modal
      
      // Ensure candidate pool is initialized
      if (candidatePool.developers.length === 0) {
        generateCandidatePool();
      }
      
      const modal = document.getElementById('hireDeveloperModal');
      updateHireDeveloperModalContent();
      modal.classList.add('active');
    }
    
    function hideHireDeveloperModal() {
      document.getElementById('hireDeveloperModal').classList.remove('active');
      startGame(); // Resume game when cancelled
    }
    
    function hireFromPool(candidateIndex, type) {
      // type: "developer", "marketer", or "manager"
      
      if (!canHireMoreEmployees()) {
        logEvent("â Office at capacity! Upgrade your office to hire more people.");
        return;
      }
      
      // Get candidate from pool
      let candidate;
      if (type === "developer") {
        candidate = candidatePool.developers[candidateIndex];
      } else if (type === "marketer") {
        candidate = candidatePool.marketers[candidateIndex];
      } else if (type === "manager") {
        candidate = candidatePool.managers[candidateIndex];
      }
      
      if (!candidate) {
        logEvent("â Candidate not found!");
        return;
      }
      
      // Check if can afford
      if (cash < candidate.monthlySalary) {
        logEvent(`â Not enough cash to hire ${candidate.name}. Need ${formatCurrency(candidate.monthlySalary)}`);
        return;
      }
      
      // Deduct first month's salary
      cash -= candidate.monthlySalary;
      
      // Add experience tracking to candidate
      candidate.experienceMonths = 0;
      
      if (type === "manager") {
        // Manager-specific setup
        candidate.baseEfficiency = candidate.efficiency;
        candidate.managedEmployees = candidate.managedEmployees || [];
        
        managers.push(candidate);
        logEvent(`ð Hired ${candidate.name} as Manager (Capacity: ${candidate.capacity}) for ${formatCurrency(candidate.monthlySalary)}/mo`);
        
        // Remove from pool
        candidatePool.managers.splice(candidateIndex, 1);
        
        // Close modal
        document.getElementById('hireManagerModal').classList.remove('active');
      } else {
        // Developer/Marketer setup
        candidate.baseEfficiency = candidate.efficiency;
        
        // Add manager system fields (if not already set)
        if (candidate.managerId === undefined) {
          candidate.managerId = null;
          candidate.isManaged = false;
        }
        
        // Add to team
        if (type === "developer") {
          developers.push(candidate);
          logEvent(`â Hired ${candidate.name} as ${candidate.tierName} for ${formatCurrency(candidate.monthlySalary)}/mo`);
          candidatePool.developers.splice(candidateIndex, 1);
          document.getElementById('hireDeveloperModal').classList.remove('active');
        } else {
          marketers.push(candidate);
          logEvent(`â Hired ${candidate.name} as ${candidate.tierName} for ${formatCurrency(candidate.monthlySalary)}/mo`);
          candidatePool.marketers.splice(candidateIndex, 1);
          document.getElementById('hireMarketerModal').classList.remove('active');
        }
      }
      
      showNotification(`Hired ${candidate.name}!`, 'success');
      
      updateCashDisplay();
      updateEmployeesUI();
      updateFinancesUI();
      // Game stays paused so user can assign the new employee
    }
    
    function showDeveloperCandidates(tierIndex) {
      const modal = document.getElementById('hireDeveloperModal');
      const list = document.getElementById('hireDeveloperList');
      const tier = DEVELOPER_TIERS[tierIndex];
      const candidates = developerCandidates[tierIndex] || [];
      
      list.innerHTML = `
        <div style="margin-bottom: 0.3rem;">
          <button 
            onclick="showHireDeveloperModal()" 
            class="btn"
            style="padding: 0.4rem 0.8rem; font-size: 0.9rem; margin-bottom: 0.5rem;"
          >
            â Back to Tiers
          </button>
          <h3 style="color: #1f2937;">Available ${tier.name}s</h3>
          <p style="color: #6b7280; font-size: 0.9rem;">
            Select a candidate to review their details. Pool refreshes monthly.
          </p>
        </div>
        ${candidates.map(candidate => {
          const canAfford = cash >= candidate.monthlySalary;
          const hasCapacity = canHireMoreEmployees();
          
          return `
            <button 
              class="hire-btn" 
              onclick="showHireConfirmation('${candidate.id}', 'developer', ${tierIndex});"
              ${!canAfford || !hasCapacity ? 'disabled' : ''}
              style="width: 100%; margin-bottom: 0.5rem;"
            >
              <div class="hire-btn-info">
                <div class="hire-btn-title">
                  <strong>${candidate.name}</strong>
                </div>
                <div class="hire-btn-stats">
                  â¡ ${Math.round(candidate.efficiency * 100)}% efficiency â¢ ð¼ ${formatCurrency(candidate.monthlySalary)}/mo
                  ${!canAfford ? '<br><span style="color: #ef4444;">â ï¸ Cannot afford</span>' : ''}
                  ${!hasCapacity ? '<br><span style="color: #ef4444;">â ï¸ No office capacity</span>' : ''}
                </div>
              </div>
              <div class="hire-btn-cost">${formatCurrency(candidate.monthlySalary)}</div>
            </button>
          `;
        }).join('')}
        ${candidates.length === 0 ? '<div class="empty-state">No candidates available this month. Wait for next month\'s pool refresh.</div>' : ''}
      `;
    }
    
    function updateHireMarketerModalContent() {
      const list = document.getElementById('hireMarketerList');
      const hasCapacity = canHireMoreEmployees();
      const milestone = getCurrentMilestone();
      const daysUntilRefresh = 30 - (currentDay % 30);
      
      // Header with simple company status
      let headerHTML = `
        <div style="background: white; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem;">
          <div style="font-size: 0.75rem; color: #6b7280;">
            <strong style="color: #111827;">Company Status:</strong> ${milestone.badge} ${milestone.name}
          </div>
        </div>
        
        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.25rem;">
          <span>ð</span>
          <span>Pool refreshes in <strong>${daysUntilRefresh} day${daysUntilRefresh > 1 ? 's' : ''}</strong></span>
        </div>
      `;
      
      // Candidate cards in 2x2 grid
      const candidatesHTML = candidatePool.marketers.map((candidate, index) => {
        const canAfford = cash >= candidate.monthlySalary;
        const tier = MARKETER_TIERS[candidate.tier];
        
        return `
          <button 
            class="hire-btn" 
            onclick="showHireConfirmation('${candidate.id}', 'marketer', ${index});"
            ${!canAfford || !hasCapacity ? 'disabled' : ''}
            style="padding: 0.6rem; min-height: auto;"
          >
            <div style="text-align: left;">
              <div style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.4rem;">${candidate.flag || 'ð'} ${candidate.name}</div>
              <div style="display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.8rem;">
                <div><span class="skill-badge skill-${tier.skill}" style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">${tier.name}</span></div>
                <div>â¡ ${Math.round(candidate.efficiency * 100)}% efficiency</div>
                <div style="color: ${!canAfford ? '#dc2626' : '#059669'}; font-weight: 600;">ð¼ ${formatCurrency(candidate.monthlySalary)}/mo</div>
                ${!canAfford ? '<div style="color: #ef4444; font-size: 0.75rem;">â ï¸ Cannot afford</div>' : ''}
                ${!hasCapacity ? '<div style="color: #ef4444; font-size: 0.75rem;">â ï¸ No office capacity</div>' : ''}
              </div>
            </div>
          </button>
        `;
      }).join('');
      
      list.innerHTML = headerHTML + '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">' + candidatesHTML + '</div>';
    }
    
    function showHireMarketerModal() {
      pauseGame(); // Auto-pause when opening modal
      
      // Ensure candidate pool is initialized
      if (candidatePool.marketers.length === 0) {
        generateCandidatePool();
      }
      
      const modal = document.getElementById('hireMarketerModal');
      updateHireMarketerModalContent();
      modal.classList.add('active');
    }
    
    function hideHireMarketerModal() {
      document.getElementById('hireMarketerModal').classList.remove('active');
      startGame(); // Resume game when cancelled
    }
    
    // ========================================
    // MANAGER HIRING FUNCTIONS
    // ========================================
    
    function generateManagerCandidate() {
      const id = nextEmployeeId++;
      
      // Generate name data
      const nameData = generateEmployeeName();
      
      // Manager base efficiency: 50% to 150%
      // Junior: 50-100%, Mid: 100-175%, Senior: 175-250%
      const baseEfficiency = Math.floor(Math.random() * (150 - 50 + 1)) + 50;
      
      // Calculate capacity: 1 employee per 25% efficiency
      const capacity = Math.floor(baseEfficiency / 25);
      
      // Determine tier based on base efficiency
      let tier, tierName;
      if (baseEfficiency < 100) {
        tier = 0;
        tierName = "Junior Manager";
      } else if (baseEfficiency < 175) {
        tier = 1;
        tierName = "Mid Manager";
      } else {
        tier = 2;
        tierName = "Senior Manager";
      }
      
      // Calculate monthly salary: capacity * 2000 with Â±15% variance
      // Example: capacity 3 = 6000 (Â±15%) = 5100-6900
      const baseSalary = capacity * 2000;
      const variance = 0.85 + (Math.random() * 0.30); // 0.85 to 1.15 for Â±15%
      const monthlySalary = Math.round(baseSalary * variance);
      
      return {
        id: id,
        name: nameData.name,
        flag: nameData.flag,
        region: nameData.region,
        role: 'manager',
        tier: tier,
        tierName: tierName,
        baseEfficiency: baseEfficiency,
        efficiency: baseEfficiency,
        capacity: capacity,
        managedEmployees: [],
        monthlySalary: monthlySalary,
        experienceMonths: 0
      };
    }
    
    function showHireManagerModalDirect() {
      // Ensure candidate pool is initialized
      if (candidatePool.managers.length === 0) {
        generateCandidatePool();
      }
      
      const modal = document.getElementById('hireManagerModal');
      updateHireManagerModalContent();
      modal.classList.add('active');
    }
    
    function hideHireManagerModal() {
      document.getElementById('hireManagerModal').classList.remove('active');
      startGame(); // Resume game when cancelled
    }
    
    function updateHireManagerModalContent() {
      const list = document.getElementById('hireManagerList');
      const candidates = candidatePool.managers;
      const hasCapacity = canHireMoreEmployees();
      const daysUntilRefresh = 30 - (currentDay % 30);
      
      list.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <h3 style="margin: 0.5rem 0; color: #1f2937;">Available Managers</h3>
          <p style="margin: 0.5rem 0; color: #6b7280; font-size: 0.9rem;">
            Managers automate employee assignments and rebalancing.
          </p>
          <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.25rem;">
            <span>ð</span>
            <span>Pool refreshes in <strong>${daysUntilRefresh} day${daysUntilRefresh > 1 ? 's' : ''}</strong></span>
          </div>
        </div>
        ${candidates.map((candidate, index) => {
          const canAfford = cash >= candidate.monthlySalary;
          
          return `
            <button 
              class="hire-btn" 
              onclick="showHireConfirmation('${candidate.id}', 'manager', ${index});"
              ${!canAfford || !hasCapacity ? 'disabled' : ''}
              style="width: 100%; margin-bottom: 0.5rem;"
            >
              <div class="hire-btn-info">
                <div class="hire-btn-title">
                  <strong>${candidate.flag} ${candidate.name}</strong>
                </div>
                <div class="hire-btn-stats">
                  <span>ð¼ Efficiency: ${candidate.efficiency}%</span>
                  <span>ð¥ Capacity: ${candidate.capacity} employees</span>
                </div>
              </div>
              <div class="hire-btn-salary">
                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.15rem;">Monthly</div>
                <div style="font-size: 1.1rem; font-weight: 600; color: ${canAfford ? '#10b981' : '#ef4444'};">
                  ${formatCurrency(candidate.monthlySalary)}
                </div>
              </div>
            </button>
          `;
        }).join('')}
        ${!hasCapacity ? '<p style="text-align: center; color: #ef4444; font-size: 0.9rem; margin-top: 1rem;">â ï¸ Office is full! Upgrade your office to hire more employees.</p>' : ''}
      `;
    }
    
    function confirmHireManager(candidateId) {
      const candidate = candidatePool.managers.find(c => c.id.toString() === candidateId);
      if (!candidate) return;
      
      if (cash < candidate.monthlySalary) {
        showNotification('Not enough cash to hire this manager!', 'error');
        return;
      }
      
      if (!canHireMoreEmployees()) {
        showNotification('Office is full! Upgrade your office first.', 'warning');
        return;
      }
      
      // Deduct first month's salary
      cash -= candidate.monthlySalary;
      
      // Add to managers array
      const newManager = {
        id: candidate.id,
        name: candidate.name,
        flag: candidate.flag,
        region: candidate.region,
        role: 'manager',
        tier: candidate.tier,
        tierName: candidate.tierName,
        baseEfficiency: candidate.baseEfficiency,
        efficiency: candidate.efficiency,
        capacity: candidate.capacity,
        managedEmployees: [],
        monthlySalary: candidate.monthlySalary,
        experienceMonths: 0
      };
      
      managers.push(newManager);
      
      // Log event
      logEvent(`ð Hired ${newManager.name} as ${newManager.tierName} (Capacity: ${newManager.capacity})`);
      showNotification(`Hired ${newManager.name} as ${newManager.tierName}!`, 'success');
      
      // Refresh candidate pool
      generateCandidatePool();
      
      // Close modal and update UI
      hideHireManagerModal();
      updateEmployeesUI();
      updateFinancesUI();
    }
    
    // ========================================
    // MANAGE TEAM MODAL (Assign/Unassign Employees to Manager)
    // ========================================
    
    function showManageTeamModal(managerId) {
      pauseGame();
      
      const manager = managers.find(m => m.id === managerId || m.id.toString() === managerId);
      if (!manager) {
        showNotification('Manager not found!', 'error');
        return;
      }
      
      const modal = document.getElementById('manageTeamModal');
      const header = document.getElementById('manageTeamModalHeader');
      const list = document.getElementById('manageTeamList');
      const footer = document.getElementById('manageTeamModalFooter');
      
      // Update header with just manager name
      header.textContent = `ð Manage Team: ${manager.name}`;
      
      // Update footer with Close and Add Selected buttons
      footer.innerHTML = `
        <button class="btn" onclick="hideManageTeamModal()">Close</button>
        <button 
          id="addSelectedBtn"
          class="btn"
          onclick="addSelectedEmployeesToManager('${manager.id}')"
          disabled
          style="background: #9ca3af; color: white; cursor: not-allowed;"
        >
          Add Selected (<span id="selectedCount">0</span>)
        </button>
      `;
      
      // Get all employees (founder + developers + marketers, excluding managers)
      const allEmployees = [
        { ...founder, id: 'founder', displayName: `${founder.name} (Founder)` },
        ...developers.map(d => ({ ...d, displayName: d.name })),
        ...marketers.map(m => ({ ...m, displayName: m.name }))
      ];
      
      // Separate managed and available employees
      // Use type-safe comparison for managerId (could be string or number)
      const managedEmployees = allEmployees.filter(emp => {
        if (!emp.isManaged) return false;
        // Check if this employee is managed by this manager (handle type mismatch)
        return emp.managerId === managerId || 
               emp.managerId?.toString() === managerId?.toString() ||
               manager.managedEmployees.includes(emp.id) ||
               manager.managedEmployees.includes(emp.id?.toString());
      });
      
      const availableEmployees = allEmployees.filter(emp => {
        // Only show employees that are NOT managed by ANY manager
        // Check both emp.isManaged flag and whether they're in any manager's list
        if (emp.isManaged) return false; // Already managed by someone
        
        // Double-check: not in any manager's managedEmployees array
        const isManagedBySomeone = managers.some(mgr => 
          mgr.managedEmployees.includes(emp.id) || 
          mgr.managedEmployees.includes(emp.id?.toString())
        );
        
        return !isManagedBySomeone; // Only show truly unmanaged employees
      });
      
      // Check if manager has capacity (dynamically calculated)
      const currentCapacity = getManagerCapacity(manager);
      const hasCapacity = manager.managedEmployees.length < currentCapacity;
      
      list.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 0.75rem; border-radius: 6px; color: white; margin-bottom: 1rem;">
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">Capacity: <strong>${manager.managedEmployees.length} / ${currentCapacity}</strong></div>
            <div style="font-size: 0.75rem; opacity: 0.9;">Efficiency: ${manager.efficiency}%</div>
          </div>
        </div>
        
        ${availableEmployees.length > 0 ? `
          <div style="margin-bottom: 1.5rem;">
            <h4 style="font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">
              â Available Employees (${availableEmployees.length})
            </h4>
            ${!hasCapacity ? `
              <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                <div style="color: #dc2626; font-size: 0.8rem; font-weight: 600;">â ï¸ Manager at full capacity</div>
                <div style="color: #991b1b; font-size: 0.7rem; margin-top: 0.15rem;">Remove employees or hire a manager with higher capacity.</div>
              </div>
            ` : ''}
            <div style="display: flex; flex-direction: column; gap: 0.35rem; max-height: 250px; overflow-y: auto;">
              ${availableEmployees.map(emp => {
                const isManagedByOther = emp.isManaged && emp.managerId !== managerId;
                const otherManager = isManagedByOther ? managers.find(m => m.id === emp.managerId) : null;
                
                // Get tier name for display
                const tierName = emp.tierName || (emp.role === 'founder' ? 'Founder' : 'Employee');
                
                return `
                  <div 
                    onclick="${hasCapacity && !isManagedByOther ? `toggleEmployeeCheckbox('${emp.id}')` : ''}"
                    style="background: white; border: 1px solid #e5e7eb; border-radius: 4px; padding: 0.5rem; display: flex; align-items: center; gap: 0.5rem; ${!hasCapacity || isManagedByOther ? 'opacity: 0.5;' : 'cursor: pointer;'} transition: background 0.15s;"
                    ${hasCapacity && !isManagedByOther ? `onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'"` : ''}
                  >
                    ${hasCapacity && !isManagedByOther ? `
                      <input 
                        type="checkbox" 
                        class="employee-checkbox" 
                        id="checkbox-${emp.id}"
                        data-employee-id="${emp.id}"
                        onclick="event.stopPropagation()"
                        onchange="updateSelectedCount()"
                        style="width: 16px; height: 16px; cursor: pointer; flex-shrink: 0;"
                      />
                    ` : '<div style="width: 16px; flex-shrink: 0;"></div>'}
                    <div style="flex: 1; min-width: 0; pointer-events: none;">
                      <div style="font-weight: 600; font-size: 0.85rem; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${emp.flag || 'ð¤'} ${emp.displayName} <span style="font-weight: 400; color: #6b7280; font-size: 0.75rem;">(${tierName})</span></div>
                      ${isManagedByOther ? `
                        <div style="font-size: 0.7rem; color: #9ca3af;">
                          ð Managed by ${otherManager ? otherManager.name : 'Another manager'}
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        ` : '<p style="text-align: center; color: #9ca3af; padding: 2rem;">No available employees</p>'}
        
        ${managedEmployees.length > 0 ? `
          <div>
            <h4 style="font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">
              ð¥ Managed Employees (${managedEmployees.length})
            </h4>
            <div style="display: flex; flex-direction: column; gap: 0.35rem; max-height: 250px; overflow-y: auto;">
              ${managedEmployees.map(emp => {
                // Find current assignment
                let assignmentText = 'Unassigned';
                const empId = emp.id === 'founder' || emp.name === founder.name ? 'founder' : emp.id;
                
                const productAssignment = products.find(p => 
                  p.assignedDevelopers.includes(empId) || 
                  p.assignedMarketers.includes(empId) ||
                  p.assignedDevelopers.includes(empId.toString()) || 
                  p.assignedMarketers.includes(empId.toString())
                );
                if (productAssignment) {
                  assignmentText = productAssignment.name;
                } else {
                  const rndAssignment = rndProjects.find(r => 
                    r.assignedDevelopers.includes(empId) ||
                    r.assignedDevelopers.includes(empId.toString())
                  );
                  if (rndAssignment) {
                    assignmentText = `${rndAssignment.name} (R&D)`;
                  }
                }
                
                // Get tier name for display
                const tierName = emp.tierName || (emp.role === 'founder' ? 'Founder' : 'Employee');
                
                return `
                  <div style="background: white; border: 1px solid #e5e7eb; border-radius: 4px; padding: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1; min-width: 0;">
                      <div style="font-weight: 600; font-size: 0.75rem; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${emp.flag || 'ð¤'} ${emp.displayName} <span style="font-weight: 400; color: #6b7280; font-size: 0.7rem;">(${tierName})</span></div>
                      <div style="font-size: 0.7rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ð ${assignmentText}
                      </div>
                    </div>
                    <button 
                      onclick="unassignFromManager('${managerId}', '${emp.id}')"
                      style="padding: 0.3rem 0.6rem; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap; margin-left: 0.5rem;"
                      onmouseover="this.style.background='#dc2626'"
                      onmouseout="this.style.background='#ef4444'"
                    >
                      Remove
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        ` : ''}
      `;
      
      modal.classList.add('active');
      
      // Reset the selected count to 0 (all checkboxes start unchecked)
      // This ensures any browser caching issues are overridden
      setTimeout(() => {
        const countSpan = document.getElementById('selectedCount');
        const addBtn = document.getElementById('addSelectedBtn');
        
        if (countSpan) countSpan.textContent = '0';
        if (addBtn) {
          addBtn.disabled = true;
          addBtn.style.background = '#9ca3af';
          addBtn.style.cursor = 'not-allowed';
          addBtn.onmouseover = null;
          addBtn.onmouseout = null;
        }
        
        // Uncheck all checkboxes explicitly (in case browser cached state)
        document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
          checkbox.checked = false;
        });
      }, 0);
    }
    
    function hideManageTeamModal() {
      document.getElementById('manageTeamModal').classList.remove('active');
      startGame();
    }
    
    function assignToManagerFromModal(managerId, employeeId) {
      const manager = managers.find(m => m.id === managerId || m.id.toString() === managerId);
      if (!manager) {
        showNotification('Manager not found!', 'error');
        return;
      }
      
      // Check capacity (dynamically calculated)
      const currentCapacity = getManagerCapacity(manager);
      if (manager.managedEmployees.length >= currentCapacity) {
        showNotification('Manager is at full capacity!', 'warning');
        return;
      }
      
      // Find employee
      let employee = null;
      if (employeeId === 'founder') {
        employee = founder;
      } else {
        employee = [...developers, ...marketers].find(e => e.id === employeeId || e.id.toString() === employeeId);
      }
      
      if (!employee) {
        showNotification('Employee not found!', 'error');
        return;
      }
      
      // Assign employee to manager
      employee.isManaged = true;
      employee.managerId = managerId;
      
      // Add to manager's list if not already there (check both strict and string comparison)
      const alreadyManaged = manager.managedEmployees.some(id => 
        id === employeeId || id.toString() === employeeId.toString()
      );
      
      if (!alreadyManaged) {
        manager.managedEmployees.push(employeeId);
        console.log(`â Added ${employee.name || founder.name} to ${manager.name}`);
        console.log(`   Manager capacity now: ${manager.managedEmployees.length}/${manager.capacity}`);
        console.log(`   Managed employees:`, manager.managedEmployees);
      }
      
      // Log event
      //logEvent(`ð ${manager.name} now manages ${employee.name || founder.name}`);
      showNotification(`${employee.name || founder.name} assigned to ${manager.name}`, 'success');
      
      // Refresh modal and UI
      showManageTeamModal(managerId);
      updateEmployeesUI();
    }
    
    function unassignFromManager(managerId, employeeId) {
      const manager = managers.find(m => m.id === managerId || m.id.toString() === managerId);
      if (!manager) {
        showNotification('Manager not found!', 'error');
        return;
      }
      
      // Find employee
      let employee = null;
      if (employeeId === 'founder') {
        employee = founder;
      } else {
        employee = [...developers, ...marketers].find(e => e.id === employeeId || e.id.toString() === employeeId);
      }
      
      if (!employee) {
        showNotification('Employee not found!', 'error');
        return;
      }
      
      // Unassign employee
      employee.isManaged = false;
      employee.managerId = null;
      
      // Remove from manager's list (handle both string and number IDs)
      manager.managedEmployees = manager.managedEmployees.filter(id => 
        id !== employeeId && id.toString() !== employeeId.toString()
      );
      
      console.log(`ð Unassigned ${employee.name || founder.name} from ${manager.name}`);
      console.log(`   Manager capacity now: ${manager.managedEmployees.length}/${manager.capacity}`);
      
      // Log event
      //logEvent(`ð ${employee.name || founder.name} removed from ${manager.name}'s team`);
      showNotification(`${employee.name || founder.name} unassigned from ${manager.name}`, 'success');
      
      // Refresh modal and UI
      showManageTeamModal(managerId);
      updateEmployeesUI();
    }
    
    function toggleEmployeeCheckbox(employeeId) {
      const checkbox = document.getElementById(`checkbox-${employeeId}`);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateSelectedCount();
      }
    }
    
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
      const count = checkboxes.length;
      const countSpan = document.getElementById('selectedCount');
      const addBtn = document.getElementById('addSelectedBtn');
      
      if (countSpan) countSpan.textContent = count;
      if (addBtn) {
        if (count > 0) {
          // Enable button - green
          addBtn.disabled = false;
          addBtn.style.background = '#10b981';
          addBtn.style.cursor = 'pointer';
          addBtn.onmouseover = function() { this.style.background = '#059669'; };
          addBtn.onmouseout = function() { this.style.background = '#10b981'; };
        } else {
          // Disable button - grey
          addBtn.disabled = true;
          addBtn.style.background = '#9ca3af';
          addBtn.style.cursor = 'not-allowed';
          addBtn.onmouseover = null;
          addBtn.onmouseout = null;
        }
      }
    }
    
    function addSelectedEmployeesToManager(managerId) {
      const manager = managers.find(m => m.id === managerId || m.id.toString() === managerId);
      if (!manager) {
        showNotification('Manager not found!', 'error');
        return;
      }
      
      // Get all checked checkboxes
      const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
      const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.employeeId);
      
      if (selectedIds.length === 0) {
        showNotification('No employees selected!', 'warning');
        return;
      }
      
      // Check capacity
      const currentCapacity = getManagerCapacity(manager);
      const availableCapacity = currentCapacity - manager.managedEmployees.length;
      
      if (selectedIds.length > availableCapacity) {
        showNotification(`Manager only has capacity for ${availableCapacity} more employee(s)!`, 'warning');
        return;
      }
      
      let successCount = 0;
      
      // Assign each selected employee
      selectedIds.forEach(employeeId => {
        // Find employee
        let employee = null;
        if (employeeId === 'founder') {
          employee = founder;
        } else {
          employee = [...developers, ...marketers].find(e => 
            e.id === employeeId || e.id.toString() === employeeId.toString()
          );
        }
        
        if (employee && !employee.isManaged) {
          // Assign employee to manager
          employee.isManaged = true;
          employee.managerId = managerId;
          
          // Add to manager's list if not already there
          const alreadyManaged = manager.managedEmployees.some(id => 
            id === employeeId || id.toString() === employeeId.toString()
          );
          
          if (!alreadyManaged) {
            manager.managedEmployees.push(employeeId);
            successCount++;
          }
        }
      });
      
      if (successCount > 0) {
        showNotification(`â ${successCount} employee(s) assigned to ${manager.name}`, 'success');
        console.log(`â Bulk assigned ${successCount} employees to ${manager.name}`);
        console.log(`   Manager capacity now: ${manager.managedEmployees.length}/${currentCapacity}`);
      }
      
      // Refresh modal and UI
      showManageTeamModal(managerId);
      updateEmployeesUI();
    }
    
    // ========================================
    // ASSIGN TO MANAGER MODAL (Select Manager for Employee)
    // ========================================
    
    function showAssignToManagerModal(employeeId) {
      pauseGame();
      
      // Find employee
      let employee = null;
      let employeeName = '';
      if (employeeId === 'founder') {
        employee = founder;
        employeeName = `${founder.name} (Founder)`;
      } else {
        employee = [...developers, ...marketers].find(e => e.id === employeeId || e.id.toString() === employeeId);
        if (employee) {
          employeeName = employee.name;
        }
      }
      
      if (!employee) {
        showNotification('Employee not found!', 'error');
        return;
      }
      
      const modal = document.getElementById('assignToManagerModal');
      const header = document.getElementById('assignToManagerModalHeader');
      const list = document.getElementById('assignToManagerList');
      
      header.textContent = `ð Assign ${employeeName}`;
      
      // Check if currently managed (handle both string and number IDs)
      const currentManager = employee.isManaged && employee.managerId 
        ? managers.find(m => 
            m.id === employee.managerId || 
            m.id.toString() === employee.managerId.toString()
          )
        : null;
      
      // Clean up all managers' assignments first to ensure accurate display
      managers.forEach(m => cleanupManagerAssignments(m));
      
      // Get managers with capacity (dynamically calculated)
      // Only show managers who have available capacity OR are the current manager
      const availableManagers = managers
        .map(manager => {
          const currentCapacity = getManagerCapacity(manager);
          const hasCapacity = manager.managedEmployees.length < currentCapacity;
          const isCurrentManager = currentManager && (manager.id === currentManager.id || manager.id.toString() === currentManager.id.toString());
          return {
            ...manager,
            currentCapacity, // Add dynamic capacity to the object
            hasCapacity,
            isCurrentManager
          };
        })
        .filter(manager => manager.hasCapacity || manager.isCurrentManager);
      
      list.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
            <div style="font-size: 0.85rem; color: #6b7280;">
              Select a manager to assign <strong style="color: #111827;">${employeeName}</strong>
            </div>
          </div>
        </div>
        
        ${currentManager ? `
          <div style="background: #fef3c7; border: 1px solid #fcd34d; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
            <div style="color: #92400e; font-size: 0.85rem; font-weight: 600;">
              Currently managed by ${currentManager.name}
            </div>
            <div style="color: #78350f; font-size: 0.75rem; margin-top: 0.25rem;">
              Assigning to another manager will remove from current manager.
            </div>
          </div>
        ` : ''}
        
        ${availableManagers.length > 0 ? `
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            ${availableManagers.map(manager => `
              <div style="background: ${manager.isCurrentManager ? '#f0fdf4' : 'white'}; border: 2px solid ${manager.isCurrentManager ? '#10b981' : '#e5e7eb'}; border-radius: 8px; padding: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                  <div style="font-weight: 600; font-size: 0.95rem; color: #111827;">
                    ${manager.flag} ${manager.name}
                    ${manager.isCurrentManager ? '<span style="margin-left: 0.5rem; font-size: 0.7rem; background: #10b981; color: white; padding: 0.15rem 0.4rem; border-radius: 4px;">CURRENT</span>' : ''}
                  </div>
                </div>
                <div style="display: flex; gap: 0.75rem; font-size: 0.8rem; margin-bottom: 0.75rem;">
                  <div>
                    <span style="color: #6b7280;">Capacity:</span>
                    <strong style="color: ${manager.hasCapacity || manager.isCurrentManager ? '#10b981' : '#ef4444'};">
                      ${manager.managedEmployees.length} / ${manager.currentCapacity}
                    </strong>
                  </div>
                  <div>
                    <span style="color: #6b7280;">Efficiency:</span>
                    <strong style="color: #111827;">${manager.efficiency}%</strong>
                  </div>
                </div>
                ${!manager.hasCapacity && !manager.isCurrentManager ? `
                  <div style="background: #fef2f2; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <div style="color: #dc2626; font-size: 0.75rem; font-weight: 600;">â ï¸ Manager at full capacity</div>
                  </div>
                ` : ''}
                <button 
                  onclick="assignEmployeeToManager('${employeeId}', '${manager.id}')"
                  ${!manager.hasCapacity && !manager.isCurrentManager ? 'disabled' : ''}
                  style="width: 100%; padding: 0.6rem; background: ${!manager.hasCapacity && !manager.isCurrentManager ? '#e5e7eb' : manager.isCurrentManager ? '#10b981' : 'linear-gradient(135deg, #667eea, #764ba2)'}; color: ${!manager.hasCapacity && !manager.isCurrentManager ? '#9ca3af' : 'white'}; border: none; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: ${!manager.hasCapacity && !manager.isCurrentManager ? 'not-allowed' : 'pointer'};"
                  ${!manager.hasCapacity && !manager.isCurrentManager ? '' : 'onmouseover="this.style.opacity=\'0.9\'" onmouseout="this.style.opacity=\'1\'"'}
                >
                  ${manager.isCurrentManager ? 'â Keep Assignment' : 'Assign to this Manager'}
                </button>
              </div>
            `).join('')}
          </div>
        ` : '<p style="text-align: center; color: #9ca3af; padding: 2rem;">No managers available</p>'}
        
        ${employee.isManaged ? `
          <div style="margin-top: 1rem;">
            <button 
              onclick="removeEmployeeFromAllManagers('${employeeId}')"
              style="width: 100%; padding: 0.6rem; background: #ef4444; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer;"
              onmouseover="this.style.background='#dc2626'"
              onmouseout="this.style.background='#ef4444'"
            >
              ð« Remove from Manager
            </button>
          </div>
        ` : ''}
      `;
      
      modal.classList.add('active');
    }
    
    function hideAssignToManagerModal() {
      document.getElementById('assignToManagerModal').classList.remove('active');
      startGame();
    }
    
    // Cleanup function to remove invalid/orphaned employee IDs from manager's list
    function cleanupManagerAssignments(manager) {
      if (!manager || !manager.managedEmployees) return;
      
      // Get all employees (including founder)
      const allEmployees = [founder, ...developers, ...marketers];
      
      // Store original count
      const beforeCount = manager.managedEmployees.length;
      
      // Remove IDs that either:
      // 1. Don't correspond to any real employee, OR
      // 2. Correspond to an employee who is NOT actually managed by this manager
      manager.managedEmployees = manager.managedEmployees.filter(id => {
        // Find the employee with this ID (handle both string and number)
        const employee = allEmployees.find(e => 
          e.id === id || 
          e.id.toString() === id.toString()
        );
        
        // If employee doesn't exist at all, remove the ID
        if (!employee) {
          console.log(`ð§¹ Removing non-existent employee ID from ${manager.name}: ${id} (type: ${typeof id})`);
          return false;
        }
        
        // If employee exists but is NOT managed by this manager, remove the ID
        if (!employee.isManaged || (employee.managerId !== manager.id && employee.managerId?.toString() !== manager.id?.toString())) {
          console.log(`ð§¹ Removing unmanaged employee from ${manager.name}: ${employee.name || 'Founder'} (ID: ${id})`);
          return false;
        }
        
        // Employee exists AND is managed by this manager - keep the ID
        return true;
      });
      
      const afterCount = manager.managedEmployees.length;
      const removed = beforeCount - afterCount;
      
      if (removed > 0) {
        console.log(`â Cleaned up ${manager.name}: removed ${removed} invalid ID(s), now ${afterCount}/${getManagerCapacity(manager)} capacity`);
        logEvent(`ð§¹ Fixed ${manager.name}'s team count (was ${beforeCount}, now ${afterCount})`);
      }
    }
    
    function assignEmployeeToManager(employeeId, managerId) {
      const manager = managers.find(m => m.id === managerId || m.id.toString() === managerId);
      if (!manager) {
        showNotification('Manager not found!', 'error');
        return;
      }
      
      // Clean up manager's list before assignment to fix any previous bugs
      cleanupManagerAssignments(manager);
      
      // Find employee
      let employee = null;
      if (employeeId === 'founder') {
        employee = founder;
      } else {
        employee = [...developers, ...marketers].find(e => e.id === employeeId || e.id.toString() === employeeId);
      }
      
      if (!employee) {
        showNotification('Employee not found!', 'error');
        return;
      }
      
      // Check if already assigned to this manager
      if (employee.isManaged && employee.managerId === managerId) {
        hideAssignToManagerModal();
        showNotification(`${employee.name || founder.name} is already managed by ${manager.name}`, 'info');
        return;
      }
      
      // Remove from previous manager if managed
      if (employee.isManaged && employee.managerId) {
        const oldManager = managers.find(m => m.id === employee.managerId || m.id.toString() === employee.managerId.toString());
        if (oldManager) {
          // Clean up old manager's list first
          cleanupManagerAssignments(oldManager);
          
          // Handle both string and number IDs
          oldManager.managedEmployees = oldManager.managedEmployees.filter(id => 
            id !== employeeId && id.toString() !== employeeId.toString()
          );
          console.log(`ð Moved ${employee.name || founder.name} from ${oldManager.name} (${oldManager.managedEmployees.length}/${oldManager.capacity})`);
          logEvent(`ð ${employee.name || founder.name} removed from ${oldManager.name}'s team`);
        }
      }
      
      // Check capacity (dynamically calculated)
      const currentCapacity = getManagerCapacity(manager);
      if (manager.managedEmployees.length >= currentCapacity) {
        showNotification('Manager is at full capacity!', 'warning');
        return;
      }
      
      // Assign employee to new manager
      employee.isManaged = true;
      employee.managerId = managerId;
      
      // Add to manager's list if not already there (check both strict and string comparison)
      const alreadyManaged = manager.managedEmployees.some(id => 
        id === employeeId || id.toString() === employeeId.toString()
      );
      
      if (!alreadyManaged) {
        manager.managedEmployees.push(employeeId);
        console.log(`â Added ${employee.name || founder.name} to ${manager.name}`);
        console.log(`   Manager capacity now: ${manager.managedEmployees.length}/${manager.capacity}`);
        console.log(`   Managed employees:`, manager.managedEmployees);
      }
      
      // Log event
      logEvent(`ð ${manager.name} now manages ${employee.name || founder.name}`);
      showNotification(`${employee.name || founder.name} assigned to ${manager.name}`, 'success');
      
      // Close modal and update UI
      hideAssignToManagerModal();
      updateEmployeesUI();
    }
    
    function removeEmployeeFromAllManagers(employeeId) {
      console.log(`\nð removeEmployeeFromAllManagers called with employeeId: ${employeeId} (type: ${typeof employeeId})`);
      
      // Find employee
      let employee = null;
      if (employeeId === 'founder') {
        employee = founder;
      } else {
        employee = [...developers, ...marketers].find(e => e.id === employeeId || e.id.toString() === employeeId.toString());
      }
      
      if (!employee) {
        console.error(`â Employee not found with ID: ${employeeId}`);
        showNotification('Employee not found!', 'error');
        return;
      }
      
      console.log(`â Found employee: ${employee.name || founder.name}`);
      console.log(`  - isManaged: ${employee.isManaged}`);
      console.log(`  - managerId: ${employee.managerId} (type: ${typeof employee.managerId})`);
      
      // Find and remove from current manager
      if (employee.isManaged && employee.managerId) {
        console.log(`\nð Looking for manager with ID: ${employee.managerId}`);
        console.log(`  Available managers:`, managers.map(m => `${m.name} (id: ${m.id}, type: ${typeof m.id})`));
        
        // Find manager (handle both string and number IDs)
        const manager = managers.find(m => 
          m.id === employee.managerId || 
          m.id.toString() === employee.managerId.toString()
        );
        
        if (manager) {
          // Clean up manager's list first to fix any previous bugs
          cleanupManagerAssignments(manager);
          console.log(`â Found manager: ${manager.name}`);
          console.log(`  - Current managedEmployees:`, manager.managedEmployees);
          console.log(`  - Current capacity: ${manager.managedEmployees.length}/${getManagerCapacity(manager)}`);
          
          // Remove from manager's list (handle both string and number IDs)
          const beforeCount = manager.managedEmployees.length;
          manager.managedEmployees = manager.managedEmployees.filter(id => 
            id !== employeeId && id.toString() !== employeeId.toString()
          );
          const afterCount = manager.managedEmployees.length;
          
          console.log(`  - After removal:`, manager.managedEmployees);
          console.log(`  - New capacity: ${afterCount}/${getManagerCapacity(manager)}`);
          console.log(`  - Removed: ${beforeCount - afterCount} employee(s)`);
          
          if (beforeCount === afterCount) {
            console.warn(`â ï¸ WARNING: Employee was NOT removed from manager's list! ID mismatch?`);
            console.warn(`  - Looking for: ${employeeId} (type: ${typeof employeeId})`);
            console.warn(`  - In array:`, manager.managedEmployees.map(id => `${id} (type: ${typeof id})`));
          }
          
          logEvent(`ð ${employee.name || founder.name} removed from ${manager.name}'s team`);
        } else {
          console.error(`â Manager with ID ${employee.managerId} not found!`);
          console.error(`  Employee managerId: ${employee.managerId} (type: ${typeof employee.managerId})`);
          console.error(`  Available manager IDs:`, managers.map(m => `${m.id} (type: ${typeof m.id})`));
        }
      } else {
        console.log(`â­ï¸ Skipping manager removal - employee not managed or no managerId`);
      }
      
      // Unassign employee
      console.log(`\nâï¸ Clearing employee management flags`);
      employee.isManaged = false;
      employee.managerId = null;
      console.log(`  - isManaged set to: ${employee.isManaged}`);
      console.log(`  - managerId set to: ${employee.managerId}`);
      
      //showNotification(`${employee.name || founder.name} removed from manager`, 'success');
      
      // Close modal and update UI
      console.log(`\nð Updating UI...`);
      hideAssignToManagerModal();
      updateEmployeesUI();
      console.log(`â removeEmployeeFromAllManagers completed\n`);
    }
    
    function showMarketerCandidates(tierIndex) {
      const modal = document.getElementById('hireMarketerModal');
      const list = document.getElementById('hireMarketerList');
      const tier = MARKETER_TIERS[tierIndex];
      const candidates = marketerCandidates[tierIndex] || [];
      
      list.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <button 
            onclick="showHireMarketerModal()" 
            class="btn"
            style="padding: 0.4rem 0.8rem; font-size: 0.9rem; margin-bottom: 0.5rem;"
          >
            â Back to Tiers
          </button>
          <h3 style="margin: 0.5rem 0; color: #1f2937;">Available ${tier.name}s</h3>
          <p style="margin: 0.5rem 0; color: #6b7280; font-size: 0.9rem;">
            Select a candidate to review their details. Pool refreshes monthly.
          </p>
        </div>
        ${candidates.map(candidate => {
          const canAfford = cash >= candidate.monthlySalary;
          const hasCapacity = canHireMoreEmployees();
          
          return `
            <button 
              class="hire-btn" 
              onclick="showHireConfirmation('${candidate.id}', 'marketer', ${tierIndex});"
              ${!canAfford || !hasCapacity ? 'disabled' : ''}
              style="width: 100%; margin-bottom: 0.5rem;"
            >
              <div class="hire-btn-info">
                <div class="hire-btn-title">
                  <strong>${candidate.name}</strong>
                </div>
                <div class="hire-btn-stats">
                  â¡ ${Math.round(candidate.efficiency * 100)}% efficiency â¢ ð¼ ${formatCurrency(candidate.monthlySalary)}/mo
                  ${!canAfford ? '<br><span style="color: #ef4444;">â ï¸ Cannot afford</span>' : ''}
                  ${!hasCapacity ? '<br><span style="color: #ef4444;">â ï¸ No office capacity</span>' : ''}
                </div>
              </div>
              <div class="hire-btn-cost">${formatCurrency(candidate.monthlySalary)}</div>
            </button>
          `;
        }).join('')}
        ${candidates.length === 0 ? '<div class="empty-state">No candidates available this month. Wait for next month\'s pool refresh.</div>' : ''}
      `;
    }
    
    // ============================================
    // HIRE CONFIRMATION MODAL
    // ============================================
    
    function showHireConfirmation(candidateId, role, candidateIndex) {
      // Use new candidate pool structure - directly access by index
      let candidates, candidate;
      
      if (role === 'developer') {
        candidates = candidatePool.developers;
      } else if (role === 'marketer') {
        candidates = candidatePool.marketers;
      } else if (role === 'manager') {
        candidates = candidatePool.managers;
      }
      
      candidate = candidates[candidateIndex];
      
      if (!candidate) {
        console.error('Candidate not found at index:', candidateIndex, 'role:', role);
        return;
      }
      
      candidateToHire = { ...candidate, candidateIndex, role };
      
      const modal = document.getElementById('hireConfirmModal');
      
      document.getElementById('hireConfirmName').textContent = `${candidate.flag || 'ð'} ${candidate.name}`;
      document.getElementById('hireConfirmRole').textContent = candidate.tierName || `Manager (Capacity: ${candidate.capacity})`;
      document.getElementById('hireConfirmEfficiency').textContent = `${Math.round(candidate.efficiency * 100)}%`;
      document.getElementById('hireConfirmSalary').textContent = `${formatCurrency(candidate.monthlySalary)}/month`;
      
      modal.classList.add('active');
    }
    
    function hideHireConfirmModal() {
      document.getElementById('hireConfirmModal').classList.remove('active');
      candidateToHire = null;
    }
    
    function confirmHireCandidate() {
      if (!candidateToHire) return;
      
      const candidate = candidateToHire;
      
      // Hide confirmation modal
      hideHireConfirmModal();
      
      // Call hireFromPool with the stored candidateIndex and role
      hireFromPool(candidate.candidateIndex, candidate.role);
    }
    
    // ============================================
    // TOGGLE TEAM SECTION
    // ============================================
    
    // Track expanded team sections to preserve state across UI updates
    let expandedTeamSections = {};
    
    function toggleTeamSection(sectionId) {
      const content = document.getElementById(sectionId);
      const toggle = document.getElementById('toggle-' + sectionId);
      
      if (content && toggle) {
        const isExpanded = content.classList.toggle('expanded');
        toggle.classList.toggle('expanded');
        
        // Save state
        expandedTeamSections[sectionId] = isExpanded;
      }
    }
    
    // ============================================
    // TEAM COMMUNICATION OVERHEAD PENALTY SYSTEM
    // ============================================
    
    // Calculate team communication overhead penalty
    // Formula: (teamSize - 1) Ã 6%, capped at 90%
    function getTeamOverheadPenalty(teamSize) {
      if (teamSize <= 1) return 0;
      return Math.min(0.90, (teamSize - 1) * 0.06);
    }
    
    // Calculate effective efficiency for a team member
    function getEffectiveEfficiency(baseEfficiency, teamSize) {
      const penalty = getTeamOverheadPenalty(teamSize);
      return baseEfficiency * (1 - penalty);
    }
    
    // Get penalty icon color based on penalty percentage
    function getPenaltyIconColor(penalty) {
      if (penalty < 0.15) return 'grey';
      if (penalty < 0.30) return 'orange';
      return 'red';
    }
    
    // Show penalty popup
    function showPenaltyPopup(teamSize, penaltyPercent) {
      const overlay = document.getElementById('teamPenaltyPopupOverlay');
      const popup = document.getElementById('teamPenaltyPopup');
      const title = document.getElementById('penaltyPopupTitle');
      
      if (overlay && popup && title) {
        title.textContent = `Team penalty: ${penaltyPercent}%`;
        overlay.classList.add('active');
        popup.style.display = 'block';
      }
    }
    
    // Hide penalty popup
    function hidePenaltyPopup() {
      const overlay = document.getElementById('teamPenaltyPopupOverlay');
      const popup = document.getElementById('teamPenaltyPopup');
      if (overlay && popup) {
        overlay.classList.remove('active');
        popup.style.display = 'none';
      }
    }
    
    // Generate penalty icon HTML
    function generatePenaltyIcon(teamSize) {
      if (teamSize <= 1) return '';
      
      const penalty = getTeamOverheadPenalty(teamSize);
      const penaltyPercent = Math.round(penalty * 100);
      const colorClass = getPenaltyIconColor(penalty);
      
      return `<span class="team-penalty-icon ${colorClass}" 
                    onclick="event.stopPropagation(); showPenaltyPopup(${teamSize}, ${penaltyPercent})">?</span>`;
    }
    
    // ASSIGN DEVELOPER/MARKETER TO PRODUCT MODALS
    // ============================================
    
    let currentAssignProductId = null;
    let currentAssignRndProjectId = null;
    
    // Track selected employees for batch assignment
    let selectedDevelopersForProduct = new Set();
    let selectedMarketersForProduct = new Set();
    let selectedDevelopersForRnd = new Set();
    
    function showAssignDeveloperModal(productId) {
      pauseGame(); // Auto-pause when opening modal
      currentAssignProductId = productId;
      selectedDevelopersForProduct.clear(); // Reset selection
      updateAssignDevelopersButton();
      
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      const modal = document.getElementById('assignDeveloperModal');
      const list = document.getElementById('assignDeveloperList');
      const productNameEl = document.getElementById('assignDeveloperProductName');
      
      productNameEl.textContent = `Select one or more developers to assign to "${product.name}"`;
      
      // Get available developers (not assigned to ANY product or R&D project)
      const availableDevelopers = [];
      
      // Founder (only show if not assigned to any product or R&D)
      const founderAssignment = getFounderAssignment();
      if (!founderAssignment) {
        availableDevelopers.push({
          id: 'founder',
          name: founder.name,
          role: 'Founder',
          efficiency: founder.efficiency,
          isFounder: true
        });
      }
      
      // Hired developers (only show if not assigned to ANY product or R&D)
      developers.forEach(dev => {
        const devAssignment = getDevAssignment(dev.id);
        if (!devAssignment) {
          availableDevelopers.push({
            id: dev.id,
            name: dev.name,
            role: dev.tierName,
            efficiency: dev.efficiency,
            isFounder: false
          });
        }
      });
      
      if (availableDevelopers.length === 0) {
        list.innerHTML = '<div class="empty-state">No available developers. All developers are currently assigned to other products or R&D projects. Unassign them first to reassign.</div>';
      } else {
        list.innerHTML = availableDevelopers.map(dev => {
          const devIdStr = typeof dev.id === 'string' ? `'${dev.id}'` : dev.id;
          return `
            <div class="employee-card-selectable" onclick="toggleDeveloperSelection(${devIdStr})" id="dev-card-${dev.id}">
              <input type="checkbox" class="employee-checkbox" id="dev-checkbox-${dev.id}" onchange="toggleDeveloperSelection(${devIdStr})" onclick="event.stopPropagation();">
              <div class="employee-card-info">
                <div class="hire-btn-header">
                  <span class="hire-btn-title">ð¨âð» ${dev.name}</span>
                  <span class="hire-btn-role">${dev.role}</span>
                </div>
                <div class="hire-btn-details">
                  <span>â¡ Efficiency: ${Math.round(dev.efficiency * 100)}%</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      modal.classList.add('active');
    }
    
    function hideAssignDeveloperModal() {
      document.getElementById('assignDeveloperModal').classList.remove('active');
      currentAssignProductId = null;
      selectedDevelopersForProduct.clear();
      startGame(); // Resume game when cancelled
    }
    
    function toggleDeveloperSelection(devId) {
      if (selectedDevelopersForProduct.has(devId)) {
        selectedDevelopersForProduct.delete(devId);
      } else {
        selectedDevelopersForProduct.add(devId);
      }
      
      // Update UI
      const card = document.getElementById('dev-card-' + devId);
      const checkbox = document.getElementById('dev-checkbox-' + devId);
      if (card && checkbox) {
        if (selectedDevelopersForProduct.has(devId)) {
          card.classList.add('selected');
          checkbox.checked = true;
        } else {
          card.classList.remove('selected');
          checkbox.checked = false;
        }
      }
      
      updateAssignDevelopersButton();
    }
    
    function updateAssignDevelopersButton() {
      const btn = document.getElementById('assignSelectedDevelopersBtn');
      const count = document.getElementById('selectedDevelopersCount');
      if (btn && count) {
        count.textContent = selectedDevelopersForProduct.size;
        btn.disabled = selectedDevelopersForProduct.size === 0;
      }
    }
    
    function showAssignMarketerModal(productId) {
      pauseGame(); // Auto-pause when opening modal
      currentAssignProductId = productId;
      selectedMarketersForProduct.clear(); // Reset selection
      updateAssignMarketersButton();
      
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      const modal = document.getElementById('assignMarketerModal');
      const list = document.getElementById('assignMarketerList');
      const productNameEl = document.getElementById('assignMarketerProductName');
      
      productNameEl.textContent = `Select one or more marketers to assign to "${product.name}"`;
      
      // Get available marketers (not assigned to ANY product or R&D)
      const availableMarketers = [];
      
      // Founder (only show if not assigned to any product or R&D project)
      const founderAssignment = getFounderAssignment();
      if (!founderAssignment) {
        availableMarketers.push({
          id: 'founder',
          name: founder.name,
          role: 'Founder',
          efficiency: founder.efficiency,
          isFounder: true
        });
      }
      
      // Hired marketers (only show if not assigned to ANY product)
      marketers.forEach(mkt => {
        const isAssignedAnywhere = products.some(p => p.assignedMarketers.includes(mkt.id));
        if (!isAssignedAnywhere) {
          availableMarketers.push({
            id: mkt.id,
            name: mkt.name,
            role: mkt.tierName,
            efficiency: mkt.efficiency,
            isFounder: false
          });
        }
      });
      
      if (availableMarketers.length === 0) {
        list.innerHTML = '<div class="empty-state">No available marketers. All marketers are currently assigned to other products. Unassign them first to reassign.</div>';
      } else {
        list.innerHTML = availableMarketers.map(mkt => {
          const mktIdStr = typeof mkt.id === 'string' ? `'${mkt.id}'` : mkt.id;
          return `
            <div class="employee-card-selectable" onclick="toggleMarketerSelection(${mktIdStr})" id="mkt-card-${mkt.id}">
              <input type="checkbox" class="employee-checkbox" id="mkt-checkbox-${mkt.id}" onchange="toggleMarketerSelection(${mktIdStr})" onclick="event.stopPropagation();">
              <div class="employee-card-info">
                <div class="hire-btn-header">
                  <span class="hire-btn-title">ð¢ ${mkt.name}</span>
                  <span class="hire-btn-role">${mkt.role}</span>
                </div>
                <div class="hire-btn-details">
                  <span>â¡ Efficiency: ${Math.round(mkt.efficiency * 100)}%</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      modal.classList.add('active');
    }
    
    function hideAssignMarketerModal() {
      document.getElementById('assignMarketerModal').classList.remove('active');
      currentAssignProductId = null;
      selectedMarketersForProduct.clear();
      startGame(); // Resume game when cancelled
    }
    
    function toggleMarketerSelection(mktId) {
      if (selectedMarketersForProduct.has(mktId)) {
        selectedMarketersForProduct.delete(mktId);
      } else {
        selectedMarketersForProduct.add(mktId);
      }
      
      // Update UI
      const card = document.getElementById('mkt-card-' + mktId);
      const checkbox = document.getElementById('mkt-checkbox-' + mktId);
      if (card && checkbox) {
        if (selectedMarketersForProduct.has(mktId)) {
          card.classList.add('selected');
          checkbox.checked = true;
        } else {
          card.classList.remove('selected');
          checkbox.checked = false;
        }
      }
      
      updateAssignMarketersButton();
    }
    
    function updateAssignMarketersButton() {
      const btn = document.getElementById('assignSelectedMarketersBtn');
      const count = document.getElementById('selectedMarketersCount');
      if (btn && count) {
        count.textContent = selectedMarketersForProduct.size;
        btn.disabled = selectedMarketersForProduct.size === 0;
      }
    }
    
    // Batch assignment functions
    function assignSelectedDevelopers() {
      if (!currentAssignProductId || selectedDevelopersForProduct.size === 0) return;
      
      selectedDevelopersForProduct.forEach(devId => {
        if (devId === 'founder') {
          assignFounderToProduct(currentAssignProductId);
        } else {
          assignEmployeeToProduct(devId, currentAssignProductId);
        }
      });
      
      hideAssignDeveloperModal();
      updateProductsUI();
    }
    
    function assignSelectedMarketers() {
      if (!currentAssignProductId || selectedMarketersForProduct.size === 0) return;
      
      selectedMarketersForProduct.forEach(mktId => {
        if (mktId === 'founder') {
          assignFounderToProductAsMarketer(currentAssignProductId);
        } else {
          assignEmployeeToProduct(mktId, currentAssignProductId);
        }
      });
      
      hideAssignMarketerModal();
      updateProductsUI();
    }
    
    function assignSelectedToRnd() {
      if (!currentAssignRndProjectId || selectedDevelopersForRnd.size === 0) return;
      
      const project = rndProjects.find(p => p.id === currentAssignRndProjectId);
      if (!project) return;
      
      selectedDevelopersForRnd.forEach(devId => {
        if (!project.assignedDevelopers.includes(devId)) {
          project.assignedDevelopers.push(devId);
          
          const devName = devId === 'founder' ? founder.name : developers.find(d => d.id === devId)?.name;
          //logEvent(`ð¨âð» ${devName} assigned to R&D: ${project.name}`);
        }
      });
      
      hideAssignToRndModal();
      updateRndUI();
    }
    
    function canAffordOfficeUpgrade() {
      if (currentOfficeTier >= OFFICE_TIERS.length - 1) return false;
      const nextTier = OFFICE_TIERS[currentOfficeTier + 1];
      const cost = currency === "USD" ? nextTier.monthlyRentUSD * 2 : nextTier.monthlyRentEUR * 2;
      return cash >= cost;
    }
    
    function handleMonthlyBilling() {
      const month = Math.floor(currentDay / 30);
      //logEvent(`ð Month ${month} completed - Processing monthly billing...`);
      
      // Refresh candidate pools for new month
      refreshCandidatePools();
      
      // ============================================
      // REVENUE COLLECTION
      // ============================================
      
      // Calculate monthly revenue from all products (published and deprecated)
      let totalRevenue = 0;
      
      products.forEach(product => {
        if (product.status === 'published' || product.status === 'deprecated') {
          const productRevenue = product.subscribers * product.monthlyPrice;
          totalRevenue += productRevenue;
        }
      });
      
      cash += totalRevenue;
      
      // Track lifetime earnings and check for milestone achievements
      const previousLifetimeEarnings = lifetimeEarnings;
      if (totalRevenue > 0) {
        lifetimeEarnings += totalRevenue;
        
        // Check if we reached a new milestone
        checkMilestoneAchievement(previousLifetimeEarnings, lifetimeEarnings);
      }
      
      // ============================================
      // CLEANUP: REMOVE OLD DEPRECATED PRODUCTS
      // ============================================
      
      // Remove products that have been deprecated for more than 365 days
      const productsBeforeCleanup = products.length;
      products = products.filter(product => {
        // Keep all non-deprecated products
        if (product.status !== 'deprecated') return true;
        
        // Keep deprecated products that are less than 365 days old
        const daysSinceDeprecation = currentDay - (product.deprecationDate || 0);
        return daysSinceDeprecation < 365;
      });
      
      const removedCount = productsBeforeCleanup - products.length;
      if (removedCount > 0) {
        logEvent(`ðï¸ Removed ${removedCount} old deprecated product(s) (deprecated > 1 year)`);
      }
      
      // ============================================
      // EXPENSE PAYMENTS
      // ============================================
      
      // Calculate office costs
      const office = OFFICE_TIERS[currentOfficeTier];
      const teamSize = getCurrentTeamSize();
      
      const rent = currency === "USD" ? office.monthlyRentUSD : office.monthlyRentEUR;
      const utilitiesBase = currency === "USD" ? office.utilitiesBaseUSD : office.utilitiesBaseEUR;
      const utilitiesPerPerson = currency === "USD" ? office.utilitiesPerPersonUSD : office.utilitiesPerPersonEUR;
      const utilities = utilitiesBase + (utilitiesPerPerson * teamSize);
      
      // Calculate insurance (2% of gross revenue + base per employee)
      const insuranceBase = currency === "USD" ? 100 : 90;
      const insurance = (totalRevenue * 0.02) + (insuranceBase * (developers.length + marketers.length + managers.length));
      
      // Calculate total salaries (including managers)
      const salaries = [...developers, ...marketers, ...managers].reduce((sum, emp) => sum + emp.monthlySalary, 0);
      
      // Calculate server hosting fee
      const server = SERVER_TIERS[currentServerTier];
      const serverFee = currency === "USD" ? server.monthlyFeeUSD : server.monthlyFeeEUR;
      
      // Deduct costs
      const totalCosts = rent + utilities + insurance + salaries + serverFee;
      cash -= totalCosts;
      
      // ============================================
      // CONSOLIDATED LOGGING
      // ============================================
      
      // Log revenue (consolidated)
      if (totalRevenue > 0) {
        logEvent(`ðµ Monthly Income: ${formatCurrency(totalRevenue)}`);
      }
      
      // Log expenses (consolidated)
      const expenseBreakdown = [];
      if (rent > 0) expenseBreakdown.push(`Rent: ${formatCurrency(rent)}`);
      expenseBreakdown.push(`Utilities: ${formatCurrency(utilities)}`);
      if (insurance > 0) expenseBreakdown.push(`Insurance: ${formatCurrency(insurance)}`);
      if (salaries > 0) expenseBreakdown.push(`Salaries: ${formatCurrency(salaries)}`);
      if (serverFee > 0) expenseBreakdown.push(`Server: ${formatCurrency(serverFee)}`);
      
      logEvent(`ð° Monthly Expenses: ${formatCurrency(totalCosts)} `); //(${expenseBreakdown.join(', ')})
      
      // Log net result
      const netResult = totalRevenue - totalCosts;
      if (netResult >= 0) {
        logEvent(`â Net Profit: ${formatCurrency(netResult)}`);
      } else {
        logEvent(`â ï¸ Net Loss: ${formatCurrency(Math.abs(netResult))}`);
      }
      
      // ============================================
      // MANAGER EFFICIENCY GROWTH
      // ============================================
      
      managers.forEach(manager => {
        // Skip if manager is already ready for promotion (waiting for negotiation)
        if (manager.readyForPromotion) return;
        
        // Managers gain 1% efficiency per billing cycle (month)
        const previousEfficiency = manager.efficiency;
        const previousCapacity = Math.floor(previousEfficiency / 25);
        
        // Increase efficiency by 1%, capped at efficiencyCap (250%)
        manager.efficiency = Math.min(manager.efficiency + 1, manager.efficiencyCap || 250);
        
        const newCapacity = Math.floor(manager.efficiency / 25);
        
        // Check if capacity increased (every 25% efficiency)
        if (newCapacity > previousCapacity) {
          // Manager is ready for promotion (salary negotiation)
          manager.readyForPromotion = true;
          manager.promotionAttempts = 0; // Reset attempts counter
          manager.proposedSalary = calculateManagerPromotionSalary(manager, newCapacity, previousCapacity);
          
          logEvent(`ð¯ ${manager.name} (Manager) is ready for promotion! Capacity: ${previousCapacity} â ${newCapacity}`);
        }
      });
      
      updateCashDisplay();
      updateEmployeesUI(); // Update to show promotion indicators
    }

    // ============================================
    // NEW GAME SETUP
    // ============================================
    
    function generateRandomCompanyName() {
      const prefix = COMPANY_PREFIXES[Math.floor(Math.random() * COMPANY_PREFIXES.length)];
      const suffix = COMPANY_SUFFIXES[Math.floor(Math.random() * COMPANY_SUFFIXES.length)];
      return `${prefix} ${suffix}`;
    }
    
    function generateRandomFounderName() {
      const nameData = generateNameFromRegion();
      return nameData.name; // Return just the name string for the input field
    }
    
    function populateNewGameForm() {
      document.getElementById('companyNameInput').value = generateRandomCompanyName();
      document.getElementById('founderNameInput').value = generateRandomFounderName();
    }
    
    function showGameOver() {
      // Update game over modal with final stats
      document.getElementById('gameOverDays').textContent = currentDay + ' days';
      document.getElementById('gameOverProducts').textContent = products.length;
      document.getElementById('gameOverTeam').textContent = getCurrentTeamSize();
      document.getElementById('gameOverCash').textContent = formatCurrency(cash);
      
      // Show modal
      document.getElementById('gameOverModal').classList.add('active');
    }
    
    function restartGame() {
      // Hide game over modal
      document.getElementById('gameOverModal').classList.remove('active');
      
      // Show new game setup modal
      document.getElementById('newGameModal').classList.add('active');
      
      // Populate form with random names
      populateNewGameForm();
    }
    
    // ============================================
    // SAVE/LOAD SYSTEM
    // ============================================
    
    function saveGame() {
      const saveData = {
        version: "3.1", // Updated to 3.1 for manager system
        timestamp: Date.now(),
        gameState: {
          // Game config
          currency: currency,
          currentDay: currentDay,
          cash: cash,
          lifetimeEarnings: lifetimeEarnings,
          companyName: companyName,
          isPlaying: isPlaying,
          gameSpeed: gameSpeed,
          
          // Founder
          founder: {
            name: founder.name,
            efficiency: founder.efficiency,
            baseEfficiency: founder.baseEfficiency,
            experienceMonths: founder.experienceMonths,
            assignedProduct: founder.assignedProduct
          },
          
          // Infrastructure
          currentOfficeTier: currentOfficeTier,
          currentServerTier: currentServerTier,
          
          // Entities
          products: products,
          developers: developers,
          marketers: marketers,
          managers: managers,
          
          // R&D System
          rndProjects: rndProjects,
          completedRndProjects: completedRndProjects,
          unlockedProducts: unlockedProducts,
          
          // IDs
          nextProductId: nextProductId,
          nextEmployeeId: nextEmployeeId,
          nextRndProjectId: nextRndProjectId,
          
          // UI State
          expandedTeamSections: expandedTeamSections,
          currentProductFilter: currentProductFilter,
          expandedProductCards: expandedProductCards,
          currentEmployeeFilter: currentEmployeeFilter,
          expandedEmployeeCards: expandedEmployeeCards,
          
          // Candidate Pools (OLD SYSTEM)
          developerCandidates: developerCandidates,
          marketerCandidates: marketerCandidates,
          lastCandidateRefresh: lastCandidateRefresh,
          
          // NEW Candidate Pool System
          candidatePool: candidatePool,
          
          // Event log (keep last 50 events)
          eventLog: eventLog.slice(-50)
        }
      };
      
      try {
        localStorage.setItem('softwareCompanyGame', JSON.stringify(saveData));
        //logEvent("ð¾ Game saved!");
        
        return true;
      } catch (e) {
        //logEvent("â Failed to save game: " + e.message);
        alert("Failed to save game. Your browser might have storage disabled.");
        return false;
      }
    }
    
    function loadGame() {
      try {
        const savedData = localStorage.getItem('softwareCompanyGame');
        if (!savedData) {
          return false; // No save found
        }
        
        const save = JSON.parse(savedData);
        
        // Validate save version
        if (!save.version || !save.gameState) {
          console.error("Invalid save format");
          return false;
        }
        
        // Restore game state
        currency = save.gameState.currency;
        currentDay = save.gameState.currentDay;
        cash = save.gameState.cash;
        lifetimeEarnings = save.gameState.lifetimeEarnings || 0;
        companyName = save.gameState.companyName;
        isPlaying = save.gameState.isPlaying || false;
        gameSpeed = save.gameState.gameSpeed || 1;
        
        // Restore founder
        founder.name = save.gameState.founder.name;
        founder.efficiency = save.gameState.founder.efficiency || 1.0;
        founder.baseEfficiency = save.gameState.founder.baseEfficiency || 1.0;
        founder.experienceMonths = save.gameState.founder.experienceMonths || 0;
        founder.assignedProduct = save.gameState.founder.assignedProduct;
        
        // Migration: Convert old XP/level system to new experience system (if old save)
        if (save.gameState.founder.skillLevel !== undefined && save.gameState.founder.experienceMonths === undefined) {
          // Old save - estimate experience months based on old efficiency
          // Old max was 1.5x, new max is 2.0x, so scale accordingly
          founder.experienceMonths = 0; // Start fresh with new system
          founder.baseEfficiency = 1.0;
        }
        
        // Restore infrastructure
        currentOfficeTier = save.gameState.currentOfficeTier || 0;
        currentServerTier = save.gameState.currentServerTier || 0;
        
        // Restore entities
        products = save.gameState.products || [];
        developers = save.gameState.developers || [];
        marketers = save.gameState.marketers || [];
        managers = save.gameState.managers || [];
        
        // Migration: Add skill property to old employees if missing
        developers.forEach(dev => {
          if (!dev.skill && dev.tier !== undefined) {
            dev.skill = DEVELOPER_TIERS[dev.tier].skill;
          }
          // Migration: Add experienceMonths to old employees
          if (dev.experienceMonths === undefined) {
            dev.experienceMonths = 0;
          }
          // Migration: Add baseEfficiency to old employees (use current efficiency as baseline)
          if (dev.baseEfficiency === undefined) {
            dev.baseEfficiency = dev.efficiency || DEVELOPER_TIERS[dev.tier].efficiency;
          }
        });
        marketers.forEach(mkt => {
          if (!mkt.skill && mkt.tier !== undefined) {
            mkt.skill = MARKETER_TIERS[mkt.tier].skill;
          }
          // Migration: Add experienceMonths to old employees
          if (mkt.experienceMonths === undefined) {
            mkt.experienceMonths = 0;
          }
          // Migration: Add baseEfficiency to old employees (use current efficiency as baseline)
          if (mkt.baseEfficiency === undefined) {
            mkt.baseEfficiency = mkt.efficiency || MARKETER_TIERS[mkt.tier].efficiency;
          }
        });
        
        // Restore R&D system
        rndProjects = save.gameState.rndProjects || [];
        completedRndProjects = save.gameState.completedRndProjects || [];
        unlockedProducts = save.gameState.unlockedProducts || ['Task Manager'];
        
        // Restore IDs
        nextProductId = save.gameState.nextProductId || 1;
        nextEmployeeId = save.gameState.nextEmployeeId || 1;
        // Ensure R&D project IDs don't collide with product IDs (start at 10000 or higher)
        nextRndProjectId = Math.max(save.gameState.nextRndProjectId || 10000, 10000);
        
        // Migration: Fix R&D projects with IDs that collide with products (< 10000)
        rndProjects.forEach(rndProject => {
          if (rndProject.id < 10000) {
            const oldId = rndProject.id;
            const newId = nextRndProjectId++;
            rndProject.id = newId;
            
            // Update any employee assignments that point to the old R&D project ID
            [...developers, ...marketers].forEach(emp => {
              if (emp.assignedProduct === oldId) {
                // Check if this assignment was meant for the R&D project (not a product)
                const productExists = products.find(p => p.id === oldId);
                if (productExists && productExists.status !== 'in_development') {
                  // Product exists but is not in development, so this must be an R&D assignment
                  emp.assignedProduct = newId;
                }
              }
            });
            
            // Update founder assignment if needed
            if (founder.assignedProduct === oldId) {
              const productExists = products.find(p => p.id === oldId);
              if (productExists && productExists.status !== 'in_development') {
                founder.assignedProduct = newId;
              }
            }
            
            console.log(`ð§ Migration: R&D project "${rndProject.name}" ID changed ${oldId} â ${newId} to avoid collision`);
          }
        });
        
        // Restore UI state
        expandedTeamSections = save.gameState.expandedTeamSections || {};
        currentProductFilter = save.gameState.currentProductFilter || 'all';
        expandedProductCards = save.gameState.expandedProductCards || {};
        currentEmployeeFilter = save.gameState.currentEmployeeFilter || 'all';
        expandedEmployeeCards = save.gameState.expandedEmployeeCards || {};
        
        // Migrate old boolean values to current day (for backward compatibility)
        for (const empId in expandedEmployeeCards) {
          if (typeof expandedEmployeeCards[empId] === 'boolean') {
            if (expandedEmployeeCards[empId] === true) {
              expandedEmployeeCards[empId] = currentDay; // Treat as just expanded
            } else {
              delete expandedEmployeeCards[empId]; // Remove if it was false
            }
          }
        }
        
        // Restore candidate pools (OLD SYSTEM)
        developerCandidates = save.gameState.developerCandidates || {};
        marketerCandidates = save.gameState.marketerCandidates || {};
        lastCandidateRefresh = save.gameState.lastCandidateRefresh || 0;
        
        // If no candidate pools exist, generate them
        if (Object.keys(developerCandidates).length === 0) {
          refreshCandidatePools();
        }
        
        // Restore NEW candidate pool system
        if (save.gameState.candidatePool) {
          candidatePool = save.gameState.candidatePool;
          // Ensure managers array exists (migration for old saves)
          if (!candidatePool.managers) {
            candidatePool.managers = [];
          }
        } else {
          // Old save without new system, initialize it
          candidatePool = {
            developers: [],
            marketers: [],
            managers: [],
            lastRefreshDay: currentDay
          };
          generateCandidatePool();
        }
        
        // Restore event log
        eventLog = save.gameState.eventLog || [];
        
        // Update UI
        document.getElementById('companyNameDisplay').textContent = companyName;
        updateCashDisplay();
        updateDayDisplay();
        updateFounderDisplay();
        updateProductsUI();
        updateRndUI();
        updateEmployeesUI();
        updateFinancesUI();
        updateEventLog();
        updateSpeedButtons();
        
        // Sync employee filter button states with restored filter
        const employeePanel = document.querySelector('#employeesContainer');
        if (employeePanel) {
          employeePanel.querySelectorAll('.filter-pill').forEach(pill => {
            pill.classList.remove('active');
            if (pill.dataset.filter === currentEmployeeFilter) {
              pill.classList.add('active');
            }
          });
        }
        
        // Show pause border if game is paused
        const pauseBorder = document.getElementById('pauseBorderOverlay');
        if (pauseBorder) {
          if (!isPlaying) {
            pauseBorder.classList.add('active');
          } else {
            pauseBorder.classList.remove('active');
          }
        }
        
        logEvent("ð Game loaded successfully!");
        
        const saveDate = new Date(save.timestamp);
        logEvent(`ð¾ Last saved: ${saveDate.toLocaleString()}`);
        
        return true;
      } catch (e) {
        console.error("Failed to load game:", e);
        logEvent("â Failed to load saved game");
        return false;
      }
    }
    
    function resetGameWithConfirmation() {
      // Pause game first
      pauseGame();
      
      // Confirm reset
      const message = "ð Reset Game?\n\nThis will delete your current progress and start a new game.\n\nCurrent Progress:\n" +
                     "â¢ Day " + currentDay + "\n" +
                     "â¢ Cash: " + formatCurrency(cash) + "\n" +
                     "â¢ Products: " + products.length + "\n" +
                     "â¢ Team: " + getCurrentTeamSize() + " people\n\n" +
                     "Are you sure?";
      
      if (confirm(message)) {
        // Clear save
        try {
          localStorage.removeItem('softwareCompanyGame');
        } catch (e) {
          console.error("Failed to clear save:", e);
        }
        
        // Show new game modal
        document.getElementById('newGameModal').classList.add('active');
        populateNewGameForm();
        
        logEvent("ð Game reset. Starting fresh...");
      } else {
        // User cancelled, resume game
        startGame();
        logEvent("â Reset cancelled");
      }
    }
    
    function initNewGame() {
      const form = document.getElementById('newGameForm');
      const companyNameInput = document.getElementById('companyNameInput');
      const founderNameInput = document.getElementById('founderNameInput');
      const selectedCurrency = document.querySelector('input[name="currency"]:checked').value;
      const selectedCapital = parseInt(document.querySelector('input[name="capital"]:checked').value);

      // Set game state
      companyName = companyNameInput.value || "My Startup";
      founder.name = founderNameInput.value || "Founder";
      founder.efficiency = 1.0;
      founder.baseEfficiency = 1.0;
      founder.experienceMonths = 0;
      founder.assignedProduct = null;
      founder.isManaged = false;
      founder.managerId = null;
      currency = selectedCurrency;
      cash = selectedCapital;
      currentDay = 0;

      // Update UI
      document.getElementById('companyNameDisplay').textContent = companyName;
      updateCashDisplay();
      updateDayDisplay();
      updateFounderDisplay();

      // Reset game state
      products = [];
      developers = [];
      marketers = [];
      managers = [];
      nextEmployeeId = 1;
      nextProductId = 1;
      currentOfficeTier = 0; // Start with Home Office
      currentServerTier = 0; // Start with Shared Hosting (free)
      eventLog = [];
      expandedTeamSections = {}; // Reset UI state
      currentProductFilter = 'all';
      expandedProductCards = {};
      currentEmployeeFilter = 'all';
      expandedEmployeeCards = {};
      lifetimeEarnings = 0; // Reset lifetime earnings
      
      // Reset R&D system
      rndProjects = [];
      completedRndProjects = [];
      unlockedProducts = ['Task Manager']; // Only Task Manager unlocked at start
      nextRndProjectId = 10000;  // Start at 10000 to avoid ID collision with products
      
      // Initialize candidate pools (OLD SYSTEM - keeping for compatibility)
      developerCandidates = {};
      marketerCandidates = {};
      lastCandidateRefresh = 0;
      refreshCandidatePools();
      
      // Initialize NEW candidate pool system
      candidatePool.developers = [];
      candidatePool.marketers = [];
      candidatePool.managers = [];
      candidatePool.lastRefreshDay = 0;
      generateCandidatePool(); // Generate initial pool based on startup milestone
      
      // Log start
      logEvent(`ð ${companyName} founded by ${founder.name}!`);
      logEvent(`ð° Starting with ${formatCurrency(cash)}`);
      logEvent(`ð¢ Working from ${OFFICE_TIERS[0].name} (capacity: ${OFFICE_TIERS[0].capacity})`);
      logEvent(`ð¥ï¸ Server: ${SERVER_TIERS[0].name} (free tier)`);
      
      // Initialize UI
      updateFounderDisplay();
      updateProductsUI();
      updateRndUI();
      updateEmployeesUI();
      updateFinancesUI();
      
      // Sync employee filter button states (should be 'all' for new game)
      const employeePanel = document.querySelector('#employeesContainer');
      if (employeePanel) {
        employeePanel.querySelectorAll('.filter-pill').forEach(pill => {
          pill.classList.remove('active');
          if (pill.dataset.filter === currentEmployeeFilter) {
            pill.classList.add('active');
          }
        });
      }

      // Close modal
      document.getElementById('newGameModal').classList.remove('active');

      // Start game paused
      isPlaying = false;
      updateSpeedButtons();
      
      // Show pause border overlay
      const pauseBorder = document.getElementById('pauseBorderOverlay');
      if (pauseBorder) {
        pauseBorder.classList.add('active');
      }
      
      logEvent(`â¸ï¸ Game paused. Press Space or click Play to start!`);
      
      // Save initial game state
      saveGame();
    }

    // Make functions globally accessible for onclick handlers
    window.assignFounderToProduct = assignFounderToProduct;
    window.assignFounderToProductAsMarketer = assignFounderToProductAsMarketer;
    window.unassignFounderFromProduct = unassignFounderFromProduct;
    window.assignEmployeeToProduct = assignEmployeeToProduct;
    window.unassignEmployeeFromProduct = unassignEmployeeFromProduct;
    window.hireDeveloper = hireDeveloper;
    window.hireMarketer = hireMarketer;
    window.hireFromPool = hireFromPool; // NEW: Hire directly from candidate pool
    window.showHireConfirmation = showHireConfirmation;
    window.confirmHireCandidate = confirmHireCandidate;
    window.hideHireConfirmModal = hideHireConfirmModal;
    window.showUpgradeOfficeModal = showUpgradeOfficeModal;
    window.hideUpgradeOfficeModal = hideUpgradeOfficeModal;
    window.confirmUpgradeOffice = confirmUpgradeOffice;
    window.showDowngradeOfficeModal = showDowngradeOfficeModal;
    window.hideDowngradeOfficeModal = hideDowngradeOfficeModal;
    window.confirmDowngradeOffice = confirmDowngradeOffice;
    window.upgradeServer = upgradeServer;
    window.showHireModal = showHireModal;
    window.hideSelectEmployeeTypeModal = hideSelectEmployeeTypeModal;
    window.selectEmployeeType = selectEmployeeType;
    window.showHireDeveloperModal = showHireDeveloperModal;
    window.hideHireDeveloperModal = hideHireDeveloperModal;
    window.showHireMarketerModal = showHireMarketerModal;
    window.hideHireMarketerModal = hideHireMarketerModal;
    window.showAssignDeveloperModal = showAssignDeveloperModal;
    window.hideAssignDeveloperModal = hideAssignDeveloperModal;
    window.toggleDeveloperSelection = toggleDeveloperSelection;
    window.assignSelectedDevelopers = assignSelectedDevelopers;
    window.showPromotionModal = showPromotionModal;
    window.hidePromotionModal = hidePromotionModal;
    window.makePromotionOffer = makePromotionOffer;
    window.showAssignMarketerModal = showAssignMarketerModal;
    window.hideAssignMarketerModal = hideAssignMarketerModal;
    window.toggleMarketerSelection = toggleMarketerSelection;
    window.assignSelectedMarketers = assignSelectedMarketers;
    window.showAssignToRndModal = showAssignToRndModal;
    window.hideAssignToRndModal = hideAssignToRndModal;
    window.toggleRndDeveloperSelection = toggleRndDeveloperSelection;
    window.assignSelectedToRnd = assignSelectedToRnd;
    window.generateRandomCompanyName = generateRandomCompanyName;
    window.generateRandomFounderName = generateRandomFounderName;
    window.restartGame = restartGame;
    window.filterEmployees = filterEmployees;
    window.toggleEmployeeCard = toggleEmployeeCard;
    window.showPenaltyPopup = showPenaltyPopup;
    window.hidePenaltyPopup = hidePenaltyPopup;
    
    // Manager-related functions
    window.showManagerPromotionModal = showManagerPromotionModal;
    window.makeManagerPromotionOffer = makeManagerPromotionOffer;
    window.hideManagerPromotionModal = hideManagerPromotionModal;
    window.showFireManagerModal = showFireManagerModal;
    window.confirmFireManager = confirmFireManager;
    window.hideFireManagerModal = hideFireManagerModal;

    // ============================================
    // EVENT LISTENERS
    // ============================================
    // Function to update panel heights based on actual header height
    function updatePanelHeights() {
      const header = document.getElementById('gameHeader');
      if (header) {
        const headerHeight = header.offsetHeight;
        document.documentElement.style.setProperty('--header-height', `${headerHeight}px`);
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Lucide icons
      if (window.lucide) {
        window.lucide.createIcons();
      }
      
      // Calculate panel heights after DOM is ready and icons are initialized
      setTimeout(updatePanelHeights, 100);
      
      // Recalculate on window resize
      window.addEventListener('resize', updatePanelHeights);
      
      // Try to load existing save
      const saveLoaded = loadGame();
      
      if (saveLoaded) {
        // Hide new game modal if save was loaded
        document.getElementById('newGameModal').classList.remove('active');
        logEvent("ð® Welcome back to " + companyName + "!");
      } else {
        // No save found, show new game modal with random names
        populateNewGameForm();
      }
      
      // Speed controls (old buttons - only attach if they exist for backwards compatibility)
      const pauseBtn = document.getElementById('pauseBtn');
      const playBtn = document.getElementById('playBtn');
      const speed2xBtn = document.getElementById('speed2xBtn');
      
      if (pauseBtn) pauseBtn.addEventListener('click', () => pauseGame());
      if (playBtn) playBtn.addEventListener('click', () => { setGameSpeed(1); startGame(); });
      if (speed2xBtn) speed2xBtn.addEventListener('click', () => { setGameSpeed(2); startGame(); });
      
      // Game controls (new buttons use onclick attributes, but keep these for old button fallback)
      const saveBtn = document.getElementById('saveBtn');
      const resetBtn = document.getElementById('resetBtn');
      
      // Note: New Tailwind buttons use onclick attributes directly, so these listeners
      // are only for backwards compatibility if old buttons exist
      if (saveBtn && !saveBtn.hasAttribute('onclick')) {
        saveBtn.addEventListener('click', () => saveGame());
      }
      if (resetBtn && !resetBtn.hasAttribute('onclick')) {
        resetBtn.addEventListener('click', () => resetGameWithConfirmation());
      }

      // New game setup
      document.getElementById('startGameBtn').addEventListener('click', () => initNewGame());

      // Phase 2: Product system
      document.getElementById('newProductBtn').addEventListener('click', () => showNewProductModal());
      document.getElementById('cancelProductBtn').addEventListener('click', () => hideNewProductModal());
      document.getElementById('createProductBtn').addEventListener('click', () => handleCreateProduct());
      
      // R&D system
      document.getElementById('newRndBtn').addEventListener('click', () => showNewRndModal());
      
      // Keyboard controls
      document.addEventListener('keydown', (event) => {
        // Spacebar to play/pause
        if (event.code === 'Space' || event.key === ' ') {
          // Don't trigger if user is typing in an input field or modal is open
          const newGameModal = document.getElementById('newGameModal');
          const activeElement = document.activeElement;
          const isTyping = activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA';
          const isModalOpen = newGameModal.classList.contains('active');
          
          if (!isTyping && !isModalOpen) {
            event.preventDefault(); // Prevent page scroll
            
            if (isPlaying) {
              pauseGame();
            } else {
              startGame();
            }
          }
        }
      });
      
      // Mobile navigation functions
      setupMobileNavigation();
    });
    
    // ============================================
    // MOBILE NAVIGATION
    // ============================================
    function scrollToPanel(index) {
      const container = document.querySelector('.main-container');
      const panels = container.querySelectorAll('.panel');
      
      if (panels[index]) {
        panels[index].scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'start' });
        updateMobileNavActive(index);
      }
    }
    
    function updateMobileNavActive(index) {
      // Update old-style navigation if it exists
      const oldButtons = document.querySelectorAll('.mobile-nav-btn');
      oldButtons.forEach((btn, i) => {
        if (i === index) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      // Update new Tailwind-based navigation
      const navButtons = [
        document.getElementById('nav-products'),
        document.getElementById('nav-rnd'),
        document.getElementById('nav-team'),
        document.getElementById('nav-finance'),
        document.getElementById('nav-log')
      ];
      
      navButtons.forEach((btn, i) => {
        if (!btn) return;
        
        const iconElement = btn.querySelector('[data-lucide]');
        const svg = btn.querySelector('svg');
        const text = btn.querySelector('span');
        
        if (i === index) {
          // Active state
          // Add 'relative' for Team (2) and Finance (3) buttons for notification dots
          btn.className = 'flex flex-col items-center gap-1 px-4 py-2 rounded-lg bg-blue-600 transition-colors' + (i === 2 || i === 3 ? ' relative' : '');
          if (iconElement) {
            iconElement.className = 'w-6 h-6 text-white';
          }
          // Update SVG stroke if it exists
          if (svg) {
            svg.setAttribute('stroke', 'currentColor');
            svg.style.color = 'white';
          }
          if (text) {
            text.className = 'text-xs text-white font-medium';
          }
        } else {
          // Inactive state
          // Add 'relative' for Team (2) and Finance (3) buttons for notification dots
          btn.className = 'flex flex-col items-center gap-1 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors' + (i === 2 || i === 3 ? ' relative' : '');
          if (iconElement) {
            iconElement.className = 'w-6 h-6 text-gray-600';
          }
          // Update SVG stroke if it exists
          if (svg) {
            svg.setAttribute('stroke', 'currentColor');
            svg.style.color = '#4b5563'; // gray-600
          }
          if (text) {
            text.className = 'text-xs text-gray-600';
          }
        }
      });
      
      // Reinitialize Lucide icons to ensure new icons are rendered
      setTimeout(() => {
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }, 50);
    }
    
    function setupMobileNavigation() {
      const container = document.querySelector('.main-container');
      if (!container) return;
      
      // Note: Swiping between panels is disabled (overflow-x: hidden)
      // Users can only navigate using the bottom navigation buttons
      // The scroll event listener below won't fire since scrolling is disabled
      let scrollTimeout;
      container.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          const containerWidth = container.offsetWidth;
          const scrollLeft = container.scrollLeft;
          const currentIndex = Math.round(scrollLeft / containerWidth);
          updateMobileNavActive(currentIndex);
        }, 100);
      });
    }
    
    // ============================================
    // TESTING & DEBUG UTILITIES (Phase 7)
    // ============================================
    
    // Test save/load system with candidate pool
    function testSaveLoad() {
      console.log('=== Save/Load Test ===');
      console.log('Before save:');
      console.log('  Lifetime Earnings:', lifetimeEarnings);
      console.log('  Candidate Pool Developers:', candidatePool.developers.length);
      console.log('  Candidate Pool Marketers:', candidatePool.marketers.length);
      console.log('  Last Refresh Day:', candidatePool.lastRefreshDay);
      console.log('  Current Milestone:', getCurrentMilestone().name);
      
      const beforeSave = {
        lifetimeEarnings: lifetimeEarnings,
        devPoolSize: candidatePool.developers.length,
        marketerPoolSize: candidatePool.marketers.length,
        lastRefresh: candidatePool.lastRefreshDay,
        milestone: getCurrentMilestone().name
      };
      
      // Save
      const saved = saveGame();
      if (!saved) {
        console.error('Save failed!');
        return;
      }
      console.log('â Save successful');
      
      // Modify state
      lifetimeEarnings += 50000;
      candidatePool.developers = [];
      console.log('Modified state (lifetime earnings +50000, cleared dev pool)');
      
      // Load
      const loaded = loadGame();
      if (!loaded) {
        console.error('Load failed!');
        return;
      }
      console.log('â Load successful');
      
      console.log('After load:');
      console.log('  Lifetime Earnings:', lifetimeEarnings);
      console.log('  Candidate Pool Developers:', candidatePool.developers.length);
      console.log('  Candidate Pool Marketers:', candidatePool.marketers.length);
      console.log('  Last Refresh Day:', candidatePool.lastRefreshDay);
      console.log('  Current Milestone:', getCurrentMilestone().name);
      
      // Verify
      const afterLoad = {
        lifetimeEarnings: lifetimeEarnings,
        devPoolSize: candidatePool.developers.length,
        marketerPoolSize: candidatePool.marketers.length,
        lastRefresh: candidatePool.lastRefreshDay,
        milestone: getCurrentMilestone().name
      };
      
      const passed = 
        beforeSave.lifetimeEarnings === afterLoad.lifetimeEarnings &&
        beforeSave.devPoolSize === afterLoad.devPoolSize &&
        beforeSave.marketerPoolSize === afterLoad.marketerPoolSize &&
        beforeSave.lastRefresh === afterLoad.lastRefresh;
      
      if (passed) {
        console.log('â Save/Load test PASSED - all data preserved correctly!');
      } else {
        console.error('â Save/Load test FAILED - data mismatch!');
        console.log('Before:', beforeSave);
        console.log('After:', afterLoad);
      }
      
      updateAllUI();
    }
    
    // Test milestone progression
    function testMilestoneProgression() {
      console.log('=== Milestone Progression Test ===');
      console.log('Current:', lifetimeEarnings, '-', getCurrentMilestone().name);
      
      HIRING_MILESTONES.forEach((milestone, index) => {
        console.log(`${index + 1}. ${milestone.badge} ${milestone.name} (${formatCurrency(milestone.threshold)})`);
        console.log(`   ${milestone.description}`);
      });
      
      console.log('\nTo test milestone unlocks, run:');
      console.log('lifetimeEarnings = 100000; checkMilestoneAchievement(0, lifetimeEarnings); updateFinancesUI();');
    }
    
    // Test candidate pool generation
    function testCandidatePool() {
      //console.log('=== Candidate Pool Test ===');
      //console.log('Generating new candidate pool...');
      generateCandidatePool();
      
      //console.log('\nDevelopers:');
      candidatePool.developers.forEach((c, i) => {
        console.log(`${i + 1}. ${c.name} (${c.tierName}) - ${Math.round(c.efficiency * 100)}% efficiency, ${formatCurrency(c.monthlySalary)}/mo`);
      });
      
      //console.log('\nMarketers:');
      candidatePool.marketers.forEach((c, i) => {
        console.log(`${i + 1}. ${c.name} (${c.tierName}) - ${Math.round(c.efficiency * 100)}% efficiency, ${formatCurrency(c.monthlySalary)}/mo`);
      });
      
      //console.log('\nLast refresh day:', candidatePool.lastRefreshDay);
      //console.log('Current milestone:', getCurrentMilestone().name);
    }
    
    // Fix manager capacity issues
    function fixManagerCapacity() {
      console.log('ð§ Fixing manager capacity issues...');
      
      managers.forEach(manager => {
        console.log(`\nð Checking ${manager.name}:`);
        console.log(`   Current managedEmployees array:`, manager.managedEmployees);
        console.log(`   Array length: ${manager.managedEmployees.length}`);
        
        // Get all employees that claim to be managed by this manager
        const allEmployees = [founder, ...developers, ...marketers];
        const claimedManaged = allEmployees.filter(e => 
          e.isManaged && (e.managerId === manager.id || e.managerId.toString() === manager.id.toString())
        );
        
        console.log(`   Employees claiming to be managed: ${claimedManaged.length}`);
        if (claimedManaged.length > 0) {
          console.log(`   Names:`, claimedManaged.map(e => e.name || founder.name));
        }
        
        // Rebuild the managedEmployees array based on actual employee data
        const correctIds = claimedManaged.map(e => e.id === 'founder' ? 'founder' : e.id);
        
        if (JSON.stringify(manager.managedEmployees.sort()) !== JSON.stringify(correctIds.sort())) {
          console.log(`   â ï¸ MISMATCH DETECTED! Fixing...`);
          console.log(`   Old array:`, manager.managedEmployees);
          console.log(`   New array:`, correctIds);
          manager.managedEmployees = correctIds;
          console.log(`   â Fixed!`);
        } else {
          console.log(`   â Already correct`);
        }
      });
      
      console.log('\nâ Manager capacity fix complete!');
      console.log('Refreshing UI...');
      updateEmployeesUI();
      console.log('â Done!');
    }
    
    // Debug managed employees state
    function debugManagedEmployees() {
      console.log('ð DEBUGGING MANAGED EMPLOYEES STATE');
      console.log('='.repeat(60));
      
      const allEmployees = [founder, ...developers, ...marketers];
      
      console.log(`\nð All Employees (${allEmployees.length} total):`);
      allEmployees.forEach(emp => {
        const empName = emp.name || founder.name;
        const empId = emp.id === 'founder' ? 'founder' : emp.id;
        const isManaged = emp.isManaged || false;
        const managerId = emp.managerId || 'none';
        const assignedProduct = emp.assignedProduct || 'none';
        
        console.log(`\n  ${empName} (${emp.role}):`);
        console.log(`    - ID: ${empId}`);
        console.log(`    - isManaged: ${isManaged}`);
        console.log(`    - managerId: ${managerId}`);
        console.log(`    - assignedProduct: ${assignedProduct}`);
        
        if (assignedProduct !== 'none') {
          const product = products.find(p => p.id === assignedProduct);
          const rndProject = rndProjects.find(r => r.id === assignedProduct);
          const target = product || rndProject;
          console.log(`    - assigned to: ${target ? target.name : 'NOT FOUND!'}`);
        }
      });
      
      console.log(`\n\nð Managers (${managers.length} total):`);
      managers.forEach(manager => {
        console.log(`\n  ${manager.name}:`);
        console.log(`    - ID: ${manager.id}`);
        console.log(`    - Capacity: ${manager.managedEmployees.length}/${manager.capacity}`);
        console.log(`    - managedEmployees array:`, manager.managedEmployees);
        
        // Check if those employees actually exist and claim to be managed
        const actuallyManaged = allEmployees.filter(e => 
          manager.managedEmployees.some(id => 
            (e.id === 'founder' && id === 'founder') || e.id === id || e.id.toString() === id.toString()
          )
        );
        
        console.log(`    - Employees found: ${actuallyManaged.length}`);
        actuallyManaged.forEach(emp => {
          const empName = emp.name || founder.name;
          console.log(`      â ${empName} - isManaged: ${emp.isManaged}, managerId: ${emp.managerId}`);
        });
      });
      
      console.log('\n' + '='.repeat(60));
    }
    
    // Expose test functions globally for console access
    window.testSaveLoad = testSaveLoad;
    window.testMilestoneProgression = testMilestoneProgression;
    window.testCandidatePool = testCandidatePool;
    window.fixManagerCapacity = fixManagerCapacity;
    window.debugManagedEmployees = debugManagedEmployees;
    
    /*console.log('ð§ª Debug utilities loaded!');
    console.log('Available test functions:');
    console.log('  - testSaveLoad()');
    console.log('  - testMilestoneProgression()');
    console.log('  - testCandidatePool()');
    console.log('  - fixManagerCapacity() - Fix manager capacity display issues');
    console.log('  - debugManagedEmployees() - Debug why employees are not being assigned');
    */
  </script>
</body>
</html>
